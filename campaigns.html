<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TCHAT - Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ©</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="./api.js"></script>
</head>
<body class="rtl min-h-screen bg-background" style="font-family: 'LamaSans', sans-serif;">
  
  <!-- Header -->
  <header class="border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
    <div class="container mx-auto flex h-16 items-center justify-between px-4">
      <div class="flex items-center gap-2">
        <a href="./dashboard.html" class="inline-flex items-center gap-2 text-body-sm font-medium text-muted-foreground transition hover:text-foreground">
          <i data-lucide="arrow-right" class="h-4 w-4"></i>
          <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø©</span>
        </a>
      </div>
      <span class="text-heading-md font-bold">Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ©</span>
      <button onclick="logout()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
        <i data-lucide="log-out" class="ml-2 h-4 w-4"></i>
        <span class="text-body-md">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    
    <!-- Page Header -->
    <section class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-heading-lg font-bold text-foreground">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ©</h1>
        <p class="text-body-sm text-muted-foreground">Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø­Ù…Ù„Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="deleteAllCampaigns()" class="inline-flex items-center gap-2 rounded-md border border-destructive bg-destructive/10 px-4 py-2 text-button-md font-medium text-destructive shadow-sm transition hover:bg-destructive/20">
          <i data-lucide="trash-2" class="h-4 w-4"></i>
          <span>Ø­Ø°Ù Ø§Ù„ÙƒÙ„</span>
        </button>
        <button onclick="showCreateCampaignModal()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
          <i data-lucide="plus" class="h-4 w-4"></i>
          <span>Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
        </button>
      </div>
    </section>

    <!-- Campaigns List -->
    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
      <div class="border-b border-border p-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="megaphone" class="h-5 w-5 text-muted-foreground"></i>
            <h2 class="text-heading-md font-semibold">Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="updateAllCampaignStatuses()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-3 py-2 text-body-sm font-medium text-muted-foreground transition hover:bg-accent hover:text-accent-foreground">
              <i data-lucide="zap" class="h-4 w-4"></i>
              <span>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª</span>
            </button>
            <button onclick="refreshCampaigns()" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
              <i data-lucide="refresh-cw" class="h-4 w-4"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full caption-bottom text-sm">
          <thead class="bg-muted/50">
            <tr class="border-b text-right text-body-sm font-semibold text-muted-foreground">
              <th class="px-4 py-3 w-[25%]">Ø§Ù„Ø­Ù…Ù„Ø©</th>
              <th class="px-4 py-3 w-[15%] text-center">Ø§Ù„Ù‚Ø§Ù„Ø¨</th>
              <th class="px-4 py-3 w-[10%] text-center">Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th class="px-4 py-3 w-[10%] text-center">Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†</th>
              <th class="px-4 py-3 w-[15%] text-center">Ø§Ù„ØªÙ‚Ø¯Ù…</th>
              <th class="px-4 py-3 w-[15%] text-center">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</th>
              <th class="px-4 py-3 w-[10%] text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="campaigns-table-body" class="divide-y divide-border">
            <tr>
              <td colspan="7" class="h-24 text-center text-body-sm text-muted-foreground">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø§Øª...</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div class="border-t border-border p-4">
        <div class="flex items-center justify-between">
          <div class="text-body-sm text-muted-foreground">
            Ø¹Ø±Ø¶ <span id="showing-from" class="text-body-sm font-medium number">0</span> - <span id="showing-to" class="text-body-sm font-medium number">0</span> Ù…Ù† <span id="total-campaigns" class="text-body-sm font-medium number">0</span> Ø­Ù…Ù„Ø©
          </div>
          <div class="flex items-center gap-2">
            <button onclick="goToFirstPage()" id="first-page-btn" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:bg-accent hover:text-foreground disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <i data-lucide="chevrons-right" class="h-4 w-4"></i>
            </button>
            <button onclick="goToPrevPage()" id="prev-page-btn" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:bg-accent hover:text-foreground disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <i data-lucide="chevron-right" class="h-4 w-4"></i>
            </button>
            <div class="flex items-center gap-1 px-2">
              <span class="text-body-sm text-muted-foreground">ØµÙØ­Ø©</span>
              <span id="current-page-num" class="text-body-sm font-medium number">1</span>
              <span class="text-body-sm text-muted-foreground">Ù…Ù†</span>
              <span id="total-pages-num" class="text-body-sm font-medium number">1</span>
            </div>
            <button onclick="goToNextPage()" id="next-page-btn" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:bg-accent hover:text-foreground disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <i data-lucide="chevron-left" class="h-4 w-4"></i>
            </button>
            <button onclick="goToLastPage()" id="last-page-btn" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:bg-accent hover:text-foreground disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <i data-lucide="chevrons-left" class="h-4 w-4"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© -->
  <div id="message-details-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] hidden">
    <div class="bg-background rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden">
      <div class="flex items-center justify-between p-6 border-b border-border">
        <h2 class="text-heading-lg font-semibold">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</h2>
        <button onclick="closeMessageDetails()" class="text-muted-foreground hover:text-foreground transition-colors">
          <i data-lucide="x" class="h-5 w-5"></i>
        </button>
      </div>
      <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]" id="message-details-content">
        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø³ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬Ù‡ Ù‡Ù†Ø§ -->
      </div>
    </div>
  </div>

  <!-- Create Campaign Modal -->
  <div id="create-campaign-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div>
            <h2 class="text-heading-lg font-bold">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø© ØªØ³ÙˆÙŠÙ‚ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <p class="text-body-sm text-muted-foreground mt-1">Ù‚Ù… Ø¨Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ù…Ù„Ø© ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†</p>
          </div>
          <button onclick="hideCreateCampaignModal()" class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="x" class="h-4 w-4"></i>
          </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6 space-y-6">
          
          <!-- Step 1: Campaign Info -->
          <div class="space-y-4">
            <h3 class="text-heading-md font-semibold flex items-center gap-2">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground text-xs font-bold">1</span>
              Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø©
            </h3>
            
            <div class="grid gap-4 md:grid-cols-2">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø©</label>
                <input type="text" id="campaign-name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø©" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" />
              </div>
              <div class="space-y-2">
                <label class="text-body-sm font-medium">Ø§Ù„Ù‚Ø§Ù„Ø¨</label>
                <select id="campaign-template" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ù„Ø¨</option>
                </select>
              </div>
            </div>
            
            <div class="space-y-2">
              <label class="text-body-sm font-medium flex items-center gap-2">
                <i data-lucide="phone" class="h-4 w-4"></i>
                <span>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„</span>
              </label>
              <select id="whatsapp-phone-number" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" style="font-variant-numeric: lining-nums;">
                <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…...</option>
              </select>
              <p class="text-body-xs text-muted-foreground">Ø§Ø®ØªØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ù†Ù‡ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©</p>
            </div>
            
            <div class="space-y-2">
              <label class="text-body-sm font-medium">ÙˆØµÙ Ø§Ù„Ø­Ù…Ù„Ø©</label>
              <textarea id="campaign-description" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„Ø­Ù…Ù„Ø©" rows="3" class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"></textarea>
            </div>
          </div>

          <!-- Step 2: Recipients -->
          <div class="space-y-4">
            <h3 class="text-heading-md font-semibold flex items-center gap-2">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground text-xs font-bold">2</span>
              Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†
            </h3>
            
            <div class="grid gap-4 md:grid-cols-2">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
                <select id="recipients-source" onchange="handleRecipientsSourceChange()" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="database">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</option>
                  <option value="manual">Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</option>
                  <option value="csv">Ø±ÙØ¹ Ù…Ù„Ù CSV</option>
                </select>
              </div>
              <div class="space-y-2" id="csv-upload-section" style="display: none;">
                <label class="text-body-sm font-medium">Ù…Ù„Ù CSV</label>
                <input type="file" id="csv-file" accept=".csv" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" />
              </div>
            </div>

            <!-- Manual Input Section -->
            <div id="manual-input-section" class="space-y-4" style="display: none;">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡</label>
                <textarea 
                  id="manual-recipients" 
                  placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ:&#10;966501234567,Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯&#10;966509876543,ÙØ§Ø·Ù…Ø© Ø¹Ù„ÙŠ&#10;966555555555,Ø®Ø§Ù„Ø¯ Ø§Ù„Ø³Ø¹ÙŠØ¯&#10;&#10;Ø£Ùˆ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· (Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ù„ÙƒÙ„ Ø±Ù‚Ù…):&#10;966501234567&#10;966509876543"
                  rows="8" 
                  class="flex min-h-[160px] w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring font-mono"
                  oninput="parseManualRecipients()"
                ></textarea>
              </div>
              <div class="flex items-center gap-4 text-body-sm text-muted-foreground">
                <div class="flex items-center gap-2">
                  <i data-lucide="info" class="h-4 w-4"></i>
                  <span>Ø§Ù„ØªÙ†Ø³ÙŠÙ‚: Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ,Ø§Ù„Ø§Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                </div>
                <div class="flex items-center gap-2">
                  <span>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¯Ø®Ù„Ø©:</span>
                  <span id="manual-count" class="font-semibold number">0</span>
                </div>
              </div>
            </div>

            <div id="recipients-preview" class="rounded-lg border border-border bg-muted/20 p-4">
              <div class="text-center text-body-sm text-muted-foreground">
                <i data-lucide="users" class="h-8 w-8 mx-auto mb-2"></i>
                <p>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† Ù‡Ù†Ø§</p>
              </div>
            </div>
          </div>

          <!-- Step 3: Batch Settings -->
          <div class="space-y-4">
            <h3 class="text-heading-md font-semibold flex items-center gap-2">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground text-xs font-bold">3</span>
              Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            </h3>
            
            <div class="grid gap-4 md:grid-cols-3">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">Ø­Ø¬Ù… Ø§Ù„Ø¯ÙØ¹Ø©</label>
                <select id="batch-size" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="50">50 Ø¹Ù…ÙŠÙ„</option>
                  <option value="100" selected>100 Ø¹Ù…ÙŠÙ„</option>
                  <option value="200">200 Ø¹Ù…ÙŠÙ„</option>
                  <option value="300">300 Ø¹Ù…ÙŠÙ„</option>
                  <option value="500">500 Ø¹Ù…ÙŠÙ„</option>
                </select>
              </div>
              <div class="space-y-2">
                <label class="text-body-sm font-medium">Ø§Ù„ÙØªØ±Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¯ÙØ¹Ø§Øª</label>
                <select id="batch-interval" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="1" selected>Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©</option>
                  <option value="2">Ø³Ø§Ø¹ØªØ§Ù†</option>
                  <option value="3">3 Ø³Ø§Ø¹Ø§Øª</option>
                  <option value="6">6 Ø³Ø§Ø¹Ø§Øª</option>
                  <option value="12">12 Ø³Ø§Ø¹Ø©</option>
                  <option value="24">24 Ø³Ø§Ø¹Ø©</option>
                </select>
              </div>
              <div class="space-y-2">
                <label class="text-body-sm font-medium">Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>
                <select id="send-type" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="batch" selected>Ù…Ø¬Ø²Ø£ (Ù…ÙˆØµÙ‰ Ø¨Ù‡)</option>
                  <option value="all">Ø§Ù„ÙƒÙ„ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©</option>
                </select>
              </div>
            </div>

            <!-- Smart Send Checkbox -->
            <div class="rounded-lg border border-border bg-card p-4">
              <label class="flex items-start gap-3 cursor-pointer">
                <input type="checkbox" id="enable-smart-send" onchange="handleSmartSendToggle()" class="mt-1 h-4 w-4 rounded border-gray-300 text-primary focus:ring-2 focus:ring-primary focus:ring-offset-2" checked />
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <i data-lucide="zap" class="h-4 w-4 text-primary"></i>
                    <span class="text-body-md font-semibold">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ</span>
                    <span class="inline-flex items-center rounded-md bg-primary/10 px-2 py-1 text-xs font-medium text-primary">Ù…ÙˆØµÙ‰ Ø¨Ù‡</span>
                  </div>
                  <p class="text-body-sm text-muted-foreground mt-1">
                    Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù‡Ø§ Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± <span class="font-semibold text-foreground">10 Ø£ÙŠØ§Ù…</span> Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¥Ø²Ø¹Ø§Ø¬ ÙˆØªØ­Ø³ÙŠÙ† Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„
                  </p>
                </div>
              </label>
            </div>

            <!-- Smart Send Info -->
            <div id="smart-send-info" class="rounded-lg border border-primary bg-primary/5 p-4">
              <div class="flex items-start gap-3">
                <i data-lucide="zap" class="h-5 w-5 text-primary mt-0.5"></i>
                <div class="flex-1">
                  <h4 class="text-body-md font-semibold text-primary mb-1">Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ âœ¨</h4>
                  <p class="text-body-sm text-muted-foreground mb-3">
                    Ø³ÙŠØªÙ… ÙØ­Øµ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙˆØ§Ø³ØªØ¨Ø¹Ø§Ø¯ Ù…Ù† ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù‡Ù… Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± <span class="font-semibold text-foreground">10 Ø£ÙŠØ§Ù…</span> Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¥Ø²Ø¹Ø§Ø¬ ÙˆØªØ­Ø³ÙŠÙ† Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„.
                  </p>
                  <button onclick="runSmartSendCheck()" id="check-recipients-btn" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-sm font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90 disabled:opacity-50">
                    <i data-lucide="scan-search" class="h-4 w-4"></i>
                    <span>ÙØ­Øµ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¢Ù†</span>
                  </button>
                </div>
              </div>
              
              <!-- Smart Send Results -->
              <div id="smart-send-results" class="mt-4 hidden">
                <div class="grid gap-3 md:grid-cols-3">
                  <div class="rounded-lg border border-border bg-card p-3">
                    <div class="text-body-xs text-muted-foreground mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</div>
                    <div class="text-heading-sm font-bold" id="smart-total">0</div>
                  </div>
                  <div class="rounded-lg border border-green-500 bg-green-500/10 p-3">
                    <div class="text-body-xs text-green-700 dark:text-green-400 mb-1">âœ… Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</div>
                    <div class="text-heading-sm font-bold text-green-600 dark:text-green-400" id="smart-allowed">0</div>
                  </div>
                  <div class="rounded-lg border border-orange-500 bg-orange-500/10 p-3">
                    <div class="text-body-xs text-orange-700 dark:text-orange-400 mb-1">âš ï¸ Ù…Ø³ØªØ¨Ø¹Ø¯</div>
                    <div class="text-heading-sm font-bold text-orange-600 dark:text-orange-400" id="smart-excluded">0</div>
                  </div>
                </div>
                <div class="mt-3 text-body-xs text-muted-foreground">
                  <i data-lucide="info" class="h-3 w-3 inline"></i>
                  <span id="smart-message">ØªÙ… Ø§Ù„ÙØ­Øµ Ø¨Ù†Ø¬Ø§Ø­</span>
                </div>
              </div>
            </div>

            <div id="batch-preview" class="rounded-lg border border-border bg-accent/20 p-4">
              <h4 class="text-body-md font-semibold mb-2">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</h4>
              <div id="batch-preview-content" class="text-body-sm text-muted-foreground">
                Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¬Ø²Ø¦Ø© Ù‡Ù†Ø§
              </div>
            </div>
          </div>

        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-between border-t border-border p-6">
          <button onclick="hideCreateCampaignModal()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-body-sm font-medium transition hover:bg-accent hover:text-accent-foreground">
            <span>Ø¥Ù„ØºØ§Ø¡</span>
          </button>
          <div class="flex items-center gap-3">
            <button onclick="previewCampaign()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-body-sm font-medium transition hover:bg-accent hover:text-accent-foreground">
              <i data-lucide="eye" class="h-4 w-4"></i>
              <span>Ù…Ø¹Ø§ÙŠÙ†Ø©</span>
            </button>
            <button onclick="createCampaign()" id="create-campaign-btn" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90 disabled:opacity-50">
              <i data-lucide="send" class="h-4 w-4"></i>
              <span>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©</span>
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Campaign Details Modal -->
  <div id="campaign-details-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-6xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div>
            <h2 id="details-campaign-name" class="text-heading-lg font-bold">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø©</h2>
            <p class="text-body-sm text-muted-foreground mt-1">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ù…Ù„Ø©</p>
          </div>
          <button onclick="hideCampaignDetailsModal()" class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="x" class="h-4 w-4"></i>
          </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6" id="campaign-details-content">
          <div class="text-center text-body-sm text-muted-foreground">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø©...</div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // ÙØ­Øµ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    const isLoggedIn = localStorage.getItem('tchat_logged_in');
    const token = localStorage.getItem('access_token') || localStorage.getItem('tchat_token');
    
    console.log('ğŸ” ÙØ­Øµ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', {
      isLoggedIn: isLoggedIn,
      token: token ? token.substring(0, 20) + '...' : 'null',
      tokenLength: token ? token.length : 0
    });
    
    if (!isLoggedIn || isLoggedIn === 'false') {
      console.log('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡ØŒ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      window.location.href = './login.html';
    }

    let campaigns = [];
    let selectedRecipients = [];
    let availableTemplates = [];
    
    // Pagination variables
    let currentPage = 1;
    const itemsPerPage = 10;

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø§Øª
    async function loadAndRenderCampaigns() {
      const tbody = document.getElementById('campaigns-table-body');
      tbody.innerHTML = '<tr><td colspan="7" class="h-24 text-center text-body-sm text-muted-foreground">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø§Øª...</td></tr>';

      try {
        campaigns = await loadCampaigns();
        currentPage = 1; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        renderCampaigns();
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø§Øª:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="h-24 text-center text-destructive text-body-sm">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø§Øª</td></tr>';
      }
    }

    function renderCampaigns() {
      const tbody = document.getElementById('campaigns-table-body');
      
      if (!campaigns.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="h-24 text-center text-body-sm text-muted-foreground">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù…Ù„Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
        updatePaginationInfo(0, 0, 0, 1, 1);
        return;
      }

      // Ø­Ø³Ø§Ø¨ Ø§Ù„ØµÙØ­Ø§Øª
      const totalPages = Math.ceil(campaigns.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, campaigns.length);
      const currentCampaigns = campaigns.slice(startIndex, endIndex);
      
      // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù€ pagination
      updatePaginationInfo(startIndex + 1, endIndex, campaigns.length, currentPage, totalPages);

      tbody.innerHTML = currentCampaigns.map(campaign => {
        const statusClass = getStatusBadgeClass(campaign.status);
        const statusText = getStatusText(campaign.status);
        const progressPercent = campaign.total_recipients > 0 
          ? Math.round((campaign.sent_count / campaign.total_recipients) * 100) 
          : 0;

        return `
          <tr class="hover:bg-muted/40 transition-colors">
            <td class="px-4 py-4">
              <div class="space-y-1">
                <div class="flex items-center gap-2">
                  <div class="text-body-md font-semibold">${campaign.name}</div>
                  ${campaign.is_smart_send ? `
                    <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground" title="Ø­Ù…Ù„Ø© Ø°ÙƒÙŠØ©">
                      <i data-lucide="zap" class="h-3 w-3"></i>
                    </span>
                  ` : ''}
                </div>
                <div class="text-body-sm text-muted-foreground">${campaign.description || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ'}</div>
                <div class="text-body-xs text-muted-foreground">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: <span class="number">${new Date(campaign.created_at).toLocaleDateString('en-GB')}</span></div>
              </div>
            </td>
            <td class="px-4 py-4 text-center">
              <span class="inline-flex items-center rounded-full border border-input px-3 py-1 text-xs font-semibold bg-accent text-accent-foreground">
                ${campaign.template_name}
              </span>
            </td>
            <td class="px-4 py-4 text-center">
              <span class="inline-flex items-center rounded-full border border-input px-3 py-1 text-xs font-semibold ${statusClass}">
                ${statusText}
              </span>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="text-body-md font-medium number">${campaign.total_recipients}</div>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="space-y-1">
                <div class="text-body-sm">
                  <span class="number">${campaign.sent_count}</span> / <span class="number">${campaign.total_recipients}</span>
                </div>
                <div class="w-full bg-muted rounded-full h-2">
                  <div class="bg-primary h-2 rounded-full transition-all" style="width: ${progressPercent}%"></div>
                </div>
                <div class="text-body-xs text-muted-foreground number">${progressPercent}%</div>
              </div>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="text-body-sm text-muted-foreground">
                <div class="number">${campaign.batch_size}</div>
                <div>ÙƒÙ„ <span class="number">${campaign.batch_interval_hours}</span> Ø³Ø§Ø¹Ø©</div>
              </div>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="flex items-center justify-center gap-1">
                <button onclick="viewCampaignDetails(${campaign.id})" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                  <i data-lucide="eye" class="h-3 w-3"></i>
                </button>
                ${campaign.status === 'draft' ? `
                  <button onclick="startCampaign(${campaign.id})" class="inline-flex h-8 w-8 items-center justify-center rounded-md bg-primary text-primary-foreground transition hover:bg-primary/90" title="Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©">
                    <i data-lucide="play" class="h-3 w-3"></i>
                  </button>
                ` : ''}
                ${campaign.status === 'running' || campaign.status === 'completed' ? `
                  <button onclick="resendCampaign(${campaign.id})" class="inline-flex h-8 w-8 items-center justify-center rounded-md bg-warning text-warning-foreground transition hover:bg-warning/90" title="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„">
                    <i data-lucide="repeat" class="h-3 w-3"></i>
                  </button>
                ` : ''}
                <button onclick="deleteCampaign(${campaign.id}, '${campaign.name}')" class="inline-flex h-8 w-8 items-center justify-center rounded-md bg-destructive text-destructive-foreground transition hover:bg-destructive/90" title="Ø­Ø°Ù Ø§Ù„Ø­Ù…Ù„Ø©">
                  <i data-lucide="trash-2" class="h-3 w-3"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      lucide.createIcons();
    }

    function getStatusBadgeClass(status) {
      const classes = {
        'draft': 'bg-muted text-muted-foreground',
        'scheduled': 'bg-warning/10 text-warning',
        'running': 'bg-primary/10 text-primary',
        'completed': 'bg-success/10 text-success',
        'paused': 'bg-warning/10 text-warning',
        'cancelled': 'bg-destructive/10 text-destructive'
      };
      return classes[status] || 'bg-muted text-muted-foreground';
    }

    function getStatusText(status) {
      const texts = {
        'draft': 'Ù…Ø³ÙˆØ¯Ø©',
        'scheduled': 'Ù…Ø¬Ø¯ÙˆÙ„Ø©',
        'running': 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„',
        'completed': 'Ù…ÙƒØªÙ…Ù„Ø©',
        'paused': 'Ù…ØªÙˆÙ‚ÙØ©',
        'cancelled': 'Ù…Ù„ØºÙŠØ©',
        'pending': 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
        'sent': 'Ø£ÙØ±Ø³ÙÙ„Øª',
        'delivered': 'ÙˆØµÙ„Øª',
        'read': 'Ù‚ÙØ±ÙØ¦Øª',
        'replied': 'ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§',
        'clicked': 'Ù†ÙÙ‚ÙØ± Ø¹Ù„ÙŠÙ‡Ø§',
        'failed': 'ÙØ´Ù„Øª'
      };
      return texts[status] || status;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
    async function loadWhatsAppPhoneNumbers() {
      const selectElement = document.getElementById('whatsapp-phone-number');
      
      try {
        const phoneNumbers = await loadMetaPhoneNumbers();
        
        if (phoneNumbers && phoneNumbers.length > 0) {
          selectElement.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</option>';
          
          phoneNumbers.forEach(phone => {
            const option = document.createElement('option');
            option.value = phone.id;
            
            // ØªÙ†Ø¸ÙŠÙ ÙˆØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
            let displayNumber = phone.display_phone_number || phone.id;
            // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±Ø§ØºØ§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ²
            displayNumber = displayNumber.replace(/[\s\+\-\(\)]/g, '');
            
            const verifiedName = phone.verified_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            
            option.textContent = `${displayNumber} - ${verifiedName}`;
            option.setAttribute('data-phone-id', phone.id);
            selectElement.appendChild(option);
          });
          
          // Ø§Ø®ØªÙŠØ§Ø± Ø£ÙˆÙ„ Ø±Ù‚Ù… Ø¨Ø´ÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ
          if (phoneNumbers.length > 0) {
            selectElement.value = phoneNumbers[0].id;
          }
        } else {
          selectElement.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ù…ØªØ§Ø­Ø©</option>';
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:', error);
        selectElement.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</option>';
      }
    }

    // Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©
    function showCreateCampaignModal() {
      document.getElementById('create-campaign-modal').classList.remove('hidden');
      document.getElementById('create-campaign-modal').classList.add('flex');
      loadTemplatesForCampaign();
      loadRecipientsPreview();
      loadWhatsAppPhoneNumbers();
    }

    function hideCreateCampaignModal() {
      document.getElementById('create-campaign-modal').classList.add('hidden');
      document.getElementById('create-campaign-modal').classList.remove('flex');
      resetCampaignForm();
    }

    function resetCampaignForm() {
      document.getElementById('campaign-name').value = '';
      document.getElementById('campaign-description').value = '';
      document.getElementById('campaign-template').value = '';
      document.getElementById('whatsapp-phone-number').value = '';
      document.getElementById('recipients-source').value = 'database';
      document.getElementById('csv-file').value = '';
      selectedRecipients = [];
      handleRecipientsSourceChange();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ù„Ù„Ø­Ù…Ù„Ø©
    async function loadTemplatesForCampaign() {
      try {
        availableTemplates = await loadMetaTemplates(100);
        const templateSelect = document.getElementById('campaign-template');
        
        templateSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ù„Ø¨</option>' +
          availableTemplates
            .filter(template => template.status === 'APPROVED')
            .map(template => `<option value="${template.name}">${template.name}</option>`)
            .join('');
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨:', error);
      }
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†
    function handleRecipientsSourceChange() {
      const source = document.getElementById('recipients-source').value;
      const csvSection = document.getElementById('csv-upload-section');
      const manualSection = document.getElementById('manual-input-section');
      
      // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹
      csvSection.style.display = 'none';
      manualSection.style.display = 'none';
      
      if (source === 'csv') {
        csvSection.style.display = 'block';
      } else if (source === 'manual') {
        manualSection.style.display = 'block';
        parseManualRecipients(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
      } else {
        loadRecipientsPreview();
      }
    }

    // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
    function parseManualRecipients() {
      const manualText = document.getElementById('manual-recipients').value.trim();
      const countEl = document.getElementById('manual-count');
      
      if (!manualText) {
        selectedRecipients = [];
        countEl.textContent = '0';
        updateRecipientsPreview();
        return;
      }

      const lines = manualText.split('\n').filter(line => line.trim());
      selectedRecipients = [];

      lines.forEach((line, index) => {
        const trimmedLine = line.trim();
        if (!trimmedLine) return;

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù‚Ù… Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ²
        const cleanLine = trimmedLine.replace(/[\s\-\+]/g, '');
        
        if (cleanLine.includes(',')) {
          // ØªÙ†Ø³ÙŠÙ‚: Ø±Ù‚Ù…,Ø§Ø³Ù…
          const [phone, name] = cleanLine.split(',').map(part => part.trim());
          if (phone && /^966\d{9}$/.test(phone)) {
            selectedRecipients.push({
              customer_id: 0,
              phone_number: phone,
              customer_name: name || `Ø¹Ù…ÙŠÙ„ ${phone.slice(-4)}`
            });
          }
        } else {
          // Ø±Ù‚Ù… ÙÙ‚Ø·
          if (/^966\d{9}$/.test(cleanLine)) {
            selectedRecipients.push({
              customer_id: 0,
              phone_number: cleanLine,
              customer_name: `Ø¹Ù…ÙŠÙ„ ${cleanLine.slice(-4)}`
            });
          }
        }
      });

      countEl.textContent = selectedRecipients.length;
      updateRecipientsPreview();
      updateBatchPreview();
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ù…Ù„Ù CSV
    function handleCSVUpload(event) {
      const file = event.target.files[0];
      
      if (!file) {
        selectedRecipients = [];
        updateRecipientsPreview();
        updateBatchPreview();
        return;
      }

      if (!file.name.endsWith('.csv')) {
        alert('ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù CSV ÙÙ‚Ø·');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.split('\n').filter(line => line.trim());
          selectedRecipients = [];

          // ØªØ®Ø·ÙŠ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
          const startIndex = lines[0].toLowerCase().includes('phone') || lines[0].toLowerCase().includes('name') || lines[0].toLowerCase().includes('Ø±Ù‚Ù…') || lines[0].toLowerCase().includes('Ø§Ø³Ù…') ? 1 : 0;

          for (let i = startIndex; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            // Ø¯Ø¹Ù… Ø§Ù„ÙÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø®ØªÙ„ÙØ© (comma, semicolon, tab)
            const separator = line.includes(';') ? ';' : line.includes('\t') ? '\t' : ',';
            const parts = line.split(separator).map(part => part.trim().replace(/^["']+|["']+$/g, '')); // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©

            if (parts.length === 0) continue;

            let phone = '';
            let name = '';

            if (parts.length === 1) {
              // Ø±Ù‚Ù… ÙÙ‚Ø· - ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù‚Ù… Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ²
              phone = parts[0].replace(/[\s\-\+]/g, '');
            } else if (parts.length >= 2) {
              // Ø±Ù‚Ù… ÙˆØ§Ø³Ù… (ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ø«Ø§Ù†ÙŠ)
              const cleanPart0 = parts[0].replace(/[\s\-\+]/g, '');
              const cleanPart1 = parts[1].replace(/[\s\-\+]/g, '');
              
              if (/^966\d{9}$/.test(cleanPart0)) {
                // Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ Ø±Ù‚Ù… ØµØ­ÙŠØ­
                phone = cleanPart0;
                name = parts[1]; // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙÙŠ Ø§Ù„Ø§Ø³Ù…
              } else if (/^966\d{9}$/.test(cleanPart1)) {
                // Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø±Ù‚Ù… ØµØ­ÙŠØ­
                name = parts[0]; // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙÙŠ Ø§Ù„Ø§Ø³Ù…
                phone = cleanPart1;
              } else {
                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù‚Ù…
                phone = cleanPart0.replace(/^0+/, ''); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£ØµÙØ§Ø± Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                if (!phone.startsWith('966')) {
                  phone = '966' + phone;
                }
                name = parts[1]; // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙÙŠ Ø§Ù„Ø§Ø³Ù…
              }
            }

            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…)
            phone = phone.replace(/[^\d]/g, '');
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ Ø¨Ù€ 05
            if (phone.startsWith('05') && phone.length === 10) {
              phone = '966' + phone.substring(1);
            } else if (phone.startsWith('5') && phone.length === 9) {
              phone = '966' + phone;
            }

            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø© ÙÙ‚Ø·)
            name = name.trim().replace(/\s+/g, ' ');

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ù‚Ù…
            if (/^966\d{9}$/.test(phone)) {
              selectedRecipients.push({
                customer_id: 0,
                phone_number: phone,
                customer_name: name || `Ø¹Ù…ÙŠÙ„ ${phone.slice(-4)}`
              });
            }
          }

          if (selectedRecipients.length === 0) {
            alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù.\n\nØ§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:\n- Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 966 Ø£Ùˆ 05\n- Ù…Ø«Ø§Ù„: 966501234567 Ø£Ùˆ 0501234567\n- ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø«Ø§Ù†ÙŠ');
          } else {
            updateRecipientsPreview();
            updateBatchPreview();
          }
        } catch (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù CSV:', error);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© CSV ØµØ­ÙŠØ­Ø©.');
        }
      };

      reader.onerror = function() {
        alert('ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù');
      };

      reader.readAsText(file, 'UTF-8');
    }

    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†
    function updateRecipientsPreview() {
      const previewEl = document.getElementById('recipients-preview');
      
      if (selectedRecipients.length === 0) {
        previewEl.innerHTML = `
          <div class="text-center text-body-sm text-muted-foreground">
            <i data-lucide="users" class="h-8 w-8 mx-auto mb-2"></i>
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø©</p>
          </div>
        `;
        return;
      }

      previewEl.innerHTML = `
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <h4 class="text-body-md font-semibold">Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†</h4>
            <span class="text-body-sm text-muted-foreground">${selectedRecipients.length} Ù…Ø³ØªÙ‚Ø¨Ù„</span>
          </div>
          <div class="grid gap-2 max-h-32 overflow-y-auto">
            ${selectedRecipients.slice(0, 5).map(r => `
              <div class="flex items-center justify-between text-body-sm">
                <span>${r.customer_name}</span>
                <span class="number">${r.phone_number}</span>
              </div>
            `).join('')}
            ${selectedRecipients.length > 5 ? `<div class="text-center text-body-xs text-muted-foreground">Ùˆ ${selectedRecipients.length - 5} Ù…Ø³ØªÙ‚Ø¨Ù„ Ø¢Ø®Ø±...</div>` : ''}
          </div>
        </div>
      `;
    }

    // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function loadRecipientsPreview() {
      const previewEl = document.getElementById('recipients-preview');
      const source = document.getElementById('recipients-source').value;
      
      if (source === 'database') {
        try {
          const customers = await loadCustomers(200);
          selectedRecipients = customers.map(customer => ({
            customer_id: customer.id,
            phone_number: customer.mobile || customer.phone,
            customer_name: customer.name
          })).filter(r => r.phone_number);

          updateRecipientsPreview();
        } catch (error) {
          previewEl.innerHTML = '<div class="text-center text-destructive text-body-sm">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>';
        }
      } else {
        previewEl.innerHTML = `
          <div class="text-center text-body-sm text-muted-foreground">
            <i data-lucide="users" class="h-8 w-8 mx-auto mb-2"></i>
            <p>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† Ù‡Ù†Ø§</p>
          </div>
        `;
      }
      
      updateBatchPreview();
    }

    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ¬Ø²Ø¦Ø©
    function updateBatchPreview() {
      const previewContent = document.getElementById('batch-preview-content');
      const sendType = document.getElementById('send-type').value;
      const batchSize = parseInt(document.getElementById('batch-size').value);
      const batchInterval = parseInt(document.getElementById('batch-interval').value);
      
      if (sendType === 'all') {
        previewContent.innerHTML = `
          <div class="text-warning">
            <i data-lucide="alert-triangle" class="inline h-4 w-4 ml-1"></i>
            Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† (${selectedRecipients.length}) Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
          </div>
        `;
        return;
      }

      const totalRecipients = selectedRecipients.length;
      const batchCount = Math.ceil(totalRecipients / batchSize);
      const totalDuration = (batchCount - 1) * batchInterval;

      previewContent.innerHTML = `
          <div class="space-y-2 text-body-sm">
            <div class="flex justify-between">
              <span>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª:</span>
              <span class="number">${batchCount}</span>
            </div>
            <div class="flex justify-between">
              <span>Ø­Ø¬Ù… ÙƒÙ„ Ø¯ÙØ¹Ø©:</span>
              <span class="number">${batchSize}</span> Ø¹Ù…ÙŠÙ„
            </div>
            <div class="flex justify-between">
              <span>Ø§Ù„ÙØªØ±Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¯ÙØ¹Ø§Øª:</span>
              <span class="number">${batchInterval}</span> Ø³Ø§Ø¹Ø©
            </div>
            <div class="flex justify-between">
              <span>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</span>
              <span class="number">${totalDuration}</span> Ø³Ø§Ø¹Ø©
            </div>
          </div>
      `;
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    function handleSendTypeChange() {
      updateBatchPreview();
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©
    async function createCampaign() {
      const name = document.getElementById('campaign-name').value.trim();
      const description = document.getElementById('campaign-description').value.trim();
      const templateName = document.getElementById('campaign-template').value;
      const batchSize = parseInt(document.getElementById('batch-size').value);
      const batchInterval = parseInt(document.getElementById('batch-interval').value);
      const sendType = document.getElementById('send-type').value;

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (!name || !templateName || selectedRecipients.length === 0) {
        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†');
        return;
      }

      const createBtn = document.getElementById('create-campaign-btn');
      createBtn.disabled = true;
      createBtn.innerHTML = '<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...</span>';

      try {
        const isSmartSend = document.getElementById('enable-smart-send').checked;
        const whatsappPhoneNumberID = document.getElementById('whatsapp-phone-number').value;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨
        if (!whatsappPhoneNumberID) {
          alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„');
          createBtn.disabled = false;
          createBtn.innerHTML = '<i data-lucide="send" class="h-4 w-4"></i><span>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©</span>';
          lucide.createIcons();
          return;
        }
        
        const campaignData = {
          name: name,
          description: description,
          template_name: templateName,
          template_language: 'ar',
          whatsapp_phone_number_id: whatsappPhoneNumberID,
          batch_size: sendType === 'all' ? selectedRecipients.length : batchSize,
          batch_interval_hours: sendType === 'all' ? 0 : batchInterval,
          is_smart_send: isSmartSend,
          recipients: selectedRecipients
        };

        const response = await fetch('https://tchat-production.up.railway.app/api/v1/campaigns', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          },
          body: JSON.stringify(campaignData)
        });

        const result = await response.json();
        
        if (result.success) {
          let message = result.message || 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!';
          
          // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø£Ø±Ù‚Ø§Ù… Ù…Ø³ØªØ¨Ø¹Ø¯Ø©ØŒ Ø£Ø¶Ù ØªÙØ§ØµÙŠÙ„
          if (result.excluded_count && result.excluded_count > 0) {
            message += `\n\nğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:\n`;
            message += `â€¢ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠÙŠÙ†: ${result.final_count}\n`;
            message += `â€¢ ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯: ${result.excluded_count} (ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù‡Ù… Ø®Ù„Ø§Ù„ 10 Ø£ÙŠØ§Ù…)`;
          }
          
          alert(message);
          hideCreateCampaignModal();
          refreshCampaigns();
        } else {
          alert('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©: ' + (result.message || result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©:', error);
        alert('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.');
      } finally {
        createBtn.disabled = false;
        createBtn.innerHTML = '<i data-lucide="send" class="h-4 w-4"></i><span>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©</span>';
        lucide.createIcons();
      }
    }

    // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø©
    async function viewCampaignDetails(campaignId) {
      document.getElementById('campaign-details-modal').classList.remove('hidden');
      document.getElementById('campaign-details-modal').classList.add('flex');
      
      const content = document.getElementById('campaign-details-content');
      content.innerHTML = '<div class="text-center text-body-sm text-muted-foreground">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø©...</div>';

      try {
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          renderCampaignDetails(result.campaign, result.recipients || []);
          
          // ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ÙØ´Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø±Ø³Ø§Ø¦Ù„ ÙØ§Ø´Ù„Ø©
          if (result.campaign.failed_count > 0) {
            setTimeout(() => loadFailureReasons(campaignId), 500);
          }
        } else {
          content.innerHTML = '<div class="text-center text-destructive text-body-sm">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø©</div>';
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø©:', error);
        content.innerHTML = '<div class="text-center text-destructive text-body-sm">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø©</div>';
      }
    }

    // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ÙØ´Ù„
    async function loadFailureReasons(campaignId) {
      const contentDiv = document.getElementById('failure-reasons-content');
      if (!contentDiv) return;
      
      contentDiv.innerHTML = `
        <div class="text-center text-body-sm text-muted-foreground">
          <i data-lucide="loader-2" class="h-6 w-6 mx-auto mb-2 animate-spin"></i>
          <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ÙØ´Ù„...</p>
        </div>
      `;
      lucide.createIcons();
      
      try {
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}/failure-reasons`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.reasons && result.reasons.length > 0) {
          // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ (ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹)
          const sortedReasons = result.reasons.sort((a, b) => b.count - a.count);
          
          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
          const total = result.total_failed;
          
          contentDiv.innerHTML = `
            <div class="space-y-3">
              ${sortedReasons.map((reason, index) => {
                const percentage = ((reason.count / total) * 100).toFixed(1);
                const barColor = getFailureReasonColor(reason.reason);
                const icon = getFailureReasonIcon(reason.reason);
                
                return `
                  <div class="rounded-lg border border-border bg-card p-4">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0">
                        <div class="flex h-10 w-10 items-center justify-center rounded-full ${barColor}/20">
                          <i data-lucide="${icon}" class="h-5 w-5 ${barColor}"></i>
                        </div>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between gap-2 mb-2">
                          <h4 class="text-body-md font-medium text-foreground">${reason.reason}</h4>
                          <div class="flex items-center gap-2 flex-shrink-0">
                            <span class="text-body-sm font-bold ${barColor}">${reason.count}</span>
                            <span class="text-body-xs text-muted-foreground">(${percentage}%)</span>
                          </div>
                        </div>
                        <div class="w-full bg-muted rounded-full h-2">
                          <div class="${barColor} h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            
            <div class="mt-4 rounded-lg border border-border bg-muted/30 p-4">
              <h4 class="text-body-sm font-semibold text-foreground mb-2">ğŸ’¡ Ù†ØµØ§Ø¦Ø­ Ù„ØªÙ‚Ù„ÙŠÙ„ Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ´Ù„:</h4>
              <ul class="text-body-xs text-muted-foreground space-y-1">
                ${getFailureRecommendations(sortedReasons).map(tip => `<li class="flex items-start gap-2"><span>â€¢</span><span>${tip}</span></li>`).join('')}
              </ul>
            </div>
          `;
        } else {
          contentDiv.innerHTML = `
            <div class="text-center text-body-sm text-muted-foreground">
              <i data-lucide="check-circle" class="h-8 w-8 mx-auto mb-2 text-success"></i>
              <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ù…ØªØ§Ø­Ø© Ø¹Ù† Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ÙØ´Ù„</p>
            </div>
          `;
        }
        
        lucide.createIcons();
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ÙØ´Ù„:', error);
        contentDiv.innerHTML = `
          <div class="text-center text-destructive text-body-sm">
            <i data-lucide="alert-triangle" class="h-8 w-8 mx-auto mb-2"></i>
            <p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ÙØ´Ù„</p>
          </div>
        `;
        lucide.createIcons();
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£
    function getFailureReasonColor(reason) {
      if (reason.includes('Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹') || reason.includes('Payment')) {
        return 'text-red-600';
      } else if (reason.includes('Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù…') || reason.includes('ecosystem')) {
        return 'text-orange-600';
      } else if (reason.includes('ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ³Ù„ÙŠÙ…') || reason.includes('undeliverable')) {
        return 'text-yellow-600';
      } else if (reason.includes('ØªØ¬Ø±Ø¨Ø©') || reason.includes('experiment')) {
        return 'text-purple-600';
      } else if (reason.includes('Ù…Ø­Ø¸ÙˆØ±') || reason.includes('blocked')) {
        return 'text-pink-600';
      } else {
        return 'text-gray-600';
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£
    function getFailureReasonIcon(reason) {
      if (reason.includes('Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹') || reason.includes('Payment')) {
        return 'credit-card';
      } else if (reason.includes('Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù…') || reason.includes('ecosystem')) {
        return 'shield-alert';
      } else if (reason.includes('ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ³Ù„ÙŠÙ…') || reason.includes('undeliverable')) {
        return 'phone-off';
      } else if (reason.includes('ØªØ¬Ø±Ø¨Ø©') || reason.includes('experiment')) {
        return 'flask';
      } else if (reason.includes('Ù…Ø­Ø¸ÙˆØ±') || reason.includes('blocked')) {
        return 'ban';
      } else {
        return 'alert-circle';
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØµØ§Ø¦Ø­ Ù…Ø®ØµØµØ© Ø­Ø³Ø¨ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ÙØ´Ù„
    function getFailureRecommendations(reasons) {
      const tips = [];
      const topReason = reasons[0]?.reason || '';
      
      if (topReason.includes('Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹')) {
        tips.push('âš ï¸ Ø¹Ø§Ø¬Ù„: ØªØ­Ù‚Ù‚ Ù…Ù† Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ ÙÙŠ Meta Business Manager');
        tips.push('ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆÙˆØ¬ÙˆØ¯ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙ');
      }
      
      if (reasons.some(r => r.reason.includes('Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù…'))) {
        tips.push('Ø§Ø³ØªØ®Ø¯Ù… Ù‚ÙˆØ§Ù„Ø¨ Ù…Ø¹ØªÙ…Ø¯Ø© Ù…Ù† Meta ÙÙ‚Ø·');
        tips.push('Ù„Ø§ ØªØ±Ø³Ù„ Ù„Ù†ÙØ³ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø´ÙƒÙ„ Ù…ØªÙƒØ±Ø§Ø±');
        tips.push('Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±');
      }
      
      if (reasons.some(r => r.reason.includes('ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ³Ù„ÙŠÙ…'))) {
        tips.push('Ù†Ø¸Ù‘Ù Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ø­Ø°Ù Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ØºÙŠØ± Ø§Ù„ØµØ­ÙŠØ­Ø©');
        tips.push('ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
      }
      
      if (tips.length === 0) {
        tips.push('Ù‚Ø³Ù‘Ù… Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø¥Ù„Ù‰ Ø¯ÙØ¹Ø§Øª ØµØºÙŠØ±Ø© (50-100 Ø±Ø³Ø§Ù„Ø©/Ø³Ø§Ø¹Ø©)');
        tips.push('Ø±Ø§Ù‚Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ´Ù„ Ù„ÙƒÙ„ Ø¯ÙØ¹Ø©');
      }
      
      return tips;
    }

    function renderCampaignDetails(campaign, recipients) {
      document.getElementById('details-campaign-name').textContent = campaign.name;
      const content = document.getElementById('campaign-details-content');
      
      const successRate = campaign.total_recipients > 0 
        ? Math.round((campaign.delivered_count / campaign.total_recipients) * 100) 
        : 0;

      content.innerHTML = `
        <div class="space-y-6">
          <!-- Campaign Info Section -->
          <div class="rounded-lg border bg-card">
            <div class="border-b border-border px-6 py-4">
              <h3 class="text-heading-md font-semibold flex items-center gap-2">
                <i data-lucide="info" class="h-5 w-5 text-primary"></i>
                <span>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ù…Ù„Ø©</span>
              </h3>
            </div>
            <div class="p-6">
              <div class="grid gap-6 md:grid-cols-2">
                <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠÙ…Ù† -->
                <div class="space-y-4">
                  <div>
                    <label class="text-body-sm font-semibold text-muted-foreground block mb-1">Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø©</label>
                    <div class="flex items-center gap-2">
                      <div class="text-body-md font-medium">${campaign.name}</div>
                      ${campaign.is_smart_send ? `
                        <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground" title="Ø­Ù…Ù„Ø© Ø°ÙƒÙŠØ©">
                          <i data-lucide="zap" class="h-3 w-3"></i>
                        </span>
                      ` : ''}
                    </div>
                  </div>
                  
                  <div>
                    <label class="text-body-sm font-semibold text-muted-foreground block mb-1">Ø§Ù„ÙˆØµÙ</label>
                    <div class="text-body-md text-foreground">${campaign.description || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ'}</div>
                  </div>
                  
                  <div>
                    <label class="text-body-sm font-semibold text-muted-foreground block mb-1">Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <div class="inline-flex items-center rounded-full border border-input px-3 py-1 text-body-sm font-semibold bg-accent text-accent-foreground">
                      ${campaign.template_name}
                    </div>
                  </div>
                  
                  <div>
                    <label class="text-body-sm font-semibold text-muted-foreground block mb-1">Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label>
                    <div class="text-body-md font-semibold">
                      ${campaign.whatsapp_phone_number_id ? `<span class="number">${campaign.whatsapp_phone_number_id}</span>` : 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ'}
                    </div>
                  </div>
                </div>
                
                <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠØ³Ø± -->
                <div class="space-y-4">
                  <div>
                    <label class="text-body-sm font-semibold text-muted-foreground block mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</label>
                    <div class="text-body-md"><span class="number">${new Date(campaign.created_at).toLocaleDateString('en-GB', { 
                      year: 'numeric', 
                      month: '2-digit', 
                      day: '2-digit'
                    })}</span> - <span class="number">${new Date(campaign.created_at).toLocaleTimeString('en-GB', {
                      hour: '2-digit',
                      minute: '2-digit'
                    })}</span></div>
                  </div>
                  
                  <div>
                    <label class="text-body-sm font-semibold text-muted-foreground block mb-1">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                    <span class="inline-flex items-center rounded-full border px-3 py-1 text-body-sm font-semibold ${getStatusBadgeClass(campaign.status)}">
                      ${getStatusText(campaign.status)}
                    </span>
                  </div>
                  
                  <div>
                    <label class="text-body-sm font-semibold text-muted-foreground block mb-1">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>
                    <div class="space-y-2">
                      <div class="flex items-center gap-2 text-body-sm">
                        <i data-lucide="users" class="h-4 w-4 text-muted-foreground"></i>
                        <span>Ø­Ø¬Ù… Ø§Ù„Ø¯ÙØ¹Ø©: <span class="font-semibold number">${campaign.batch_size}</span> Ø¹Ù…ÙŠÙ„</span>
                      </div>
                      <div class="flex items-center gap-2 text-body-sm">
                        <i data-lucide="clock" class="h-4 w-4 text-muted-foreground"></i>
                        <span>Ø§Ù„ÙØªØ±Ø©: ÙƒÙ„ <span class="font-semibold number">${campaign.batch_interval_hours}</span> Ø³Ø§Ø¹Ø©</span>
                      </div>
                      ${campaign.is_smart_send ? `
                        <div class="flex items-center gap-2 text-body-sm text-primary">
                          <i data-lucide="zap" class="h-4 w-4"></i>
                          <span class="font-medium">Ø¥Ø±Ø³Ø§Ù„ Ø°ÙƒÙŠ âœ¨ (Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…ÙƒØ±Ø±)</span>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Stats Cards -->
          <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-7">
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold number">${campaign.total_recipients}</div>
              <div class="text-body-sm text-muted-foreground">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-primary number">${campaign.sent_count}</div>
              <div class="text-body-sm text-muted-foreground">Ø£ÙØ±Ø³ÙÙ„Øª</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-success number">${campaign.delivered_count}</div>
              <div class="text-body-sm text-muted-foreground">ÙˆØµÙ„Øª</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-accent-foreground number">${campaign.read_count}</div>
              <div class="text-body-sm text-muted-foreground">Ù‚ÙØ±ÙØ¦Øª</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-warning number">${campaign.replied_count || 0}</div>
              <div class="text-body-sm text-muted-foreground">ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-purple-600 number">${campaign.clicked_count || 0}</div>
              <div class="text-body-sm text-muted-foreground">
                Ù†ÙÙ‚ÙØ± Ø¹Ù„ÙŠÙ‡Ø§
                <div class="text-body-xs text-muted-foreground mt-1">
                  (ÙÙ‚Ø· Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©)
                </div>
              </div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-destructive number">${campaign.failed_count}</div>
              <div class="text-body-sm text-muted-foreground">ÙØ´Ù„Øª</div>
            </div>
          </div>

          <!-- Failure Reasons Section -->
          ${campaign.failed_count > 0 ? `
            <div class="rounded-lg border border-destructive/30 bg-destructive/5" id="failure-reasons-section">
              <div class="border-b border-destructive/20 p-4">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <i data-lucide="alert-circle" class="h-5 w-5 text-destructive"></i>
                    <h3 class="text-heading-md font-semibold text-destructive">Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ÙØ´Ù„ (${campaign.failed_count})</h3>
                  </div>
                  <button onclick="loadFailureReasons(${campaign.id})" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-3 py-2 text-body-sm font-medium transition hover:bg-accent">
                    <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                    <span>ØªØ­Ø¯ÙŠØ«</span>
                  </button>
                </div>
              </div>
              <div id="failure-reasons-content" class="p-4">
                <div class="text-center text-body-sm text-muted-foreground">
                  <i data-lucide="loader-2" class="h-6 w-6 mx-auto mb-2 animate-spin"></i>
                  <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ÙØ´Ù„...</p>
                </div>
              </div>
            </div>
          ` : ''}

          <!-- Recipients Table -->
          <div class="rounded-lg border bg-card">
            <div class="border-b border-border p-4">
              <div class="flex items-center justify-between">
                <h3 class="text-heading-md font-semibold">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†</h3>
                <button onclick="fixCampaignStats(${campaign.id})" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-3 py-2 text-body-sm font-medium transition hover:bg-accent hover:text-accent-foreground">
                  <i data-lucide="calculator" class="h-4 w-4"></i>
                  <span>Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø¯Ù‚ÙŠÙ‚</span>
                </button>
              </div>
            </div>
            <div class="overflow-x-auto max-h-96">
              <table class="w-full caption-bottom text-sm">
                <thead class="bg-muted/50 sticky top-0">
                  <tr class="border-b text-right text-body-sm font-semibold text-muted-foreground">
                    <th class="px-4 py-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th class="px-4 py-3 text-center">Ø§Ù„Ø¯ÙØ¹Ø©</th>
                    <th class="px-4 py-3 text-center">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th class="px-4 py-3 text-center">Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</th>
                    <th class="px-4 py-3 text-center">Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
                    <th class="px-4 py-3 text-center">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th>
                    <th class="px-4 py-3 text-center">Ø§Ù„Ø±Ø¯</th>
                    <th class="px-4 py-3 text-center">Ø§Ù„Ù†Ù‚Ø±</th>
                    <th class="px-4 py-3 text-center">ØªÙØ§ØµÙŠÙ„</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  ${recipients.length > 0 ? recipients.map(recipient => `
                    <tr class="hover:bg-muted/40">
                      <td class="px-4 py-3">
                        <div class="space-y-1">
                          <div class="text-body-md font-medium">${recipient.customer_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                          <div class="text-body-sm text-muted-foreground number">${recipient.phone_number}</div>
                        </div>
                      </td>
                      <td class="px-4 py-3 text-center">
                        <span class="inline-flex items-center rounded-full border border-input px-2 py-1 text-xs font-medium bg-accent text-accent-foreground">
                          ${recipient.batch_number || 1}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-center">
                        <span class="inline-flex items-center rounded-full border border-input px-2 py-1 text-xs font-semibold ${getStatusBadgeClass(recipient.status)}">
                          ${getStatusText(recipient.status)}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.sent_at ? new Date(recipient.sent_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.delivered_at ? new Date(recipient.delivered_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.read_at ? new Date(recipient.read_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.replied_at ? new Date(recipient.replied_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.clicked_at ? new Date(recipient.clicked_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                      <td class="px-4 py-3 text-center">
                        ${recipient.message_id ? `
                          <button onclick="showMessageDetails('${recipient.message_id}')" class="inline-flex items-center gap-1 rounded-md border border-input bg-background px-2 py-1 text-xs font-medium transition hover:bg-accent hover:text-accent-foreground">
                            <i data-lucide="info" class="h-3 w-3"></i>
                            <span>ØªÙØ§ØµÙŠÙ„</span>
                          </button>
                        ` : '-'}
                      </td>
                    </tr>
                  `).join('') : `
                    <tr>
                      <td colspan="9" class="h-32 text-center text-body-sm text-muted-foreground">
                        <div class="space-y-3">
                          <i data-lucide="users-x" class="h-8 w-8 mx-auto"></i>
                          <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©</p>
                          <p class="text-body-xs">Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø­Ù…Ù„Ø© Ø£ÙÙ†Ø´Ø¦Øª Ø¨Ø¯ÙˆÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†</p>
                          <button onclick="addRecipientsToExistingCampaign(${campaign.id})" class="inline-flex items-center gap-2 rounded-md bg-primary px-3 py-2 text-body-sm font-medium text-primary-foreground transition hover:bg-primary/90">
                            <i data-lucide="user-plus" class="h-4 w-4"></i>
                            <span>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†</span>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      lucide.createIcons();
    }

    function hideCampaignDetailsModal() {
      document.getElementById('campaign-details-modal').classList.add('hidden');
      document.getElementById('campaign-details-modal').classList.remove('flex');
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©
    async function startCampaign(campaignId) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©ØŸ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙˆØ±Ø§Ù‹.')) {
        return;
      }

      try {
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}/start`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          }
        });

        const result = await response.json();
        
        if (result.success) {
          alert('ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!');
          refreshCampaigns();
        } else {
          alert('ÙØ´Ù„ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©: ' + (result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©:', error);
        alert('ØªØ¹Ø°Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.');
      }
    }

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ù…Ù„Ø©
    async function resendCampaign(campaignId) {
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©ØŸ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.')) {
        return;
      }

      try {
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}/resend`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          }
        });

        const result = await response.json();
        
        if (result.success) {
          alert('ØªÙ… Ø¨Ø¯Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!');
          refreshCampaigns();
        } else {
          alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + (result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', error);
        alert('ØªØ¹Ø°Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.');
      }
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† Ù„Ø­Ù…Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
    async function addRecipientsToExistingCampaign(campaignId) {
      const phoneNumber = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 966550002445):');
      
      if (!phoneNumber || !phoneNumber.trim()) {
        return;
      }

      const cleanPhone = phoneNumber.trim().replace(/[\s\-\+]/g, '');
      
      if (!/^966\d{9}$/.test(cleanPhone)) {
        alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 966 ÙˆÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 12 Ø±Ù‚Ù…Ø§Ù‹');
        return;
      }

      try {
        const campaignData = {
          recipients: [{
            customer_id: 0,
            phone_number: cleanPhone,
            customer_name: `Ø¹Ù…ÙŠÙ„ ${cleanPhone.slice(-4)}`
          }]
        };

        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}/recipients`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          },
          body: JSON.stringify(campaignData)
        });

        const result = await response.json();
        
        if (result.success) {
          alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ø¨Ù†Ø¬Ø§Ø­!');
          viewCampaignDetails(campaignId); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„
        } else {
          alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„: ' + (result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„:', error);
        alert('ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.');
      }
    }

    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ù…Ù„Ø© Ø¨Ø¯Ù‚Ø©
    async function fixCampaignStats(campaignId) {
      try {
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}/fix-stats`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø¯Ù‚Ø©!');
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø©
          viewCampaignDetails(campaignId);
        } else {
          alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ' + (result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
        alert('ØªØ¹Ø°Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
      }
    }

    // Ø­Ø°Ù Ø­Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø©
    async function deleteCampaign(campaignId, campaignName) {
      const confirmed = confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø­Ù…Ù„Ø© "${campaignName}"ØŸ\n\nâš ï¸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ù…Ù„Ø© ÙˆØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`);
      
      if (!confirmed) {
        return;
      }

      try {
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          }
        });

        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!');
          refreshCampaigns();
        } else {
          alert('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ù…Ù„Ø©: ' + (result.error || result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ù…Ù„Ø©:', error);
        alert('âŒ ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø­Ù…Ù„Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.');
      }
    }

    // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù…Ù„Ø§Øª
    async function deleteAllCampaigns() {
      // ØªØ£ÙƒÙŠØ¯ Ø£ÙˆÙ„ÙŠ
      if (!confirm('âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù…Ù„Ø§ØªØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡ ÙˆØ³ÙŠØ­Ø°Ù:\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù…Ù„Ø§Øª\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†\n- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª\n\nØ§ÙƒØªØ¨ "Ù†Ø¹Ù… Ø§Ø­Ø°Ù Ø§Ù„ÙƒÙ„" Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©')) {
        return;
      }

      // ØªØ£ÙƒÙŠØ¯ Ø«Ø§Ù†ÙŠ Ù…Ø¹ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±
      const confirmText = prompt('Ù„Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŒ Ø§ÙƒØªØ¨: DELETE_ALL_CAMPAIGNS');
      
      if (confirmText !== 'DELETE_ALL_CAMPAIGNS') {
        alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
        return;
      }

      try {
        const response = await fetch('https://tchat-production.up.railway.app/api/v1/campaigns/delete-all', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          },
          body: JSON.stringify({
            confirm_password: 'DELETE_ALL_CAMPAIGNS'
          })
        });

        const result = await response.json();
        
        if (result.success) {
          alert(`ØªÙ… Ø­Ø°Ù ${result.deleted_count} Ø­Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!`);
          refreshCampaigns();
        } else {
          alert('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ù…Ù„Ø§Øª: ' + (result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ù…Ù„Ø§Øª:', error);
        alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø­Ù…Ù„Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.');
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù…Ù„Ø§Øª
    async function updateAllCampaignStatuses() {
      try {
        const response = await fetch('https://tchat-production.up.railway.app/api/v1/campaigns/update-statuses', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          }
        });

        const result = await response.json();
        
        if (result.success) {
          alert(`ØªÙ… ÙØ­Øµ ÙˆØªØ­Ø¯ÙŠØ« ${result.updated_count} Ø­Ù…Ù„Ø©`);
          refreshCampaigns();
        } else {
          alert('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª: ' + (result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª:', error);
        alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.');
      }
    }

    async function refreshCampaigns() {
      await loadAndRenderCampaigns();
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙØ¹ÙŠÙ„/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ
    function handleSmartSendToggle() {
      const smartSendEnabled = document.getElementById('enable-smart-send').checked;
      const smartSendInfo = document.getElementById('smart-send-info');
      
      if (smartSendEnabled) {
        smartSendInfo.classList.remove('hidden');
      } else {
        smartSendInfo.classList.add('hidden');
        // Ø¥Ø®ÙØ§Ø¡ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¸Ø§Ù‡Ø±Ø©
        const resultsDiv = document.getElementById('smart-send-results');
        if (resultsDiv) {
          resultsDiv.classList.add('hidden');
        }
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±
        smartSendFilteredRecipients = null;
      }
    }

    // Ù…ØªØºÙŠØ± Ø¹Ø§Ù… Ù„ØªØ®Ø²ÙŠÙ† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø°ÙƒÙŠ
    let smartSendFilteredRecipients = null;

    // Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ
    async function runSmartSendCheck() {
      const checkBtn = document.getElementById('check-recipients-btn');
      const resultsDiv = document.getElementById('smart-send-results');
      
      // Ø¬Ù…Ø¹ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†
      let phoneNumbers = [];
      const source = document.getElementById('recipients-source').value;
      
      if (source === 'manual') {
        const manualText = document.getElementById('manual-recipients').value;
        const lines = manualText.split('\n').filter(line => line.trim());
        phoneNumbers = lines.map(line => {
          const parts = line.split(',');
          return parts[0].trim();
        }).filter(phone => phone);
      } else if (source === 'database') {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (window.parsedRecipients && window.parsedRecipients.length > 0) {
          phoneNumbers = window.parsedRecipients.map(r => r.phone_number);
        }
      }
      
      if (phoneNumbers.length === 0) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ù„Ù„ÙØ­Øµ. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }
      
      // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
      checkBtn.disabled = true;
      checkBtn.innerHTML = '<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</span>';
      lucide.createIcons();
      
      try {
        const response = await fetch('https://tchat-production.up.railway.app/api/v1/campaigns/smart-send-check', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          },
          body: JSON.stringify({
            phone_numbers: phoneNumbers
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Ø­ÙØ¸ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù…Ù„Ø©
          smartSendFilteredRecipients = result.allowed_numbers;
          
          // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          document.getElementById('smart-total').textContent = result.total;
          document.getElementById('smart-allowed').textContent = result.allowed;
          document.getElementById('smart-excluded').textContent = result.excluded;
          document.getElementById('smart-message').textContent = result.message;
          
          resultsDiv.classList.remove('hidden');
          
          // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
          updateRecipientsPreview();
          
        } else {
          alert('ÙØ´Ù„ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ:', error);
        alert('ØªØ¹Ø°Ø± ÙØ­Øµ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.');
      } finally {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        checkBtn.disabled = false;
        checkBtn.innerHTML = '<i data-lucide="scan-search" class="h-4 w-4"></i><span>ÙØ­Øµ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¢Ù†</span>';
        lucide.createIcons();
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø°ÙƒÙŠ
    function updateRecipientsPreview() {
      if (!smartSendFilteredRecipients || smartSendFilteredRecipients.length === 0) return;
      
      const source = document.getElementById('recipients-source').value;
      
      if (source === 'manual') {
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
        const originalText = document.getElementById('manual-recipients').value;
        const lines = originalText.split('\n').filter(line => line.trim());
        
        const filteredLines = lines.filter(line => {
          const phone = line.split(',')[0].trim();
          return smartSendFilteredRecipients.includes(phone);
        });
        
        // ØªØ­Ø¯ÙŠØ« textarea (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ÙŠÙ…ÙƒÙ† ØªØ¹Ø·ÙŠÙ„Ù‡ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©)
        // document.getElementById('manual-recipients').value = filteredLines.join('\n');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        document.getElementById('manual-count').textContent = smartSendFilteredRecipients.length;
      }
    }

    // Pagination functions
    function updatePaginationInfo(from, to, total, current, totalPages) {
      document.getElementById('showing-from').textContent = from;
      document.getElementById('showing-to').textContent = to;
      document.getElementById('total-campaigns').textContent = total;
      document.getElementById('current-page-num').textContent = current;
      document.getElementById('total-pages-num').textContent = totalPages;
      
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
      const firstBtn = document.getElementById('first-page-btn');
      const prevBtn = document.getElementById('prev-page-btn');
      const nextBtn = document.getElementById('next-page-btn');
      const lastBtn = document.getElementById('last-page-btn');
      
      firstBtn.disabled = current === 1;
      prevBtn.disabled = current === 1;
      nextBtn.disabled = current === totalPages;
      lastBtn.disabled = current === totalPages;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
      lucide.createIcons();
    }
    
    function goToFirstPage() {
      if (currentPage !== 1) {
        currentPage = 1;
        renderCampaigns();
      }
    }
    
    function goToPrevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderCampaigns();
      }
    }
    
    function goToNextPage() {
      const totalPages = Math.ceil(campaigns.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderCampaigns();
      }
    }
    
    function goToLastPage() {
      const totalPages = Math.ceil(campaigns.length / itemsPerPage);
      if (currentPage !== totalPages) {
        currentPage = totalPages;
        renderCampaigns();
      }
    }

    // Ø¯ÙˆØ§Ù„ API Ù„Ù„Ø­Ù…Ù„Ø§Øª
    async function loadCampaigns(limit = 50) {
      try {
        const data = await apiRequest(`/campaigns?limit=${limit}`);
        if (data.success && Array.isArray(data.data)) {
          return data.data;
        }
        console.error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø­Ù…Ù„Ø§Øª:', data);
        return [];
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„Ø§Øª:', error);
        return [];
      }
    }

    async function loadMetaTemplates(limit = 50) {
      try {
        const data = await apiRequest(`/meta/templates?limit=${limit}`);
        if (data.success && Array.isArray(data.data)) {
          return data.data;
        }
        console.error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨:', data);
        return [];
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨:', error);
        return [];
      }
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      loadAndRenderCampaigns();
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
      document.getElementById('batch-size').addEventListener('change', updateBatchPreview);
      document.getElementById('batch-interval').addEventListener('change', updateBatchPreview);
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø±ÙØ¹ Ù…Ù„Ù CSV
      document.getElementById('csv-file').addEventListener('change', handleCSVUpload);
      
      // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
      handleSmartSendToggle();
    });

    // Ø¯Ø§Ù„Ø© logout Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ api.js

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙØ­Øµ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ù…ÙŠØ²
    function isValidToken(token) {
      return token && 
             token !== 'null' && 
             token !== 'undefined' && 
             token.length > 10 &&
             token.includes('.');
    }

    // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (skipRefresh: ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù†Ø¯ 401 Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ)
    async function showMessageDetails(messageId, skipRefresh) {
      try {
        console.log('ğŸ” Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', messageId);
        
        // ÙØ­Øµ Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        if (!messageId || messageId === 'null' || messageId === 'undefined' || messageId === '') {
          console.error('âŒ Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± ØµØ§Ù„Ø­:', messageId);
          alert('Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± ØµØ§Ù„Ø­');
          return;
        }
        
        // ÙØ­Øµ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ù…ÙŠØ²
        const token = localStorage.getItem('access_token') || localStorage.getItem('tchat_token');
        const isLoggedIn = localStorage.getItem('tchat_logged_in');
        
        console.log('ğŸ” ÙØ­Øµ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ù…ÙŠØ²:', {
          token: token ? token.substring(0, 20) + '...' : 'null',
          isLoggedIn: isLoggedIn,
          tokenLength: token ? token.length : 0
        });
        
        if (!isLoggedIn || isLoggedIn === 'false') {
          console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡');
          alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
          window.location.href = './login.html';
          return;
        }
        
        if (!isValidToken(token)) {
          console.error('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù…Ø² Ù…Ù…ÙŠØ² ØµØ§Ù„Ø­');
          console.log('ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ†:', {
            access_token: localStorage.getItem('access_token'),
            tchat_token: localStorage.getItem('tchat_token'),
            isLoggedIn: localStorage.getItem('tchat_logged_in'),
            allKeys: Object.keys(localStorage)
          });
          
          // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
          const refreshToken = localStorage.getItem('tchat_refresh_token');
          if (refreshToken && refreshToken !== 'null') {
            try {
              const refreshResponse = await fetch('https://tchat-production.up.railway.app/api/v1/auth/refresh', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${refreshToken}`
                }
              });
              
              if (refreshResponse.ok) {
                const refreshData = await refreshResponse.json();
                if (refreshData.success && refreshData.token) {
                  localStorage.setItem('tchat_token', refreshData.token);
                  console.log('âœ… ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ù…ÙŠØ² Ø¨Ù†Ø¬Ø§Ø­');
                  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                  return showMessageDetails(messageId);
                }
              }
            } catch (error) {
              console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ù…ÙŠØ²:', error);
            }
          }
          
          alert('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
          localStorage.removeItem('tchat_token');
          localStorage.removeItem('tchat_logged_in');
          localStorage.removeItem('tchat_refresh_token');
          window.location.href = './login.html';
          return;
        }
        
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/messages/${messageId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:', errorText);
          
          // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø·Ø£ 401: Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø±Ù…Ø² Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù†ØªÙ‡ÙŠØ©
          if (response.status === 401) {
            if (!skipRefresh) {
              const refreshToken = localStorage.getItem('tchat_refresh_token');
              if (refreshToken && refreshToken !== 'null') {
                try {
                  const refreshResponse = await fetch('https://tchat-production.up.railway.app/api/v1/auth/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${refreshToken}` }
                  });
                  if (refreshResponse.ok) {
                    const refreshData = await refreshResponse.json();
                    if (refreshData.success && refreshData.token) {
                      localStorage.setItem('tchat_token', refreshData.token);
                      console.log('âœ… ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø±Ù…Ø² Ø¨Ø¹Ø¯ 401ØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
                      return showMessageDetails(messageId, true);
                    }
                  }
                } catch (e) {
                  console.error('âŒ ÙØ´Ù„ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø±Ù…Ø² Ø¨Ø¹Ø¯ 401:', e);
                }
              }
            }
            console.error('âŒ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ù…ÙŠØ²');
            alert('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
            localStorage.removeItem('tchat_token');
            localStorage.removeItem('tchat_logged_in');
            localStorage.removeItem('tchat_refresh_token');
            window.location.href = './login.html';
            return;
          }
          
          throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 100)}`);
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const responseText = await response.text();
          console.error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©:', responseText);
          throw new Error('Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„ÙŠØ³Øª JSON ØµØ§Ù„Ø­');
        }

        const result = await response.json();
        
        if (result.success && result.data) {
          displayMessageDetails(result.data);
        } else {
          console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', result);
          if (result.error === 'Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©') {
            alert('Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù‚Ø¯ ØªÙƒÙˆÙ† Ù‚Ø¯ÙŠÙ…Ø© Ø£Ùˆ Ù…Ø­Ø°ÙˆÙØ©.');
          } else {
            throw new Error(result.message || 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
          }
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
        alert('ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ' + error.message);
      }
    }

    // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©
    function displayMessageDetails(message) {
      const modal = document.getElementById('message-details-modal');
      const content = document.getElementById('message-details-content');
      
      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® (Ø£Ø±Ù‚Ø§Ù… ØºØ±Ø¨ÙŠØ© 1234567890)
      const createdAt = new Date(message.created_at).toLocaleString('ar-SA', { numberingSystem: 'latn' });
      const timestampReceived = message.timestamp_received ? 
        new Date(message.timestamp_received * 1000).toLocaleString('ar-SA', { numberingSystem: 'latn' }) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      
      // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ¯Ø±
      let sourceTypeText = '';
      let sourceIcon = '';
      switch(message.source_type) {
        case 'campaign':
          sourceTypeText = 'Ø­Ù…Ù„Ø© ØªØ³ÙˆÙŠÙ‚ÙŠØ©';
          sourceIcon = 'ğŸ“¢';
          break;
        case 'abandoned_cart':
          sourceTypeText = 'Ø³Ù„Ø© Ù…ØªØ±ÙˆÙƒØ©';
          sourceIcon = 'ğŸ›’';
          break;
        case 'manual':
          sourceTypeText = 'Ø±Ø³Ø§Ù„Ø© ÙŠØ¯ÙˆÙŠØ©';
          sourceIcon = 'ğŸ’¬';
          break;
        default:
          sourceTypeText = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          sourceIcon = 'ğŸ“¨';
      }

      // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      let statusText = '';
      let statusColor = '';
      switch(message.status) {
        case 'sent':
          statusText = 'Ù…Ø±Ø³Ù„Ø©';
          statusColor = 'text-blue-600';
          break;
        case 'delivered':
          statusText = 'Ù…Ø³Ù„Ù…Ø©';
          statusColor = 'text-green-600';
          break;
        case 'read':
          statusText = 'Ù…Ù‚Ø±ÙˆØ¡Ø©';
          statusColor = 'text-green-700';
          break;
        case 'failed':
          statusText = 'ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
          statusColor = 'text-red-600';
          break;
        default:
          statusText = message.status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          statusColor = 'text-gray-600';
      }

      content.innerHTML = `
        <div class="space-y-6">
          <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-body-sm text-muted-foreground">Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
              <p class="text-body-md font-mono break-all">${message.message_id || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            </div>
            <div>
              <label class="text-body-sm text-muted-foreground">Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</label>
              <p class="text-body-md">${message.conversation_id || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            </div>
            <div>
              <label class="text-body-sm text-muted-foreground">Ù…Ù†</label>
              <p class="text-body-md">${message.from_phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            </div>
            <div>
              <label class="text-body-sm text-muted-foreground">Ø¥Ù„Ù‰</label>
              <p class="text-body-md">${message.to_phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            </div>
          </div>

          <!-- Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ù„Ù…ØµØ¯Ø± -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-body-sm text-muted-foreground">Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
              <p class="text-body-md">${message.message_type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            </div>
            <div>
              <label class="text-body-sm text-muted-foreground">Ø§Ù„Ù…ØµØ¯Ø±</label>
              <p class="text-body-md">${sourceIcon} ${sourceTypeText}</p>
            </div>
            <div>
              <label class="text-body-sm text-muted-foreground">Ø§Ù„Ø§ØªØ¬Ø§Ù‡</label>
              <p class="text-body-md">${message.direction === 'incoming' ? 'ÙˆØ§Ø±Ø¯' : 'ØµØ§Ø¯Ø±'}</p>
            </div>
            <div>
              <label class="text-body-sm text-muted-foreground">Ø§Ù„Ø­Ø§Ù„Ø©</label>
              <p class="text-body-md ${statusColor} font-medium">${statusText}</p>
            </div>
          </div>

          <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
          <div>
            <label class="text-body-sm text-muted-foreground">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
            <div class="mt-2 p-4 bg-muted rounded-lg">
              <p class="text-body-md">${message.content || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰'}</p>
            </div>
          </div>

          <!-- Ø§Ù„ÙˆØ³Ø§Ø¦Ø· -->
          ${message.media_id || message.media_url ? `
          <div>
            <label class="text-body-sm text-muted-foreground">Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</label>
            <div class="mt-2 space-y-2">
              ${message.media_id ? `<p class="text-body-sm">Ù…Ø¹Ø±Ù Ø§Ù„ÙˆØ³Ø§Ø¦Ø·: <code class="bg-muted px-2 py-1 rounded">${message.media_id}</code></p>` : ''}
              ${message.media_url ? `<p class="text-body-sm">Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ³Ø§Ø¦Ø·: <a href="${message.media_url}" target="_blank" class="text-primary hover:underline">Ø¹Ø±Ø¶</a></p>` : ''}
            </div>
          </div>
          ` : ''}

          <!-- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-body-sm text-muted-foreground">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</label>
              <p class="text-body-md">${createdAt}</p>
            </div>
            <div>
              <label class="text-body-sm text-muted-foreground">Ø·Ø§Ø¨Ø¹ Ø²Ù…Ù†ÙŠ Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ</label>
              <p class="text-body-md">${timestampReceived}</p>
            </div>
          </div>

          <!-- Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØµØ¯Ø± -->
          ${message.source_id ? `
          <div>
            <label class="text-body-sm text-muted-foreground">Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØµØ¯Ø±</label>
            <p class="text-body-md">${message.source_id}</p>
          </div>
          ` : ''}

          <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ -->
          ${message.webhook_data && Object.keys(message.webhook_data).length > 0 ? `
          <div>
            <label class="text-body-sm text-muted-foreground">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ</label>
            <div class="mt-2 p-4 bg-muted rounded-lg overflow-auto max-h-40">
              <pre class="text-body-xs font-mono">${JSON.stringify(message.webhook_data, null, 2)}</pre>
            </div>
          </div>
          ` : ''}
        </div>
      `;

      modal.classList.remove('hidden');
      
      // Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†Ø§ÙØ°Ø© ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©
      modal.style.zIndex = '9999';
      modal.style.position = 'fixed';
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
      setTimeout(() => {
        lucide.createIcons();
      }, 50);
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    function closeMessageDetails() {
      document.getElementById('message-details-modal').classList.add('hidden');
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.getElementById('message-details-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeMessageDetails();
      }
    });

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('message-details-modal');
        if (modal && !modal.classList.contains('hidden')) {
          closeMessageDetails();
        }
      }
    });
  </script>
</body>
</html>
