<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TCHAT - الحملات التسويقية</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="./api.js"></script>
</head>
<body class="rtl min-h-screen bg-background" style="font-family: 'LamaSans', sans-serif;">
  
  <!-- Header -->
  <header class="border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
    <div class="container mx-auto flex h-16 items-center justify-between px-4">
      <div class="flex items-center gap-2">
        <a href="./dashboard.html" class="inline-flex items-center gap-2 text-body-sm font-medium text-muted-foreground transition hover:text-foreground">
          <i data-lucide="arrow-right" class="h-4 w-4"></i>
          <span>العودة إلى اللوحة</span>
        </a>
      </div>
      <span class="text-heading-md font-bold">الحملات التسويقية</span>
      <button onclick="logout()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
        <i data-lucide="log-out" class="ml-2 h-4 w-4"></i>
        <span class="text-body-md">تسجيل الخروج</span>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    
    <!-- Page Header -->
    <section class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-heading-lg font-bold text-foreground">إدارة الحملات التسويقية</h1>
        <p class="text-body-sm text-muted-foreground">إنشاء وإدارة حملات واتساب للعملاء</p>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="deleteAllCampaigns()" class="inline-flex items-center gap-2 rounded-md border border-destructive bg-destructive/10 px-4 py-2 text-button-md font-medium text-destructive shadow-sm transition hover:bg-destructive/20">
          <i data-lucide="trash-2" class="h-4 w-4"></i>
          <span>حذف الكل</span>
        </button>
        <button onclick="showCreateCampaignModal()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
          <i data-lucide="plus" class="h-4 w-4"></i>
          <span>حملة جديدة</span>
        </button>
      </div>
    </section>

    <!-- Campaigns List -->
    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
      <div class="border-b border-border p-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="megaphone" class="h-5 w-5 text-muted-foreground"></i>
            <h2 class="text-heading-md font-semibold">الحملات الحالية</h2>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="updateAllCampaignStatuses()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-3 py-2 text-body-sm font-medium text-muted-foreground transition hover:bg-accent hover:text-accent-foreground">
              <i data-lucide="zap" class="h-4 w-4"></i>
              <span>تحديث الحالات</span>
            </button>
            <button onclick="refreshCampaigns()" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
              <i data-lucide="refresh-cw" class="h-4 w-4"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full caption-bottom text-sm">
          <thead class="bg-muted/50">
            <tr class="border-b text-right text-body-sm font-semibold text-muted-foreground">
              <th class="px-4 py-3 w-[25%]">الحملة</th>
              <th class="px-4 py-3 w-[15%] text-center">القالب</th>
              <th class="px-4 py-3 w-[10%] text-center">الحالة</th>
              <th class="px-4 py-3 w-[10%] text-center">المستقبلين</th>
              <th class="px-4 py-3 w-[15%] text-center">التقدم</th>
              <th class="px-4 py-3 w-[15%] text-center">الإعدادات</th>
              <th class="px-4 py-3 w-[10%] text-center">الإجراءات</th>
            </tr>
          </thead>
          <tbody id="campaigns-table-body" class="divide-y divide-border">
            <tr>
              <td colspan="7" class="h-24 text-center text-body-sm text-muted-foreground">جاري تحميل الحملات...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <!-- Create Campaign Modal -->
  <div id="create-campaign-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div>
            <h2 class="text-heading-lg font-bold">إنشاء حملة تسويقية جديدة</h2>
            <p class="text-body-sm text-muted-foreground mt-1">قم بإعداد الحملة واختيار المستقبلين</p>
          </div>
          <button onclick="hideCreateCampaignModal()" class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="x" class="h-4 w-4"></i>
          </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6 space-y-6">
          
          <!-- Step 1: Campaign Info -->
          <div class="space-y-4">
            <h3 class="text-heading-md font-semibold flex items-center gap-2">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground text-xs font-bold">1</span>
              معلومات الحملة
            </h3>
            
            <div class="grid gap-4 md:grid-cols-2">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">اسم الحملة</label>
                <input type="text" id="campaign-name" placeholder="أدخل اسم الحملة" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" />
              </div>
              <div class="space-y-2">
                <label class="text-body-sm font-medium">القالب</label>
                <select id="campaign-template" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="">اختر القالب</option>
                </select>
              </div>
            </div>
            
            <div class="space-y-2">
              <label class="text-body-sm font-medium">وصف الحملة</label>
              <textarea id="campaign-description" placeholder="وصف مختصر للحملة" rows="3" class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"></textarea>
            </div>
          </div>

          <!-- Step 2: Recipients -->
          <div class="space-y-4">
            <h3 class="text-heading-md font-semibold flex items-center gap-2">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground text-xs font-bold">2</span>
              المستقبلين
            </h3>
            
            <div class="grid gap-4 md:grid-cols-2">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">مصدر البيانات</label>
                <select id="recipients-source" onchange="handleRecipientsSourceChange()" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="database">العملاء المسجلين</option>
                  <option value="manual">إدخال يدوي</option>
                  <option value="csv">رفع ملف CSV</option>
                </select>
              </div>
              <div class="space-y-2" id="csv-upload-section" style="display: none;">
                <label class="text-body-sm font-medium">ملف CSV</label>
                <input type="file" id="csv-file" accept=".csv" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" />
              </div>
            </div>

            <!-- Manual Input Section -->
            <div id="manual-input-section" class="space-y-4" style="display: none;">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">أرقام الهواتف والأسماء</label>
                <textarea 
                  id="manual-recipients" 
                  placeholder="أدخل الأرقام والأسماء بالتنسيق التالي:&#10;966501234567,أحمد محمد&#10;966509876543,فاطمة علي&#10;966555555555,خالد السعيد&#10;&#10;أو أرقام فقط (سطر واحد لكل رقم):&#10;966501234567&#10;966509876543"
                  rows="8" 
                  class="flex min-h-[160px] w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring font-mono"
                  oninput="parseManualRecipients()"
                ></textarea>
              </div>
              <div class="flex items-center gap-4 text-body-sm text-muted-foreground">
                <div class="flex items-center gap-2">
                  <i data-lucide="info" class="h-4 w-4"></i>
                  <span>التنسيق: رقم الهاتف,الاسم (اختياري)</span>
                </div>
                <div class="flex items-center gap-2">
                  <span>عدد الأرقام المدخلة:</span>
                  <span id="manual-count" class="font-semibold number">0</span>
                </div>
              </div>
            </div>

            <div id="recipients-preview" class="rounded-lg border border-border bg-muted/20 p-4">
              <div class="text-center text-body-sm text-muted-foreground">
                <i data-lucide="users" class="h-8 w-8 mx-auto mb-2"></i>
                <p>سيتم عرض المستقبلين هنا</p>
              </div>
            </div>
          </div>

          <!-- Step 3: Batch Settings -->
          <div class="space-y-4">
            <h3 class="text-heading-md font-semibold flex items-center gap-2">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground text-xs font-bold">3</span>
              إعدادات الإرسال
            </h3>
            
            <div class="grid gap-4 md:grid-cols-3">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">حجم الدفعة</label>
                <select id="batch-size" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="50">50 عميل</option>
                  <option value="100" selected>100 عميل</option>
                  <option value="200">200 عميل</option>
                  <option value="300">300 عميل</option>
                  <option value="500">500 عميل</option>
                </select>
              </div>
              <div class="space-y-2">
                <label class="text-body-sm font-medium">الفترة بين الدفعات</label>
                <select id="batch-interval" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="1" selected>ساعة واحدة</option>
                  <option value="2">ساعتان</option>
                  <option value="3">3 ساعات</option>
                  <option value="6">6 ساعات</option>
                  <option value="12">12 ساعة</option>
                  <option value="24">24 ساعة</option>
                </select>
              </div>
              <div class="space-y-2">
                <label class="text-body-sm font-medium">نوع الإرسال</label>
                <select id="send-type" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="batch" selected>مجزأ (موصى به)</option>
                  <option value="all">الكل دفعة واحدة</option>
                </select>
              </div>
            </div>

            <!-- Smart Send Checkbox -->
            <div class="rounded-lg border border-border bg-card p-4">
              <label class="flex items-start gap-3 cursor-pointer">
                <input type="checkbox" id="enable-smart-send" onchange="handleSmartSendToggle()" class="mt-1 h-4 w-4 rounded border-gray-300 text-primary focus:ring-2 focus:ring-primary focus:ring-offset-2" checked />
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <i data-lucide="zap" class="h-4 w-4 text-primary"></i>
                    <span class="text-body-md font-semibold">تفعيل الإرسال الذكي</span>
                    <span class="inline-flex items-center rounded-md bg-primary/10 px-2 py-1 text-xs font-medium text-primary">موصى به</span>
                  </div>
                  <p class="text-body-sm text-muted-foreground mt-1">
                    استبعاد الأرقام التي تم الإرسال لها خلال آخر <span class="font-semibold text-foreground">10 أيام</span> لتجنب الإزعاج وتحسين معدل التفاعل
                  </p>
                </div>
              </label>
            </div>

            <!-- Smart Send Info -->
            <div id="smart-send-info" class="rounded-lg border border-primary bg-primary/5 p-4">
              <div class="flex items-start gap-3">
                <i data-lucide="zap" class="h-5 w-5 text-primary mt-0.5"></i>
                <div class="flex-1">
                  <h4 class="text-body-md font-semibold text-primary mb-1">الإرسال الذكي ✨</h4>
                  <p class="text-body-sm text-muted-foreground mb-3">
                    سيتم فحص الأرقام المدخلة واستبعاد من تم الإرسال لهم خلال آخر <span class="font-semibold text-foreground">10 أيام</span> لتجنب الإزعاج وتحسين معدل التفاعل.
                  </p>
                  <button onclick="runSmartSendCheck()" id="check-recipients-btn" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-sm font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90 disabled:opacity-50">
                    <i data-lucide="scan-search" class="h-4 w-4"></i>
                    <span>فحص الأرقام الآن</span>
                  </button>
                </div>
              </div>
              
              <!-- Smart Send Results -->
              <div id="smart-send-results" class="mt-4 hidden">
                <div class="grid gap-3 md:grid-cols-3">
                  <div class="rounded-lg border border-border bg-card p-3">
                    <div class="text-body-xs text-muted-foreground mb-1">إجمالي الأرقام</div>
                    <div class="text-heading-sm font-bold" id="smart-total">0</div>
                  </div>
                  <div class="rounded-lg border border-green-500 bg-green-500/10 p-3">
                    <div class="text-body-xs text-green-700 dark:text-green-400 mb-1">✅ مسموح بالإرسال</div>
                    <div class="text-heading-sm font-bold text-green-600 dark:text-green-400" id="smart-allowed">0</div>
                  </div>
                  <div class="rounded-lg border border-orange-500 bg-orange-500/10 p-3">
                    <div class="text-body-xs text-orange-700 dark:text-orange-400 mb-1">⚠️ مستبعد</div>
                    <div class="text-heading-sm font-bold text-orange-600 dark:text-orange-400" id="smart-excluded">0</div>
                  </div>
                </div>
                <div class="mt-3 text-body-xs text-muted-foreground">
                  <i data-lucide="info" class="h-3 w-3 inline"></i>
                  <span id="smart-message">تم الفحص بنجاح</span>
                </div>
              </div>
            </div>

            <div id="batch-preview" class="rounded-lg border border-border bg-accent/20 p-4">
              <h4 class="text-body-md font-semibold mb-2">معاينة الإرسال</h4>
              <div id="batch-preview-content" class="text-body-sm text-muted-foreground">
                سيتم عرض تفاصيل التجزئة هنا
              </div>
            </div>
          </div>

        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-between border-t border-border p-6">
          <button onclick="hideCreateCampaignModal()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-body-sm font-medium transition hover:bg-accent hover:text-accent-foreground">
            <span>إلغاء</span>
          </button>
          <div class="flex items-center gap-3">
            <button onclick="previewCampaign()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-body-sm font-medium transition hover:bg-accent hover:text-accent-foreground">
              <i data-lucide="eye" class="h-4 w-4"></i>
              <span>معاينة</span>
            </button>
            <button onclick="createCampaign()" id="create-campaign-btn" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90 disabled:opacity-50">
              <i data-lucide="send" class="h-4 w-4"></i>
              <span>إنشاء الحملة</span>
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Campaign Details Modal -->
  <div id="campaign-details-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-6xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div>
            <h2 id="details-campaign-name" class="text-heading-lg font-bold">تفاصيل الحملة</h2>
            <p class="text-body-sm text-muted-foreground mt-1">إحصائيات ومتابعة الحملة</p>
          </div>
          <button onclick="hideCampaignDetailsModal()" class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="x" class="h-4 w-4"></i>
          </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6" id="campaign-details-content">
          <div class="text-center text-body-sm text-muted-foreground">جاري تحميل تفاصيل الحملة...</div>
        </div>

      </div>
    </div>
  </div>

  <script>
    if (!localStorage.getItem('tchat_logged_in')) {
      window.location.href = './login.html';
    }

    let campaigns = [];
    let selectedRecipients = [];
    let availableTemplates = [];

    // تحميل الحملات
    async function loadAndRenderCampaigns() {
      const tbody = document.getElementById('campaigns-table-body');
      tbody.innerHTML = '<tr><td colspan="7" class="h-24 text-center text-body-sm text-muted-foreground">جاري تحميل الحملات...</td></tr>';

      try {
        campaigns = await loadCampaigns();
        renderCampaigns();
      } catch (error) {
        console.error('خطأ في تحميل الحملات:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="h-24 text-center text-destructive text-body-sm">تعذر تحميل الحملات</td></tr>';
      }
    }

    function renderCampaigns() {
      const tbody = document.getElementById('campaigns-table-body');
      
      if (!campaigns.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="h-24 text-center text-body-sm text-muted-foreground">لا توجد حملات حالياً</td></tr>';
        return;
      }

      tbody.innerHTML = campaigns.map(campaign => {
        const statusClass = getStatusBadgeClass(campaign.status);
        const statusText = getStatusText(campaign.status);
        const progressPercent = campaign.total_recipients > 0 
          ? Math.round((campaign.sent_count / campaign.total_recipients) * 100) 
          : 0;

        return `
          <tr class="hover:bg-muted/40 transition-colors">
            <td class="px-4 py-4">
              <div class="space-y-1">
                <div class="text-body-md font-semibold">${campaign.name}</div>
                <div class="text-body-sm text-muted-foreground">${campaign.description || 'بدون وصف'}</div>
                <div class="text-body-xs text-muted-foreground">تم الإنشاء: <span class="number">${new Date(campaign.created_at).toLocaleDateString('en-GB')}</span></div>
              </div>
            </td>
            <td class="px-4 py-4 text-center">
              <span class="inline-flex items-center rounded-full border border-input px-3 py-1 text-xs font-semibold bg-accent text-accent-foreground">
                ${campaign.template_name}
              </span>
            </td>
            <td class="px-4 py-4 text-center">
              <span class="inline-flex items-center rounded-full border border-input px-3 py-1 text-xs font-semibold ${statusClass}">
                ${statusText}
              </span>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="text-body-md font-medium number">${campaign.total_recipients}</div>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="space-y-1">
                <div class="text-body-sm">
                  <span class="number">${campaign.sent_count}</span> / <span class="number">${campaign.total_recipients}</span>
                </div>
                <div class="w-full bg-muted rounded-full h-2">
                  <div class="bg-primary h-2 rounded-full transition-all" style="width: ${progressPercent}%"></div>
                </div>
                <div class="text-body-xs text-muted-foreground number">${progressPercent}%</div>
              </div>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="text-body-sm text-muted-foreground">
                <div class="number">${campaign.batch_size}</div>
                <div>كل <span class="number">${campaign.batch_interval_hours}</span> ساعة</div>
              </div>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="flex items-center justify-center gap-1">
                <button onclick="viewCampaignDetails(${campaign.id})" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground" title="عرض التفاصيل">
                  <i data-lucide="eye" class="h-3 w-3"></i>
                </button>
                ${campaign.status === 'draft' ? `
                  <button onclick="startCampaign(${campaign.id})" class="inline-flex h-8 w-8 items-center justify-center rounded-md bg-primary text-primary-foreground transition hover:bg-primary/90" title="بدء الحملة">
                    <i data-lucide="play" class="h-3 w-3"></i>
                  </button>
                ` : ''}
                ${campaign.status === 'running' || campaign.status === 'completed' ? `
                  <button onclick="resendCampaign(${campaign.id})" class="inline-flex h-8 w-8 items-center justify-center rounded-md bg-warning text-warning-foreground transition hover:bg-warning/90" title="إعادة الإرسال">
                    <i data-lucide="repeat" class="h-3 w-3"></i>
                  </button>
                ` : ''}
                <button onclick="deleteCampaign(${campaign.id}, '${campaign.name}')" class="inline-flex h-8 w-8 items-center justify-center rounded-md bg-destructive text-destructive-foreground transition hover:bg-destructive/90" title="حذف الحملة">
                  <i data-lucide="trash-2" class="h-3 w-3"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      lucide.createIcons();
    }

    function getStatusBadgeClass(status) {
      const classes = {
        'draft': 'bg-muted text-muted-foreground',
        'scheduled': 'bg-warning/10 text-warning',
        'running': 'bg-primary/10 text-primary',
        'completed': 'bg-success/10 text-success',
        'paused': 'bg-warning/10 text-warning',
        'cancelled': 'bg-destructive/10 text-destructive'
      };
      return classes[status] || 'bg-muted text-muted-foreground';
    }

    function getStatusText(status) {
      const texts = {
        'draft': 'مسودة',
        'scheduled': 'مجدولة',
        'running': 'قيد التشغيل',
        'completed': 'مكتملة',
        'paused': 'متوقفة',
        'cancelled': 'ملغية',
        'pending': 'في الانتظار',
        'sent': 'أُرسِلت',
        'delivered': 'وصلت',
        'read': 'قُرِئت',
        'replied': 'تم الرد عليها',
        'clicked': 'نُقِر عليها',
        'failed': 'فشلت'
      };
      return texts[status] || status;
    }

    // عرض/إخفاء نافذة إنشاء الحملة
    function showCreateCampaignModal() {
      document.getElementById('create-campaign-modal').classList.remove('hidden');
      document.getElementById('create-campaign-modal').classList.add('flex');
      loadTemplatesForCampaign();
      loadRecipientsPreview();
    }

    function hideCreateCampaignModal() {
      document.getElementById('create-campaign-modal').classList.add('hidden');
      document.getElementById('create-campaign-modal').classList.remove('flex');
      resetCampaignForm();
    }

    function resetCampaignForm() {
      document.getElementById('campaign-name').value = '';
      document.getElementById('campaign-description').value = '';
      document.getElementById('campaign-template').value = '';
      document.getElementById('recipients-source').value = 'database';
      document.getElementById('csv-file').value = '';
      selectedRecipients = [];
      handleRecipientsSourceChange();
    }

    // تحميل القوالب للحملة
    async function loadTemplatesForCampaign() {
      try {
        availableTemplates = await loadMetaTemplates(100);
        const templateSelect = document.getElementById('campaign-template');
        
        templateSelect.innerHTML = '<option value="">اختر القالب</option>' +
          availableTemplates
            .filter(template => template.status === 'APPROVED')
            .map(template => `<option value="${template.name}">${template.name}</option>`)
            .join('');
      } catch (error) {
        console.error('خطأ في تحميل القوالب:', error);
      }
    }

    // معالجة تغيير مصدر المستقبلين
    function handleRecipientsSourceChange() {
      const source = document.getElementById('recipients-source').value;
      const csvSection = document.getElementById('csv-upload-section');
      const manualSection = document.getElementById('manual-input-section');
      
      // إخفاء جميع الأقسام أولاً
      csvSection.style.display = 'none';
      manualSection.style.display = 'none';
      
      if (source === 'csv') {
        csvSection.style.display = 'block';
      } else if (source === 'manual') {
        manualSection.style.display = 'block';
        parseManualRecipients(); // تحديث العداد
      } else {
        loadRecipientsPreview();
      }
    }

    // تحليل المستقبلين من الإدخال اليدوي
    function parseManualRecipients() {
      const manualText = document.getElementById('manual-recipients').value.trim();
      const countEl = document.getElementById('manual-count');
      
      if (!manualText) {
        selectedRecipients = [];
        countEl.textContent = '0';
        updateRecipientsPreview();
        return;
      }

      const lines = manualText.split('\n').filter(line => line.trim());
      selectedRecipients = [];

      lines.forEach((line, index) => {
        const trimmedLine = line.trim();
        if (!trimmedLine) return;

        // تنظيف الرقم من المسافات والرموز
        const cleanLine = trimmedLine.replace(/[\s\-\+]/g, '');
        
        if (cleanLine.includes(',')) {
          // تنسيق: رقم,اسم
          const [phone, name] = cleanLine.split(',').map(part => part.trim());
          if (phone && /^966\d{9}$/.test(phone)) {
            selectedRecipients.push({
              customer_id: 0,
              phone_number: phone,
              customer_name: name || `عميل ${phone.slice(-4)}`
            });
          }
        } else {
          // رقم فقط
          if (/^966\d{9}$/.test(cleanLine)) {
            selectedRecipients.push({
              customer_id: 0,
              phone_number: cleanLine,
              customer_name: `عميل ${cleanLine.slice(-4)}`
            });
          }
        }
      });

      countEl.textContent = selectedRecipients.length;
      updateRecipientsPreview();
      updateBatchPreview();
    }

    // معالجة رفع ملف CSV
    function handleCSVUpload(event) {
      const file = event.target.files[0];
      
      if (!file) {
        selectedRecipients = [];
        updateRecipientsPreview();
        updateBatchPreview();
        return;
      }

      if (!file.name.endsWith('.csv')) {
        alert('يرجى رفع ملف CSV فقط');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.split('\n').filter(line => line.trim());
          selectedRecipients = [];

          // تخطي السطر الأول إذا كان يحتوي على رؤوس الأعمدة
          const startIndex = lines[0].toLowerCase().includes('phone') || lines[0].toLowerCase().includes('name') || lines[0].toLowerCase().includes('رقم') || lines[0].toLowerCase().includes('اسم') ? 1 : 0;

          for (let i = startIndex; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            // دعم الفواصل المختلفة (comma, semicolon, tab)
            const separator = line.includes(';') ? ';' : line.includes('\t') ? '\t' : ',';
            const parts = line.split(separator).map(part => part.trim().replace(/^["']+|["']+$/g, '')); // إزالة علامات الاقتباس فقط من البداية والنهاية

            if (parts.length === 0) continue;

            let phone = '';
            let name = '';

            if (parts.length === 1) {
              // رقم فقط - تنظيف الرقم من المسافات والرموز
              phone = parts[0].replace(/[\s\-\+]/g, '');
            } else if (parts.length >= 2) {
              // رقم واسم (يمكن أن يكون الرقم في العمود الأول أو الثاني)
              const cleanPart0 = parts[0].replace(/[\s\-\+]/g, '');
              const cleanPart1 = parts[1].replace(/[\s\-\+]/g, '');
              
              if (/^966\d{9}$/.test(cleanPart0)) {
                // العمود الأول رقم صحيح
                phone = cleanPart0;
                name = parts[1]; // الاحتفاظ بالمسافات في الاسم
              } else if (/^966\d{9}$/.test(cleanPart1)) {
                // العمود الثاني رقم صحيح
                name = parts[0]; // الاحتفاظ بالمسافات في الاسم
                phone = cleanPart1;
              } else {
                // محاولة تنظيف الرقم
                phone = cleanPart0.replace(/^0+/, ''); // إزالة الأصفار من البداية
                if (!phone.startsWith('966')) {
                  phone = '966' + phone;
                }
                name = parts[1]; // الاحتفاظ بالمسافات في الاسم
              }
            }

            // تنظيف الرقم النهائي (إزالة كل شيء ما عدا الأرقام)
            phone = phone.replace(/[^\d]/g, '');
            
            // محاولة تصحيح الأرقام التي تبدأ بـ 05
            if (phone.startsWith('05') && phone.length === 10) {
              phone = '966' + phone.substring(1);
            } else if (phone.startsWith('5') && phone.length === 9) {
              phone = '966' + phone;
            }

            // تنظيف الاسم (إزالة المسافات الزائدة فقط)
            name = name.trim().replace(/\s+/g, ' ');

            // التحقق من صحة الرقم
            if (/^966\d{9}$/.test(phone)) {
              selectedRecipients.push({
                customer_id: 0,
                phone_number: phone,
                customer_name: name || `عميل ${phone.slice(-4)}`
              });
            }
          }

          if (selectedRecipients.length === 0) {
            alert('لم يتم العثور على أرقام صحيحة في الملف.\n\nالتنسيق المطلوب:\n- رقم الهاتف يجب أن يبدأ بـ 966 أو 05\n- مثال: 966501234567 أو 0501234567\n- يمكن إضافة الاسم في العمود الثاني');
          } else {
            updateRecipientsPreview();
            updateBatchPreview();
          }
        } catch (error) {
          console.error('خطأ في قراءة ملف CSV:', error);
          alert('حدث خطأ في قراءة الملف. تأكد من أن الملف بصيغة CSV صحيحة.');
        }
      };

      reader.onerror = function() {
        alert('فشل في قراءة الملف');
      };

      reader.readAsText(file, 'UTF-8');
    }

    // تحديث معاينة المستقبلين
    function updateRecipientsPreview() {
      const previewEl = document.getElementById('recipients-preview');
      
      if (selectedRecipients.length === 0) {
        previewEl.innerHTML = `
          <div class="text-center text-body-sm text-muted-foreground">
            <i data-lucide="users" class="h-8 w-8 mx-auto mb-2"></i>
            <p>لا توجد أرقام صحيحة</p>
          </div>
        `;
        return;
      }

      previewEl.innerHTML = `
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <h4 class="text-body-md font-semibold">المستقبلين المحددين</h4>
            <span class="text-body-sm text-muted-foreground">${selectedRecipients.length} مستقبل</span>
          </div>
          <div class="grid gap-2 max-h-32 overflow-y-auto">
            ${selectedRecipients.slice(0, 5).map(r => `
              <div class="flex items-center justify-between text-body-sm">
                <span>${r.customer_name}</span>
                <span class="number">${r.phone_number}</span>
              </div>
            `).join('')}
            ${selectedRecipients.length > 5 ? `<div class="text-center text-body-xs text-muted-foreground">و ${selectedRecipients.length - 5} مستقبل آخر...</div>` : ''}
          </div>
        </div>
      `;
    }

    // معاينة المستقبلين من قاعدة البيانات
    async function loadRecipientsPreview() {
      const previewEl = document.getElementById('recipients-preview');
      const source = document.getElementById('recipients-source').value;
      
      if (source === 'database') {
        try {
          const customers = await loadCustomers(200);
          selectedRecipients = customers.map(customer => ({
            customer_id: customer.id,
            phone_number: customer.mobile || customer.phone,
            customer_name: customer.name
          })).filter(r => r.phone_number);

          updateRecipientsPreview();
        } catch (error) {
          previewEl.innerHTML = '<div class="text-center text-destructive text-body-sm">تعذر تحميل العملاء</div>';
        }
      } else {
        previewEl.innerHTML = `
          <div class="text-center text-body-sm text-muted-foreground">
            <i data-lucide="users" class="h-8 w-8 mx-auto mb-2"></i>
            <p>سيتم عرض المستقبلين هنا</p>
          </div>
        `;
      }
      
      updateBatchPreview();
    }

    // تحديث معاينة التجزئة
    function updateBatchPreview() {
      const previewContent = document.getElementById('batch-preview-content');
      const sendType = document.getElementById('send-type').value;
      const batchSize = parseInt(document.getElementById('batch-size').value);
      const batchInterval = parseInt(document.getElementById('batch-interval').value);
      
      if (sendType === 'all') {
        previewContent.innerHTML = `
          <div class="text-warning">
            <i data-lucide="alert-triangle" class="inline h-4 w-4 ml-1"></i>
            سيتم إرسال الرسائل لجميع المستقبلين (${selectedRecipients.length}) دفعة واحدة
          </div>
        `;
        return;
      }

      const totalRecipients = selectedRecipients.length;
      const batchCount = Math.ceil(totalRecipients / batchSize);
      const totalDuration = (batchCount - 1) * batchInterval;

      previewContent.innerHTML = `
          <div class="space-y-2 text-body-sm">
            <div class="flex justify-between">
              <span>عدد الدفعات:</span>
              <span class="number">${batchCount}</span>
            </div>
            <div class="flex justify-between">
              <span>حجم كل دفعة:</span>
              <span class="number">${batchSize}</span> عميل
            </div>
            <div class="flex justify-between">
              <span>الفترة بين الدفعات:</span>
              <span class="number">${batchInterval}</span> ساعة
            </div>
            <div class="flex justify-between">
              <span>المدة الإجمالية:</span>
              <span class="number">${totalDuration}</span> ساعة
            </div>
          </div>
      `;
    }

    // معالجة تغيير نوع الإرسال
    function handleSendTypeChange() {
      updateBatchPreview();
    }

    // إنشاء الحملة
    async function createCampaign() {
      const name = document.getElementById('campaign-name').value.trim();
      const description = document.getElementById('campaign-description').value.trim();
      const templateName = document.getElementById('campaign-template').value;
      const batchSize = parseInt(document.getElementById('batch-size').value);
      const batchInterval = parseInt(document.getElementById('batch-interval').value);
      const sendType = document.getElementById('send-type').value;

      // التحقق من البيانات
      if (!name || !templateName || selectedRecipients.length === 0) {
        alert('يرجى ملء جميع الحقول المطلوبة واختيار المستقبلين');
        return;
      }

      const createBtn = document.getElementById('create-campaign-btn');
      createBtn.disabled = true;
      createBtn.innerHTML = '<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i><span>جاري الإنشاء...</span>';

      try {
        const campaignData = {
          name: name,
          description: description,
          template_name: templateName,
          template_language: 'ar',
          batch_size: sendType === 'all' ? selectedRecipients.length : batchSize,
          batch_interval_hours: sendType === 'all' ? 0 : batchInterval,
          recipients: selectedRecipients
        };

        const response = await fetch('https://tchat-production.up.railway.app/api/v1/campaigns', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('tchat_token')}`
          },
          body: JSON.stringify(campaignData)
        });

        const result = await response.json();
        
        if (result.success) {
          alert('تم إنشاء الحملة بنجاح!');
          hideCreateCampaignModal();
          refreshCampaigns();
        } else {
          alert('فشل في إنشاء الحملة: ' + (result.message || 'خطأ غير معروف'));
        }
      } catch (error) {
        console.error('خطأ في إنشاء الحملة:', error);
        alert('تعذر إنشاء الحملة. تحقق من الاتصال.');
      } finally {
        createBtn.disabled = false;
        createBtn.innerHTML = '<i data-lucide="send" class="h-4 w-4"></i><span>إنشاء الحملة</span>';
        lucide.createIcons();
      }
    }

    // عرض تفاصيل الحملة
    async function viewCampaignDetails(campaignId) {
      document.getElementById('campaign-details-modal').classList.remove('hidden');
      document.getElementById('campaign-details-modal').classList.add('flex');
      
      const content = document.getElementById('campaign-details-content');
      content.innerHTML = '<div class="text-center text-body-sm text-muted-foreground">جاري تحميل تفاصيل الحملة...</div>';

      try {
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('tchat_token')}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          renderCampaignDetails(result.campaign, result.recipients || []);
          
          // تحميل أسباب الفشل إذا كانت هناك رسائل فاشلة
          if (result.campaign.failed_count > 0) {
            setTimeout(() => loadFailureReasons(campaignId), 500);
          }
        } else {
          content.innerHTML = '<div class="text-center text-destructive text-body-sm">تعذر تحميل تفاصيل الحملة</div>';
        }
      } catch (error) {
        console.error('خطأ في تحميل تفاصيل الحملة:', error);
        content.innerHTML = '<div class="text-center text-destructive text-body-sm">تعذر تحميل تفاصيل الحملة</div>';
      }
    }

    // دالة تحميل أسباب الفشل
    async function loadFailureReasons(campaignId) {
      const contentDiv = document.getElementById('failure-reasons-content');
      if (!contentDiv) return;
      
      contentDiv.innerHTML = `
        <div class="text-center text-body-sm text-muted-foreground">
          <i data-lucide="loader-2" class="h-6 w-6 mx-auto mb-2 animate-spin"></i>
          <p>جاري تحميل أسباب الفشل...</p>
        </div>
      `;
      lucide.createIcons();
      
      try {
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}/failure-reasons`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('tchat_token')}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.reasons && result.reasons.length > 0) {
          // ترتيب الأسباب حسب العدد (تنازلياً)
          const sortedReasons = result.reasons.sort((a, b) => b.count - a.count);
          
          // حساب النسب المئوية
          const total = result.total_failed;
          
          contentDiv.innerHTML = `
            <div class="space-y-3">
              ${sortedReasons.map((reason, index) => {
                const percentage = ((reason.count / total) * 100).toFixed(1);
                const barColor = getFailureReasonColor(reason.reason);
                const icon = getFailureReasonIcon(reason.reason);
                
                return `
                  <div class="rounded-lg border border-border bg-card p-4">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0">
                        <div class="flex h-10 w-10 items-center justify-center rounded-full ${barColor}/20">
                          <i data-lucide="${icon}" class="h-5 w-5 ${barColor}"></i>
                        </div>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between gap-2 mb-2">
                          <h4 class="text-body-md font-medium text-foreground">${reason.reason}</h4>
                          <div class="flex items-center gap-2 flex-shrink-0">
                            <span class="text-body-sm font-bold ${barColor}">${reason.count}</span>
                            <span class="text-body-xs text-muted-foreground">(${percentage}%)</span>
                          </div>
                        </div>
                        <div class="w-full bg-muted rounded-full h-2">
                          <div class="${barColor} h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            
            <div class="mt-4 rounded-lg border border-border bg-muted/30 p-4">
              <h4 class="text-body-sm font-semibold text-foreground mb-2">💡 نصائح لتقليل معدل الفشل:</h4>
              <ul class="text-body-xs text-muted-foreground space-y-1">
                ${getFailureRecommendations(sortedReasons).map(tip => `<li class="flex items-start gap-2"><span>•</span><span>${tip}</span></li>`).join('')}
              </ul>
            </div>
          `;
        } else {
          contentDiv.innerHTML = `
            <div class="text-center text-body-sm text-muted-foreground">
              <i data-lucide="check-circle" class="h-8 w-8 mx-auto mb-2 text-success"></i>
              <p>لا توجد تفاصيل متاحة عن أسباب الفشل</p>
            </div>
          `;
        }
        
        lucide.createIcons();
      } catch (error) {
        console.error('خطأ في تحميل أسباب الفشل:', error);
        contentDiv.innerHTML = `
          <div class="text-center text-destructive text-body-sm">
            <i data-lucide="alert-triangle" class="h-8 w-8 mx-auto mb-2"></i>
            <p>تعذر تحميل أسباب الفشل</p>
          </div>
        `;
        lucide.createIcons();
      }
    }

    // دالة لتحديد لون حسب نوع الخطأ
    function getFailureReasonColor(reason) {
      if (reason.includes('طريقة الدفع') || reason.includes('Payment')) {
        return 'text-red-600';
      } else if (reason.includes('حماية النظام') || reason.includes('ecosystem')) {
        return 'text-orange-600';
      } else if (reason.includes('غير قابل للتسليم') || reason.includes('undeliverable')) {
        return 'text-yellow-600';
      } else if (reason.includes('تجربة') || reason.includes('experiment')) {
        return 'text-purple-600';
      } else if (reason.includes('محظور') || reason.includes('blocked')) {
        return 'text-pink-600';
      } else {
        return 'text-gray-600';
      }
    }

    // دالة لتحديد أيقونة حسب نوع الخطأ
    function getFailureReasonIcon(reason) {
      if (reason.includes('طريقة الدفع') || reason.includes('Payment')) {
        return 'credit-card';
      } else if (reason.includes('حماية النظام') || reason.includes('ecosystem')) {
        return 'shield-alert';
      } else if (reason.includes('غير قابل للتسليم') || reason.includes('undeliverable')) {
        return 'phone-off';
      } else if (reason.includes('تجربة') || reason.includes('experiment')) {
        return 'flask';
      } else if (reason.includes('محظور') || reason.includes('blocked')) {
        return 'ban';
      } else {
        return 'alert-circle';
      }
    }

    // دالة للحصول على نصائح مخصصة حسب أسباب الفشل
    function getFailureRecommendations(reasons) {
      const tips = [];
      const topReason = reasons[0]?.reason || '';
      
      if (topReason.includes('طريقة الدفع')) {
        tips.push('⚠️ عاجل: تحقق من طريقة الدفع في Meta Business Manager');
        tips.push('تأكد من صلاحية البطاقة ووجود رصيد كافٍ');
      }
      
      if (reasons.some(r => r.reason.includes('حماية النظام'))) {
        tips.push('استخدم قوالب معتمدة من Meta فقط');
        tips.push('لا ترسل لنفس العملاء بشكل متكرار');
        tips.push('استخدم الإرسال الذكي لتجنب التكرار');
      }
      
      if (reasons.some(r => r.reason.includes('غير قابل للتسليم'))) {
        tips.push('نظّف قائمة الأرقام واحذف الأرقام غير الصحيحة');
        tips.push('تحقق من صحة الأرقام قبل الإرسال');
      }
      
      if (tips.length === 0) {
        tips.push('قسّم الحملات إلى دفعات صغيرة (50-100 رسالة/ساعة)');
        tips.push('راقب معدل الفشل لكل دفعة');
      }
      
      return tips;
    }

    function renderCampaignDetails(campaign, recipients) {
      document.getElementById('details-campaign-name').textContent = campaign.name;
      const content = document.getElementById('campaign-details-content');
      
      const successRate = campaign.total_recipients > 0 
        ? Math.round((campaign.delivered_count / campaign.total_recipients) * 100) 
        : 0;

      content.innerHTML = `
        <div class="space-y-6">
          <!-- Stats Cards -->
          <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-7">
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold number">${campaign.total_recipients}</div>
              <div class="text-body-sm text-muted-foreground">إجمالي المستقبلين</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-primary number">${campaign.sent_count}</div>
              <div class="text-body-sm text-muted-foreground">أُرسِلت</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-success number">${campaign.delivered_count}</div>
              <div class="text-body-sm text-muted-foreground">وصلت</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-accent-foreground number">${campaign.read_count}</div>
              <div class="text-body-sm text-muted-foreground">قُرِئت</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-warning number">${campaign.replied_count || 0}</div>
              <div class="text-body-sm text-muted-foreground">تم الرد عليها</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-purple-600 number">${campaign.clicked_count || 0}</div>
              <div class="text-body-sm text-muted-foreground">
                نُقِر عليها
                <div class="text-body-xs text-muted-foreground mt-1">
                  (فقط للأزرار التفاعلية)
                </div>
              </div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-destructive number">${campaign.failed_count}</div>
              <div class="text-body-sm text-muted-foreground">فشلت</div>
            </div>
          </div>

          <!-- Failure Reasons Section -->
          ${campaign.failed_count > 0 ? `
            <div class="rounded-lg border border-destructive/30 bg-destructive/5" id="failure-reasons-section">
              <div class="border-b border-destructive/20 p-4">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <i data-lucide="alert-circle" class="h-5 w-5 text-destructive"></i>
                    <h3 class="text-heading-md font-semibold text-destructive">أسباب الفشل (${campaign.failed_count})</h3>
                  </div>
                  <button onclick="loadFailureReasons(${campaign.id})" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-3 py-2 text-body-sm font-medium transition hover:bg-accent">
                    <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                    <span>تحديث</span>
                  </button>
                </div>
              </div>
              <div id="failure-reasons-content" class="p-4">
                <div class="text-center text-body-sm text-muted-foreground">
                  <i data-lucide="loader-2" class="h-6 w-6 mx-auto mb-2 animate-spin"></i>
                  <p>جاري تحميل أسباب الفشل...</p>
                </div>
              </div>
            </div>
          ` : ''}

          <!-- Recipients Table -->
          <div class="rounded-lg border bg-card">
            <div class="border-b border-border p-4">
              <div class="flex items-center justify-between">
                <h3 class="text-heading-md font-semibold">تفاصيل المستقبلين</h3>
                <button onclick="fixCampaignStats(${campaign.id})" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-3 py-2 text-body-sm font-medium transition hover:bg-accent hover:text-accent-foreground">
                  <i data-lucide="calculator" class="h-4 w-4"></i>
                  <span>إعادة حساب دقيق</span>
                </button>
              </div>
            </div>
            <div class="overflow-x-auto max-h-96">
              <table class="w-full caption-bottom text-sm">
                <thead class="bg-muted/50 sticky top-0">
                  <tr class="border-b text-right text-body-sm font-semibold text-muted-foreground">
                    <th class="px-4 py-3">العميل</th>
                    <th class="px-4 py-3 text-center">الدفعة</th>
                    <th class="px-4 py-3 text-center">الحالة</th>
                    <th class="px-4 py-3 text-center">الإرسال</th>
                    <th class="px-4 py-3 text-center">التسليم</th>
                    <th class="px-4 py-3 text-center">القراءة</th>
                    <th class="px-4 py-3 text-center">الرد</th>
                    <th class="px-4 py-3 text-center">النقر</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  ${recipients.length > 0 ? recipients.map(recipient => `
                    <tr class="hover:bg-muted/40">
                      <td class="px-4 py-3">
                        <div class="space-y-1">
                          <div class="text-body-md font-medium">${recipient.customer_name || 'غير محدد'}</div>
                          <div class="text-body-sm text-muted-foreground number">${recipient.phone_number}</div>
                        </div>
                      </td>
                      <td class="px-4 py-3 text-center">
                        <span class="inline-flex items-center rounded-full border border-input px-2 py-1 text-xs font-medium bg-accent text-accent-foreground">
                          ${recipient.batch_number || 1}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-center">
                        <span class="inline-flex items-center rounded-full border border-input px-2 py-1 text-xs font-semibold ${getStatusBadgeClass(recipient.status)}">
                          ${getStatusText(recipient.status)}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.sent_at ? new Date(recipient.sent_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.delivered_at ? new Date(recipient.delivered_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.read_at ? new Date(recipient.read_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.replied_at ? new Date(recipient.replied_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.clicked_at ? new Date(recipient.clicked_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                    </tr>
                  `).join('') : `
                    <tr>
                      <td colspan="8" class="h-32 text-center text-body-sm text-muted-foreground">
                        <div class="space-y-3">
                          <i data-lucide="users-x" class="h-8 w-8 mx-auto"></i>
                          <p>لا توجد مستقبلين في هذه الحملة</p>
                          <p class="text-body-xs">قد تكون الحملة أُنشئت بدون إضافة مستقبلين</p>
                          <button onclick="addRecipientsToExistingCampaign(${campaign.id})" class="inline-flex items-center gap-2 rounded-md bg-primary px-3 py-2 text-body-sm font-medium text-primary-foreground transition hover:bg-primary/90">
                            <i data-lucide="user-plus" class="h-4 w-4"></i>
                            <span>إضافة مستقبلين</span>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      lucide.createIcons();
    }

    function hideCampaignDetailsModal() {
      document.getElementById('campaign-details-modal').classList.add('hidden');
      document.getElementById('campaign-details-modal').classList.remove('flex');
    }

    // بدء الحملة
    async function startCampaign(campaignId) {
      if (!confirm('هل أنت متأكد من بدء هذه الحملة؟ سيتم إرسال الرسائل فوراً.')) {
        return;
      }

      try {
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}/start`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('tchat_token')}`
          }
        });

        const result = await response.json();
        
        if (result.success) {
          alert('تم بدء الحملة بنجاح!');
          refreshCampaigns();
        } else {
          alert('فشل في بدء الحملة: ' + (result.message || 'خطأ غير معروف'));
        }
      } catch (error) {
        console.error('خطأ في بدء الحملة:', error);
        alert('تعذر بدء الحملة. تحقق من الاتصال.');
      }
    }

    // إعادة إرسال الحملة
    async function resendCampaign(campaignId) {
      if (!confirm('هل تريد إعادة إرسال هذه الحملة؟ سيتم إرسال الرسائل للمستقبلين مرة أخرى.')) {
        return;
      }

      try {
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}/resend`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('tchat_token')}`
          }
        });

        const result = await response.json();
        
        if (result.success) {
          alert('تم بدء إعادة الإرسال بنجاح!');
          refreshCampaigns();
        } else {
          alert('فشل في إعادة الإرسال: ' + (result.message || 'خطأ غير معروف'));
        }
      } catch (error) {
        console.error('خطأ في إعادة الإرسال:', error);
        alert('تعذر إعادة الإرسال. تحقق من الاتصال.');
      }
    }

    // إضافة مستقبلين لحملة موجودة
    async function addRecipientsToExistingCampaign(campaignId) {
      const phoneNumber = prompt('أدخل رقم الهاتف (مثال: 966550002445):');
      
      if (!phoneNumber || !phoneNumber.trim()) {
        return;
      }

      const cleanPhone = phoneNumber.trim().replace(/[\s\-\+]/g, '');
      
      if (!/^966\d{9}$/.test(cleanPhone)) {
        alert('رقم الهاتف غير صحيح. يجب أن يبدأ بـ 966 ويحتوي على 12 رقماً');
        return;
      }

      try {
        const campaignData = {
          recipients: [{
            customer_id: 0,
            phone_number: cleanPhone,
            customer_name: `عميل ${cleanPhone.slice(-4)}`
          }]
        };

        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}/recipients`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('tchat_token')}`
          },
          body: JSON.stringify(campaignData)
        });

        const result = await response.json();
        
        if (result.success) {
          alert('تم إضافة المستقبل بنجاح!');
          viewCampaignDetails(campaignId); // إعادة تحميل التفاصيل
        } else {
          alert('فشل في إضافة المستقبل: ' + (result.message || 'خطأ غير معروف'));
        }
      } catch (error) {
        console.error('خطأ في إضافة المستقبل:', error);
        alert('تعذر إضافة المستقبل. تحقق من الاتصال.');
      }
    }

    // إعادة حساب إحصائيات الحملة بدقة
    async function fixCampaignStats(campaignId) {
      try {
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}/fix-stats`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('tchat_token')}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('تم إعادة حساب الإحصائيات بدقة!');
          // إعادة تحميل تفاصيل الحملة
          viewCampaignDetails(campaignId);
        } else {
          alert('فشل في إعادة حساب الإحصائيات: ' + (result.message || 'خطأ غير معروف'));
        }
      } catch (error) {
        console.error('خطأ في إعادة حساب الإحصائيات:', error);
        alert('تعذر إعادة حساب الإحصائيات');
      }
    }

    // حذف حملة واحدة
    async function deleteCampaign(campaignId, campaignName) {
      const confirmed = confirm(`هل أنت متأكد من حذف الحملة "${campaignName}"؟\n\n⚠️ سيتم حذف الحملة وجميع بياناتها نهائياً ولا يمكن التراجع عن هذا الإجراء.`);
      
      if (!confirmed) {
        return;
      }

      try {
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('tchat_token')}`
          }
        });

        const result = await response.json();
        
        if (result.success) {
          alert('✅ تم حذف الحملة بنجاح!');
          refreshCampaigns();
        } else {
          alert('❌ فشل في حذف الحملة: ' + (result.error || result.message || 'خطأ غير معروف'));
        }
      } catch (error) {
        console.error('خطأ في حذف الحملة:', error);
        alert('❌ تعذر حذف الحملة. تحقق من الاتصال.');
      }
    }

    // حذف جميع الحملات
    async function deleteAllCampaigns() {
      // تأكيد أولي
      if (!confirm('⚠️ تحذير: هل أنت متأكد من حذف جميع الحملات؟\n\nهذا الإجراء لا يمكن التراجع عنه وسيحذف:\n- جميع الحملات\n- جميع المستقبلين\n- جميع الإحصائيات\n\nاكتب "نعم احذف الكل" للمتابعة')) {
        return;
      }

      // تأكيد ثاني مع كلمة مرور
      const confirmText = prompt('للتأكيد النهائي، اكتب: DELETE_ALL_CAMPAIGNS');
      
      if (confirmText !== 'DELETE_ALL_CAMPAIGNS') {
        alert('تم إلغاء العملية');
        return;
      }

      try {
        const response = await fetch('https://tchat-production.up.railway.app/api/v1/campaigns/delete-all', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('tchat_token')}`
          },
          body: JSON.stringify({
            confirm_password: 'DELETE_ALL_CAMPAIGNS'
          })
        });

        const result = await response.json();
        
        if (result.success) {
          alert(`تم حذف ${result.deleted_count} حملة بنجاح!`);
          refreshCampaigns();
        } else {
          alert('فشل في حذف الحملات: ' + (result.message || 'خطأ غير معروف'));
        }
      } catch (error) {
        console.error('خطأ في حذف الحملات:', error);
        alert('تعذر حذف الحملات. تحقق من الاتصال.');
      }
    }

    // تحديث حالات جميع الحملات
    async function updateAllCampaignStatuses() {
      try {
        const response = await fetch('https://tchat-production.up.railway.app/api/v1/campaigns/update-statuses', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('tchat_token')}`
          }
        });

        const result = await response.json();
        
        if (result.success) {
          alert(`تم فحص وتحديث ${result.updated_count} حملة`);
          refreshCampaigns();
        } else {
          alert('فشل في تحديث الحالات: ' + (result.message || 'خطأ غير معروف'));
        }
      } catch (error) {
        console.error('خطأ في تحديث الحالات:', error);
        alert('تعذر تحديث الحالات. تحقق من الاتصال.');
      }
    }

    async function refreshCampaigns() {
      await loadAndRenderCampaigns();
    }

    // دالة معالجة تفعيل/إلغاء الإرسال الذكي
    function handleSmartSendToggle() {
      const smartSendEnabled = document.getElementById('enable-smart-send').checked;
      const smartSendInfo = document.getElementById('smart-send-info');
      
      if (smartSendEnabled) {
        smartSendInfo.classList.remove('hidden');
      } else {
        smartSendInfo.classList.add('hidden');
        // إخفاء نتائج الفحص إذا كانت ظاهرة
        const resultsDiv = document.getElementById('smart-send-results');
        if (resultsDiv) {
          resultsDiv.classList.add('hidden');
        }
        // إعادة تعيين المتغير
        smartSendFilteredRecipients = null;
      }
    }

    // متغير عام لتخزين نتائج الفحص الذكي
    let smartSendFilteredRecipients = null;

    // دالة فحص الإرسال الذكي
    async function runSmartSendCheck() {
      const checkBtn = document.getElementById('check-recipients-btn');
      const resultsDiv = document.getElementById('smart-send-results');
      
      // جمع أرقام الهواتف من المستقبلين
      let phoneNumbers = [];
      const source = document.getElementById('recipients-source').value;
      
      if (source === 'manual') {
        const manualText = document.getElementById('manual-recipients').value;
        const lines = manualText.split('\n').filter(line => line.trim());
        phoneNumbers = lines.map(line => {
          const parts = line.split(',');
          return parts[0].trim();
        }).filter(phone => phone);
      } else if (source === 'database') {
        // استخدام المستقبلين من قاعدة البيانات
        if (window.parsedRecipients && window.parsedRecipients.length > 0) {
          phoneNumbers = window.parsedRecipients.map(r => r.phone_number);
        }
      }
      
      if (phoneNumbers.length === 0) {
        alert('لا توجد أرقام للفحص. يرجى إضافة مستقبلين أولاً.');
        return;
      }
      
      // تعطيل الزر وإظهار رسالة التحميل
      checkBtn.disabled = true;
      checkBtn.innerHTML = '<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i><span>جاري الفحص...</span>';
      lucide.createIcons();
      
      try {
        const response = await fetch('https://tchat-production.up.railway.app/api/v1/campaigns/smart-send-check', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('tchat_token')}`
          },
          body: JSON.stringify({
            phone_numbers: phoneNumbers
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // حفظ الأرقام المسموحة للاستخدام عند إنشاء الحملة
          smartSendFilteredRecipients = result.allowed_numbers;
          
          // عرض النتائج
          document.getElementById('smart-total').textContent = result.total;
          document.getElementById('smart-allowed').textContent = result.allowed;
          document.getElementById('smart-excluded').textContent = result.excluded;
          document.getElementById('smart-message').textContent = result.message;
          
          resultsDiv.classList.remove('hidden');
          
          // تحديث عدد المستقبلين في الواجهة
          updateRecipientsPreview();
          
        } else {
          alert('فشل في فحص الأرقام: ' + (result.error || 'خطأ غير معروف'));
        }
      } catch (error) {
        console.error('خطأ في فحص الإرسال الذكي:', error);
        alert('تعذر فحص الأرقام. تحقق من الاتصال.');
      } finally {
        // إعادة تفعيل الزر
        checkBtn.disabled = false;
        checkBtn.innerHTML = '<i data-lucide="scan-search" class="h-4 w-4"></i><span>فحص الأرقام الآن</span>';
        lucide.createIcons();
      }
    }

    // تحديث معاينة المستقبلين بعد الفحص الذكي
    function updateRecipientsPreview() {
      if (!smartSendFilteredRecipients || smartSendFilteredRecipients.length === 0) return;
      
      const source = document.getElementById('recipients-source').value;
      
      if (source === 'manual') {
        // تحديث قائمة المستقبلين المدخلة يدوياً
        const originalText = document.getElementById('manual-recipients').value;
        const lines = originalText.split('\n').filter(line => line.trim());
        
        const filteredLines = lines.filter(line => {
          const phone = line.split(',')[0].trim();
          return smartSendFilteredRecipients.includes(phone);
        });
        
        // تحديث textarea (اختياري - يمكن تعطيله إذا أردت إبقاء القائمة الأصلية)
        // document.getElementById('manual-recipients').value = filteredLines.join('\n');
        
        // تحديث العداد
        document.getElementById('manual-count').textContent = smartSendFilteredRecipients.length;
      }
    }

    // دوال API للحملات
    async function loadCampaigns(limit = 50) {
      try {
        const data = await apiRequest(`/campaigns?limit=${limit}`);
        if (data.success && Array.isArray(data.data)) {
          return data.data;
        }
        console.error('فشل في جلب الحملات:', data);
        return [];
      } catch (error) {
        console.error('خطأ في تحميل الحملات:', error);
        return [];
      }
    }

    async function loadMetaTemplates(limit = 50) {
      try {
        const data = await apiRequest(`/meta/templates?limit=${limit}`);
        if (data.success && Array.isArray(data.data)) {
          return data.data;
        }
        console.error('فشل في جلب القوالب:', data);
        return [];
      } catch (error) {
        console.error('خطأ في تحميل القوالب:', error);
        return [];
      }
    }

    // تهيئة الصفحة
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      loadAndRenderCampaigns();
      
      // إضافة مستمعات للتحديث التلقائي
      document.getElementById('batch-size').addEventListener('change', updateBatchPreview);
      document.getElementById('batch-interval').addEventListener('change', updateBatchPreview);
      
      // إضافة مستمع لرفع ملف CSV
      document.getElementById('csv-file').addEventListener('change', handleCSVUpload);
      
      // تفعيل الإرسال الذكي افتراضياً
      handleSmartSendToggle();
    });

    function logout() {
      localStorage.removeItem('tchat_logged_in');
      localStorage.removeItem('tchat_user');
      localStorage.removeItem('tchat_token');
      window.location.href = './login.html';
    }
  </script>
</body>
</html>
