<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TCHAT - الحملات التسويقية</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="./api.js"></script>
</head>
<body class="rtl min-h-screen bg-background" style="font-family: 'LamaSans', sans-serif;">
  
  <!-- Header -->
  <header class="border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
    <div class="container mx-auto flex h-16 items-center justify-between px-4">
      <div class="flex items-center gap-2">
        <a href="./dashboard.html" class="inline-flex items-center gap-2 text-body-sm font-medium text-muted-foreground transition hover:text-foreground">
          <i data-lucide="arrow-right" class="h-4 w-4"></i>
          <span>العودة إلى اللوحة</span>
        </a>
      </div>
      <span class="text-heading-md font-bold">الحملات التسويقية</span>
      <button onclick="logout()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
        <i data-lucide="log-out" class="ml-2 h-4 w-4"></i>
        <span class="text-body-md">تسجيل الخروج</span>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    
    <!-- Page Header -->
    <section class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-heading-lg font-bold text-foreground">إدارة الحملات التسويقية</h1>
        <p class="text-body-sm text-muted-foreground">إنشاء وإدارة حملات واتساب للعملاء</p>
      </div>
      <button onclick="showCreateCampaignModal()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
        <i data-lucide="plus" class="h-4 w-4"></i>
        <span>حملة جديدة</span>
      </button>
    </section>

    <!-- Campaigns List -->
    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
      <div class="border-b border-border p-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="megaphone" class="h-5 w-5 text-muted-foreground"></i>
            <h2 class="text-heading-md font-semibold">الحملات الحالية</h2>
          </div>
          <button onclick="refreshCampaigns()" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="refresh-cw" class="h-4 w-4"></i>
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full caption-bottom text-sm">
          <thead class="bg-muted/50">
            <tr class="border-b text-right text-body-sm font-semibold text-muted-foreground">
              <th class="px-4 py-3 w-[25%]">الحملة</th>
              <th class="px-4 py-3 w-[15%] text-center">القالب</th>
              <th class="px-4 py-3 w-[10%] text-center">الحالة</th>
              <th class="px-4 py-3 w-[10%] text-center">المستقبلين</th>
              <th class="px-4 py-3 w-[15%] text-center">التقدم</th>
              <th class="px-4 py-3 w-[15%] text-center">الإعدادات</th>
              <th class="px-4 py-3 w-[10%] text-center">الإجراءات</th>
            </tr>
          </thead>
          <tbody id="campaigns-table-body" class="divide-y divide-border">
            <tr>
              <td colspan="7" class="h-24 text-center text-body-sm text-muted-foreground">جاري تحميل الحملات...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <!-- Create Campaign Modal -->
  <div id="create-campaign-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-background/80 backdrop-blur-sm">
    <div class="w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div>
            <h2 class="text-heading-lg font-bold">إنشاء حملة تسويقية جديدة</h2>
            <p class="text-body-sm text-muted-foreground mt-1">قم بإعداد الحملة واختيار المستقبلين</p>
          </div>
          <button onclick="hideCreateCampaignModal()" class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="x" class="h-4 w-4"></i>
          </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6 space-y-6">
          
          <!-- Step 1: Campaign Info -->
          <div class="space-y-4">
            <h3 class="text-heading-md font-semibold flex items-center gap-2">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground text-xs font-bold">1</span>
              معلومات الحملة
            </h3>
            
            <div class="grid gap-4 md:grid-cols-2">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">اسم الحملة</label>
                <input type="text" id="campaign-name" placeholder="أدخل اسم الحملة" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" />
              </div>
              <div class="space-y-2">
                <label class="text-body-sm font-medium">القالب</label>
                <select id="campaign-template" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="">اختر القالب</option>
                </select>
              </div>
            </div>
            
            <div class="space-y-2">
              <label class="text-body-sm font-medium">وصف الحملة</label>
              <textarea id="campaign-description" placeholder="وصف مختصر للحملة" rows="3" class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"></textarea>
            </div>
          </div>

          <!-- Step 2: Recipients -->
          <div class="space-y-4">
            <h3 class="text-heading-md font-semibold flex items-center gap-2">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground text-xs font-bold">2</span>
              المستقبلين
            </h3>
            
            <div class="grid gap-4 md:grid-cols-2">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">مصدر البيانات</label>
                <select id="recipients-source" onchange="handleRecipientsSourceChange()" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="database">العملاء المسجلين</option>
                  <option value="csv">رفع ملف CSV</option>
                </select>
              </div>
              <div class="space-y-2" id="csv-upload-section" style="display: none;">
                <label class="text-body-sm font-medium">ملف CSV</label>
                <input type="file" id="csv-file" accept=".csv" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" />
              </div>
            </div>

            <div id="recipients-preview" class="rounded-lg border border-border bg-muted/20 p-4">
              <div class="text-center text-body-sm text-muted-foreground">
                <i data-lucide="users" class="h-8 w-8 mx-auto mb-2"></i>
                <p>سيتم عرض المستقبلين هنا</p>
              </div>
            </div>
          </div>

          <!-- Step 3: Batch Settings -->
          <div class="space-y-4">
            <h3 class="text-heading-md font-semibold flex items-center gap-2">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground text-xs font-bold">3</span>
              إعدادات الإرسال
            </h3>
            
            <div class="grid gap-4 md:grid-cols-3">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">حجم الدفعة</label>
                <select id="batch-size" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="50">50 عميل</option>
                  <option value="100" selected>100 عميل</option>
                  <option value="200">200 عميل</option>
                  <option value="300">300 عميل</option>
                  <option value="500">500 عميل</option>
                </select>
              </div>
              <div class="space-y-2">
                <label class="text-body-sm font-medium">الفترة بين الدفعات</label>
                <select id="batch-interval" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="1" selected>ساعة واحدة</option>
                  <option value="2">ساعتان</option>
                  <option value="3">3 ساعات</option>
                  <option value="6">6 ساعات</option>
                  <option value="12">12 ساعة</option>
                  <option value="24">24 ساعة</option>
                </select>
              </div>
              <div class="space-y-2">
                <label class="text-body-sm font-medium">نوع الإرسال</label>
                <select id="send-type" onchange="handleSendTypeChange()" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="batch">مجزأ (موصى به)</option>
                  <option value="all">الكل دفعة واحدة</option>
                </select>
              </div>
            </div>

            <div id="batch-preview" class="rounded-lg border border-border bg-accent/20 p-4">
              <h4 class="text-body-md font-semibold mb-2">معاينة الإرسال</h4>
              <div id="batch-preview-content" class="text-body-sm text-muted-foreground">
                سيتم عرض تفاصيل التجزئة هنا
              </div>
            </div>
          </div>

        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-between border-t border-border p-6">
          <button onclick="hideCreateCampaignModal()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-body-sm font-medium transition hover:bg-accent hover:text-accent-foreground">
            <span>إلغاء</span>
          </button>
          <div class="flex items-center gap-3">
            <button onclick="previewCampaign()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-body-sm font-medium transition hover:bg-accent hover:text-accent-foreground">
              <i data-lucide="eye" class="h-4 w-4"></i>
              <span>معاينة</span>
            </button>
            <button onclick="createCampaign()" id="create-campaign-btn" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90 disabled:opacity-50">
              <i data-lucide="send" class="h-4 w-4"></i>
              <span>إنشاء الحملة</span>
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Campaign Details Modal -->
  <div id="campaign-details-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-background/80 backdrop-blur-sm">
    <div class="w-full max-w-6xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div>
            <h2 id="details-campaign-name" class="text-heading-lg font-bold">تفاصيل الحملة</h2>
            <p class="text-body-sm text-muted-foreground mt-1">إحصائيات ومتابعة الحملة</p>
          </div>
          <button onclick="hideCampaignDetailsModal()" class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="x" class="h-4 w-4"></i>
          </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6" id="campaign-details-content">
          <div class="text-center text-body-sm text-muted-foreground">جاري تحميل تفاصيل الحملة...</div>
        </div>

      </div>
    </div>
  </div>

  <script>
    if (!localStorage.getItem('tchat_logged_in')) {
      window.location.href = './login.html';
    }

    let campaigns = [];
    let selectedRecipients = [];
    let availableTemplates = [];

    // تحميل الحملات
    async function loadAndRenderCampaigns() {
      const tbody = document.getElementById('campaigns-table-body');
      tbody.innerHTML = '<tr><td colspan="7" class="h-24 text-center text-body-sm text-muted-foreground">جاري تحميل الحملات...</td></tr>';

      try {
        campaigns = await loadCampaigns();
        renderCampaigns();
      } catch (error) {
        console.error('خطأ في تحميل الحملات:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="h-24 text-center text-destructive text-body-sm">تعذر تحميل الحملات</td></tr>';
      }
    }

    function renderCampaigns() {
      const tbody = document.getElementById('campaigns-table-body');
      
      if (!campaigns.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="h-24 text-center text-body-sm text-muted-foreground">لا توجد حملات حالياً</td></tr>';
        return;
      }

      tbody.innerHTML = campaigns.map(campaign => {
        const statusClass = getStatusBadgeClass(campaign.status);
        const statusText = getStatusText(campaign.status);
        const progressPercent = campaign.total_recipients > 0 
          ? Math.round((campaign.sent_count / campaign.total_recipients) * 100) 
          : 0;

        return `
          <tr class="hover:bg-muted/40 transition-colors">
            <td class="px-4 py-4">
              <div class="space-y-1">
                <div class="text-body-md font-semibold">${campaign.name}</div>
                <div class="text-body-sm text-muted-foreground">${campaign.description || 'بدون وصف'}</div>
                <div class="text-body-xs text-muted-foreground">تم الإنشاء: ${new Date(campaign.created_at).toLocaleDateString('ar-SA')}</div>
              </div>
            </td>
            <td class="px-4 py-4 text-center">
              <span class="inline-flex items-center rounded-full border border-input px-3 py-1 text-xs font-semibold bg-accent text-accent-foreground">
                ${campaign.template_name}
              </span>
            </td>
            <td class="px-4 py-4 text-center">
              <span class="inline-flex items-center rounded-full border border-input px-3 py-1 text-xs font-semibold ${statusClass}">
                ${statusText}
              </span>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="text-body-md font-medium number">${campaign.total_recipients}</div>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="space-y-1">
                <div class="text-body-sm">
                  <span class="number">${campaign.sent_count}</span> / <span class="number">${campaign.total_recipients}</span>
                </div>
                <div class="w-full bg-muted rounded-full h-2">
                  <div class="bg-primary h-2 rounded-full transition-all" style="width: ${progressPercent}%"></div>
                </div>
                <div class="text-body-xs text-muted-foreground">${progressPercent}%</div>
              </div>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="text-body-sm text-muted-foreground">
                <div class="number">${campaign.batch_size}</div>
                <div>كل ${campaign.batch_interval_hours} ساعة</div>
              </div>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="flex items-center justify-center gap-1">
                <button onclick="viewCampaignDetails(${campaign.id})" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
                  <i data-lucide="eye" class="h-3 w-3"></i>
                </button>
                ${campaign.status === 'draft' ? `
                  <button onclick="startCampaign(${campaign.id})" class="inline-flex h-8 w-8 items-center justify-center rounded-md bg-primary text-primary-foreground transition hover:bg-primary/90">
                    <i data-lucide="play" class="h-3 w-3"></i>
                  </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');

      lucide.createIcons();
    }

    function getStatusBadgeClass(status) {
      const classes = {
        'draft': 'bg-muted text-muted-foreground',
        'scheduled': 'bg-warning/10 text-warning',
        'running': 'bg-primary/10 text-primary',
        'completed': 'bg-success/10 text-success',
        'paused': 'bg-warning/10 text-warning',
        'cancelled': 'bg-destructive/10 text-destructive'
      };
      return classes[status] || 'bg-muted text-muted-foreground';
    }

    function getStatusText(status) {
      const texts = {
        'draft': 'مسودة',
        'scheduled': 'مجدولة',
        'running': 'قيد التشغيل',
        'completed': 'مكتملة',
        'paused': 'متوقفة',
        'cancelled': 'ملغية'
      };
      return texts[status] || status;
    }

    // عرض/إخفاء نافذة إنشاء الحملة
    function showCreateCampaignModal() {
      document.getElementById('create-campaign-modal').classList.remove('hidden');
      document.getElementById('create-campaign-modal').classList.add('flex');
      loadTemplatesForCampaign();
      loadRecipientsPreview();
    }

    function hideCreateCampaignModal() {
      document.getElementById('create-campaign-modal').classList.add('hidden');
      document.getElementById('create-campaign-modal').classList.remove('flex');
      resetCampaignForm();
    }

    function resetCampaignForm() {
      document.getElementById('campaign-name').value = '';
      document.getElementById('campaign-description').value = '';
      document.getElementById('campaign-template').value = '';
      document.getElementById('recipients-source').value = 'database';
      document.getElementById('csv-file').value = '';
      selectedRecipients = [];
      handleRecipientsSourceChange();
    }

    // تحميل القوالب للحملة
    async function loadTemplatesForCampaign() {
      try {
        availableTemplates = await loadMetaTemplates(100);
        const templateSelect = document.getElementById('campaign-template');
        
        templateSelect.innerHTML = '<option value="">اختر القالب</option>' +
          availableTemplates
            .filter(template => template.status === 'APPROVED')
            .map(template => `<option value="${template.name}">${template.name}</option>`)
            .join('');
      } catch (error) {
        console.error('خطأ في تحميل القوالب:', error);
      }
    }

    // معالجة تغيير مصدر المستقبلين
    function handleRecipientsSourceChange() {
      const source = document.getElementById('recipients-source').value;
      const csvSection = document.getElementById('csv-upload-section');
      
      if (source === 'csv') {
        csvSection.style.display = 'block';
      } else {
        csvSection.style.display = 'none';
        loadRecipientsPreview();
      }
    }

    // معاينة المستقبلين
    async function loadRecipientsPreview() {
      const previewEl = document.getElementById('recipients-preview');
      const source = document.getElementById('recipients-source').value;
      
      if (source === 'database') {
        try {
          const customers = await loadCustomers(200);
          selectedRecipients = customers.map(customer => ({
            customer_id: customer.id,
            phone_number: customer.mobile || customer.phone,
            customer_name: customer.name
          })).filter(r => r.phone_number);

          previewEl.innerHTML = `
            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <h4 class="text-body-md font-semibold">العملاء من قاعدة البيانات</h4>
                <span class="text-body-sm text-muted-foreground">${selectedRecipients.length} عميل</span>
              </div>
              <div class="grid gap-2 max-h-32 overflow-y-auto">
                ${selectedRecipients.slice(0, 5).map(r => `
                  <div class="flex items-center justify-between text-body-sm">
                    <span>${r.customer_name}</span>
                    <span class="number">${r.phone_number}</span>
                  </div>
                `).join('')}
                ${selectedRecipients.length > 5 ? `<div class="text-center text-body-xs text-muted-foreground">و ${selectedRecipients.length - 5} عميل آخر...</div>` : ''}
              </div>
            </div>
          `;
        } catch (error) {
          previewEl.innerHTML = '<div class="text-center text-destructive text-body-sm">تعذر تحميل العملاء</div>';
        }
      }
      
      updateBatchPreview();
    }

    // تحديث معاينة التجزئة
    function updateBatchPreview() {
      const previewContent = document.getElementById('batch-preview-content');
      const sendType = document.getElementById('send-type').value;
      const batchSize = parseInt(document.getElementById('batch-size').value);
      const batchInterval = parseInt(document.getElementById('batch-interval').value);
      
      if (sendType === 'all') {
        previewContent.innerHTML = `
          <div class="text-warning">
            <i data-lucide="alert-triangle" class="inline h-4 w-4 ml-1"></i>
            سيتم إرسال الرسائل لجميع المستقبلين (${selectedRecipients.length}) دفعة واحدة
          </div>
        `;
        return;
      }

      const totalRecipients = selectedRecipients.length;
      const batchCount = Math.ceil(totalRecipients / batchSize);
      const totalDuration = (batchCount - 1) * batchInterval;

      previewContent.innerHTML = `
        <div class="space-y-2 text-body-sm">
          <div class="flex justify-between">
            <span>عدد الدفعات:</span>
            <span class="number">${batchCount}</span>
          </div>
          <div class="flex justify-between">
            <span>حجم كل دفعة:</span>
            <span class="number">${batchSize} عميل</span>
          </div>
          <div class="flex justify-between">
            <span>الفترة بين الدفعات:</span>
            <span class="number">${batchInterval} ساعة</span>
          </div>
          <div class="flex justify-between">
            <span>المدة الإجمالية:</span>
            <span class="number">${totalDuration} ساعة</span>
          </div>
        </div>
      `;
    }

    // معالجة تغيير نوع الإرسال
    function handleSendTypeChange() {
      updateBatchPreview();
    }

    // إنشاء الحملة
    async function createCampaign() {
      const name = document.getElementById('campaign-name').value.trim();
      const description = document.getElementById('campaign-description').value.trim();
      const templateName = document.getElementById('campaign-template').value;
      const batchSize = parseInt(document.getElementById('batch-size').value);
      const batchInterval = parseInt(document.getElementById('batch-interval').value);
      const sendType = document.getElementById('send-type').value;

      // التحقق من البيانات
      if (!name || !templateName || selectedRecipients.length === 0) {
        alert('يرجى ملء جميع الحقول المطلوبة واختيار المستقبلين');
        return;
      }

      const createBtn = document.getElementById('create-campaign-btn');
      createBtn.disabled = true;
      createBtn.innerHTML = '<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i><span>جاري الإنشاء...</span>';

      try {
        const campaignData = {
          name: name,
          description: description,
          template_name: templateName,
          template_language: 'ar',
          batch_size: sendType === 'all' ? selectedRecipients.length : batchSize,
          batch_interval_hours: sendType === 'all' ? 0 : batchInterval,
          recipients: selectedRecipients
        };

        const response = await fetch('https://tchat-production.up.railway.app/api/v1/campaigns', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('tchat_token')}`
          },
          body: JSON.stringify(campaignData)
        });

        const result = await response.json();
        
        if (result.success) {
          alert('تم إنشاء الحملة بنجاح!');
          hideCreateCampaignModal();
          refreshCampaigns();
        } else {
          alert('فشل في إنشاء الحملة: ' + (result.message || 'خطأ غير معروف'));
        }
      } catch (error) {
        console.error('خطأ في إنشاء الحملة:', error);
        alert('تعذر إنشاء الحملة. تحقق من الاتصال.');
      } finally {
        createBtn.disabled = false;
        createBtn.innerHTML = '<i data-lucide="send" class="h-4 w-4"></i><span>إنشاء الحملة</span>';
        lucide.createIcons();
      }
    }

    // عرض تفاصيل الحملة
    async function viewCampaignDetails(campaignId) {
      document.getElementById('campaign-details-modal').classList.remove('hidden');
      document.getElementById('campaign-details-modal').classList.add('flex');
      
      const content = document.getElementById('campaign-details-content');
      content.innerHTML = '<div class="text-center text-body-sm text-muted-foreground">جاري تحميل تفاصيل الحملة...</div>';

      try {
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('tchat_token')}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          renderCampaignDetails(result.campaign, result.recipients);
        } else {
          content.innerHTML = '<div class="text-center text-destructive text-body-sm">تعذر تحميل تفاصيل الحملة</div>';
        }
      } catch (error) {
        console.error('خطأ في تحميل تفاصيل الحملة:', error);
        content.innerHTML = '<div class="text-center text-destructive text-body-sm">تعذر تحميل تفاصيل الحملة</div>';
      }
    }

    function renderCampaignDetails(campaign, recipients) {
      document.getElementById('details-campaign-name').textContent = campaign.name;
      const content = document.getElementById('campaign-details-content');
      
      const successRate = campaign.total_recipients > 0 
        ? Math.round((campaign.delivered_count / campaign.total_recipients) * 100) 
        : 0;

      content.innerHTML = `
        <div class="space-y-6">
          <!-- Stats Cards -->
          <div class="grid gap-4 md:grid-cols-4">
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold number">${campaign.total_recipients}</div>
              <div class="text-body-sm text-muted-foreground">إجمالي المستقبلين</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-primary number">${campaign.sent_count}</div>
              <div class="text-body-sm text-muted-foreground">تم الإرسال</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-success number">${campaign.delivered_count}</div>
              <div class="text-body-sm text-muted-foreground">تم التسليم</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-destructive number">${campaign.failed_count}</div>
              <div class="text-body-sm text-muted-foreground">فشل</div>
            </div>
          </div>

          <!-- Recipients Table -->
          <div class="rounded-lg border bg-card">
            <div class="border-b border-border p-4">
              <h3 class="text-heading-md font-semibold">تفاصيل المستقبلين</h3>
            </div>
            <div class="overflow-x-auto max-h-96">
              <table class="w-full caption-bottom text-sm">
                <thead class="bg-muted/50 sticky top-0">
                  <tr class="border-b text-right text-body-sm font-semibold text-muted-foreground">
                    <th class="px-4 py-3">العميل</th>
                    <th class="px-4 py-3 text-center">الدفعة</th>
                    <th class="px-4 py-3 text-center">الحالة</th>
                    <th class="px-4 py-3 text-center">وقت الإرسال</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  ${recipients.map(recipient => `
                    <tr class="hover:bg-muted/40">
                      <td class="px-4 py-3">
                        <div class="space-y-1">
                          <div class="text-body-md font-medium">${recipient.customer_name}</div>
                          <div class="text-body-sm text-muted-foreground number">${recipient.phone_number}</div>
                        </div>
                      </td>
                      <td class="px-4 py-3 text-center">
                        <span class="inline-flex items-center rounded-full border border-input px-2 py-1 text-xs font-medium bg-accent text-accent-foreground">
                          ${recipient.batch_number}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-center">
                        <span class="inline-flex items-center rounded-full border border-input px-2 py-1 text-xs font-semibold ${getStatusBadgeClass(recipient.status)}">
                          ${getStatusText(recipient.status)}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        ${recipient.sent_at ? new Date(recipient.sent_at).toLocaleString('ar-SA') : '-'}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      lucide.createIcons();
    }

    function hideCampaignDetailsModal() {
      document.getElementById('campaign-details-modal').classList.add('hidden');
      document.getElementById('campaign-details-modal').classList.remove('flex');
    }

    // بدء الحملة
    async function startCampaign(campaignId) {
      if (!confirm('هل أنت متأكد من بدء هذه الحملة؟ سيتم إرسال الرسائل فوراً.')) {
        return;
      }

      try {
        const response = await fetch(`https://tchat-production.up.railway.app/api/v1/campaigns/${campaignId}/start`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('tchat_token')}`
          }
        });

        const result = await response.json();
        
        if (result.success) {
          alert('تم بدء الحملة بنجاح!');
          refreshCampaigns();
        } else {
          alert('فشل في بدء الحملة: ' + (result.message || 'خطأ غير معروف'));
        }
      } catch (error) {
        console.error('خطأ في بدء الحملة:', error);
        alert('تعذر بدء الحملة. تحقق من الاتصال.');
      }
    }

    async function refreshCampaigns() {
      await loadAndRenderCampaigns();
    }

    // دوال API للحملات
    async function loadCampaigns(limit = 50) {
      try {
        const data = await apiRequest(`/campaigns?limit=${limit}`);
        if (data.success && Array.isArray(data.data)) {
          return data.data;
        }
        console.error('فشل في جلب الحملات:', data);
        return [];
      } catch (error) {
        console.error('خطأ في تحميل الحملات:', error);
        return [];
      }
    }

    async function loadMetaTemplates(limit = 50) {
      try {
        const data = await apiRequest(`/meta/templates?limit=${limit}`);
        if (data.success && Array.isArray(data.data)) {
          return data.data;
        }
        console.error('فشل في جلب القوالب:', data);
        return [];
      } catch (error) {
        console.error('خطأ في تحميل القوالب:', error);
        return [];
      }
    }

    // تهيئة الصفحة
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      loadAndRenderCampaigns();
      
      // إضافة مستمعات للتحديث التلقائي
      document.getElementById('batch-size').addEventListener('change', updateBatchPreview);
      document.getElementById('batch-interval').addEventListener('change', updateBatchPreview);
    });

    function logout() {
      localStorage.removeItem('tchat_logged_in');
      localStorage.removeItem('tchat_user');
      localStorage.removeItem('tchat_token');
      window.location.href = './login.html';
    }
  </script>
</body>
</html>
