<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TCHAT - تسجيل الدخول</title>
    <link rel="stylesheet" href="./style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  </head>
  <body class="rtl min-h-screen bg-background text-foreground">

    <!-- محتوى الصفحة -->
    <main class="container mx-auto flex min-h-screen items-center justify-center px-4 py-12">
      <div class="w-full max-w-md">
        <div class="mb-8 text-center">
          <h1 class="text-heading-lg font-bold text-foreground">مرحباً بعودتك</h1>
          <p class="text-body-sm text-muted-foreground mt-2">سجّل الدخول للوصول إلى لوحة التحكم</p>
        </div>

        <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
          <div class="space-y-6 px-6 py-8">
            <form class="space-y-5" id="login-form" novalidate>
              <div class="space-y-2">
                <label for="username" class="text-body-sm font-medium text-foreground">اسم المستخدم</label>
                <div class="relative">
                  <input
                    id="username"
                    type="text"
                    required
                    autocomplete="username"
                    class="flex h-11 w-full rounded-lg border border-input bg-background px-4 pr-11 text-body-md text-foreground placeholder:text-muted-foreground shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                    placeholder="أدخل اسم المستخدم"
                  />
                  <i data-lucide="user" class="pointer-events-none absolute right-4 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"></i>
                </div>
              </div>

              <div class="space-y-2">
                <label for="password" class="text-body-sm font-medium text-foreground">كلمة المرور</label>
                <div class="relative">
                  <input
                    id="password"
                    type="password"
                    required
                    autocomplete="current-password"
                    class="flex h-11 w-full rounded-lg border border-input bg-background px-4 pr-11 text-body-md text-foreground placeholder:text-muted-foreground shadow-sm transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                    placeholder="أدخل كلمة المرور"
                  />
                  <button type="button" id="toggle-password" class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground transition hover:text-foreground">
                    <i data-lucide="eye" class="h-4 w-4"></i>
                  </button>
                  <i data-lucide="lock" class="pointer-events-none absolute right-4 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"></i>
                </div>
              </div>

              <button
                type="submit"
                class="inline-flex w-full items-center justify-center gap-2 rounded-lg bg-primary px-4 py-3 text-button-md font-semibold text-primary-foreground shadow-sm transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"
                disabled
              >
                <span class="text-button-md font-semibold">تسجيل الدخول</span>
                <i data-lucide="arrow-left" class="h-4 w-4"></i>
              </button>
            </form>

            <p class="text-center text-body-sm text-muted-foreground">© 2025 مناسبتي - جميع الحقوق محفوظة</p>
          </div>
        </div>
      </div>
    </main>

    <script>
      const passwordInput = document.getElementById('password');
      const togglePasswordBtn = document.getElementById('toggle-password');
      const submitBtn = document.querySelector('button[type="submit"]');
      const defaultButtonTemplate = '<span class="text-button-md font-semibold">تسجيل الدخول</span><i data-lucide="arrow-left" class="h-4 w-4"></i>';

      // تفعيل/إلغاء تفعيل زر تسجيل الدخول
      function toggleLoginButton() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        submitBtn.disabled = !(username.trim() && password.trim());
      }

      // إضافة مستمعات الأحداث للحقول
      document.getElementById('username').addEventListener('input', toggleLoginButton);
      document.getElementById('password').addEventListener('input', toggleLoginButton);

      // تبديل إظهار كلمة المرور
      togglePasswordBtn.addEventListener('click', () => {
        const isPassword = passwordInput.type === 'password';
        passwordInput.type = isPassword ? 'text' : 'password';
        togglePasswordBtn.innerHTML = isPassword
          ? '<i data-lucide="eye-off" class="h-4 w-4"></i>'
          : '<i data-lucide="eye" class="h-4 w-4"></i>';
        lucide.createIcons();
        passwordInput.focus();
      });

      // معالج تسجيل الدخول
      document.getElementById('login-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        // تعطيل الزر أثناء المعالجة
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="text-button-md font-semibold">جاري التحقق...</span><i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i>';
        
        try {
          // إرسال طلب تسجيل الدخول إلى Backend
          const response = await fetch('https://tchat-production.up.railway.app/api/v1/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              username: username,
              password: password
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            // حفظ بيانات المستخدم والـ token
            localStorage.setItem('tchat_logged_in', 'true');
            localStorage.setItem('tchat_user', JSON.stringify(data.user));
            localStorage.setItem('tchat_token', data.token);
            
            // توجيه إلى لوحة التحكم
            window.location.href = './dashboard.html';
          } else {
            // إعادة تعيين النموذج عند الفشل
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            toggleLoginButton();
            
            // إضافة تأثير اهتزاز
            const form = document.getElementById('login-form');
            form.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
              form.style.animation = '';
            }, 500);
          }
        } catch (error) {
          console.error('خطأ في تسجيل الدخول:', error);
          
          // في حالة عدم الاتصال، استخدم التحقق المحلي
          if (username === 'admin' && password === 'admin') {
            localStorage.setItem('tchat_logged_in', 'true');
            localStorage.setItem('tchat_user', JSON.stringify({
              username: 'admin',
              full_name: 'المدير العام',
              email: 'admin@tchat.com'
            }));
            window.location.href = './dashboard.html';
          } else {
            // تأثير اهتزاز عند الخطأ
            const form = document.getElementById('login-form');
            form.style.animation = 'shake 0.5s ease-in-out';
            setTimeout(() => {
              form.style.animation = '';
            }, 500);
          }
        } finally {
          // إعادة تفعيل الزر
          submitBtn.disabled = false;
          submitBtn.innerHTML = defaultButtonTemplate;
          lucide.createIcons();
        }
      });

      // تهيئة أيقونات Lucide
      document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        toggleLoginButton();
      });
    </script>
  </body>
</html>
