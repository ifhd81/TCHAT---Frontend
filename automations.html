<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TCHAT - Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¤ØªÙ…ØªØ©</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="./api.js"></script>
  <script src="./components/header.js"></script>
</head>
<body class="rtl min-h-screen bg-background" style="font-family: 'LamaSans', sans-serif;">
  
  <div class="min-h-screen">
    
    <!-- Header Container -->
    <div id="header-container"></div>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    
    <!-- Page Header -->
    <section class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-heading-lg font-bold text-foreground">Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¤ØªÙ…ØªØ©</h1>
        <p class="text-body-sm text-muted-foreground">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø§Ø« Ù…Ø¹ÙŠÙ†Ø©</p>
      </div>
      <button onclick="showCreateAutomationModal()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
        <i data-lucide="plus" class="h-4 w-4"></i>
        <span>Ø£ØªÙ…ØªØ© Ø¬Ø¯ÙŠØ¯Ø©</span>
      </button>
    </section>

    <!-- Stats Cards -->
    <section class="mb-8 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <div class="rounded-xl border bg-card p-6 shadow-sm">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-primary/10">
            <i data-lucide="zap" class="h-5 w-5 text-primary"></i>
          </div>
          <div>
            <p class="text-body-sm text-muted-foreground">Ø§Ù„Ø£ØªÙ…ØªØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</p>
            <p class="text-heading-lg font-bold number" id="active-automations-count">0</p>
          </div>
        </div>
      </div>
      <div class="rounded-xl border bg-card p-6 shadow-sm">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-success/10">
            <i data-lucide="send" class="h-5 w-5 text-success"></i>
          </div>
          <div>
            <p class="text-body-sm text-muted-foreground">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</p>
            <p class="text-heading-lg font-bold number" id="total-sent-count">0</p>
          </div>
        </div>
      </div>
      <div class="rounded-xl border bg-card p-6 shadow-sm">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-warning/10">
            <i data-lucide="shopping-cart" class="h-5 w-5 text-warning"></i>
          </div>
          <div>
            <p class="text-body-sm text-muted-foreground">Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</p>
            <p class="text-heading-lg font-bold number" id="total-carts-count">0</p>
          </div>
        </div>
      </div>
      <div class="rounded-xl border bg-card p-6 shadow-sm">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-accent">
            <i data-lucide="percent" class="h-5 w-5 text-accent-foreground"></i>
          </div>
          <div>
            <p class="text-body-sm text-muted-foreground">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„</p>
            <p class="text-heading-lg font-bold number" id="conversion-rate">0%</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Automations List with Visual Workflow -->
    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
      <div class="border-b border-border p-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="workflow" class="h-5 w-5 text-muted-foreground"></i>
            <h2 class="text-heading-md font-semibold">Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¤ØªÙ…ØªØ© Ù…Ø¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
          </div>
          <button onclick="refreshAutomations()" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="refresh-cw" class="h-4 w-4"></i>
          </button>
        </div>
      </div>

      <div class="p-6">
        <div id="automations-list" class="space-y-6">
          <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØªÙ…ØªØ§Øª Ù‡Ù†Ø§ -->
        </div>
      </div>
    </div>

    <!-- Current Configuration Section -->
    <div class="mt-8 rounded-xl border bg-card text-card-foreground shadow-sm">
      <div class="border-b border-border p-6">
        <div class="flex items-center gap-3">
          <i data-lucide="settings" class="h-5 w-5 text-muted-foreground"></i>
          <h2 class="text-heading-md font-semibold">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©</h2>
        </div>
      </div>
      <div class="p-6">
        <div class="rounded-lg border border-border bg-muted/30 p-6">
          <div class="flex items-start gap-4">
            <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-warning/10">
              <i data-lucide="shopping-cart" class="h-6 w-6 text-warning"></i>
            </div>
            <div class="flex-1">
              <h3 class="text-heading-sm font-semibold text-foreground">ØªØ°ÙƒÙŠØ± Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©</h3>
              <p class="mt-1 text-body-sm text-muted-foreground">ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</p>
              
              <div class="mt-4 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
                <div class="rounded-md border border-border bg-background p-4">
                  <div class="flex items-center gap-2 text-body-sm text-muted-foreground">
                    <i data-lucide="file-text" class="h-4 w-4"></i>
                    <span>Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
                  </div>
                  <p class="mt-1 text-body-md font-semibold text-foreground" id="current-template-name">cart_1</p>
                </div>
                <div class="rounded-md border border-border bg-background p-4">
                  <div class="flex items-center gap-2 text-body-sm text-muted-foreground">
                    <i data-lucide="clock" class="h-4 w-4"></i>
                    <span>ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span>
                  </div>
                  <p class="mt-1 text-body-md font-semibold text-foreground" id="current-send-time">ÙÙˆØ±ÙŠ</p>
                </div>
                <div class="rounded-md border border-border bg-background p-4">
                  <div class="flex items-center gap-2 text-body-sm text-muted-foreground">
                    <i data-lucide="toggle-right" class="h-4 w-4"></i>
                    <span>Ø§Ù„Ø­Ø§Ù„Ø©</span>
                  </div>
                  <p class="mt-1 text-body-md font-semibold text-success" id="current-status">Ù…ÙØ¹Ù‘Ù„</p>
                </div>
              </div>

              <div class="mt-4 flex items-center gap-3">
                <button onclick="showEditAbandonedCartModal()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-medium text-primary-foreground shadow-sm transition hover:bg-primary/90">
                  <i data-lucide="edit" class="h-4 w-4"></i>
                  <span>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                </button>
                <button onclick="toggleAbandonedCartStatus()" id="toggle-status-btn" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-button-md font-medium text-foreground shadow-sm transition hover:bg-accent">
                  <i data-lucide="pause" class="h-4 w-4"></i>
                  <span>Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>

  </div>

  <!-- Modal: Edit Abandoned Cart Settings -->
  <div id="edit-abandoned-cart-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div>
            <h2 class="text-heading-lg font-bold">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©</h2>
            <p class="text-body-sm text-muted-foreground mt-1">ØªØ®ØµÙŠØµ Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙˆÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</p>
          </div>
          <button onclick="hideEditAbandonedCartModal()" class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="x" class="h-5 w-5"></i>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-6">
          
          <!-- Template Selection -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <p class="text-body-sm text-muted-foreground">Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡ Ø¹Ù†Ø¯ ØªØ±Ùƒ Ø§Ù„Ø³Ù„Ø©</p>
            <select id="template-select" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨...</option>
            </select>
            
            <!-- Template Preview -->
            <div id="template-preview" class="hidden mt-4 rounded-lg border border-border bg-muted/30 p-4">
              <div class="flex items-center gap-2 mb-3">
                <i data-lucide="eye" class="h-4 w-4 text-muted-foreground"></i>
                <span class="text-body-sm font-medium text-muted-foreground">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚Ø§Ù„Ø¨</span>
              </div>
              <div id="template-preview-content" class="text-body-md text-foreground whitespace-pre-wrap"></div>
            </div>
          </div>

          <!-- Timing Selection -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>
            <p class="text-body-sm text-muted-foreground">Ù…ØªÙ‰ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ ØªØ±Ùƒ Ø§Ù„Ø³Ù„Ø©ØŸ</p>
            <select id="timing-select" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="0">ÙÙˆØ±ÙŠ (Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±)</option>
              <option value="5">Ø¨Ø¹Ø¯ 5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
              <option value="15">Ø¨Ø¹Ø¯ 15 Ø¯Ù‚ÙŠÙ‚Ø©</option>
              <option value="30">Ø¨Ø¹Ø¯ 30 Ø¯Ù‚ÙŠÙ‚Ø©</option>
              <option value="60">Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø©</option>
              <option value="120">Ø¨Ø¹Ø¯ Ø³Ø§Ø¹ØªÙŠÙ†</option>
              <option value="180">Ø¨Ø¹Ø¯ 3 Ø³Ø§Ø¹Ø§Øª</option>
              <option value="360">Ø¨Ø¹Ø¯ 6 Ø³Ø§Ø¹Ø§Øª</option>
              <option value="720">Ø¨Ø¹Ø¯ 12 Ø³Ø§Ø¹Ø©</option>
              <option value="1440">Ø¨Ø¹Ø¯ 24 Ø³Ø§Ø¹Ø©</option>
            </select>
          </div>

          <!-- Additional Options -->
          <div class="space-y-4 rounded-lg border border-border p-4">
            <h3 class="text-body-md font-semibold text-foreground">Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h3>
            
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="prevent-duplicate" checked class="h-5 w-5 rounded border-input text-primary focus:ring-primary">
              <div>
                <span class="text-body-md text-foreground">Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙƒØ±Ø±</span>
                <p class="text-body-sm text-muted-foreground">Ø¹Ø¯Ù… Ø¥Ø±Ø³Ø§Ù„ Ø£ÙƒØ«Ø± Ù…Ù† Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©</p>
              </div>
            </label>

            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="skip-purchased" checked class="h-5 w-5 rounded border-input text-primary focus:ring-primary">
              <div>
                <span class="text-body-md text-foreground">ØªØ®Ø·ÙŠ Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©</span>
                <p class="text-body-sm text-muted-foreground">Ø¹Ø¯Ù… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ø§ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±Ø§Ø¡</p>
              </div>
            </label>
          </div>

        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 border-t border-border p-6">
          <button onclick="hideEditAbandonedCartModal()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-button-md font-medium text-foreground shadow-sm transition hover:bg-accent">
            Ø¥Ù„ØºØ§Ø¡
          </button>
          <button onclick="saveAbandonedCartSettings()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
            <i data-lucide="save" class="h-4 w-4"></i>
            <span>Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal: Create New Automation -->
  <div id="create-automation-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div>
            <h2 class="text-heading-lg font-bold">Ø¥Ù†Ø´Ø§Ø¡ Ø£ØªÙ…ØªØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <p class="text-body-sm text-muted-foreground mt-1">Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø¯Ø« Ù…Ø¹ÙŠÙ†</p>
          </div>
          <button onclick="hideCreateAutomationModal()" class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="x" class="h-5 w-5"></i>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-6">
          
          <!-- Automation Name -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">Ø§Ø³Ù… Ø§Ù„Ø£ØªÙ…ØªØ©</label>
            <input type="text" id="automation-name" placeholder="Ù…Ø«Ø§Ù„: ØªØ°ÙƒÙŠØ± Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
          </div>

          <!-- Trigger Selection -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù…ÙØ´ØºÙ‘Ù„</label>
            <p class="text-body-sm text-muted-foreground">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø°ÙŠ Ø³ÙŠÙØ´ØºÙ‘Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø£ØªÙ…ØªØ©</p>
            <select id="trigger-select" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¯Ø«...</option>
              <option value="abandoned_cart">Ø³Ù„Ø© Ù…ØªØ±ÙˆÙƒØ©</option>
              <option value="new_order">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</option>
              <option value="order_shipped">Ø´Ø­Ù† Ø§Ù„Ø·Ù„Ø¨</option>
              <option value="order_delivered">ØªÙˆØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</option>
              <option value="new_customer">Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</option>
            </select>
          </div>

          <!-- Template Selection -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <select id="new-automation-template" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨...</option>
            </select>
          </div>

          <!-- Timing Selection -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>
            <select id="new-automation-timing" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="0">ÙÙˆØ±ÙŠ</option>
              <option value="5">Ø¨Ø¹Ø¯ 5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
              <option value="15">Ø¨Ø¹Ø¯ 15 Ø¯Ù‚ÙŠÙ‚Ø©</option>
              <option value="30">Ø¨Ø¹Ø¯ 30 Ø¯Ù‚ÙŠÙ‚Ø©</option>
              <option value="60">Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø©</option>
              <option value="120">Ø¨Ø¹Ø¯ Ø³Ø§Ø¹ØªÙŠÙ†</option>
              <option value="1440">Ø¨Ø¹Ø¯ 24 Ø³Ø§Ø¹Ø©</option>
            </select>
          </div>

        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 border-t border-border p-6">
          <button onclick="hideCreateAutomationModal()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-button-md font-medium text-foreground shadow-sm transition hover:bg-accent">
            Ø¥Ù„ØºØ§Ø¡
          </button>
          <button onclick="createAutomation()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
            <i data-lucide="plus" class="h-4 w-4"></i>
            <span>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ØªÙ…ØªØ©</span>
          </button>
        </div>

      </div>
    </div>
  </div>

  <script>
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (!localStorage.getItem('tchat_logged_in')) {
      window.location.href = './login.html';
    }

    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    let allTemplates = [];
    let automations = [];
    let abandonedCartSettings = {
      id: 0,
      templateName: 'cart_1',
      templateLanguage: 'ar',
      delayMinutes: 0,
      isActive: true,
      preventDuplicate: true,
      skipPurchased: true
    };

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', async () => {
      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù‡ÙŠØ¯Ø±
      renderHeader('header-container', { activePage: 'automations' });
      lucide.createIcons();
      await Promise.all([
        loadTemplates(),
        loadAutomations(),
        loadAbandonedCartSettings(),
        loadStats()
      ]);
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ù…Ù† API
    async function loadTemplates() {
      try {
        const response = await apiRequest('/meta/templates?limit=100');
        if (response && response.data) {
          allTemplates = response.data.filter(t => t.status === 'APPROVED');
          populateTemplateSelects();
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨:', error);
        showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨', 'error');
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† API
    async function loadStats() {
      try {
        const response = await apiRequest('/automations/stats');
        if (response && response.success && response.data) {
          const stats = response.data;
          document.getElementById('active-automations-count').textContent = stats.active_automations || 0;
          document.getElementById('total-sent-count').textContent = stats.total_sent || 0;
          document.getElementById('total-carts-count').textContent = stats.total_carts || 0;
          const conversionRate = stats.conversion_rate || 0;
          document.getElementById('conversion-rate').textContent = conversionRate.toFixed(1) + '%';
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
      }
    }

    // Ù…Ù„Ø¡ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨
    function populateTemplateSelects() {
      const selects = ['template-select', 'new-automation-template'];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨...</option>';
        
        allTemplates.forEach(template => {
          const langText = template.language === 'ar' ? 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©';
          const option = document.createElement('option');
          option.value = template.name;
          option.textContent = `${template.name} (${langText})`;
          option.dataset.template = JSON.stringify(template);
          select.appendChild(option);
        });
      });

      // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚Ø§Ù„Ø¨
      const templateSelect = document.getElementById('template-select');
      if (templateSelect) {
        templateSelect.addEventListener('change', showTemplatePreview);
      }
    }

    // Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚Ø§Ù„Ø¨
    function showTemplatePreview() {
      const select = document.getElementById('template-select');
      const preview = document.getElementById('template-preview');
      const previewContent = document.getElementById('template-preview-content');
      
      const selectedOption = select.options[select.selectedIndex];
      if (!selectedOption.value || !selectedOption.dataset.template) {
        preview.classList.add('hidden');
        return;
      }

      const template = JSON.parse(selectedOption.dataset.template);
      const components = template.components || [];
      
      let previewText = '';
      components.forEach(comp => {
        if (comp.type === 'HEADER' && comp.text) {
          previewText += `ğŸ“Œ ${comp.text}\n\n`;
        }
        if (comp.type === 'BODY' && comp.text) {
          previewText += comp.text + '\n\n';
        }
        if (comp.type === 'FOOTER' && comp.text) {
          previewText += `â€”\n${comp.text}`;
        }
      });

      previewContent.textContent = previewText || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…ØªØ§Ø­Ø©';
      preview.classList.remove('hidden');
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØªÙ…ØªØ§Øª Ù…Ù† API Ù…Ø¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
    async function loadAutomations() {
      try {
        const response = await apiRequest('/automations/with-stats');
        if (response && response.success && response.data) {
          automationsWithStats = response.data;
        }
        renderAutomationsWithStats();
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØªÙ…ØªØ§Øª:', error);
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        try {
          const fallback = await apiRequest('/automations');
          if (fallback && fallback.success && fallback.data) {
            automations = fallback.data;
            renderAutomations();
          }
        } catch (e) {
          renderAutomations();
        }
      }
    }

    let automationsWithStats = [];

    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ© Ù…Ù† API
    async function loadAbandonedCartSettings() {
      try {
        const response = await apiRequest('/automations/trigger/abandoned_cart');
        if (response && response.success && response.data) {
          const data = response.data;
          abandonedCartSettings = {
            id: data.id,
            templateName: data.template_name,
            templateLanguage: data.template_language || 'ar',
            delayMinutes: data.delay_minutes || 0,
            isActive: data.is_active,
            preventDuplicate: data.prevent_duplicate,
            skipPurchased: data.skip_purchased
          };
        }
        updateCurrentSettingsDisplay();
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©:', error);
        updateCurrentSettingsDisplay(); // Ø¹Ø±Ø¶ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    function updateCurrentSettingsDisplay() {
      document.getElementById('current-template-name').textContent = abandonedCartSettings.templateName;
      
      const timingText = getTimingText(abandonedCartSettings.delayMinutes);
      document.getElementById('current-send-time').textContent = timingText;
      
      const statusEl = document.getElementById('current-status');
      const toggleBtn = document.getElementById('toggle-status-btn');
      
      if (abandonedCartSettings.isActive) {
        statusEl.textContent = 'Ù…ÙØ¹Ù‘Ù„';
        statusEl.className = 'mt-1 text-body-md font-semibold text-success';
        toggleBtn.innerHTML = '<i data-lucide="pause" class="h-4 w-4"></i><span>Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</span>';
      } else {
        statusEl.textContent = 'Ù…ØªÙˆÙ‚Ù';
        statusEl.className = 'mt-1 text-body-md font-semibold text-destructive';
        toggleBtn.innerHTML = '<i data-lucide="play" class="h-4 w-4"></i><span>ØªÙØ¹ÙŠÙ„</span>';
      }
      
      lucide.createIcons();
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Øµ Ø§Ù„ÙˆÙ‚Øª
    function getTimingText(minutes) {
      if (minutes === 0) return 'ÙÙˆØ±ÙŠ';
      if (minutes < 60) return `Ø¨Ø¹Ø¯ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
      if (minutes === 60) return 'Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø©';
      if (minutes < 1440) return `Ø¨Ø¹Ø¯ ${minutes / 60} Ø³Ø§Ø¹Ø§Øª`;
      return `Ø¨Ø¹Ø¯ ${minutes / 1440} ÙŠÙˆÙ…`;
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø£ØªÙ…ØªØ§Øª (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
    function renderAutomations() {
      const container = document.getElementById('automations-list');
      
      // Ø£ØªÙ…ØªØ© Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      const abandonedCartAutomation = `
        <div class="rounded-lg border border-border bg-background p-4 transition hover:shadow-md">
          <div class="flex items-start justify-between">
            <div class="flex items-start gap-4">
              <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-warning/10">
                <i data-lucide="shopping-cart" class="h-6 w-6 text-warning"></i>
              </div>
              <div>
                <div class="flex items-center gap-2">
                  <h3 class="text-heading-sm font-semibold text-foreground">ØªØ°ÙƒÙŠØ± Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©</h3>
                  <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${abandonedCartSettings.isActive ? 'bg-success/10 text-success' : 'bg-destructive/10 text-destructive'}">
                    ${abandonedCartSettings.isActive ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…ØªÙˆÙ‚Ù'}
                  </span>
                </div>
                <p class="mt-1 text-body-sm text-muted-foreground">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</p>
                <div class="mt-2 flex items-center gap-4 text-body-xs text-muted-foreground">
                  <span class="flex items-center gap-1">
                    <i data-lucide="file-text" class="h-3 w-3"></i>
                    ${abandonedCartSettings.templateName}
                  </span>
                  <span class="flex items-center gap-1">
                    <i data-lucide="clock" class="h-3 w-3"></i>
                    ${getTimingText(abandonedCartSettings.delayMinutes)}
                  </span>
                </div>
              </div>
            </div>
            <button onclick="showEditAbandonedCartModal()" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
              <i data-lucide="settings" class="h-4 w-4"></i>
            </button>
          </div>
        </div>
      `;

      container.innerHTML = abandonedCartAutomation;
      lucide.createIcons();
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ÙØ´ØºÙ‘Ù„
    function getTriggerIcon(triggerType) {
      const icons = {
        'abandoned_cart': 'shopping-cart',
        'new_order': 'package',
        'order_shipped': 'truck',
        'order_delivered': 'check-circle',
        'new_customer': 'user-plus',
        'browse_abandonment': 'eye',
        'review_request': 'star'
      };
      return icons[triggerType] || 'zap';
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù„ÙˆÙ† Ø§Ù„Ù…ÙØ´ØºÙ‘Ù„
    function getTriggerColor(triggerType) {
      const colors = {
        'abandoned_cart': 'warning',
        'new_order': 'primary',
        'order_shipped': 'accent',
        'order_delivered': 'success',
        'new_customer': 'primary',
        'browse_abandonment': 'warning',
        'review_request': 'accent'
      };
      return colors[triggerType] || 'primary';
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…ÙØ´ØºÙ‘Ù„ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
    function getTriggerName(triggerType) {
      const names = {
        'abandoned_cart': 'Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©',
        'new_order': 'Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯',
        'order_shipped': 'Ø´Ø­Ù† Ø§Ù„Ø·Ù„Ø¨',
        'order_delivered': 'ØªÙˆØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨',
        'new_customer': 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯',
        'browse_abandonment': 'ØªØ±Ùƒ ØªØµÙØ­ Ø§Ù„Ù…ØªØ¬Ø±',
        'review_request': 'Ø·Ù„Ø¨ ØªÙ‚ÙŠÙŠÙ…'
      };
      return names[triggerType] || triggerType;
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø£ØªÙ…ØªØ§Øª Ù…Ø¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© (Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±Ø¦ÙŠ)
    function renderAutomationsWithStats() {
      const container = document.getElementById('automations-list');
      
      if (!automationsWithStats || automationsWithStats.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-muted-foreground">
            <i data-lucide="workflow" class="h-12 w-12 mx-auto mb-4 opacity-50"></i>
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù…Ù„Ø§Øª Ù…Ø¤ØªÙ…ØªØ© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      container.innerHTML = automationsWithStats.map(automation => {
        const triggerIcon = getTriggerIcon(automation.trigger_type);
        const triggerColor = getTriggerColor(automation.trigger_type);
        const triggerName = getTriggerName(automation.trigger_type);
        
        // Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
        const step1 = automation.steps && automation.steps[0] ? automation.steps[0] : {
          sent: 0, delivered: 0, read: 0, replied: 0, clicked: 0, failed: 0, waiting: 0, skipped: 0
        };

        return `
          <div class="rounded-xl border border-border bg-card overflow-hidden">
            
            <!-- Ø§Ù„Ù…ÙØ´ØºÙ‘Ù„ (Trigger) -->
            <div class="bg-muted/30 border-b border-border p-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-${triggerColor}/10">
                    <i data-lucide="${triggerIcon}" class="h-5 w-5 text-${triggerColor}"></i>
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="text-body-xs text-muted-foreground">Ø§Ù„Ù…ÙØ´ØºÙ‘Ù„</span>
                      <i data-lucide="star" class="h-3 w-3 text-muted-foreground"></i>
                    </div>
                    <h3 class="text-body-md font-semibold">${triggerName}</h3>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${automation.is_active ? 'bg-success/10 text-success' : 'bg-destructive/10 text-destructive'}">
                    ${automation.is_active ? 'ÙØ¹Ù‘Ø§Ù„' : 'Ù…ØªÙˆÙ‚Ù'}
                  </span>
                  <button onclick="showEditAbandonedCartModal()" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
                    <i data-lucide="settings" class="h-4 w-4"></i>
                  </button>
                </div>
              </div>
              <div class="mt-3 flex items-center gap-2 text-body-sm text-muted-foreground">
                <span>Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¯Ø£ÙˆØ§ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©</span>
                <span class="inline-flex items-center justify-center rounded-md bg-primary/10 text-primary px-2 py-0.5 text-body-sm font-bold number">${automation.total_started || 0}</span>
              </div>
            </div>

            <!-- Ø®Ø· Ø§Ù„Ø±Ø¨Ø· -->
            <div class="flex justify-center py-2">
              <div class="w-0.5 h-6 bg-primary"></div>
            </div>

            <!-- Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù‚Ø§Ù„Ø¨ -->
            <div class="mx-4 mb-4 rounded-lg border-2 border-warning bg-warning/5 overflow-hidden">
              <div class="bg-warning text-warning-foreground px-4 py-3 flex items-center gap-2">
                <i data-lucide="send" class="h-4 w-4"></i>
                <span class="font-semibold">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù‚Ø§Ù„Ø¨</span>
              </div>
              
              <div class="p-4 space-y-4">
                <!-- ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ§Ù„Ù‚Ø§Ù„Ø¨ -->
                <div class="flex items-center justify-between text-body-sm">
                  <div class="flex items-center gap-2 text-muted-foreground">
                    <i data-lucide="clock" class="h-4 w-4"></i>
                    <span>Ø§Ù†ØªØ¸Ø± ${getTimingText(step1.delay_minutes || abandonedCartSettings.delayMinutes)}</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-muted-foreground">Ø«Ù… Ø£Ø±Ø³Ù„</span>
                    <span class="inline-flex items-center rounded-md border border-input bg-background px-2 py-1 text-body-sm font-medium">
                      <i data-lucide="file-text" class="h-3 w-3 ml-1"></i>
                      ${step1.template_name || abandonedCartSettings.templateName}
                    </span>
                  </div>
                </div>

                <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± -->
                <div class="flex items-center gap-4 text-body-sm">
                  <div class="flex items-center gap-2">
                    <span class="text-muted-foreground">Ø¨Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>
                    <span class="inline-flex items-center justify-center rounded-md bg-muted px-2 py-0.5 text-body-sm font-bold number">${step1.waiting || 0}</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-muted-foreground">ØªØ®Ø·Ù‘ÙˆØ§ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</span>
                    <span class="inline-flex items-center justify-center rounded-md bg-muted px-2 py-0.5 text-body-sm font-bold number">${step1.skipped || 0}</span>
                  </div>
                </div>

                <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© -->
                <div class="pt-4 border-t border-border">
                  <h4 class="text-body-sm font-semibold text-muted-foreground mb-3">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø®Ø·ÙˆØ© Ù…Ù†Ø° Ø§Ù„Ø¨Ø¯Ø¡</h4>
                  <div class="grid grid-cols-3 md:grid-cols-6 gap-3">
                    <div class="text-center">
                      <div class="inline-flex items-center justify-center rounded-lg bg-blue-100 text-blue-800 px-3 py-1.5 text-body-md font-bold number">${step1.sent || 0}</div>
                      <div class="text-body-xs text-muted-foreground mt-1">Ø£ÙØ±Ø³Ù„Øª</div>
                    </div>
                    <div class="text-center">
                      <div class="inline-flex items-center justify-center rounded-lg bg-green-100 text-green-800 px-3 py-1.5 text-body-md font-bold number">${step1.delivered || 0}</div>
                      <div class="text-body-xs text-muted-foreground mt-1">ÙˆØµÙ„Øª</div>
                    </div>
                    <div class="text-center">
                      <div class="inline-flex items-center justify-center rounded-lg bg-purple-100 text-purple-800 px-3 py-1.5 text-body-md font-bold number">${step1.read || 0}</div>
                      <div class="text-body-xs text-muted-foreground mt-1">Ù‚ÙØ±Ø¦Øª</div>
                    </div>
                    <div class="text-center">
                      <div class="inline-flex items-center justify-center rounded-lg bg-indigo-100 text-indigo-800 px-3 py-1.5 text-body-md font-bold number">${step1.replied || 0}</div>
                      <div class="text-body-xs text-muted-foreground mt-1">Ø±ÙØ¯ Ø¹Ù„ÙŠÙ‡Ø§</div>
                    </div>
                    <div class="text-center">
                      <div class="inline-flex items-center justify-center rounded-lg bg-pink-100 text-pink-800 px-3 py-1.5 text-body-md font-bold number">${step1.clicked || 0}</div>
                      <div class="text-body-xs text-muted-foreground mt-1">Ù†ÙÙ‚Ø± Ø¹Ù„ÙŠÙ‡</div>
                    </div>
                    <div class="text-center">
                      <div class="inline-flex items-center justify-center rounded-lg bg-red-100 text-red-800 px-3 py-1.5 text-body-md font-bold number">${step1.failed || 0}</div>
                      <div class="text-body-xs text-muted-foreground mt-1">Ø§Ø±ØªØ¯Øª</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Ø®Ø· Ø§Ù„Ø±Ø¨Ø· -->
            <div class="flex justify-center py-2">
              <div class="w-0.5 h-6 bg-success"></div>
            </div>

            <!-- Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: Ø£ÙƒÙ…Ù„ -->
            <div class="mx-4 mb-4 rounded-lg border-2 border-success bg-success/5 overflow-hidden">
              <div class="bg-success text-success-foreground px-4 py-3 flex items-center gap-2">
                <i data-lucide="check" class="h-4 w-4"></i>
                <span class="font-semibold">Ø£ÙƒÙ…Ù„</span>
              </div>
              <div class="p-4 text-center">
                <div class="inline-flex items-center justify-center rounded-lg bg-success/10 text-success px-4 py-2 text-heading-md font-bold number">${automation.total_completed || 0}</div>
                <div class="text-body-sm text-muted-foreground mt-2">Ø¹Ù…Ù„Ø§Ø¡ Ù‚Ø¯ Ø£ÙƒÙ…Ù„ÙˆØ§ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©</div>
              </div>
            </div>

          </div>
        `;
      }).join('');

      lucide.createIcons();
    }

    // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©
    function showEditAbandonedCartModal() {
      const modal = document.getElementById('edit-abandoned-cart-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      document.getElementById('template-select').value = abandonedCartSettings.templateName;
      document.getElementById('timing-select').value = abandonedCartSettings.delayMinutes;
      document.getElementById('prevent-duplicate').checked = abandonedCartSettings.preventDuplicate;
      document.getElementById('skip-purchased').checked = abandonedCartSettings.skipPurchased;
      
      showTemplatePreview();
      lucide.createIcons();
    }

    // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©
    function hideEditAbandonedCartModal() {
      const modal = document.getElementById('edit-abandoned-cart-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©
    async function saveAbandonedCartSettings() {
      const templateName = document.getElementById('template-select').value;
      const delayMinutes = parseInt(document.getElementById('timing-select').value);
      const preventDuplicate = document.getElementById('prevent-duplicate').checked;
      const skipPurchased = document.getElementById('skip-purchased').checked;

      if (!templateName) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø§Ù„Ø¨', 'error');
        return;
      }

      // ØªØ­Ø¯ÙŠØ¯ Ù„ØºØ© Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±
      const templateSelect = document.getElementById('template-select');
      const selectedOption = templateSelect.options[templateSelect.selectedIndex];
      let templateLanguage = 'ar';
      if (selectedOption.dataset.template) {
        const template = JSON.parse(selectedOption.dataset.template);
        templateLanguage = template.language || 'ar';
      }

      const payload = {
        template_name: templateName,
        template_language: templateLanguage,
        delay_minutes: delayMinutes,
        is_active: abandonedCartSettings.isActive,
        prevent_duplicate: preventDuplicate,
        skip_purchased: skipPurchased
      };

      try {
        // Ø­ÙØ¸ ÙÙŠ API
        const response = await apiRequest(`/automations/${abandonedCartSettings.id}`, 'PUT', payload);
        
        if (response && response.success) {
          abandonedCartSettings = {
            ...abandonedCartSettings,
            templateName,
            templateLanguage,
            delayMinutes,
            preventDuplicate,
            skipPurchased
          };

          hideEditAbandonedCartModal();
          updateCurrentSettingsDisplay();
          renderAutomations();
          showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } else {
          showToast(response?.message || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'error');
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
        showToast('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'error');
      }
    }

    // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©
    async function toggleAbandonedCartStatus() {
      try {
        const response = await apiRequest(`/automations/${abandonedCartSettings.id}/toggle`, 'POST');
        
        if (response && response.success) {
          abandonedCartSettings.isActive = response.is_active;
          updateCurrentSettingsDisplay();
          renderAutomations();
          loadStats();
          
          const message = abandonedCartSettings.isActive ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ØªÙ…ØªØ©' : 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø£ØªÙ…ØªØ©';
          showToast(message, 'success');
        } else {
          showToast(response?.message || 'ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©', 'error');
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©:', error);
        showToast('ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©', 'error');
      }
    }

    // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø£ØªÙ…ØªØ© Ø¬Ø¯ÙŠØ¯Ø©
    function showCreateAutomationModal() {
      const modal = document.getElementById('create-automation-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
      document.getElementById('automation-name').value = '';
      document.getElementById('trigger-select').value = '';
      document.getElementById('new-automation-template').value = '';
      document.getElementById('new-automation-timing').value = '0';
      lucide.createIcons();
    }

    // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø£ØªÙ…ØªØ© Ø¬Ø¯ÙŠØ¯Ø©
    function hideCreateAutomationModal() {
      const modal = document.getElementById('create-automation-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø£ØªÙ…ØªØ© Ø¬Ø¯ÙŠØ¯Ø©
    async function createAutomation() {
      const name = document.getElementById('automation-name').value.trim();
      const trigger = document.getElementById('trigger-select').value;
      const template = document.getElementById('new-automation-template').value;
      const timing = parseInt(document.getElementById('new-automation-timing').value) || 0;

      if (!name || !trigger || !template) {
        showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
      }

      // ØªØ­Ø¯ÙŠØ¯ Ù„ØºØ© Ø§Ù„Ù‚Ø§Ù„Ø¨
      const templateSelect = document.getElementById('new-automation-template');
      const selectedOption = templateSelect.options[templateSelect.selectedIndex];
      let templateLanguage = 'ar';
      if (selectedOption.dataset.template) {
        const templateData = JSON.parse(selectedOption.dataset.template);
        templateLanguage = templateData.language || 'ar';
      }

      const payload = {
        name: name,
        trigger_type: trigger,
        template_name: template,
        template_language: templateLanguage,
        delay_minutes: timing,
        is_active: true,
        prevent_duplicate: true,
        skip_purchased: true
      };

      try {
        const response = await apiRequest('/automations', 'POST', payload);
        
        if (response && response.success) {
          hideCreateAutomationModal();
          await loadAutomations();
          await loadStats();
          showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ØªÙ…ØªØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } else {
          showToast(response?.message || 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ØªÙ…ØªØ©', 'error');
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ØªÙ…ØªØ©:', error);
        showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ØªÙ…ØªØ©', 'error');
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØªÙ…ØªØ§Øª
    async function refreshAutomations() {
      await Promise.all([loadAutomations(), loadAbandonedCartSettings(), loadStats()]);
      showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'success');
    }

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Toast
    function showToast(message, type = 'info') {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Toast
      const toast = document.createElement('div');
      toast.className = `fixed bottom-4 left-4 z-50 rounded-lg px-4 py-3 shadow-lg transition-all duration-300 transform translate-y-full opacity-0`;
      
      if (type === 'success') {
        toast.classList.add('bg-success', 'text-white');
      } else if (type === 'error') {
        toast.classList.add('bg-destructive', 'text-white');
      } else {
        toast.classList.add('bg-primary', 'text-white');
      }
      
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // Ø¥Ø¸Ù‡Ø§Ø±
      setTimeout(() => {
        toast.classList.remove('translate-y-full', 'opacity-0');
      }, 10);
      
      // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
      setTimeout(() => {
        toast.classList.add('translate-y-full', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>
