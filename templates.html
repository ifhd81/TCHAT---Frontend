<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TCHAT - القوالب</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="./api.js"></script>
  <script src="./components/header.js"></script>
</head>
<body class="rtl min-h-screen bg-background" style="font-family: 'LamaSans', sans-serif;">
  <!-- Header Container -->
  <div id="header-container"></div>

  <!-- Template Preview Modal -->
  <div id="template-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="closeTemplateModal()"></div>
    <div class="fixed inset-4 md:inset-auto md:left-1/2 md:top-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[420px] md:max-h-[85vh] bg-card rounded-2xl shadow-2xl overflow-hidden flex flex-col">
      <!-- Modal Header -->
      <div class="flex items-center justify-between px-4 py-3 border-b border-border bg-muted/30">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full bg-[#25D366] flex items-center justify-center">
            <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
          </div>
          <div>
            <div id="modal-template-name" class="text-sm font-semibold text-foreground"></div>
            <div id="modal-template-lang" class="text-[10px] text-muted-foreground"></div>
          </div>
        </div>
        <button onclick="closeTemplateModal()" class="w-8 h-8 rounded-full hover:bg-muted flex items-center justify-center transition-colors">
          <i data-lucide="x" class="w-4 h-4 text-muted-foreground"></i>
        </button>
      </div>
      
      <!-- WhatsApp Chat Background -->
      <div class="flex-1 overflow-y-auto p-4" style="background-color: #e5ddd5; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwgAADsIBFShKgAAAABl0RVh0U29mdHdhcmUAcGFpbnQubmV0IDQuMC4xMkMEa+wAAABZSURBVGhD7c4xDQAwDMCw8v/n8hSfEFBT+pNktu/P7D6j/RntN9pvtN9ov9F+o/1G+432G+032m+032i/0X6j/Ub7jfYb7Tfab7TfaL/RfqP9RvuN9pt2km8JwJ4zGtJUHAAAAABJRU5ErkJggg==');">
        <div id="modal-message-preview" class="max-w-[85%] mr-auto"></div>
      </div>
      
      <!-- Modal Footer -->
      <div class="px-4 py-3 border-t border-border bg-muted/30">
        <div class="flex items-center justify-between text-[10px] text-muted-foreground">
          <span id="modal-template-category"></span>
          <span id="modal-template-status"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Template Modal - Smart Version -->
  <div id="create-template-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="closeCreateModal()"></div>
    <div class="fixed inset-2 md:inset-auto md:left-1/2 md:top-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[900px] md:max-h-[92vh] bg-card rounded-2xl shadow-2xl overflow-hidden flex flex-col">
      <!-- Modal Header -->
      <div class="flex items-center justify-between px-5 py-4 border-b border-border bg-muted/30">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
            <i data-lucide="plus" class="w-5 h-5 text-primary"></i>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-foreground">إنشاء قالب جديد</h3>
            <p class="text-xs text-muted-foreground">سيتم مراجعة القالب من Meta قبل الموافقة (24 ساعة تقريباً)</p>
          </div>
        </div>
        <button onclick="closeCreateModal()" class="w-8 h-8 rounded-full hover:bg-muted flex items-center justify-center transition-colors">
          <i data-lucide="x" class="w-4 h-4 text-muted-foreground"></i>
        </button>
      </div>
      
      <!-- Modal Body - Two Columns -->
      <div class="flex-1 overflow-hidden flex">
        <!-- Left Column: Form -->
        <div class="flex-1 overflow-y-auto p-5 space-y-4 border-l border-border">
          <!-- Validation Errors -->
          <div id="validation-errors" class="hidden p-3 rounded-lg bg-destructive/10 border border-destructive/20 text-sm text-destructive space-y-1"></div>

          <!-- اسم القالب -->
          <div class="space-y-1.5">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium text-foreground">اسم القالب <span class="text-destructive">*</span></label>
              <span id="name-counter" class="text-[10px] text-muted-foreground">0/512</span>
            </div>
            <input type="text" id="template-name" placeholder="welcome_message" maxlength="512"
              oninput="sanitizeTemplateName(); updateCounter('template-name', 'name-counter', 512); updateLivePreview();"
              onkeydown="return validateTemplateNameKey(event);"
              class="w-full rounded-lg border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring font-mono lowercase" 
              dir="ltr" autocomplete="off" autocapitalize="off" />
            <p id="name-hint" class="text-[10px] text-muted-foreground">أحرف إنجليزية صغيرة (a-z)، أرقام (0-9)، شرطات سفلية (_) فقط</p>
          </div>

          <!-- فئة ولغة القالب -->
          <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1.5">
              <label class="text-sm font-medium text-foreground">الفئة <span class="text-destructive">*</span></label>
              <select id="template-category" onchange="updateLivePreview()" class="w-full rounded-lg border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring">
                <option value="">اختر الفئة</option>
                <option value="MARKETING">تسويق (Marketing)</option>
                <option value="UTILITY">خدمات (Utility)</option>
                <option value="AUTHENTICATION">تحقق (Authentication)</option>
              </select>
            </div>
            <div class="space-y-1.5">
              <label class="text-sm font-medium text-foreground">اللغة <span class="text-destructive">*</span></label>
              <select id="template-language" onchange="updateLivePreview()" class="w-full rounded-lg border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring">
                <option value="ar">العربية (ar)</option>
                <option value="en">الإنجليزية (en)</option>
                <option value="en_US">English - US (en_US)</option>
              </select>
            </div>
          </div>

          <hr class="border-border" />

          <!-- الترويسة -->
          <div class="space-y-2">
            <label class="text-sm font-medium text-foreground">الترويسة (اختياري)</label>
            <select id="header-type" onchange="toggleHeaderInput(); updateLivePreview();" class="w-full rounded-lg border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring">
              <option value="none">بدون ترويسة</option>
              <option value="TEXT">نص (حتى 60 حرف)</option>
              <option value="IMAGE">صورة</option>
              <option value="VIDEO">فيديو</option>
              <option value="DOCUMENT">مستند PDF</option>
            </select>
          </div>

          <!-- نص الترويسة -->
          <div id="header-text-container" class="space-y-1.5 hidden">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium text-foreground">نص الترويسة</label>
              <span id="header-counter" class="text-[10px] text-muted-foreground">0/60</span>
            </div>
            <input type="text" id="header-text" placeholder="عنوان الرسالة" maxlength="60"
              oninput="updateCounter('header-text', 'header-counter', 60); updateLivePreview();"
              class="w-full rounded-lg border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring" />
            <p class="text-[10px] text-muted-foreground">يدعم متغير واحد فقط {{1}}</p>
          </div>

          <!-- رفع ملف الترويسة (صورة/فيديو/مستند) -->
          <div id="header-media-container" class="space-y-2 hidden">
            <label class="text-sm font-medium text-foreground flex items-center gap-2">
              <i data-lucide="upload" class="w-4 h-4 text-muted-foreground"></i>
              <span id="header-media-label">رفع الصورة</span>
            </label>
            <div id="header-media-upload" class="border-2 border-dashed border-border rounded-lg p-4 text-center hover:border-primary/50 hover:bg-muted/30 transition-colors cursor-pointer" onclick="document.getElementById('header-media-input').click()">
              <input type="file" id="header-media-input" class="hidden" accept="image/*" onchange="handleMediaUpload(event)" />
              <div id="header-media-preview" class="hidden">
                <img id="header-media-preview-img" class="max-h-32 mx-auto rounded-lg mb-2" />
                <p id="header-media-filename" class="text-xs text-muted-foreground"></p>
              </div>
              <div id="header-media-placeholder">
                <div class="w-12 h-12 mx-auto mb-2 rounded-full bg-muted/50 flex items-center justify-center">
                  <i data-lucide="image-plus" class="w-6 h-6 text-muted-foreground"></i>
                </div>
                <p class="text-sm text-muted-foreground">اضغط لاختيار ملف أو اسحب الملف هنا</p>
                <p id="header-media-formats" class="text-[10px] text-muted-foreground mt-1">PNG, JPG, JPEG (حتى 5MB)</p>
              </div>
            </div>
            <p class="text-[10px] text-muted-foreground bg-warning/10 px-2 py-1 rounded flex items-center gap-1">
              <i data-lucide="info" class="w-3 h-3"></i>
              <span>الملف مطلوب لإرسال القالب للمراجعة من Meta</span>
            </p>
          </div>

          <!-- محتوى الرسالة -->
          <div class="space-y-1.5">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium text-foreground">محتوى الرسالة <span class="text-destructive">*</span></label>
              <span id="body-counter" class="text-[10px] text-muted-foreground">0/1024</span>
            </div>
            <textarea id="body-text" rows="4" placeholder="مرحباً {{1}}، شكراً لتسجيلك معنا! رقم طلبك هو {{2}}." maxlength="1024"
              oninput="updateCounter('body-text', 'body-counter', 1024); detectVariables(); updateLivePreview();"
              class="w-full rounded-lg border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring resize-none"></textarea>
            <p class="text-[10px] text-muted-foreground">
              استخدم <code class="bg-muted px-1 rounded">{{1}}</code> <code class="bg-muted px-1 rounded">{{2}}</code> للمتغيرات | 
              <code class="bg-muted px-1 rounded">*نص*</code> للخط العريض | 
              <code class="bg-muted px-1 rounded">_نص_</code> للمائل
            </p>
          </div>

          <!-- أمثلة المتغيرات -->
          <div id="variables-container" class="space-y-2 hidden">
            <label class="text-sm font-medium text-foreground flex items-center gap-2">
              <i data-lucide="variable" class="w-4 h-4 text-primary"></i>
              أمثلة المتغيرات <span class="text-destructive">*</span>
            </label>
            <div id="variables-inputs" class="space-y-2"></div>
            <p class="text-[10px] text-muted-foreground bg-warning/10 px-2 py-1 rounded">مطلوبة للموافقة من Meta - ستُستخدم كأمثلة أثناء المراجعة</p>
          </div>

          <!-- التذييل -->
          <div class="space-y-1.5">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium text-foreground">التذييل (اختياري)</label>
              <span id="footer-counter" class="text-[10px] text-muted-foreground">0/60</span>
            </div>
            <input type="text" id="footer-text" placeholder="للإلغاء أرسل STOP" maxlength="60"
              oninput="updateCounter('footer-text', 'footer-counter', 60); updateLivePreview();"
              class="w-full rounded-lg border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring" />
          </div>

          <hr class="border-border" />

          <!-- الأزرار -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium text-foreground flex items-center gap-2">
                <i data-lucide="mouse-pointer-click" class="w-4 h-4 text-muted-foreground"></i>
                الأزرار (اختياري)
              </label>
              <button type="button" onclick="addButton()" id="add-button-btn" class="text-xs text-primary hover:underline flex items-center gap-1">
                <i data-lucide="plus" class="w-3 h-3"></i>
                إضافة زر
              </button>
            </div>
            <div id="buttons-container" class="space-y-2"></div>
            <div id="buttons-info" class="text-[10px] text-muted-foreground bg-muted/50 px-2 py-1.5 rounded space-y-0.5">
              <div><strong>الحدود:</strong> 10 أزرار كحد أقصى (2 URL، 1 هاتف، 10 رد سريع)</div>
              <div><strong>ملاحظة:</strong> أزرار الرد السريع يجب أن تكون مجمّعة معاً</div>
            </div>
          </div>
        </div>

        <!-- Right Column: Live Preview -->
        <div class="w-[320px] flex flex-col bg-muted/20">
          <div class="px-4 py-3 border-b border-border bg-muted/30">
            <h4 class="text-sm font-semibold text-foreground flex items-center gap-2">
              <i data-lucide="eye" class="w-4 h-4 text-muted-foreground"></i>
              معاينة حية
            </h4>
            <p class="text-[10px] text-muted-foreground">كيف سيظهر القالب في WhatsApp</p>
          </div>
          <div class="flex-1 overflow-y-auto p-4" style="background-color: #e5ddd5; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwgAADsIBFShKgAAAABl0RVh0U29mdHdhcmUAcGFpbnQubmV0IDQuMC4xMkMEa+wAAABZSURBVGhD7c4xDQAwDMCw8v/n8hSfEFBT+pNktu/P7D6j/RntN9pvtN9ov9F+o/1G+432G+032m+032i/0X6j/Ub7jfYb7Tfab7TfaL/RfqP9RvuN9pt2km8JwJ4zGtJUHAAAAABJRU5ErkJggg==');">
            <div id="live-preview" class="max-w-full">
              <div class="text-center text-xs text-muted-foreground py-8">
                ابدأ بإدخال محتوى القالب<br/>لرؤية المعاينة الحية
              </div>
            </div>
          </div>
          <!-- Preview Info -->
          <div class="px-4 py-2 border-t border-border bg-muted/30 text-[10px] text-muted-foreground">
            <div class="flex items-center justify-between">
              <span id="preview-category-badge" class="px-2 py-0.5 rounded-full bg-muted">—</span>
              <span id="preview-lang-badge">—</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="px-5 py-3 border-t border-border bg-muted/30 flex items-center justify-between gap-3">
        <div class="flex items-center gap-2 text-xs text-muted-foreground">
          <i data-lucide="info" class="w-4 h-4"></i>
          <span>القوالب تتم مراجعتها من Meta خلال 24 ساعة</span>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="closeCreateModal()" class="px-4 py-2 rounded-lg border border-input bg-background text-sm font-medium hover:bg-muted transition-colors">
            إلغاء
          </button>
          <button onclick="previewBeforeSubmit()" class="px-4 py-2 rounded-lg border border-primary text-primary text-sm font-medium hover:bg-primary/10 transition-colors flex items-center gap-2">
            <i data-lucide="eye" class="w-4 h-4"></i>
            مراجعة
          </button>
          <button onclick="submitTemplate()" id="submit-template-btn" class="px-5 py-2 rounded-lg bg-primary text-primary-foreground text-sm font-medium hover:bg-primary/90 transition-colors flex items-center gap-2">
            <i data-lucide="send" class="w-4 h-4"></i>
            إرسال للمراجعة
          </button>
        </div>
      </div>
    </div>
  </div>

  <main class="container mx-auto px-4 py-8">
    <section class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-heading-lg font-bold text-foreground">القوالب المعتمدة</h1>
        <p class="text-body-sm text-muted-foreground">عرض أحدث قوالب واتساب المعتمدة في حساب Meta</p>
      </div>
      <div class="flex items-center gap-4">
        <button onclick="openCreateModal()" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-primary text-primary-foreground text-sm font-medium hover:bg-primary/90 transition-colors">
          <i data-lucide="plus" class="w-4 h-4"></i>
          إنشاء قالب
        </button>
        <div class="flex items-center gap-2 text-body-sm text-muted-foreground">
          <span>إجمالي القوالب:</span>
          <span id="templates-total" class="text-heading-md font-semibold number">0</span>
        </div>
      </div>
    </section>

    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
      <div class="border-b border-border p-6">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="layout-dashboard" class="h-5 w-5 text-muted-foreground"></i>
            <h2 class="text-heading-md font-semibold">قوالب واتساب</h2>
          </div>
          <div class="flex flex-wrap items-center gap-3 text-body-sm text-muted-foreground">
            <div class="flex items-center gap-2 whitespace-nowrap">
              <span>تصفية حسب اللغة</span>
              <select id="language-filter" class="rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                <option value="all">جميع اللغات</option>
                <option value="ar">العربية</option>
                <option value="en">الإنجليزية</option>
              </select>
            </div>
            <div class="flex items-center gap-2 whitespace-nowrap">
              <span>فئة القالب</span>
              <select id="category-filter" class="rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                <option value="all">جميع الفئات</option>
                <option value="MARKETING">تسويق</option>
                <option value="UTILITY">تنبيهات</option>
                <option value="AUTHENTICATION">تحقق</option>
              </select>
            </div>
            <div class="flex items-center gap-2 whitespace-nowrap">
              <span>عدد السجلات</span>
              <select id="limit-select" class="rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>
        </div>
        <div class="mt-4 flex items-center gap-3 text-body-sm text-muted-foreground">
          <input type="search" id="search-input" placeholder="ابحث باسم القالب..." class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2" />
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full caption-bottom text-sm">
          <thead class="bg-muted/50">
            <tr class="border-b text-right text-[11px] font-semibold text-muted-foreground">
              <th class="px-3 py-2 w-[50%]">القالب</th>
              <th class="px-3 py-2 w-[16%] text-center">اللغة</th>
              <th class="px-3 py-2 w-[17%] text-center">الفئة</th>
              <th class="px-3 py-2 w-[17%] text-center">الحالة</th>
            </tr>
          </thead>
          <tbody id="templates-table-body" class="divide-y divide-border">
            <tr>
              <td colspan="4" class="h-20 text-center text-[12px] text-muted-foreground">جاري تحميل القوالب...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="flex items-center justify-between gap-4 border-t border-border px-4 py-3">
        <div class="text-[11px] text-muted-foreground whitespace-nowrap">صفحة <span id="current-page">1</span> من <span id="total-pages">1</span></div>
        <div class="flex items-center gap-1.5">
          <button id="prev-page" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-2.5 py-1.5 text-[11px] font-medium text-muted-foreground transition-colors disabled:opacity-40 hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2" disabled>
            <i data-lucide="chevron-right" class="h-3.5 w-3.5"></i>
            <span>السابق</span>
          </button>
          <button id="next-page" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-2.5 py-1.5 text-[11px] font-medium text-muted-foreground transition-colors disabled:opacity-40 hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
            <span>التالي</span>
            <i data-lucide="chevron-left" class="h-3.5 w-3.5"></i>
          </button>
        </div>
      </div>
    </div>
  </main>

  <script>
    if (!localStorage.getItem('tchat_logged_in')) {
      window.location.href = './login.html';
    }

    const badgeClass = 'inline-flex items-center justify-center h-5 min-w-[60px] rounded-full border border-input px-2 text-[10px] font-medium';

    let allTemplates = [];
    let filteredTemplates = [];
    let currentPage = 1;
    let pageSize = 50;


    function renderTemplatesPage() {
      const tbody = document.getElementById('templates-table-body');
      if (!filteredTemplates.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="h-20 text-center text-[12px] text-muted-foreground">لا توجد قوالب مطابقة للمعايير الحالية</td></tr>';
        updatePagination();
        return;
      }

      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, filteredTemplates.length);
      const pageItems = filteredTemplates.slice(startIndex, endIndex);

      tbody.innerHTML = pageItems.map(template => {
        const components = Array.isArray(template.components) ? template.components : [];

        const statusClass = `${badgeClass} ${template.status === 'APPROVED' ? 'bg-success/10 text-success' : template.status === 'REJECTED' ? 'bg-destructive/10 text-destructive' : 'bg-warning/10 text-warning'}`;
        const statusText = template.status === 'APPROVED' ? 'معتمد' : template.status === 'REJECTED' ? 'مرفوض' : 'قيد المراجعة';

        const categoryClass = `${badgeClass} ${template.category === 'MARKETING' ? 'bg-primary/10 text-primary' : template.category === 'UTILITY' ? 'bg-muted text-muted-foreground' : template.category === 'AUTHENTICATION' ? 'bg-accent text-accent-foreground' : 'bg-muted text-muted-foreground'}`;
        const categoryText = template.category === 'MARKETING' ? 'تسويق' : template.category === 'UTILITY' ? 'خدمات' : template.category === 'AUTHENTICATION' ? 'تحقق' : template.category || 'غير محدد';
        const languageText = template.language === 'ar' ? 'العربية' : template.language === 'en' ? 'الإنجليزية' : template.language;

        const componentTags = components.length
          ? `<div class="flex flex-wrap items-center gap-0.5">${components.map(component => `<span class="inline-flex items-center rounded px-1 py-px text-[9px] font-medium bg-muted/40 text-muted-foreground/80">${component.type}</span>`).join('')}</div>`
          : '';

        return `
          <tr class="align-middle hover:bg-muted/40 transition-colors cursor-pointer" onclick="openTemplateModal('${template.id}')">
            <td class="px-3 py-2.5">
              <div class="space-y-1">
                <div class="text-[13px] font-semibold text-foreground leading-tight">${template.name}</div>
                <div class="flex flex-wrap items-center gap-x-2 gap-y-1">
                  <span class="text-[10px] text-muted-foreground/60 number font-mono">${template.id}</span>
                  ${componentTags}
                </div>
              </div>
            </td>
            <td class="px-3 py-2.5 text-center align-middle">
              <span class="text-[11px] text-muted-foreground">${languageText}</span>
            </td>
            <td class="px-3 py-2.5 text-center align-middle">
              <span class="${categoryClass}">${categoryText}</span>
            </td>
            <td class="px-3 py-2.5 text-center align-middle">
              <span class="${statusClass}">${statusText}</span>
            </td>
          </tr>
        `;
      }).join('');

      updatePagination();
      lucide.createIcons();
    }

    function updatePagination() {
      const total = filteredTemplates.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      currentPage = Math.min(currentPage, totalPages);

      document.getElementById('current-page').textContent = totalPages ? currentPage : 0;
      document.getElementById('total-pages').textContent = totalPages;
      document.getElementById('templates-total').textContent = total;

      document.getElementById('prev-page').disabled = currentPage <= 1;
      document.getElementById('next-page').disabled = currentPage >= totalPages;
    }

    function applyFilters() {
      const lang = document.getElementById('language-filter').value;
      const category = document.getElementById('category-filter').value;
      const search = document.getElementById('search-input').value.trim().toLowerCase();

      filteredTemplates = allTemplates.filter(template => {
        const matchesLang = lang === 'all' || template.language === lang;
        const matchesCategory = category === 'all' || template.category === category;
        const matchesSearch = !search || template.name.toLowerCase().includes(search);
        return matchesLang && matchesCategory && matchesSearch;
      });

      currentPage = 1;
      renderTemplatesPage();
    }

    async function loadTemplates(limit = 50) {
      const tbody = document.getElementById('templates-table-body');
      tbody.innerHTML = '<tr><td colspan="4" class="h-20 text-center text-[12px] text-muted-foreground">جاري تحميل القوالب...</td></tr>';

      try {
        const templates = await loadMetaTemplates(limit);
        allTemplates = templates || [];
        filteredTemplates = [...allTemplates];
        renderTemplatesPage();
      } catch (error) {
        console.error('خطأ في تحميل القوالب:', error);
        tbody.innerHTML = '<tr><td colspan="4" class="h-20 text-center text-[12px] text-destructive">تعذر تحميل القوالب من Meta</td></tr>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // تهيئة مكون الهيدر
      renderHeader('header-container', { activePage: 'templates' });
      
      lucide.createIcons();

      document.getElementById('language-filter').addEventListener('change', applyFilters);
      document.getElementById('category-filter').addEventListener('change', applyFilters);
      document.getElementById('search-input').addEventListener('input', applyFilters);
      document.getElementById('limit-select').addEventListener('change', (e) => {
        pageSize = Number(e.target.value);
        currentPage = 1;
        renderTemplatesPage();
      });

      document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderTemplatesPage();
        }
      });

      document.getElementById('next-page').addEventListener('click', () => {
        const totalPages = Math.ceil(filteredTemplates.length / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          renderTemplatesPage();
        }
      });

      loadTemplates();
    });

    async function loadMetaTemplates(limit = 50) {
      try {
        const data = await apiRequest(`/meta/templates?limit=${limit}`);
        console.log('استجابة القوالب:', data);
        
        if (data.success && Array.isArray(data.data)) {
          return data.data;
        }
        
        // عرض رسالة الخطأ للمستخدم
        const errorMsg = data.message || data.error || 'خطأ غير معروف';
        console.error('فشل في جلب قوالب Meta:', errorMsg);
        
        const tbody = document.getElementById('templates-table-body');
        tbody.innerHTML = `<tr><td colspan="4" class="h-20 text-center text-[12px] text-destructive">
          <div class="space-y-1">
            <div>فشل في جلب القوالب من Meta</div>
            <div class="text-[11px] text-muted-foreground">${errorMsg}</div>
          </div>
        </td></tr>`;
        
        return [];
      } catch (error) {
        console.error('خطأ في تحميل قوالب Meta:', error);
        return [];
      }
    }

    // دوال Modal لعرض القالب
    function openTemplateModal(templateId) {
      const template = allTemplates.find(t => t.id === templateId);
      if (!template) return;

      const modal = document.getElementById('template-modal');
      const langText = template.language === 'ar' ? 'العربية' : template.language === 'en' ? 'الإنجليزية' : template.language;
      const categoryText = template.category === 'MARKETING' ? 'تسويق' : template.category === 'UTILITY' ? 'خدمات' : template.category === 'AUTHENTICATION' ? 'تحقق' : template.category;
      const statusText = template.status === 'APPROVED' ? 'معتمد ✓' : template.status === 'REJECTED' ? 'مرفوض ✗' : 'قيد المراجعة';

      document.getElementById('modal-template-name').textContent = template.name;
      document.getElementById('modal-template-lang').textContent = langText;
      document.getElementById('modal-template-category').textContent = categoryText;
      document.getElementById('modal-template-status').textContent = statusText;

      // بناء معاينة الرسالة بتصميم واتساب
      const preview = document.getElementById('modal-message-preview');
      preview.innerHTML = renderWhatsAppMessage(template);

      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      lucide.createIcons();
    }

    function closeTemplateModal() {
      const modal = document.getElementById('template-modal');
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // إغلاق المودال بزر Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeTemplateModal();
    });

    function renderWhatsAppMessage(template) {
      const components = Array.isArray(template.components) ? template.components : [];
      
      const header = components.find(c => c.type === 'HEADER');
      const body = components.find(c => c.type === 'BODY');
      const footer = components.find(c => c.type === 'FOOTER');
      const buttons = components.find(c => c.type === 'BUTTONS');

      let html = `<div class="rounded-lg overflow-hidden shadow-sm" style="background-color: #dcf8c6;">`;
      
      // Header
      if (header) {
        if (header.format === 'IMAGE') {
          const imgUrl = header.example?.header_handle?.[0] || '';
          html += `<div class="w-full aspect-video bg-muted/20 flex items-center justify-center overflow-hidden">
            ${imgUrl ? `<img src="${imgUrl}" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<div class=\\'flex flex-col items-center justify-center h-full text-muted-foreground/50\\' dir=\\'ltr\\'><svg class=\\'w-10 h-10\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><rect x=\\'3\\' y=\\'3\\' width=\\'18\\' height=\\'18\\' rx=\\'2\\'/><circle cx=\\'8.5\\' cy=\\'8.5\\' r=\\'1.5\\'/><path d=\\'m21 15-5-5L5 21\\'/></svg><span class=\\'text-xs mt-1\\'>صورة</span></div>'" />` : `<div class="flex flex-col items-center justify-center h-full text-muted-foreground/50"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg><span class="text-xs mt-1">صورة</span></div>`}
          </div>`;
        } else if (header.format === 'VIDEO') {
          html += `<div class="w-full aspect-video bg-black/10 flex items-center justify-center">
            <div class="flex flex-col items-center text-muted-foreground/50">
              <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              <span class="text-xs mt-1">فيديو</span>
            </div>
          </div>`;
        } else if (header.format === 'DOCUMENT') {
          html += `<div class="px-3 py-2 bg-black/5 flex items-center gap-2 border-b border-black/5">
            <svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8" fill="none" stroke="white" stroke-width="1.5"/></svg>
            <span class="text-xs text-foreground/70">مستند</span>
          </div>`;
        } else if (header.text) {
          html += `<div class="px-3 pt-2 text-sm font-bold text-foreground/90">${formatWhatsAppText(header.text)}</div>`;
        }
      }

      // Body
      if (body?.text) {
        html += `<div class="px-3 py-2 text-[13px] text-foreground/90 leading-relaxed whitespace-pre-wrap">${formatWhatsAppText(body.text)}</div>`;
      }

      // Footer
      if (footer?.text) {
        html += `<div class="px-3 pb-2 text-[11px] text-foreground/50">${footer.text}</div>`;
      }

      // Timestamp
      html += `<div class="px-3 pb-1.5 flex justify-end">
        <span class="text-[10px] text-foreground/40">${new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit', hour12: true })}</span>
      </div>`;

      html += `</div>`;

      // Buttons
      if (buttons?.buttons?.length) {
        html += `<div class="mt-1 space-y-1">`;
        buttons.buttons.forEach(btn => {
          const icon = btn.type === 'URL' ? `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14 21 3"/></svg>` :
                   btn.type === 'PHONE_NUMBER' ? `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.362 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.338 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>` :
                   btn.type === 'QUICK_REPLY' ? `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>` : '';
          html += `<div class="rounded-lg bg-white shadow-sm px-3 py-2 flex items-center justify-center gap-2 text-[#00a884] text-[13px] font-medium">
            ${icon}
            <span>${btn.text}</span>
          </div>`;
        });
        html += `</div>`;
      }

      return html;
    }

    function formatWhatsAppText(text) {
      if (!text) return '';
      // تحويل تنسيق واتساب
      return text
        .replace(/\*(.*?)\*/g, '<strong>$1</strong>') // Bold
        .replace(/_(.*?)_/g, '<em>$1</em>') // Italic
        .replace(/~(.*?)~/g, '<del>$1</del>') // Strikethrough
        .replace(/```(.*?)```/g, '<code class="bg-black/10 px-1 rounded">$1</code>') // Code
        .replace(/\{\{(\d+)\}\}/g, '<span class="bg-[#00a884]/20 text-[#00a884] px-1 rounded text-[11px]">{{$1}}</span>'); // Variables
    }

    // ============ دوال إنشاء القالب - النسخة الذكية ============

    // حدود Meta الرسمية
    const META_LIMITS = {
      name: 512,
      header_text: 60,
      body: 1024,
      footer: 60,
      button_text: 25,
      url: 2000,
      phone: 20,
      max_buttons: 10,
      max_url_buttons: 2,
      max_phone_buttons: 1,
      max_quick_reply_buttons: 10
    };

    let buttonsCount = 0;
    let buttonsList = [];
    let uploadedMediaHandle = null; // لحفظ handle الملف المرفوع

    // ============ دوال التحقق من اسم القالب ============
    
    // تنظيف اسم القالب - يحول الأحرف الكبيرة لصغيرة ويزيل غير المسموح
    function sanitizeTemplateName() {
      const input = document.getElementById('template-name');
      const hint = document.getElementById('name-hint');
      let value = input.value;
      
      // تحويل لأحرف صغيرة
      value = value.toLowerCase();
      
      // إزالة أي حرف غير مسموح (أي شيء ليس a-z, 0-9, _)
      const sanitized = value.replace(/[^a-z0-9_]/g, '');
      
      // إذا تم تغيير القيمة، أظهر تنبيه
      if (value !== sanitized) {
        hint.textContent = '⚠️ تم إزالة الأحرف غير المسموحة';
        hint.classList.add('text-warning');
        setTimeout(() => {
          hint.textContent = 'أحرف إنجليزية صغيرة (a-z)، أرقام (0-9)، شرطات سفلية (_) فقط';
          hint.classList.remove('text-warning');
        }, 2000);
      }
      
      input.value = sanitized;
    }

    // منع إدخال الأحرف غير المسموحة من لوحة المفاتيح
    function validateTemplateNameKey(event) {
      const key = event.key;
      
      // السماح بمفاتيح التحكم
      if (event.ctrlKey || event.metaKey || event.altKey) return true;
      if (['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'].includes(key)) {
        return true;
      }
      
      // السماح فقط بـ a-z, 0-9, _
      const allowed = /^[a-zA-Z0-9_]$/;
      if (!allowed.test(key)) {
        event.preventDefault();
        
        // إظهار تنبيه
        const hint = document.getElementById('name-hint');
        hint.textContent = '⚠️ فقط أحرف إنجليزية صغيرة وأرقام وشرطات سفلية';
        hint.classList.add('text-destructive');
        setTimeout(() => {
          hint.textContent = 'أحرف إنجليزية صغيرة (a-z)، أرقام (0-9)، شرطات سفلية (_) فقط';
          hint.classList.remove('text-destructive');
        }, 1500);
        
        return false;
      }
      
      return true;
    }

    // ============ دوال رفع الملفات ============
    
    function handleMediaUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const headerType = document.getElementById('header-type').value;
      const preview = document.getElementById('header-media-preview');
      const placeholder = document.getElementById('header-media-placeholder');
      const previewImg = document.getElementById('header-media-preview-img');
      const filename = document.getElementById('header-media-filename');
      
      // التحقق من حجم الملف
      const maxSizes = {
        'IMAGE': 5 * 1024 * 1024,      // 5MB
        'VIDEO': 16 * 1024 * 1024,     // 16MB
        'DOCUMENT': 100 * 1024 * 1024  // 100MB
      };
      
      if (file.size > maxSizes[headerType]) {
        const maxMB = maxSizes[headerType] / (1024 * 1024);
        alert(`حجم الملف يتجاوز الحد الأقصى (${maxMB}MB)`);
        event.target.value = '';
        return;
      }
      
      // عرض المعاينة
      placeholder.classList.add('hidden');
      preview.classList.remove('hidden');
      filename.textContent = file.name + ' (' + formatFileSize(file.size) + ')';
      
      if (headerType === 'IMAGE') {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          previewImg.classList.remove('hidden');
          updateLivePreview();
        };
        reader.readAsDataURL(file);
      } else if (headerType === 'VIDEO') {
        previewImg.classList.add('hidden');
        preview.innerHTML = `
          <div class="flex items-center justify-center gap-2 py-4">
            <i data-lucide="video" class="w-8 h-8 text-primary"></i>
            <div class="text-right">
              <p class="text-sm font-medium">${file.name}</p>
              <p class="text-xs text-muted-foreground">${formatFileSize(file.size)}</p>
            </div>
          </div>
        `;
        lucide.createIcons();
      } else if (headerType === 'DOCUMENT') {
        previewImg.classList.add('hidden');
        preview.innerHTML = `
          <div class="flex items-center justify-center gap-2 py-4">
            <i data-lucide="file-text" class="w-8 h-8 text-red-500"></i>
            <div class="text-right">
              <p class="text-sm font-medium">${file.name}</p>
              <p class="text-xs text-muted-foreground">${formatFileSize(file.size)}</p>
            </div>
          </div>
        `;
        lucide.createIcons();
      }
      
      // TODO: رفع الملف إلى Meta Resumable Upload API والحصول على handle
      // uploadedMediaHandle = await uploadToMeta(file);
      uploadedMediaHandle = 'pending_upload'; // مؤقتاً
      
      updateLivePreview();
    }
    
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function openCreateModal() {
      document.getElementById('create-template-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      lucide.createIcons();
      updateLivePreview();
    }

    function closeCreateModal() {
      document.getElementById('create-template-modal').classList.add('hidden');
      document.body.style.overflow = '';
      resetCreateForm();
    }

    function resetCreateForm() {
      document.getElementById('template-name').value = '';
      document.getElementById('template-category').value = '';
      document.getElementById('template-language').value = 'ar';
      document.getElementById('header-type').value = 'none';
      document.getElementById('header-text').value = '';
      document.getElementById('body-text').value = '';
      document.getElementById('footer-text').value = '';
      document.getElementById('header-text-container').classList.add('hidden');
      document.getElementById('header-media-container').classList.add('hidden');
      document.getElementById('variables-container').classList.add('hidden');
      document.getElementById('variables-inputs').innerHTML = '';
      document.getElementById('buttons-container').innerHTML = '';
      document.getElementById('validation-errors').classList.add('hidden');
      
      // إعادة تعيين خانة الميديا
      document.getElementById('header-media-input').value = '';
      document.getElementById('header-media-preview').classList.add('hidden');
      document.getElementById('header-media-placeholder').classList.remove('hidden');
      uploadedMediaHandle = null;
      
      buttonsCount = 0;
      buttonsList = [];
      updateAllCounters();
      updateLivePreview();
    }

    // تحديث عداد الأحرف
    function updateCounter(inputId, counterId, max) {
      const input = document.getElementById(inputId);
      const counter = document.getElementById(counterId);
      const len = input.value.length;
      counter.textContent = `${len}/${max}`;
      
      if (len > max * 0.9) {
        counter.classList.add('text-warning');
        counter.classList.remove('text-destructive');
      }
      if (len >= max) {
        counter.classList.add('text-destructive');
        counter.classList.remove('text-warning');
      }
      if (len < max * 0.9) {
        counter.classList.remove('text-warning', 'text-destructive');
      }
    }

    function updateAllCounters() {
      updateCounter('template-name', 'name-counter', META_LIMITS.name);
      updateCounter('header-text', 'header-counter', META_LIMITS.header_text);
      updateCounter('body-text', 'body-counter', META_LIMITS.body);
      updateCounter('footer-text', 'footer-counter', META_LIMITS.footer);
    }

    function toggleHeaderInput() {
      const headerType = document.getElementById('header-type').value;
      const textContainer = document.getElementById('header-text-container');
      const mediaContainer = document.getElementById('header-media-container');
      const mediaInput = document.getElementById('header-media-input');
      const mediaLabel = document.getElementById('header-media-label');
      const mediaFormats = document.getElementById('header-media-formats');
      const uploadIcon = mediaContainer?.querySelector('[data-lucide="image-plus"]');
      
      // إخفاء جميع الحاويات أولاً
      textContainer.classList.add('hidden');
      mediaContainer.classList.add('hidden');
      
      if (headerType === 'TEXT') {
        textContainer.classList.remove('hidden');
      } else if (headerType === 'IMAGE') {
        mediaContainer.classList.remove('hidden');
        mediaLabel.textContent = 'رفع الصورة';
        mediaInput.accept = 'image/png,image/jpeg,image/jpg';
        mediaFormats.textContent = 'PNG, JPG, JPEG (حتى 5MB)';
      } else if (headerType === 'VIDEO') {
        mediaContainer.classList.remove('hidden');
        mediaLabel.textContent = 'رفع الفيديو';
        mediaInput.accept = 'video/mp4,video/3gpp';
        mediaFormats.textContent = 'MP4, 3GP (حتى 16MB)';
      } else if (headerType === 'DOCUMENT') {
        mediaContainer.classList.remove('hidden');
        mediaLabel.textContent = 'رفع المستند';
        mediaInput.accept = 'application/pdf';
        mediaFormats.textContent = 'PDF (حتى 100MB)';
      }
      
      // إعادة تهيئة الأيقونات
      lucide.createIcons();
    }

    function detectVariables() {
      const bodyText = document.getElementById('body-text').value;
      const headerText = document.getElementById('header-text').value;
      const allText = bodyText + ' ' + headerText;
      
      const matches = allText.match(/\{\{(\d+)\}\}/g);
      const container = document.getElementById('variables-container');
      const inputsContainer = document.getElementById('variables-inputs');
      
      if (matches && matches.length > 0) {
        container.classList.remove('hidden');
        const uniqueVars = [...new Set(matches)].sort((a, b) => {
          const numA = parseInt(a.replace(/[{}]/g, ''));
          const numB = parseInt(b.replace(/[{}]/g, ''));
          return numA - numB;
        });
        
        // حفظ القيم الموجودة
        const existingValues = {};
        uniqueVars.forEach(v => {
          const num = v.replace(/[{}]/g, '');
          const existing = document.getElementById(`var-example-${num}`);
          if (existing) existingValues[num] = existing.value;
        });
        
        inputsContainer.innerHTML = uniqueVars.map(v => {
          const num = v.replace(/[{}]/g, '');
          const existingVal = existingValues[num] || '';
          return `
            <div class="flex items-center gap-2">
              <span class="text-[10px] font-mono bg-primary/10 text-primary px-2 py-1 rounded min-w-[40px] text-center">${v}</span>
              <input type="text" id="var-example-${num}" value="${existingVal}" placeholder="مثال: ${num === '1' ? 'أحمد' : num === '2' ? '12345' : 'قيمة'}" 
                oninput="updateLivePreview()"
                class="flex-1 rounded-lg border border-input bg-background px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-ring" />
            </div>
          `;
        }).join('');
      } else {
        container.classList.add('hidden');
        inputsContainer.innerHTML = '';
      }
      lucide.createIcons();
    }

    // Validation شامل حسب متطلبات Meta
    function validateTemplate() {
      const errors = [];
      const name = document.getElementById('template-name').value.trim();
      const category = document.getElementById('template-category').value;
      const bodyText = document.getElementById('body-text').value.trim();
      const headerType = document.getElementById('header-type').value;
      const headerText = document.getElementById('header-text').value.trim();
      const footerText = document.getElementById('footer-text').value.trim();

      // التحقق من الاسم
      if (!name) {
        errors.push('اسم القالب مطلوب');
      } else if (!/^[a-z0-9_]+$/.test(name)) {
        errors.push('اسم القالب يجب أن يحتوي على أحرف صغيرة إنجليزية (a-z)، أرقام (0-9)، وشرطات سفلية (_) فقط');
      } else if (name.length > META_LIMITS.name) {
        errors.push(`اسم القالب يتجاوز الحد الأقصى (${META_LIMITS.name} حرف)`);
      }

      // التحقق من الفئة
      if (!category) {
        errors.push('فئة القالب مطلوبة');
      }

      // التحقق من المحتوى
      if (!bodyText) {
        errors.push('محتوى الرسالة مطلوب');
      } else if (bodyText.length > META_LIMITS.body) {
        errors.push(`محتوى الرسالة يتجاوز الحد الأقصى (${META_LIMITS.body} حرف)`);
      }

      // التحقق من الترويسة
      if (headerType === 'TEXT') {
        if (headerText.length > META_LIMITS.header_text) {
          errors.push(`نص الترويسة يتجاوز الحد الأقصى (${META_LIMITS.header_text} حرف)`);
        }
        // التحقق من عدد المتغيرات في الترويسة
        const headerVars = headerText.match(/\{\{(\d+)\}\}/g);
        if (headerVars && headerVars.length > 1) {
          errors.push('الترويسة تدعم متغير واحد فقط');
        }
      } else if (['IMAGE', 'VIDEO', 'DOCUMENT'].includes(headerType)) {
        const mediaInput = document.getElementById('header-media-input');
        if (!mediaInput.files || mediaInput.files.length === 0) {
          const mediaTypes = { 'IMAGE': 'الصورة', 'VIDEO': 'الفيديو', 'DOCUMENT': 'المستند' };
          errors.push(`يرجى رفع ${mediaTypes[headerType]} للترويسة`);
        }
      }

      // التحقق من التذييل
      if (footerText.length > META_LIMITS.footer) {
        errors.push(`التذييل يتجاوز الحد الأقصى (${META_LIMITS.footer} حرف)`);
      }

      // التحقق من أمثلة المتغيرات
      const varMatches = bodyText.match(/\{\{(\d+)\}\}/g);
      if (varMatches && varMatches.length > 0) {
        const uniqueVars = [...new Set(varMatches)];
        for (const v of uniqueVars) {
          const num = v.replace(/[{}]/g, '');
          const example = document.getElementById(`var-example-${num}`)?.value.trim();
          if (!example) {
            errors.push(`مثال للمتغير ${v} مطلوب للموافقة من Meta`);
          }
        }
      }

      // التحقق من الأزرار
      const buttons = collectButtons();
      if (buttons.length > 0) {
        const urlCount = buttons.filter(b => b.type === 'URL').length;
        const phoneCount = buttons.filter(b => b.type === 'PHONE_NUMBER').length;
        const qrCount = buttons.filter(b => b.type === 'QUICK_REPLY').length;

        if (urlCount > META_LIMITS.max_url_buttons) {
          errors.push(`الحد الأقصى لأزرار URL هو ${META_LIMITS.max_url_buttons}`);
        }
        if (phoneCount > META_LIMITS.max_phone_buttons) {
          errors.push(`الحد الأقصى لأزرار الهاتف هو ${META_LIMITS.max_phone_buttons}`);
        }
        if (buttons.length > META_LIMITS.max_buttons) {
          errors.push(`الحد الأقصى للأزرار هو ${META_LIMITS.max_buttons}`);
        }

        // التحقق من نص الأزرار
        for (let i = 0; i < buttons.length; i++) {
          if (buttons[i].text.length > META_LIMITS.button_text) {
            errors.push(`نص الزر ${i + 1} يتجاوز الحد الأقصى (${META_LIMITS.button_text} حرف)`);
          }
          if (buttons[i].type === 'URL' && !buttons[i].url) {
            errors.push(`رابط الزر ${i + 1} مطلوب`);
          }
          if (buttons[i].type === 'URL' && buttons[i].url && !isValidURL(buttons[i].url)) {
            errors.push(`رابط الزر ${i + 1} غير صالح`);
          }
          if (buttons[i].type === 'PHONE_NUMBER' && !buttons[i].phone_number) {
            errors.push(`رقم هاتف الزر ${i + 1} مطلوب`);
          }
        }

        // التحقق من ترتيب أزرار Quick Reply
        if (qrCount > 0 && (urlCount > 0 || phoneCount > 0)) {
          const buttonTypes = buttons.map(b => b.type);
          let lastQRIndex = -1;
          let hasNonQRAfterQR = false;
          
          for (let i = 0; i < buttonTypes.length; i++) {
            if (buttonTypes[i] === 'QUICK_REPLY') {
              if (hasNonQRAfterQR) {
                errors.push('أزرار الرد السريع يجب أن تكون مجمّعة معاً (لا يمكن وضع أزرار أخرى بينها)');
                break;
              }
              lastQRIndex = i;
            } else if (lastQRIndex >= 0) {
              hasNonQRAfterQR = true;
            }
          }
        }
      }

      return errors;
    }

    function isValidURL(string) {
      try {
        new URL(string);
        return true;
      } catch (_) {
        return false;
      }
    }

    function showValidationErrors(errors) {
      const container = document.getElementById('validation-errors');
      if (errors.length === 0) {
        container.classList.add('hidden');
        return;
      }
      
      container.innerHTML = `
        <div class="font-medium flex items-center gap-2">
          <i data-lucide="alert-circle" class="w-4 h-4"></i>
          يرجى تصحيح الأخطاء التالية:
        </div>
        <ul class="list-disc list-inside space-y-0.5 mr-2">
          ${errors.map(e => `<li>${e}</li>`).join('')}
        </ul>
      `;
      container.classList.remove('hidden');
      lucide.createIcons();
      
      // التمرير للأعلى لرؤية الأخطاء
      container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // المعاينة الحية
    function updateLivePreview() {
      const name = document.getElementById('template-name').value.trim() || 'اسم_القالب';
      const category = document.getElementById('template-category').value;
      const language = document.getElementById('template-language').value;
      const headerType = document.getElementById('header-type').value;
      const headerText = document.getElementById('header-text').value.trim();
      const bodyText = document.getElementById('body-text').value.trim();
      const footerText = document.getElementById('footer-text').value.trim();
      
      // تحديث badges
      const categoryBadge = document.getElementById('preview-category-badge');
      const langBadge = document.getElementById('preview-lang-badge');
      
      categoryBadge.textContent = category === 'MARKETING' ? 'تسويق' : category === 'UTILITY' ? 'خدمات' : category === 'AUTHENTICATION' ? 'تحقق' : '—';
      categoryBadge.className = `px-2 py-0.5 rounded-full text-[10px] ${category === 'MARKETING' ? 'bg-primary/20 text-primary' : category === 'UTILITY' ? 'bg-blue-500/20 text-blue-600' : category === 'AUTHENTICATION' ? 'bg-orange-500/20 text-orange-600' : 'bg-muted'}`;
      
      langBadge.textContent = language === 'ar' ? 'العربية' : language === 'en' ? 'English' : 'English US';

      const preview = document.getElementById('live-preview');
      
      if (!bodyText) {
        preview.innerHTML = `
          <div class="text-center text-xs text-muted-foreground py-8">
            ابدأ بإدخال محتوى القالب<br/>لرؤية المعاينة الحية
          </div>
        `;
        return;
      }

      // استبدال المتغيرات بالأمثلة
      let previewBody = bodyText;
      let previewHeader = headerText;
      
      const varMatches = (bodyText + ' ' + headerText).match(/\{\{(\d+)\}\}/g);
      if (varMatches) {
        const uniqueVars = [...new Set(varMatches)];
        uniqueVars.forEach(v => {
          const num = v.replace(/[{}]/g, '');
          const example = document.getElementById(`var-example-${num}`)?.value.trim() || `[${v}]`;
          const regex = new RegExp(`\\{\\{${num}\\}\\}`, 'g');
          previewBody = previewBody.replace(regex, `<span class="bg-primary/20 text-primary px-0.5 rounded">${example}</span>`);
          previewHeader = previewHeader.replace(regex, `<span class="bg-primary/20 text-primary px-0.5 rounded">${example}</span>`);
        });
      }

      // تنسيق WhatsApp
      previewBody = formatWhatsAppText(previewBody);

      let html = `<div class="rounded-lg overflow-hidden shadow-sm" style="background-color: #dcf8c6;">`;
      
      // Header
      if (headerType !== 'none') {
        if (headerType === 'IMAGE') {
          html += `<div class="w-full aspect-video bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center">
            <div class="flex flex-col items-center text-gray-500">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
              <span class="text-[10px] mt-1">صورة</span>
            </div>
          </div>`;
        } else if (headerType === 'VIDEO') {
          html += `<div class="w-full aspect-video bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center">
            <div class="flex flex-col items-center text-white/70">
              <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              <span class="text-[10px] mt-1">فيديو</span>
            </div>
          </div>`;
        } else if (headerType === 'DOCUMENT') {
          html += `<div class="px-3 py-2 bg-red-50 flex items-center gap-2 border-b border-red-100">
            <svg class="w-7 h-7 text-red-500" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
            <span class="text-xs text-red-700">document.pdf</span>
          </div>`;
        } else if (headerType === 'TEXT' && previewHeader) {
          html += `<div class="px-3 pt-2 text-sm font-bold text-foreground/90">${previewHeader}</div>`;
        }
      }

      // Body
      html += `<div class="px-3 py-2 text-[13px] text-foreground/90 leading-relaxed whitespace-pre-wrap">${previewBody}</div>`;

      // Footer
      if (footerText) {
        html += `<div class="px-3 pb-2 text-[11px] text-foreground/50">${footerText}</div>`;
      }

      // Timestamp
      html += `<div class="px-3 pb-1.5 flex justify-end">
        <span class="text-[10px] text-foreground/40">${new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit', hour12: true })}</span>
      </div>`;

      html += `</div>`;

      // Buttons
      const buttons = collectButtons();
      if (buttons.length > 0) {
        html += `<div class="mt-1 space-y-1">`;
        buttons.forEach(btn => {
          const icon = btn.type === 'URL' ? `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14 21 3"/></svg>` :
                   btn.type === 'PHONE_NUMBER' ? `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.362 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.338 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>` :
                   `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>`;
          html += `<div class="rounded-lg bg-white shadow-sm px-3 py-2 flex items-center justify-center gap-2 text-[#00a884] text-[12px] font-medium">
            ${icon}
            <span>${btn.text || 'نص الزر'}</span>
          </div>`;
        });
        html += `</div>`;
      }

      preview.innerHTML = html;
    }

    function collectButtons() {
      const buttons = [];
      const container = document.getElementById('buttons-container');
      const buttonElements = container.querySelectorAll('[id^="button-"]');
      
      buttonElements.forEach((el, index) => {
        const id = el.id.replace('button-', '');
        const type = document.getElementById(`button-type-${id}`)?.value;
        const text = document.getElementById(`button-text-${id}`)?.value.trim();
        
        if (type && text) {
          const button = { type, text };
          if (type === 'URL') {
            button.url = document.getElementById(`button-url-${id}`)?.value.trim() || '';
          } else if (type === 'PHONE_NUMBER') {
            button.phone_number = document.getElementById(`button-phone-${id}`)?.value.trim() || '';
          }
          buttons.push(button);
        }
      });
      
      return buttons;
    }

    function addButton() {
      const currentButtons = collectButtons();
      if (currentButtons.length >= META_LIMITS.max_buttons) {
        alert(`الحد الأقصى ${META_LIMITS.max_buttons} أزرار`);
        return;
      }
      
      buttonsCount++;
      const container = document.getElementById('buttons-container');
      const buttonHtml = `
        <div class="p-2.5 border border-border rounded-lg space-y-2 bg-muted/20" id="button-${buttonsCount}">
          <div class="flex items-center justify-between">
            <span class="text-[10px] font-medium text-muted-foreground">زر ${buttonsCount}</span>
            <button type="button" onclick="removeButton(${buttonsCount})" class="text-[10px] text-destructive hover:underline">حذف</button>
          </div>
          <select id="button-type-${buttonsCount}" onchange="toggleButtonFields(${buttonsCount}); updateLivePreview();" class="w-full rounded border border-input bg-background px-2 py-1.5 text-sm">
            <option value="QUICK_REPLY">رد سريع (Quick Reply)</option>
            <option value="URL">رابط URL</option>
            <option value="PHONE_NUMBER">رقم هاتف</option>
          </select>
          <div class="relative">
            <input type="text" id="button-text-${buttonsCount}" placeholder="نص الزر" maxlength="${META_LIMITS.button_text}"
              oninput="updateLivePreview()"
              class="w-full rounded border border-input bg-background px-2 py-1.5 text-sm" />
            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-[9px] text-muted-foreground">${META_LIMITS.button_text}</span>
          </div>
          <input type="url" id="button-url-${buttonsCount}" placeholder="https://example.com" maxlength="${META_LIMITS.url}"
            oninput="updateLivePreview()"
            class="w-full rounded border border-input bg-background px-2 py-1.5 text-sm hidden" dir="ltr" />
          <input type="tel" id="button-phone-${buttonsCount}" placeholder="+966500000000" maxlength="${META_LIMITS.phone}"
            oninput="updateLivePreview()"
            class="w-full rounded border border-input bg-background px-2 py-1.5 text-sm hidden" dir="ltr" />
        </div>
      `;
      container.insertAdjacentHTML('beforeend', buttonHtml);
      updateLivePreview();
    }

    function removeButton(id) {
      document.getElementById(`button-${id}`)?.remove();
      updateLivePreview();
    }

    function toggleButtonFields(id) {
      const type = document.getElementById(`button-type-${id}`).value;
      const urlField = document.getElementById(`button-url-${id}`);
      const phoneField = document.getElementById(`button-phone-${id}`);
      
      urlField.classList.add('hidden');
      phoneField.classList.add('hidden');
      
      if (type === 'URL') {
        urlField.classList.remove('hidden');
      } else if (type === 'PHONE_NUMBER') {
        phoneField.classList.remove('hidden');
      }
    }

    // مراجعة قبل الإرسال
    function previewBeforeSubmit() {
      const errors = validateTemplate();
      showValidationErrors(errors);
      
      if (errors.length === 0) {
        // عرض رسالة تأكيد
        const name = document.getElementById('template-name').value.trim();
        alert(`✅ القالب "${name}" جاهز للإرسال!\n\nيمكنك الآن النقر على "إرسال للمراجعة" لإرسال القالب إلى Meta.`);
      }
    }

    async function submitTemplate() {
      // التحقق أولاً
      const errors = validateTemplate();
      if (errors.length > 0) {
        showValidationErrors(errors);
        return;
      }

      const name = document.getElementById('template-name').value.trim();
      const category = document.getElementById('template-category').value;
      const language = document.getElementById('template-language').value;
      const headerType = document.getElementById('header-type').value;
      const headerText = document.getElementById('header-text').value.trim();
      const bodyText = document.getElementById('body-text').value.trim();
      const footerText = document.getElementById('footer-text').value.trim();

      // بناء المكونات
      const components = [];

      // Header
      if (headerType !== 'none') {
        const headerComponent = { type: 'HEADER', format: headerType };
        if (headerType === 'TEXT' && headerText) {
          headerComponent.text = headerText;
          
          // إضافة أمثلة متغيرات الترويسة
          const headerVars = headerText.match(/\{\{(\d+)\}\}/g);
          if (headerVars && headerVars.length > 0) {
            const num = headerVars[0].replace(/[{}]/g, '');
            const example = document.getElementById(`var-example-${num}`)?.value.trim();
            if (example) {
              headerComponent.example = { header_text: [example] };
            }
          }
        }
        components.push(headerComponent);
      }

      // Body
      const bodyComponent = { type: 'BODY', text: bodyText };
      
      // جمع أمثلة المتغيرات
      const varMatches = bodyText.match(/\{\{(\d+)\}\}/g);
      if (varMatches && varMatches.length > 0) {
        const uniqueVars = [...new Set(varMatches)].sort((a, b) => {
          const numA = parseInt(a.replace(/[{}]/g, ''));
          const numB = parseInt(b.replace(/[{}]/g, ''));
          return numA - numB;
        });
        const examples = uniqueVars.map(v => {
          const num = v.replace(/[{}]/g, '');
          return document.getElementById(`var-example-${num}`)?.value.trim() || '';
        });
        bodyComponent.example = { body_text: [examples] };
      }
      components.push(bodyComponent);

      // Footer
      if (footerText) {
        components.push({ type: 'FOOTER', text: footerText });
      }

      // Buttons
      const buttons = collectButtons();
      if (buttons.length > 0) {
        components.push({ type: 'BUTTONS', buttons: buttons });
      }

      // إرسال الطلب
      const submitBtn = document.getElementById('submit-template-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> جاري الإرسال...';
      lucide.createIcons();

      try {
        const response = await apiRequest('/meta/templates', {
          method: 'POST',
          body: JSON.stringify({
            name: name,
            category: category,
            language: language,
            components: components
          })
        });

        if (response.success) {
          alert(`✅ تم إنشاء القالب "${name}" بنجاح!\n\nالحالة: قيد المراجعة\nسيتم مراجعته من Meta خلال 24 ساعة تقريباً.`);
          closeCreateModal();
          loadTemplates();
        } else {
          const errorMsg = response.message || response.error || 'خطأ غير معروف';
          showValidationErrors([`فشل من Meta: ${errorMsg}`]);
        }
      } catch (error) {
        console.error('خطأ في إنشاء القالب:', error);
        showValidationErrors(['حدث خطأ في الاتصال. يرجى المحاولة مرة أخرى.']);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> إرسال للمراجعة';
        lucide.createIcons();
      }
    }

    // إغلاق modal الإنشاء بزر Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const createModal = document.getElementById('create-template-modal');
        if (!createModal.classList.contains('hidden')) {
          closeCreateModal();
          return;
        }
        closeTemplateModal();
      }
    });

    // دالة logout موجودة في api.js
  </script>
</body>
</html>
