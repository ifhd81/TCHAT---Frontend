<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TCHAT - ุงูุญููุงุช ุงูุชุณููููุฉ</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="./config.js"></script>
  <script src="./api.js"></script>
  <script src="./components/header.js"></script>
  <script src="./components/confirm-modal.js"></script>
</head>
<body class="rtl min-h-screen bg-background" style="font-family: 'LamaSans', sans-serif;">
  
  <!-- Header Container -->
  <div id="header-container"></div>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    
    <!-- Page Header -->
    <section class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-heading-lg font-bold text-foreground">ุฅุฏุงุฑุฉ ุงูุญููุงุช ุงูุชุณููููุฉ</h1>
        <p class="text-body-sm text-muted-foreground">ุฅูุดุงุก ูุฅุฏุงุฑุฉ ุญููุงุช ูุงุชุณุงุจ ููุนููุงุก</p>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="showTestSendModal()" class="inline-flex items-center gap-2 rounded-md border border-primary bg-primary/10 px-4 py-2 text-button-md font-medium text-primary shadow-sm transition hover:bg-primary/20">
          <i data-lucide="send" class="h-4 w-4"></i>
          <span>ุฅุฑุณุงู ุชุฌุฑูุจู</span>
        </button>
        <button onclick="deleteAllCampaigns()" class="inline-flex items-center gap-2 rounded-md border border-destructive bg-destructive/10 px-4 py-2 text-button-md font-medium text-destructive shadow-sm transition hover:bg-destructive/20">
          <i data-lucide="trash-2" class="h-4 w-4"></i>
          <span>ุญุฐู ุงููู</span>
        </button>
        <button onclick="showCreateCampaignModal()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
          <i data-lucide="plus" class="h-4 w-4"></i>
          <span>ุญููุฉ ุฌุฏูุฏุฉ</span>
        </button>
      </div>
    </section>

    <!-- Campaigns List -->
    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
      <div class="border-b border-border p-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="megaphone" class="h-5 w-5 text-muted-foreground"></i>
            <h2 class="text-heading-md font-semibold">ุงูุญููุงุช ุงูุญุงููุฉ</h2>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="updateAllCampaignStatuses()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-3 py-2 text-body-sm font-medium text-muted-foreground transition hover:bg-accent hover:text-accent-foreground">
              <i data-lucide="zap" class="h-4 w-4"></i>
              <span>ุชุญุฏูุซ ุงูุญุงูุงุช</span>
            </button>
            <button onclick="refreshCampaigns()" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
              <i data-lucide="refresh-cw" class="h-4 w-4"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full caption-bottom text-sm">
          <thead class="bg-muted/50">
            <tr class="border-b text-right text-body-sm font-semibold text-muted-foreground">
              <th class="px-4 py-3 w-[25%]">ุงูุญููุฉ</th>
              <th class="px-4 py-3 w-[15%] text-center">ุงููุงูุจ</th>
              <th class="px-4 py-3 w-[10%] text-center">ุงูุญุงูุฉ</th>
              <th class="px-4 py-3 w-[10%] text-center">ุงููุณุชูุจููู</th>
              <th class="px-4 py-3 w-[15%] text-center">ุงูุชูุฏู</th>
              <th class="px-4 py-3 w-[15%] text-center">ุงูุฅุนุฏุงุฏุงุช</th>
              <th class="px-4 py-3 w-[10%] text-center">ุงูุฅุฌุฑุงุกุงุช</th>
            </tr>
          </thead>
          <tbody id="campaigns-table-body" class="divide-y divide-border">
            <tr>
              <td colspan="7" class="h-24 text-center text-body-sm text-muted-foreground">ุฌุงุฑู ุชุญููู ุงูุญููุงุช...</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div class="border-t border-border p-4">
        <div class="flex items-center justify-between">
          <div class="text-body-sm text-muted-foreground">
            ุนุฑุถ <span id="showing-from" class="text-body-sm font-medium number">0</span> - <span id="showing-to" class="text-body-sm font-medium number">0</span> ูู <span id="total-campaigns" class="text-body-sm font-medium number">0</span> ุญููุฉ
          </div>
          <div class="flex items-center gap-2">
            <button onclick="goToFirstPage()" id="first-page-btn" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:bg-accent hover:text-foreground disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <i data-lucide="chevrons-right" class="h-4 w-4"></i>
            </button>
            <button onclick="goToPrevPage()" id="prev-page-btn" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:bg-accent hover:text-foreground disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <i data-lucide="chevron-right" class="h-4 w-4"></i>
            </button>
            <div class="flex items-center gap-1 px-2">
              <span class="text-body-sm text-muted-foreground">ุตูุญุฉ</span>
              <span id="current-page-num" class="text-body-sm font-medium number">1</span>
              <span class="text-body-sm text-muted-foreground">ูู</span>
              <span id="total-pages-num" class="text-body-sm font-medium number">1</span>
            </div>
            <button onclick="goToNextPage()" id="next-page-btn" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:bg-accent hover:text-foreground disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <i data-lucide="chevron-left" class="h-4 w-4"></i>
            </button>
            <button onclick="goToLastPage()" id="last-page-btn" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:bg-accent hover:text-foreground disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <i data-lucide="chevrons-left" class="h-4 w-4"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- ูุงูุฐุฉ ุชูุงุตูู ุงูุฑุณุงูุฉ -->
  <div id="message-details-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[9999] hidden">
    <div class="bg-background rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden">
      <div class="flex items-center justify-between p-6 border-b border-border">
        <h2 class="text-heading-lg font-semibold">ุชูุงุตูู ุงูุฑุณุงูุฉ</h2>
        <button onclick="closeMessageDetails()" class="text-muted-foreground hover:text-foreground transition-colors">
          <i data-lucide="x" class="h-5 w-5"></i>
        </button>
      </div>
      <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]" id="message-details-content">
        <!-- ูุญุชูู ุงูุชูุงุตูู ุณูุชู ุฅุฏุฑุงุฌู ููุง -->
      </div>
    </div>
  </div>

  <!-- Create Campaign Modal -->
  <div id="create-campaign-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div>
            <h2 class="text-heading-lg font-bold">ุฅูุดุงุก ุญููุฉ ุชุณููููุฉ ุฌุฏูุฏุฉ</h2>
            <p class="text-body-sm text-muted-foreground mt-1">ูู ุจุฅุนุฏุงุฏ ุงูุญููุฉ ูุงุฎุชูุงุฑ ุงููุณุชูุจููู</p>
          </div>
          <button onclick="hideCreateCampaignModal()" class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="x" class="h-4 w-4"></i>
          </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6 space-y-6">
          
          <!-- Step 1: Campaign Info -->
          <div class="space-y-4">
            <h3 class="text-heading-md font-semibold flex items-center gap-2">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground text-xs font-bold">1</span>
              ูุนูููุงุช ุงูุญููุฉ
            </h3>
            
            <div class="grid gap-4 md:grid-cols-2">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">ุงุณู ุงูุญููุฉ</label>
                <input type="text" id="campaign-name" placeholder="ุฃุฏุฎู ุงุณู ุงูุญููุฉ" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" />
              </div>
              <div class="space-y-2">
                <label class="text-body-sm font-medium">ุงููุงูุจ</label>
                <select id="campaign-template" onchange="onCreateCampaignTemplateChange()" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="">ุงุฎุชุฑ ุงููุงูุจ</option>
                </select>
              </div>
            </div>
            
            <div class="space-y-2">
              <label class="text-body-sm font-medium flex items-center gap-2">
                <i data-lucide="phone" class="h-4 w-4"></i>
                <span>ุฑูู ุงููุงุชุณุงุจ ููุฅุฑุณุงู</span>
              </label>
              <select id="whatsapp-phone-number" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" style="font-variant-numeric: lining-nums;">
                <option value="">ุฌุงุฑู ุชุญููู ุงูุฃุฑูุงู...</option>
              </select>
              <p class="text-body-xs text-muted-foreground">ุงุฎุชุฑ ุงูุฑูู ุงูุฐู ุณูุชู ุงูุฅุฑุณุงู ููู ูู ูุฐู ุงูุญููุฉ</p>
            </div>
            
            <!-- ุตูุฑุฉ ุงูุฑุฃุณ (ุชุธูุฑ ุนูุฏ ุงุฎุชูุงุฑ ูุงูุจ ูุญุชูู ุตูุฑุฉ ุฑุฃุณ) -->
            <div id="create-campaign-header-image-box" class="space-y-2 p-4 rounded-xl border border-primary/25 bg-primary/5 hidden">
              <label class="text-body-sm font-medium flex items-center gap-2 text-foreground">
                <i data-lucide="image" class="h-4 w-4 text-primary shrink-0"></i>
                <span>ุตูุฑุฉ ุงูุฑุฃุณ (ูุทููุจ ูููุงูุจ)</span>
              </label>
              <p class="text-body-2xs text-muted-foreground">ุงุฑูุน ุตูุฑุฉ ุฑุฃุณ ุงูุฑุณุงูุฉ. ุจุฏูููุง ูุฏ ููุดู ุงูุชุณููู.</p>
              <input type="file" id="create-campaign-header-image-file" accept="image/jpeg,image/png,image/jpg" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm file:mr-2 file:rounded file:border-0 file:bg-primary file:px-3 file:py-1 file:text-body-sm file:text-primary-foreground" />
              <!-- ูุคุดุฑ ุฑูุน ุงูุตูุฑุฉ -->
              <div id="create-campaign-header-image-upload-progress" class="hidden mt-2 p-3 rounded-lg border border-primary/25 bg-primary/10 space-y-2">
                <div class="flex items-center justify-between text-body-sm text-primary">
                  <div class="flex items-center gap-2">
                    <i data-lucide="loader-2" class="h-4 w-4 shrink-0 animate-spin"></i>
                    <span>ุฌุงุฑู ุฑูุน ุงูุตูุฑุฉ...</span>
                  </div>
                  <span id="create-campaign-header-image-upload-percent" class="tabular-nums">0%</span>
                </div>
                <div class="h-2 rounded-full bg-primary/20 overflow-hidden">
                  <div id="create-campaign-header-image-upload-progress-bar" class="h-full rounded-full bg-primary transition-[width] duration-150" style="width: 0%"></div>
                </div>
              </div>
              <input type="hidden" id="create-campaign-header-image-url" value="" />
              <div id="create-campaign-header-image-preview" class="hidden mt-2 rounded-lg overflow-hidden border border-border bg-muted/20 max-w-xs">
                <img id="create-campaign-header-image-preview-img" src="" alt="ูุนุงููุฉ" class="w-full max-h-32 object-cover" />
              </div>
            </div>
            
            <div class="space-y-2">
              <label class="text-body-sm font-medium">ูุตู ุงูุญููุฉ</label>
              <textarea id="campaign-description" placeholder="ูุตู ูุฎุชุตุฑ ููุญููุฉ" rows="3" class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"></textarea>
            </div>
          </div>

          <!-- Step 2: Recipients -->
          <div class="space-y-4">
            <h3 class="text-heading-md font-semibold flex items-center gap-2">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground text-xs font-bold">2</span>
              ุงููุณุชูุจููู
            </h3>
            
            <div class="grid gap-4 md:grid-cols-2">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">ูุตุฏุฑ ุงูุจูุงูุงุช</label>
                <select id="recipients-source" onchange="handleRecipientsSourceChange()" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="database" data-count="0">ุงูุนููุงุก ุงููุณุฌููู (ุฌุงุฑู ุงูุชุญููู...)</option>
                  <option value="manual" data-count="0">ุฅุฏุฎุงู ูุฏูู (0)</option>
                  <option value="csv" data-count="0">ุฑูุน ููู CSV (0)</option>
                </select>
              </div>
              <div class="space-y-2" id="target-country-wrap" style="display: none;">
                <label class="text-body-sm font-medium flex items-center gap-2">
                  <i data-lucide="globe" class="h-4 w-4"></i>
                  <span>ุงูุฏููุฉ ุงููุณุชูุฏูุฉ</span>
                </label>
                <select id="target-country-dial-code" onchange="onTargetCountryChange()" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="">ุฌููุน ุงูุนููุงุก</option>
                </select>
                <p class="text-body-xs text-muted-foreground">ุงุฎุชูุงุฑู: ุฅุฑุณุงู ููุฃุฑูุงู ุงูุชู ุชุจุฏุฃ ุจููุชุงุญ ุงูุฏููุฉ ููุท (ูุซู +966)</p>
              </div>
              <div class="space-y-2" id="csv-upload-section" style="display: none;">
                <label class="text-body-sm font-medium">ููู CSV</label>
                <input type="file" id="csv-file" accept=".csv" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" />
              </div>
            </div>

            <!-- Manual Input Section -->
            <div id="manual-input-section" class="space-y-4" style="display: none;">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">ุฃุฑูุงู ุงูููุงุชู ูุงูุฃุณูุงุก</label>
                <textarea 
                  id="manual-recipients" 
                  placeholder="ุฃุฏุฎู ุงูุฃุฑูุงู ูุงูุฃุณูุงุก ุจุงูุชูุณูู ุงูุชุงูู:&#10;966501234567,ุฃุญูุฏ ูุญูุฏ&#10;966509876543,ูุงุทูุฉ ุนูู&#10;966555555555,ุฎุงูุฏ ุงูุณุนูุฏ&#10;&#10;ุฃู ุฃุฑูุงู ููุท (ุณุทุฑ ูุงุญุฏ ููู ุฑูู):&#10;966501234567&#10;966509876543"
                  rows="8" 
                  class="flex min-h-[160px] w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring font-mono"
                  oninput="parseManualRecipients()"
                ></textarea>
              </div>
              <div class="flex items-center gap-4 text-body-sm text-muted-foreground">
                <div class="flex items-center gap-2">
                  <i data-lucide="info" class="h-4 w-4"></i>
                  <span>ุงูุชูุณูู: ุฑูู ุงููุงุชู,ุงูุงุณู (ุงุฎุชูุงุฑู)</span>
                </div>
                <div class="flex items-center gap-2">
                  <span>ุนุฏุฏ ุงูุฃุฑูุงู ุงููุฏุฎูุฉ:</span>
                  <span id="manual-count" class="font-semibold number">0</span>
                </div>
              </div>
            </div>

            <div id="recipients-preview" class="rounded-xl border border-border bg-gradient-to-b from-muted/30 to-muted/10 p-0 overflow-hidden">
              <div class="text-center text-body-sm text-muted-foreground py-8 px-4">
                <div class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-primary/10 text-primary mb-3">
                  <i data-lucide="users" class="h-6 w-6"></i>
                </div>
                <p class="font-medium text-foreground/80">ุณูุชู ุนุฑุถ ุงููุณุชูุจููู ููุง</p>
                <p class="text-body-xs mt-1">ุฃุฏุฎู ุงูุฃุฑูุงู ุฃู ุงุฎุชุฑ ุงููุตุฏุฑ ุฃุนูุงู</p>
              </div>
            </div>
          </div>

          <!-- Step 3: Batch Settings -->
          <div class="space-y-4">
            <h3 class="text-heading-md font-semibold flex items-center gap-2">
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground text-xs font-bold">3</span>
              ุฅุนุฏุงุฏุงุช ุงูุฅุฑุณุงู
            </h3>
            
            <div class="grid gap-4 md:grid-cols-3">
              <div class="space-y-2">
                <label class="text-body-sm font-medium">ุญุฌู ุงูุฏูุนุฉ</label>
                <select id="batch-size" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="50">50 ุนููู</option>
                  <option value="100" selected>100 ุนููู</option>
                  <option value="200">200 ุนููู</option>
                  <option value="300">300 ุนููู</option>
                  <option value="500">500 ุนููู</option>
                  <option value="1000">1,000 ุนููู</option>
                  <option value="5000">5,000 ุนููู</option>
                  <option value="10000">10,000 ุนููู</option>
                  <option value="20000">20,000 ุนููู</option>
                </select>
              </div>
              <div class="space-y-2">
                <label class="text-body-sm font-medium">ุงููุชุฑุฉ ุจูู ุงูุฏูุนุงุช</label>
                <select id="batch-interval" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="5">5 ุฏูุงุฆู</option>
                  <option value="15">15 ุฏูููุฉ</option>
                  <option value="30">30 ุฏูููุฉ</option>
                  <option value="60" selected>ุณุงุนุฉ ูุงุญุฏุฉ</option>
                  <option value="120">ุณุงุนุชุงู</option>
                  <option value="180">3 ุณุงุนุงุช</option>
                  <option value="360">6 ุณุงุนุงุช</option>
                  <option value="720">12 ุณุงุนุฉ</option>
                  <option value="1440">24 ุณุงุนุฉ</option>
                </select>
              </div>
              <div class="space-y-2">
                <label class="text-body-sm font-medium">ููุน ุงูุฅุฑุณุงู</label>
                <select id="send-type" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="batch" selected>ูุฌุฒุฃ (ููุตู ุจู)</option>
                  <option value="all">ุงููู ุฏูุนุฉ ูุงุญุฏุฉ</option>
                </select>
              </div>
            </div>

            <!-- Smart Send Checkbox -->
            <div class="rounded-lg border border-border bg-card p-4">
              <label class="flex items-start gap-3 cursor-pointer">
                <input type="checkbox" id="enable-smart-send" onchange="handleSmartSendToggle()" class="mt-1 h-4 w-4 rounded border-gray-300 text-primary focus:ring-2 focus:ring-primary focus:ring-offset-2" checked />
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <i data-lucide="zap" class="h-4 w-4 text-primary"></i>
                    <span class="text-body-md font-semibold">ุชูุนูู ุงูุฅุฑุณุงู ุงูุฐูู</span>
                    <span class="inline-flex items-center rounded-md bg-primary/10 px-2 py-1 text-xs font-medium text-primary">ููุตู ุจู</span>
                  </div>
                  <p class="text-body-sm text-muted-foreground mt-1">
                    ุงุณุชุจุนุงุฏ ุงูุฃุฑูุงู ุงูุชู ุชู ุงูุฅุฑุณุงู ููุง ุฎูุงู ุขุฎุฑ <span class="font-semibold text-foreground">10 ุฃูุงู</span> ูุชุฌูุจ ุงูุฅุฒุนุงุฌ ูุชุญุณูู ูุนุฏู ุงูุชูุงุนู
                  </p>
                </div>
              </label>
            </div>

            <!-- Smart Send Info -->
            <div id="smart-send-info" class="rounded-lg border border-primary bg-primary/5 p-4">
              <div class="flex items-start gap-3">
                <i data-lucide="zap" class="h-5 w-5 text-primary mt-0.5"></i>
                <div class="flex-1">
                  <h4 class="text-body-md font-semibold text-primary mb-1">ุงูุฅุฑุณุงู ุงูุฐูู โจ</h4>
                  <p class="text-body-sm text-muted-foreground mb-3">
                    ุณูุชู ูุญุต ุงูุฃุฑูุงู ุงููุฏุฎูุฉ ูุงุณุชุจุนุงุฏ ูู ุชู ุงูุฅุฑุณุงู ููู ุฎูุงู ุขุฎุฑ <span class="font-semibold text-foreground">10 ุฃูุงู</span> ูุชุฌูุจ ุงูุฅุฒุนุงุฌ ูุชุญุณูู ูุนุฏู ุงูุชูุงุนู.
                  </p>
                  <button onclick="runSmartSendCheck()" id="check-recipients-btn" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-sm font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90 disabled:opacity-50">
                    <i data-lucide="scan-search" class="h-4 w-4"></i>
                    <span>ูุญุต ุงูุฃุฑูุงู ุงูุขู</span>
                  </button>
                </div>
              </div>
              
              <!-- Smart Send Results -->
              <div id="smart-send-results" class="mt-4 hidden">
                <div class="grid gap-3 md:grid-cols-3">
                  <div class="rounded-lg border border-border bg-card p-3">
                    <div class="text-body-xs text-muted-foreground mb-1">ุฅุฌูุงูู ุงูุฃุฑูุงู</div>
                    <div class="text-heading-sm font-bold" id="smart-total">0</div>
                  </div>
                  <div class="rounded-lg border border-green-500 bg-green-500/10 p-3">
                    <div class="text-body-xs text-green-700 dark:text-green-400 mb-1">โ ูุณููุญ ุจุงูุฅุฑุณุงู</div>
                    <div class="text-heading-sm font-bold text-green-600 dark:text-green-400" id="smart-allowed">0</div>
                  </div>
                  <div class="rounded-lg border border-orange-500 bg-orange-500/10 p-3">
                    <div class="text-body-xs text-orange-700 dark:text-orange-400 mb-1">โ๏ธ ูุณุชุจุนุฏ</div>
                    <div class="text-heading-sm font-bold text-orange-600 dark:text-orange-400" id="smart-excluded">0</div>
                  </div>
                </div>
                <div class="mt-3 text-body-xs text-muted-foreground">
                  <i data-lucide="info" class="h-3 w-3 inline"></i>
                  <span id="smart-message">ุชู ุงููุญุต ุจูุฌุงุญ</span>
                </div>
              </div>
            </div>

            <div id="batch-preview" class="rounded-lg border border-border bg-accent/20 p-4">
              <h4 class="text-body-md font-semibold mb-2">ูุนุงููุฉ ุงูุฅุฑุณุงู</h4>
              <div id="batch-preview-content" class="text-body-sm text-muted-foreground">
                ุณูุชู ุนุฑุถ ุชูุงุตูู ุงูุชุฌุฒุฆุฉ ููุง
              </div>
            </div>
          </div>

        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-between border-t border-border p-6">
          <button onclick="hideCreateCampaignModal()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-body-sm font-medium transition hover:bg-accent hover:text-accent-foreground">
            <span>ุฅูุบุงุก</span>
          </button>
          <div class="flex items-center gap-3">
            <button onclick="previewCampaign()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-body-sm font-medium transition hover:bg-accent hover:text-accent-foreground">
              <i data-lucide="eye" class="h-4 w-4"></i>
              <span>ูุนุงููุฉ</span>
            </button>
            <button onclick="createCampaign()" id="create-campaign-btn" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90 disabled:opacity-50">
              <i data-lucide="send" class="h-4 w-4"></i>
              <span>ุฅูุดุงุก ุงูุญููุฉ</span>
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Test Send Modal -->
  <div id="test-send-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary/10">
              <i data-lucide="send" class="h-5 w-5 text-primary"></i>
            </div>
            <div>
              <h2 class="text-heading-md font-bold">ุฅุฑุณุงู ุชุฌุฑูุจู</h2>
              <p class="text-body-sm text-muted-foreground">ุงุฎุชุจุฑ ุงููุงูุจ ูุจู ุฅุฑุณุงูู ููุนููุงุก</p>
            </div>
          </div>
          <button onclick="hideTestSendModal()" class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="x" class="h-4 w-4"></i>
          </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6 space-y-5">
          
          <!-- ุฑูู ุงููุงุชู -->
          <div class="space-y-2">
            <label class="text-body-sm font-medium flex items-center gap-2">
              <i data-lucide="phone" class="h-4 w-4 text-muted-foreground"></i>
              <span>ุฑูู ุงููุงุชู</span>
            </label>
            <input type="text" id="test-phone-number" placeholder="ูุซุงู: 966501234567" class="flex h-11 w-full rounded-md border border-input bg-background px-4 py-2 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring font-mono" dir="ltr" />
            <p class="text-body-xs text-muted-foreground">ุฃุฏุฎู ุงูุฑูู ุจุตูุบุฉ ุฏูููุฉ ุจุฏูู + ุฃู 00</p>
          </div>

          <!-- ุงุฎุชูุงุฑ ุงููุงูุจ -->
          <div class="space-y-2">
            <label class="text-body-sm font-medium flex items-center gap-2">
              <i data-lucide="layout-template" class="h-4 w-4 text-muted-foreground"></i>
              <span>ุงููุงูุจ</span>
            </label>
            <select id="test-template" class="flex h-11 w-full rounded-md border border-input bg-background px-4 py-2 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="">ุฌุงุฑู ุชุญููู ุงูููุงูุจ...</option>
            </select>
          </div>

          <!-- ุญููู ุงููุชุบูุฑุงุช ุงูุฏููุงููููุฉ -->
          <div id="template-variables-container" class="space-y-3">
            <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู ุจูุงุกู ุนูู ุงููุงูุจ ุงููุฎุชุงุฑ -->
          </div>

          <!-- ูุบุฉ ุงููุงูุจ -->
          <div class="space-y-2">
            <label class="text-body-sm font-medium flex items-center gap-2">
              <i data-lucide="globe" class="h-4 w-4 text-muted-foreground"></i>
              <span>ูุบุฉ ุงููุงูุจ</span>
            </label>
            <select id="test-template-language" class="flex h-11 w-full rounded-md border border-input bg-background px-4 py-2 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="ar">ุงูุนุฑุจูุฉ</option>
              <option value="en">ุงูุฅูุฌููุฒูุฉ</option>
              <option value="en_US">English (US)</option>
            </select>
          </div>

          <!-- ูุชูุฌุฉ ุงูุชุญููู ุงูุฐูู -->
          <div id="template-analysis-result" class="hidden p-3 rounded-lg border">
            <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
          </div>
          
          <!-- ุฎูุงุฑ ุงูุชุฌุงูุฒ ุงููุฏูู -->
          <div class="flex items-center gap-3 p-3 rounded-lg bg-muted/50 border border-muted">
            <input type="checkbox" id="test-no-variables" class="h-4 w-4 rounded border-input" />
            <label for="test-no-variables" class="text-body-sm cursor-pointer">
              <span class="font-medium">ุชุฌุงูุฒ ุงูุชุญููู ุงูุฐูู</span>
              <span class="text-muted-foreground block text-body-xs">ุฅุฑุณุงู ุงููุงูุจ ุจุฏูู ูุชุบูุฑุงุช (ููุญุงูุงุช ุงูุฎุงุตุฉ)</span>
            </label>
          </div>

        </div>

        <!-- ูุชูุฌุฉ ุงูุฅุฑุณุงู -->
        <div id="test-send-result" class="hidden mx-6 mb-6">
          <div id="test-send-result-content" class="rounded-lg border p-4">
            <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-between border-t border-border p-6">
          <button onclick="hideTestSendModal()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-body-sm font-medium transition hover:bg-accent hover:text-accent-foreground">
            <span>ุฅุบูุงู</span>
          </button>
          <button onclick="sendTestMessage()" id="test-send-btn" class="inline-flex items-center gap-2 rounded-md bg-primary px-5 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90 disabled:opacity-50">
            <i data-lucide="send" class="h-4 w-4"></i>
            <span>ุฅุฑุณุงู ุงูุขู</span>
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Campaign Details Modal -->
  <div id="campaign-details-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-6xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div>
            <h2 id="details-campaign-name" class="text-heading-lg font-bold">ุชูุงุตูู ุงูุญููุฉ</h2>
            <p class="text-body-sm text-muted-foreground mt-1">ุฅุญุตุงุฆูุงุช ููุชุงุจุนุฉ ุงูุญููุฉ</p>
          </div>
          <button onclick="hideCampaignDetailsModal()" class="inline-flex h-10 w-10 min-h-[40px] min-w-[40px] max-h-[40px] max-w-[40px] shrink-0 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground box-border">
            <i data-lucide="x" class="h-4 w-4"></i>
          </button>
        </div>

        <!-- Modal Content -->
        <div class="p-6" id="campaign-details-content">
          <div class="text-center text-body-sm text-muted-foreground">ุฌุงุฑู ุชุญููู ุชูุงุตูู ุงูุญููุฉ...</div>
        </div>

      </div>
    </div>
  </div>

  <!-- ููุฏุงู ุชุฃููุฏ ุญุฐู ุงูุญููุฉ -->
  <div id="confirm-delete-campaign-modal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/50 backdrop-blur-sm" aria-modal="true">
    <div class="mx-4 w-full max-w-md rounded-xl border border-border bg-card p-6 shadow-lg">
      <div class="flex items-center gap-3 text-destructive mb-4">
        <span class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-destructive/10">
          <i data-lucide="alert-triangle" class="h-5 w-5 text-destructive"></i>
        </span>
        <h3 class="text-heading-md font-semibold text-foreground">ุชุฃููุฏ ุญุฐู ุงูุญููุฉ</h3>
      </div>
      <p class="text-body-sm text-muted-foreground mb-2">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุญููุฉ <strong id="confirm-delete-campaign-name" class="text-foreground"></strong>ุ</p>
      <p class="text-body-xs text-muted-foreground mb-6">ุณูุชู ุญุฐู ุงูุญููุฉ ูุฌููุน ุจูุงูุงุชูุง ููุงุฆูุงู ููุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.</p>
      <div class="flex items-center justify-end gap-2">
        <button type="button" id="confirm-delete-campaign-cancel" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-body-sm font-medium transition hover:bg-accent hover:text-accent-foreground">
          ุฅูุบุงุก
        </button>
        <button type="button" id="confirm-delete-campaign-submit" class="inline-flex items-center gap-2 rounded-md bg-destructive px-4 py-2 text-body-sm font-medium text-destructive-foreground transition hover:bg-destructive/90">
          ุญุฐู ุงูุญููุฉ
        </button>
      </div>
    </div>
  </div>

  <script>
    // ==================== ูุธุงู ุงูุฅุดุนุงุฑุงุช Toast ====================
    function showToast(message, type = 'info') {
      // ุฅุฒุงูุฉ ุฃู toast ููุฌูุฏ
      const existingToast = document.querySelector('.toast-notification');
      if (existingToast) existingToast.remove();
      
      // ุฅูุดุงุก ุนูุตุฑ Toast
      const toast = document.createElement('div');
      toast.className = 'toast-notification fixed bottom-4 left-4 z-[9999] rounded-lg px-4 py-3 shadow-lg transition-all duration-300 transform translate-y-full opacity-0 flex items-center gap-3 max-w-md';
      
      // ุชุญุฏูุฏ ุงูููู ูุงูุฃููููุฉ ุญุณุจ ุงูููุน
      let bgColor, icon;
      switch(type) {
        case 'success':
          bgColor = 'bg-primary text-white';
          icon = '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
          break;
        case 'error':
          bgColor = 'bg-destructive text-white';
          icon = '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
          break;
        case 'warning':
          bgColor = 'bg-warning text-white';
          icon = '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
          break;
        default:
          bgColor = 'bg-foreground text-background';
          icon = '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
      }
      
      toast.classList.add(...bgColor.split(' '));
      toast.innerHTML = `${icon}<span class="text-body-sm">${message}</span>`;
      document.body.appendChild(toast);
      
      // ุฅุธูุงุฑ ุงูู Toast
      requestAnimationFrame(() => {
        toast.classList.remove('translate-y-full', 'opacity-0');
      });
      
      // ุฅุฎูุงุก ุงูู Toast ุจุนุฏ 4 ุซูุงูู
      setTimeout(() => {
        toast.classList.add('translate-y-full', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }
    
    // ูุญุต ุชุณุฌูู ุงูุฏุฎูู
    const isLoggedIn = localStorage.getItem('tchat_logged_in');
    const token = localStorage.getItem('access_token') || localStorage.getItem('tchat_token');
    
    console.log('๐ ูุญุต ุชุณุฌูู ุงูุฏุฎูู:', {
      isLoggedIn: isLoggedIn,
      token: token ? token.substring(0, 20) + '...' : 'null',
      tokenLength: token ? token.length : 0
    });
    
    if (!isLoggedIn || isLoggedIn === 'false') {
      console.log('โ ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู ุฏุฎูููุ ุฅุนุงุฏุฉ ุชูุฌูู ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู');
      window.location.href = './login.html';
    }

    let campaigns = [];
    let selectedRecipients = [];
    let availableTemplates = [];
    
    // Pagination variables
    let currentPage = 1;
    const itemsPerPage = 10;

    // ุชูุณูู ุงููุชุฑุฉ ุจูู ุงูุฏูุนุงุช (ุฏูุงุฆู ุฃู ุณุงุนุงุช)
    function formatCampaignInterval(campaign) {
      const min = campaign.batch_interval_minutes || 0;
      if (min > 0) {
        if (min < 60) return min + (min === 1 ? ' ุฏูููุฉ' : ' ุฏูุงุฆู');
        if (min === 60) return 'ุณุงุนุฉ ูุงุญุฏุฉ';
        const h = min / 60;
        if (h === 2) return 'ุณุงุนุชุงู';
        return h + ' ุณุงุนุงุช';
      }
      const h = campaign.batch_interval_hours || 0;
      if (h <= 0) return '-';
      if (h === 1) return 'ุณุงุนุฉ ูุงุญุฏุฉ';
      if (h === 2) return 'ุณุงุนุชุงู';
      return h + ' ุณุงุนุงุช';
    }

    // ููุณ ุงูุชูุณูู ููู ููุฑุฌุน HTML ุขูู ููุนุฑุถ (ุงูุฑูู ูู .number ูุงููุต ุงูุนุฑุจู ุฎุงุฑุฌู ูุชุฌูุจ ุงูุนูุงุณ ุงูุญุฑูู)
    function formatCampaignIntervalHtml(campaign) {
      const min = campaign.batch_interval_minutes || 0;
      if (min > 0) {
        if (min < 60) return `<span class="number">${min}</span> ${min === 1 ? 'ุฏูููุฉ' : 'ุฏูุงุฆู'}`;
        if (min === 60) return 'ุณุงุนุฉ ูุงุญุฏุฉ';
        const h = min / 60;
        if (h === 2) return 'ุณุงุนุชุงู';
        return `<span class="number">${h}</span> ุณุงุนุงุช`;
      }
      const h = campaign.batch_interval_hours || 0;
      if (h <= 0) return '-';
      if (h === 1) return 'ุณุงุนุฉ ูุงุญุฏุฉ';
      if (h === 2) return 'ุณุงุนุชุงู';
      return `<span class="number">${h}</span> ุณุงุนุงุช`;
    }

    // ุชุญููู ุงูุญููุงุช
    async function loadAndRenderCampaigns() {
      const tbody = document.getElementById('campaigns-table-body');
      tbody.innerHTML = '<tr><td colspan="7" class="h-24 text-center text-body-sm text-muted-foreground">ุฌุงุฑู ุชุญููู ุงูุญููุงุช...</td></tr>';

      try {
        campaigns = await loadCampaigns();
        currentPage = 1; // ุฅุนุงุฏุฉ ุชุนููู ุงูุตูุญุฉ ุงูุญุงููุฉ
        renderCampaigns();
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุงูุญููุงุช:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="h-24 text-center text-destructive text-body-sm">ุชุนุฐุฑ ุชุญููู ุงูุญููุงุช</td></tr>';
      }
    }

    function renderCampaigns() {
      const tbody = document.getElementById('campaigns-table-body');
      
      if (!campaigns.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="h-24 text-center text-body-sm text-muted-foreground">ูุง ุชูุฌุฏ ุญููุงุช ุญุงููุงู</td></tr>';
        updatePaginationInfo(0, 0, 0, 1, 1);
        return;
      }

      // ุญุณุงุจ ุงูุตูุญุงุช
      const totalPages = Math.ceil(campaigns.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, campaigns.length);
      const currentCampaigns = campaigns.slice(startIndex, endIndex);
      
      // ุชุญุฏูุซ ูุนูููุงุช ุงูู pagination
      updatePaginationInfo(startIndex + 1, endIndex, campaigns.length, currentPage, totalPages);

      tbody.innerHTML = currentCampaigns.map(campaign => {
        const statusClass = getStatusBadgeClass(campaign.status);
        const statusText = getStatusText(campaign.status);
        const progressPercent = campaign.total_recipients > 0 
          ? Math.round((campaign.sent_count / campaign.total_recipients) * 100) 
          : 0;

        return `
          <tr class="hover:bg-muted/40 transition-colors">
            <td class="px-4 py-4">
              <div class="space-y-1">
                <div class="flex items-center gap-2">
                  <div class="text-body-md font-semibold">${campaign.name}</div>
                  ${campaign.is_smart_send ? `
                    <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground" title="ุญููุฉ ุฐููุฉ">
                      <i data-lucide="zap" class="h-3 w-3"></i>
                    </span>
                  ` : ''}
                </div>
                <div class="text-body-sm text-muted-foreground">${campaign.description || 'ุจุฏูู ูุตู'}</div>
                <div class="text-body-xs text-muted-foreground">ุชู ุงูุฅูุดุงุก: <span class="number">${new Date(campaign.created_at).toLocaleDateString('en-GB')}</span></div>
              </div>
            </td>
            <td class="px-4 py-4 text-center">
              <span class="inline-flex items-center rounded-full border border-input px-3 py-1 text-xs font-semibold bg-accent text-accent-foreground">
                ${campaign.template_name}
              </span>
            </td>
            <td class="px-4 py-4 text-center">
              <span class="inline-flex items-center rounded-full border border-input px-3 py-1 text-xs font-semibold ${statusClass}">
                ${statusText}
              </span>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="text-body-md font-medium number">${campaign.total_recipients}</div>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="space-y-1">
                <div class="text-body-sm">
                  <span class="number">${campaign.sent_count}</span> / <span class="number">${campaign.total_recipients}</span>
                </div>
                <div class="w-full bg-muted rounded-full h-2">
                  <div class="bg-primary h-2 rounded-full transition-all" style="width: ${progressPercent}%"></div>
                </div>
                <div class="text-body-xs text-muted-foreground number">${progressPercent}%</div>
              </div>
            </td>
            <td class="px-4 py-4 text-center">
              <div class="text-body-sm text-muted-foreground">
                <div class="number">${campaign.batch_size}</div>
                <div>ูู ${formatCampaignIntervalHtml(campaign)}</div>
              </div>
            </td>
            <td class="px-4 py-2 text-center align-middle">
              <div class="flex items-center justify-center gap-1">
                <button onclick="viewCampaignDetails(${campaign.id})" class="inline-flex h-8 w-8 shrink-0 items-center justify-center rounded-md border border-input bg-background p-0 text-muted-foreground transition hover:text-foreground" style="min-width:32px;min-height:32px;max-width:32px;max-height:32px" title="ุนุฑุถ ุงูุชูุงุตูู">
                  <i data-lucide="eye" class="h-3 w-3"></i>
                </button>
                ${campaign.status === 'draft' ? `
                  <button onclick="startCampaign(${campaign.id})" class="inline-flex h-8 w-8 shrink-0 items-center justify-center rounded-md bg-primary p-0 text-primary-foreground transition hover:bg-primary/90" style="min-width:32px;min-height:32px;max-width:32px;max-height:32px" title="ุจุฏุก ุงูุญููุฉ">
                    <i data-lucide="play" class="h-3 w-3"></i>
                  </button>
                ` : ''}
                ${campaign.status === 'running' || campaign.status === 'completed' ? `
                  <button onclick="resendCampaign(${campaign.id})" class="inline-flex h-8 w-8 shrink-0 items-center justify-center rounded-md bg-warning p-0 text-warning-foreground transition hover:bg-warning/90" style="min-width:32px;min-height:32px;max-width:32px;max-height:32px" title="ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู">
                    <i data-lucide="repeat" class="h-3 w-3"></i>
                  </button>
                ` : ''}
                <button type="button" class="btn-delete-campaign inline-flex h-8 w-8 shrink-0 items-center justify-center rounded-md bg-destructive p-0 text-destructive-foreground transition hover:bg-destructive/90" style="min-width:32px;min-height:32px;max-width:32px;max-height:32px" title="ุญุฐู ุงูุญููุฉ" data-campaign-id="${campaign.id}" data-campaign-name="${(campaign.name || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}">
                  <i data-lucide="trash-2" class="h-3 w-3"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      lucide.createIcons();
    }

    function getStatusBadgeClass(status) {
      const classes = {
        'draft': 'bg-muted text-muted-foreground',
        'scheduled': 'bg-warning/10 text-warning',
        'running': 'bg-primary/10 text-primary',
        'completed': 'bg-success/10 text-success',
        'paused': 'bg-warning/10 text-warning',
        'cancelled': 'bg-destructive/10 text-destructive'
      };
      return classes[status] || 'bg-muted text-muted-foreground';
    }

    function getStatusText(status) {
      const texts = {
        'draft': 'ูุณูุฏุฉ',
        'scheduled': 'ูุฌุฏููุฉ',
        'running': 'ููุฏ ุงูุชุดุบูู',
        'completed': 'ููุชููุฉ',
        'paused': 'ูุชูููุฉ',
        'cancelled': 'ููุบูุฉ',
        'pending': 'ูู ุงูุงูุชุธุงุฑ',
        'sent': 'ุฃูุฑุณููุช',
        'delivered': 'ูุตูุช',
        'read': 'ููุฑูุฆุช',
        'replied': 'ุชู ุงูุฑุฏ ุนูููุง',
        'clicked': 'ููููุฑ ุนูููุง',
        'failed': 'ูุดูุช'
      };
      return texts[status] || status;
    }

    // ุชุญููู ุฃุฑูุงู ุงููุงุชุณุงุจ
    async function loadWhatsAppPhoneNumbers() {
      const selectElement = document.getElementById('whatsapp-phone-number');
      
      try {
        const phoneNumbers = await loadMetaPhoneNumbers();
        
        if (phoneNumbers && phoneNumbers.length > 0) {
          selectElement.innerHTML = '<option value="">ุงุฎุชุฑ ุฑูู ุงููุงุชุณุงุจ</option>';
          
          phoneNumbers.forEach(phone => {
            const option = document.createElement('option');
            option.value = phone.id;
            
            // ุชูุธูู ูุชูุณูู ุฑูู ุงููุงุชู
            let displayNumber = phone.display_phone_number || phone.id;
            // ุฅุฒุงูุฉ ุฌููุน ุงููุฑุงุบุงุช ูุงูุฑููุฒ
            displayNumber = displayNumber.replace(/[\s\+\-\(\)]/g, '');
            
            const verifiedName = phone.verified_name || 'ุบูุฑ ูุญุฏุฏ';
            
            option.textContent = `${displayNumber} - ${verifiedName}`;
            option.setAttribute('data-phone-id', phone.id);
            selectElement.appendChild(option);
          });
          
          // ุงุฎุชูุงุฑ ุฃูู ุฑูู ุจุดูู ุงูุชุฑุงุถู
          if (phoneNumbers.length > 0) {
            selectElement.value = phoneNumbers[0].id;
          }
        } else {
          selectElement.innerHTML = '<option value="">ูุง ุชูุฌุฏ ุฃุฑูุงู ูุชุงุญุฉ</option>';
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุฃุฑูุงู ุงููุงุชุณุงุจ:', error);
        selectElement.innerHTML = '<option value="">ุฎุทุฃ ูู ุชุญููู ุงูุฃุฑูุงู</option>';
      }
    }

    // ุนุฑุถ/ุฅุฎูุงุก ูุงูุฐุฉ ุฅูุดุงุก ุงูุญููุฉ
    function showCreateCampaignModal() {
      document.getElementById('create-campaign-modal').classList.remove('hidden');
      document.getElementById('create-campaign-modal').classList.add('flex');
      loadTemplatesForCampaign();
      const src = document.getElementById('recipients-source').value;
      const targetWrap = document.getElementById('target-country-wrap');
      if (targetWrap) targetWrap.style.display = (src === 'database') ? 'block' : 'none';
      loadCampaignCountryOptions().then(function () { loadRecipientsPreview(); });
      loadWhatsAppPhoneNumbers();
    }

    function hideCreateCampaignModal() {
      document.getElementById('create-campaign-modal').classList.add('hidden');
      document.getElementById('create-campaign-modal').classList.remove('flex');
      resetCampaignForm();
    }

    function resetCampaignForm() {
      document.getElementById('campaign-name').value = '';
      document.getElementById('campaign-description').value = '';
      document.getElementById('campaign-template').value = '';
      document.getElementById('whatsapp-phone-number').value = '';
      document.getElementById('recipients-source').value = 'database';
      const targetCountrySelect = document.getElementById('target-country-dial-code');
      if (targetCountrySelect) targetCountrySelect.value = '';
      document.getElementById('csv-file').value = '';
      document.getElementById('manual-recipients').value = '';
      selectedRecipients = [];
      // ุฅุฎูุงุก ุตูุฑุฉ ุงูุฑุฃุณ ููุณุญ ููููุง
      const headerBox = document.getElementById('create-campaign-header-image-box');
      if (headerBox) headerBox.classList.add('hidden');
      const headerUrl = document.getElementById('create-campaign-header-image-url');
      if (headerUrl) headerUrl.value = '';
      const headerFile = document.getElementById('create-campaign-header-image-file');
      if (headerFile) headerFile.value = '';
      const headerPreview = document.getElementById('create-campaign-header-image-preview');
      if (headerPreview) headerPreview.classList.add('hidden');
      const headerProgress = document.getElementById('create-campaign-header-image-upload-progress');
      if (headerProgress) headerProgress.classList.add('hidden');
      
      // ุฅุนุงุฏุฉ ุชุนููู ุฃุนุฏุงุฏ ุงููุตุงุฏุฑ
      updateSourceCount('manual', 0);
      updateSourceCount('csv', 0);
      
      handleRecipientsSourceChange();
    }

    // ุนูุฏ ุชุบููุฑ ุงููุงูุจ ูู ูููุฐุฌ ุฅูุดุงุก ุงูุญููุฉ: ุฅุธูุงุฑ ุญูู ุตูุฑุฉ ุงูุฑุฃุณ ุฅู ูุงู ุงููุงูุจ ูุญุชูููุง
    let createCampaignHeaderImageListenerAttached = false;
    async function onCreateCampaignTemplateChange() {
      const templateName = document.getElementById('campaign-template').value;
      const box = document.getElementById('create-campaign-header-image-box');
      const urlInput = document.getElementById('create-campaign-header-image-url');
      const fileInput = document.getElementById('create-campaign-header-image-file');
      const previewDiv = document.getElementById('create-campaign-header-image-preview');
      const previewImg = document.getElementById('create-campaign-header-image-preview-img');
      if (!box) return;
      if (!templateName) {
        box.classList.add('hidden');
        if (urlInput) urlInput.value = '';
        if (fileInput) fileInput.value = '';
        if (previewDiv) previewDiv.classList.add('hidden');
        const prog = document.getElementById('create-campaign-header-image-upload-progress');
        if (prog) prog.classList.add('hidden');
        return;
      }
      const template = (availableTemplates || []).find(t => t.name === templateName);
      if (!template) {
        box.classList.add('hidden');
        return;
      }
      const analysis = typeof analyzeTemplate === 'function' ? analyzeTemplate(template) : { header: { needed: false } };
      if (analysis.header && analysis.header.needed && analysis.header.type === 'image') {
        box.classList.remove('hidden');
        lucide.createIcons();
        if (!createCampaignHeaderImageListenerAttached && fileInput) {
          createCampaignHeaderImageListenerAttached = true;
          fileInput.addEventListener('change', async function() {
            const file = this.files && this.files[0];
            if (!file) {
              if (urlInput) urlInput.value = '';
              if (previewDiv) previewDiv.classList.add('hidden');
              return;
            }
            if (!file.type.match(/^image\/(jpeg|png|jpg)$/)) {
              showToast('ุงูููู ูุฌุจ ุฃู ูููู ุตูุฑุฉ (JPEG ุฃู PNG)', 'error');
              return;
            }
            if (file.size > 5 * 1024 * 1024) {
              showToast('ุญุฌู ุงูุตูุฑุฉ ูุฌุจ ุฃูุง ูุชุฌุงูุฒ 5 ููุฌุงุจุงูุช', 'error');
              return;
            }
            const token = localStorage.getItem('access_token') || localStorage.getItem('tchat_token');
            if (!token) {
              showToast('ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู', 'error');
              return;
            }
            const baseUrl = (typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : '/api/v1').replace(/\/$/, '');
            const formData = new FormData();
            formData.append('file', file);
            const progressEl = document.getElementById('create-campaign-header-image-upload-progress');
            const progressBar = document.getElementById('create-campaign-header-image-upload-progress-bar');
            const progressPercent = document.getElementById('create-campaign-header-image-upload-percent');
            function setProgress(pct) {
              const v = Math.min(100, Math.max(0, pct));
              if (progressBar) progressBar.style.width = v + '%';
              if (progressPercent) progressPercent.textContent = Math.round(v) + '%';
            }
            if (progressEl) {
              progressEl.classList.remove('hidden');
              setProgress(0);
              lucide.createIcons();
            }
            if (fileInput) fileInput.disabled = true;
            try {
              const data = await new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `${baseUrl}/campaigns/upload-header-image`);
                xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                xhr.responseType = 'json';
                xhr.upload.onprogress = function(ev) {
                  if (ev.lengthComputable) setProgress((ev.loaded / ev.total) * 100);
                  else setProgress(50); // ุบูุฑ ูุนุฑูู ุงูุญุฌู
                };
                xhr.onload = function() {
                  try {
                    const res = typeof xhr.response === 'object' ? xhr.response : JSON.parse(xhr.responseText || '{}');
                    resolve(res);
                  } catch (e) {
                    reject(new Error('Invalid response'));
                  }
                };
                xhr.onerror = function() { reject(new Error('Network error')); };
                xhr.send(formData);
              });
              setProgress(100);
              if (data.success && data.url) {
                if (urlInput) urlInput.value = data.url;
                if (previewImg) previewImg.src = data.url;
                if (previewDiv) previewDiv.classList.remove('hidden');
                showToast('ุชู ุฑูุน ุงูุตูุฑุฉ ุจูุฌุงุญ', 'success');
              } else {
                showToast(data.message || data.error || 'ูุดู ุฑูุน ุงูุตูุฑุฉ', 'error');
              }
            } catch (err) {
              console.error('ุฑูุน ุตูุฑุฉ ุงูุฑุฃุณ:', err);
              showToast('ูุดู ุฑูุน ุงูุตูุฑุฉ', 'error');
            } finally {
              if (progressEl) progressEl.classList.add('hidden');
              if (progressBar) progressBar.style.width = '0%';
              if (progressPercent) progressPercent.textContent = '0%';
              if (fileInput) fileInput.disabled = false;
            }
          });
        }
      } else {
        box.classList.add('hidden');
        if (urlInput) urlInput.value = '';
        if (fileInput) fileInput.value = '';
        if (previewDiv) previewDiv.classList.add('hidden');
        const prog = document.getElementById('create-campaign-header-image-upload-progress');
        if (prog) prog.classList.add('hidden');
      }
    }

    // ุชุญููู ุงูููุงูุจ ููุญููุฉ
    async function loadTemplatesForCampaign() {
      try {
        availableTemplates = await loadMetaTemplates(100);
        const templateSelect = document.getElementById('campaign-template');
        
        templateSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุงูุจ</option>' +
          availableTemplates
            .filter(template => template.status === 'APPROVED')
            .map(template => `<option value="${template.name}">${template.name}</option>`)
            .join('');
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุงูููุงูุจ:', error);
      }
    }

    // ูุนุงูุฌุฉ ุชุบููุฑ ูุตุฏุฑ ุงููุณุชูุจููู
    function handleRecipientsSourceChange() {
      const source = document.getElementById('recipients-source').value;
      const csvSection = document.getElementById('csv-upload-section');
      const manualSection = document.getElementById('manual-input-section');
      const targetCountryWrap = document.getElementById('target-country-wrap');
      
      // ุฅุฎูุงุก ุฌููุน ุงูุฃูุณุงู ุฃููุงู
      csvSection.style.display = 'none';
      manualSection.style.display = 'none';
      if (targetCountryWrap) targetCountryWrap.style.display = 'none';
      
      // ูุณุญ ุงููุณุชูุจููู ุนูุฏ ุชุบููุฑ ุงููุตุฏุฑ
      selectedRecipients = [];
      
      if (source === 'csv') {
        csvSection.style.display = 'block';
        // ุชุญุฏูุซ ูู ุนุฏุฏ CSV ุงููุญููุธ
        const csvCount = document.getElementById('csv-file').files.length > 0 ? 
          parseInt(document.querySelector('option[value="csv"]').dataset.count || 0) : 0;
        if (csvCount > 0) {
          // ุฅุนุงุฏุฉ ูุฑุงุกุฉ ุงูููู ุฅุฐุง ูุงู ููุฌูุฏุงู
          const fileInput = document.getElementById('csv-file');
          if (fileInput.files[0]) {
            handleCSVUpload({ target: fileInput });
          }
        }
      } else if (source === 'manual') {
        manualSection.style.display = 'block';
        parseManualRecipients(); // ุชุญุฏูุซ ุงูุนุฏุงุฏ
      } else {
        // database: ุฅุธูุงุฑ ุฎูุงุฑ ุงูุฏููุฉ ุงููุณุชูุฏูุฉ ูุชุญููู ุงููุงุฆูุฉ
        if (targetCountryWrap) targetCountryWrap.style.display = 'block';
        loadCampaignCountryOptions().then(() => loadRecipientsPreview());
        return;
      }
      
      updateRecipientsPreview();
      updateBatchPreview();
    }

    // ุชุญููู ุฎูุงุฑุงุช ุงูุฏูู ููุญููุฉ (ุฃุฑูุงู ุชุจุฏุฃ ุจููุชุงุญ ุงูุฏููุฉ)
    async function loadCampaignCountryOptions() {
      const select = document.getElementById('target-country-dial-code');
      if (!select) return;
      try {
        const base = (typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : '/api/v1').replace(/\/$/, '');
        const token = localStorage.getItem('access_token') || localStorage.getItem('tchat_token');
        const res = await fetch(`${base}/campaigns/customer-countries`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const json = await res.json();
        select.innerHTML = '<option value="">ุฌููุน ุงูุนููุงุก</option>';
        if (json.success && Array.isArray(json.data)) {
          json.data.forEach(function (item) {
            const opt = document.createElement('option');
            opt.value = item.dial_code;
            opt.textContent = item.label_ar + ' (+' + item.dial_code + ') โ ' + (item.count || 0);
            opt.dataset.count = String(item.count || 0);
            select.appendChild(opt);
          });
        }
        lucide.createIcons();
      } catch (e) {
        console.error('ุชุญููู ุฏูู ุงูุญููุฉ:', e);
      }
    }

    // ุนูุฏ ุชุบููุฑ ุงูุฏููุฉ ุงููุณุชูุฏูุฉ: ุชุญุฏูุซ ุงูุนุฏุฏ ูุงููุนุงููุฉ
    function onTargetCountryChange() {
      const source = document.getElementById('recipients-source').value;
      if (source !== 'database') return;
      const dialCode = (document.getElementById('target-country-dial-code') || {}).value || '';
      updateDatabaseCountByDialCode(dialCode);
    }

    async function updateDatabaseCountByDialCode(dialCode) {
      const base = (typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : '/api/v1').replace(/\/$/, '');
      const token = localStorage.getItem('access_token') || localStorage.getItem('tchat_token');
      try {
        const url = dialCode
          ? `${base}/campaigns/customer-count?dial_code=${encodeURIComponent(dialCode)}`
          : `${base}/campaigns/customer-count`;
        const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
        const json = await res.json();
        const count = (json.count != null) ? json.count : (json.data && json.data.count != null ? json.data.count : 0);
        databaseCustomersCount = count;
        updateSourceCount('database', count);
        updateRecipientsPreview();
        updateBatchPreview();
      } catch (e) {
        console.error('ุชุญุฏูุซ ุนุฏุฏ ุงูุนููุงุก ุญุณุจ ุงูุฏููุฉ:', e);
      }
    }

    // ุชุญููู ุงููุณุชูุจููู ูู ุงูุฅุฏุฎุงู ุงููุฏูู
    function parseManualRecipients() {
      const manualText = document.getElementById('manual-recipients').value.trim();
      const countEl = document.getElementById('manual-count');
      
      if (!manualText) {
        selectedRecipients = [];
        countEl.textContent = '0';
        updateRecipientsPreview();
        return;
      }

      const lines = manualText.split('\n').filter(line => line.trim());
      selectedRecipients = [];
      let invalidCount = 0;

      lines.forEach((line, index) => {
        const trimmedLine = line.trim();
        if (!trimmedLine) return;

        let phone = '';
        let name = '';
        
        // ุฏุนู ุงูููุงุตู ุงููุฎุชููุฉ
        const separator = trimmedLine.includes(',') ? ',' : trimmedLine.includes(';') ? ';' : null;
        
        if (separator) {
          // ุชูุณูู: ุฑูู,ุงุณู ุฃู ุฑูู;ุงุณู
          const parts = trimmedLine.split(separator).map(part => part.trim());
          phone = parts[0];
          name = parts[1] || '';
        } else {
          // ุฑูู ููุท
          phone = trimmedLine;
        }
        
        // ุชูุธูู ุงูุฑูู ูู ุงููุณุงูุงุช ูุงูุฑููุฒ
        phone = phone.replace(/[\s\-\+\(\)]/g, '');
        
        // ุชุญููู ุงูุฃุฑูุงู ุงูุชู ุชุจุฏุฃ ุจู 05 ุฃู 5
        if (phone.startsWith('05') && phone.length === 10) {
          phone = '966' + phone.substring(1);
        } else if (phone.startsWith('5') && phone.length === 9) {
          phone = '966' + phone;
        } else if (phone.startsWith('00966')) {
          phone = phone.substring(2);
        } else if (phone.startsWith('+966')) {
          phone = phone.substring(1);
        }
        
        // ุงูุชุญูู ูู ุตุญุฉ ุงูุฑูู
        if (/^966\d{9}$/.test(phone)) {
          selectedRecipients.push({
            customer_id: 0,
            phone_number: phone,
            customer_name: name || `ุนููู ${phone.slice(-4)}`
          });
        } else if (phone) {
          invalidCount++;
        }
      });

      countEl.textContent = selectedRecipients.length;
      
      // ุชุญุฏูุซ ุงูุนุฏุฏ ูู ูุงุฆูุฉ ุงููุตุงุฏุฑ
      updateSourceCount('manual', selectedRecipients.length);
      
      // ุนุฑุถ ุฑุณุงูุฉ ุฅุฐุง ูุงู ููุงู ุฃุฑูุงู ุบูุฑ ุตุงูุญุฉ
      if (invalidCount > 0 && selectedRecipients.length > 0) {
        showToast(`ุชู ุชุฌุงูู ${invalidCount} ุฑูู ุบูุฑ ุตุงูุญ`, 'warning');
      } else if (invalidCount > 0 && selectedRecipients.length === 0) {
        showToast('ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃุฑูุงู ุตุงูุญุฉ. ุชุฃูุฏ ูู ุงูุชูุณูู: 966XXXXXXXXX ุฃู 05XXXXXXXX', 'error');
      }
      
      updateRecipientsPreview();
      updateBatchPreview();
    }

    // ูุนุงูุฌุฉ ุฑูุน ููู CSV
    function handleCSVUpload(event) {
      const file = event.target.files[0];
      
      if (!file) {
        selectedRecipients = [];
        updateRecipientsPreview();
        updateBatchPreview();
        return;
      }

      if (!file.name.endsWith('.csv')) {
        showToast('ูุฑุฌู ุฑูุน ููู CSV ููุท', 'error');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.split('\n').filter(line => line.trim());
          selectedRecipients = [];

          // ุชุฎุทู ุงูุณุทุฑ ุงูุฃูู ุฅุฐุง ูุงู ูุญุชูู ุนูู ุฑุคูุณ ุงูุฃุนูุฏุฉ
          const startIndex = lines[0].toLowerCase().includes('phone') || lines[0].toLowerCase().includes('name') || lines[0].toLowerCase().includes('ุฑูู') || lines[0].toLowerCase().includes('ุงุณู') ? 1 : 0;

          for (let i = startIndex; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            // ุฏุนู ุงูููุงุตู ุงููุฎุชููุฉ (comma, semicolon, tab)
            const separator = line.includes(';') ? ';' : line.includes('\t') ? '\t' : ',';
            const parts = line.split(separator).map(part => part.trim().replace(/^["']+|["']+$/g, '')); // ุฅุฒุงูุฉ ุนูุงูุงุช ุงูุงูุชุจุงุณ ููุท ูู ุงูุจุฏุงูุฉ ูุงูููุงูุฉ

            if (parts.length === 0) continue;

            let phone = '';
            let name = '';

            if (parts.length === 1) {
              // ุฑูู ููุท - ุชูุธูู ุงูุฑูู ูู ุงููุณุงูุงุช ูุงูุฑููุฒ
              phone = parts[0].replace(/[\s\-\+]/g, '');
            } else if (parts.length >= 2) {
              // ุฑูู ูุงุณู (ูููู ุฃู ูููู ุงูุฑูู ูู ุงูุนููุฏ ุงูุฃูู ุฃู ุงูุซุงูู)
              const cleanPart0 = parts[0].replace(/[\s\-\+]/g, '');
              const cleanPart1 = parts[1].replace(/[\s\-\+]/g, '');
              
              if (/^966\d{9}$/.test(cleanPart0)) {
                // ุงูุนููุฏ ุงูุฃูู ุฑูู ุตุญูุญ
                phone = cleanPart0;
                name = parts[1]; // ุงูุงุญุชูุงุธ ุจุงููุณุงูุงุช ูู ุงูุงุณู
              } else if (/^966\d{9}$/.test(cleanPart1)) {
                // ุงูุนููุฏ ุงูุซุงูู ุฑูู ุตุญูุญ
                name = parts[0]; // ุงูุงุญุชูุงุธ ุจุงููุณุงูุงุช ูู ุงูุงุณู
                phone = cleanPart1;
              } else {
                // ูุญุงููุฉ ุชูุธูู ุงูุฑูู
                phone = cleanPart0.replace(/^0+/, ''); // ุฅุฒุงูุฉ ุงูุฃุตูุงุฑ ูู ุงูุจุฏุงูุฉ
                if (!phone.startsWith('966')) {
                  phone = '966' + phone;
                }
                name = parts[1]; // ุงูุงุญุชูุงุธ ุจุงููุณุงูุงุช ูู ุงูุงุณู
              }
            }

            // ุชูุธูู ุงูุฑูู ุงูููุงุฆู (ุฅุฒุงูุฉ ูู ุดูุก ูุง ุนุฏุง ุงูุฃุฑูุงู)
            phone = phone.replace(/[^\d]/g, '');
            
            // ูุญุงููุฉ ุชุตุญูุญ ุงูุฃุฑูุงู ุงูุชู ุชุจุฏุฃ ุจู 05
            if (phone.startsWith('05') && phone.length === 10) {
              phone = '966' + phone.substring(1);
            } else if (phone.startsWith('5') && phone.length === 9) {
              phone = '966' + phone;
            }

            // ุชูุธูู ุงูุงุณู (ุฅุฒุงูุฉ ุงููุณุงูุงุช ุงูุฒุงุฆุฏุฉ ููุท)
            name = name.trim().replace(/\s+/g, ' ');

            // ุงูุชุญูู ูู ุตุญุฉ ุงูุฑูู
            if (/^966\d{9}$/.test(phone)) {
              selectedRecipients.push({
                customer_id: 0,
                phone_number: phone,
                customer_name: name || `ุนููู ${phone.slice(-4)}`
              });
            }
          }

          // ุชุญุฏูุซ ุงูุนุฏุฏ ูู ูุงุฆูุฉ ุงููุตุงุฏุฑ
          updateSourceCount('csv', selectedRecipients.length);
          
          if (selectedRecipients.length === 0) {
            showToast('ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃุฑูุงู ุตุญูุญุฉ ูู ุงูููู', 'error');
          } else {
            updateRecipientsPreview();
            updateBatchPreview();
            showToast(`ุชู ุชุญููู ${selectedRecipients.length} ูุณุชูุจู ุจูุฌุงุญ`, 'success');
          }
        } catch (error) {
          console.error('ุฎุทุฃ ูู ูุฑุงุกุฉ ููู CSV:', error);
          showToast('ุญุฏุซ ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู. ุชุฃูุฏ ูู ุตูุบุฉ CSV', 'error');
        }
      };

      reader.onerror = function() {
        showToast('ูุดู ูู ูุฑุงุกุฉ ุงูููู', 'error');
      };

      reader.readAsText(file, 'UTF-8');
    }

    // ุชุญุฏูุซ ูุนุงููุฉ ุงููุณุชูุจููู
    function updateRecipientsPreview() {
      const previewEl = document.getElementById('recipients-preview');
      
      if (selectedRecipients.length === 0) {
        previewEl.innerHTML = `
          <div class="text-center py-8 px-4">
            <div class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-amber-500/10 text-amber-600 dark:text-amber-400 mb-3">
              <i data-lucide="users" class="h-6 w-6"></i>
            </div>
            <p class="text-body-sm font-medium text-foreground/80">ูุง ุชูุฌุฏ ุฃุฑูุงู ุตุญูุญุฉ</p>
            <p class="text-body-xs text-muted-foreground mt-1">ุชุญูู ูู ุงูุชูุณูู: 966XXXXXXXXX</p>
          </div>
        `;
        if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
        return;
      }

      const source = document.getElementById('recipients-source').value;
      const totalCount = (source === 'database' && databaseCustomersCount > 0) ? databaseCustomersCount : selectedRecipients.length;
      const restCount = Math.max(0, totalCount - 5);
      previewEl.innerHTML = `
        <div class="rounded-xl overflow-hidden">
          <div class="flex items-center justify-between gap-3 px-4 py-3 bg-primary/10 border-b border-primary/20">
            <div class="flex items-center gap-2">
              <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-primary text-primary-foreground">
                <i data-lucide="users" class="h-4 w-4"></i>
              </div>
              <h4 class="text-body-md font-semibold text-foreground">ุงููุณุชูุจููู ุงููุญุฏุฏูู</h4>
            </div>
            <span class="inline-flex items-center rounded-full bg-primary px-3 py-1 text-body-xs font-semibold text-primary-foreground">${totalCount} ูุณุชูุจู</span>
          </div>
          <div class="max-h-36 overflow-y-auto p-2 space-y-1">
            ${selectedRecipients.slice(0, 5).map((r, i) => `
              <div class="flex items-center justify-between gap-3 rounded-lg px-3 py-2 text-body-sm ${i % 2 === 0 ? 'bg-background/60' : 'bg-muted/30'} hover:bg-muted/50 transition-colors">
                <div class="flex items-center gap-2 min-w-0 flex-1">
                  <span class="flex h-7 w-7 shrink-0 items-center justify-center rounded-full bg-primary/15 text-primary">${typeof userIconSvg === 'function' ? userIconSvg('h-4 w-4') : '<i data-lucide=\"user\" class=\"h-4 w-4\"></i>'}</span>
                  <span class="truncate font-medium text-foreground">${r.customer_name || 'โ'}</span>
                </div>
                <span class="number shrink-0 text-muted-foreground font-mono text-body-xs dir-ltr">${r.phone_number}</span>
              </div>
            `).join('')}
            ${restCount > 0 ? `
              <div class="rounded-lg px-3 py-2 text-center bg-muted/40 border border-dashed border-border">
                <span class="text-body-xs font-medium text-muted-foreground">ู ${restCount} ูุณุชูุจู ุขุฎุฑ</span>
              </div>
            ` : ''}
          </div>
        </div>
      `;
      if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
    }

    // ุชุญุฏูุซ ุนุฏุฏ ุงููุณุชูุจููู ูู ูุงุฆูุฉ ุงููุตุงุฏุฑ
    function updateSourceCount(source, count) {
      const select = document.getElementById('recipients-source');
      const option = select.querySelector(`option[value="${source}"]`);
      if (option) {
        const labels = {
          'database': 'ุงูุนููุงุก ุงููุณุฌููู',
          'manual': 'ุฅุฏุฎุงู ูุฏูู',
          'csv': 'ุฑูุน ููู CSV'
        };
        option.textContent = `${labels[source]} (${count})`;
        option.dataset.count = count;
      }
    }

    // ูุชุบูุฑ ูุชุฎุฒูู ุนุฏุฏ ุงูุนููุงุก ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    let databaseCustomersCount = 0;

    // ูุนุงููุฉ ุงููุณุชูุจููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    async function loadRecipientsPreview() {
      const previewEl = document.getElementById('recipients-preview');
      const source = document.getElementById('recipients-source').value;
      
      if (source === 'database') {
        try {
          const dialCodeEl = document.getElementById('target-country-dial-code');
          const dialCode = (dialCodeEl && dialCodeEl.value) ? dialCodeEl.value.trim() : '';
          let totalCount = 0;
          if (dialCode) {
            const base = (typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : '/api/v1').replace(/\/$/, '');
            const token = localStorage.getItem('access_token') || localStorage.getItem('tchat_token');
            const res = await fetch(`${base}/campaigns/customer-count?dial_code=${encodeURIComponent(dialCode)}`, { headers: { 'Authorization': 'Bearer ' + token } });
            const json = await res.json();
            totalCount = (json.count != null) ? json.count : (json.data && json.data.count != null ? json.data.count : 0);
          } else {
            const stats = await loadSystemStats();
            totalCount = (stats && stats.total_customers) ? stats.total_customers : 0;
          }
          databaseCustomersCount = totalCount;
          updateSourceCount('database', totalCount);

          // ุชุญููู ุนููุฉ ูููุนุงููุฉ ููุท (ุงูู API ูุญุฏู ุจู 200)
          const customers = await loadCustomers(500);
          selectedRecipients = customers.map(customer => ({
            customer_id: customer.id,
            phone_number: customer.mobile || customer.phone,
            customer_name: customer.name
          })).filter(r => r.phone_number);
          updateRecipientsPreview();
        } catch (error) {
          previewEl.innerHTML = '<div class="text-center text-destructive text-body-sm">ุชุนุฐุฑ ุชุญููู ุงูุนููุงุก</div>';
          updateSourceCount('database', 0);
        }
      } else if (source === 'manual') {
        // ูุตุฏุฑ ูุฏูู: ูุฒุงููุฉ ูู ุญูู ุงููุต ุซู ุนุฑุถ ุงููุนุงููุฉ
        parseManualRecipients();
      } else {
        // CSV ุฃู ุบูุฑ ูุญุฏุฏ: ุนุฑุถ ุงููุนุงููุฉ ุฅู ููุฌุฏุช ูุณุชูุจูููุ ูุฅูุง ุงููุต ุงูุงูุชุฑุงุถู
        if (selectedRecipients.length > 0) {
          updateRecipientsPreview();
        } else {
          previewEl.innerHTML = `
          <div class="text-center py-8 px-4 text-body-sm text-muted-foreground">
            <div class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-primary/10 text-primary mb-3">
              <i data-lucide="users" class="h-6 w-6"></i>
            </div>
            <p class="font-medium text-foreground/80">ุณูุชู ุนุฑุถ ุงููุณุชูุจููู ููุง</p>
            <p class="text-body-xs mt-1">ุฃุฏุฎู ุงูุฃุฑูุงู ุฃู ุงุฎุชุฑ ุงููุตุฏุฑ ุฃุนูุงู</p>
          </div>
        `;
          if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
        }
      }
      
      updateBatchPreview();
    }

    // ุชุญุฏูุซ ูุนุงููุฉ ุงูุชุฌุฒุฆุฉ
    function updateBatchPreview() {
      const previewContent = document.getElementById('batch-preview-content');
      const sendType = document.getElementById('send-type').value;
      const batchSize = parseInt(document.getElementById('batch-size').value);
      const batchInterval = parseInt(document.getElementById('batch-interval').value);
      
      if (sendType === 'all') {
        previewContent.innerHTML = `
          <div class="text-warning">
            <i data-lucide="alert-triangle" class="inline h-4 w-4 ml-1"></i>
            ุณูุชู ุฅุฑุณุงู ุงูุฑุณุงุฆู ูุฌููุน ุงููุณุชูุจููู (${selectedRecipients.length}) ุฏูุนุฉ ูุงุญุฏุฉ
          </div>
        `;
        return;
      }

      const totalRecipients = selectedRecipients.length;
      const batchCount = Math.ceil(totalRecipients / batchSize);
      const totalDurationMinutes = (batchCount - 1) * batchInterval;
      // ุนุฑุถ ุงูุฑูู ุฏุงุฎู .number ูุงููุต ุงูุนุฑุจู ุฎุงุฑุฌู ูุชุฌูุจ ุงูุนูุงุณ ุงูุญุฑูู (bidi)
      const intervalLabelHtml = batchInterval < 60
        ? `<span class="number">${batchInterval}</span> ุฏูููุฉ`
        : (batchInterval === 60 ? 'ุณุงุนุฉ ูุงุญุฏุฉ' : `<span class="number">${batchInterval / 60}</span> ุณุงุนุฉ`);
      const durationLabelHtml = totalDurationMinutes < 60
        ? `<span class="number">${totalDurationMinutes}</span> ุฏูููุฉ`
        : `<span class="number">${totalDurationMinutes / 60}</span> ุณุงุนุฉ`;

      previewContent.innerHTML = `
          <div class="space-y-2 text-body-sm">
            <div class="flex justify-between">
              <span>ุนุฏุฏ ุงูุฏูุนุงุช:</span>
              <span class="number">${batchCount}</span>
            </div>
            <div class="flex justify-between">
              <span>ุญุฌู ูู ุฏูุนุฉ:</span>
              <span class="number">${batchSize}</span> ุนููู
            </div>
            <div class="flex justify-between">
              <span>ุงููุชุฑุฉ ุจูู ุงูุฏูุนุงุช:</span>
              <span>${intervalLabelHtml}</span>
            </div>
            <div class="flex justify-between">
              <span>ุงููุฏุฉ ุงูุฅุฌูุงููุฉ:</span>
              <span>${durationLabelHtml}</span>
            </div>
          </div>
      `;
    }

    // ูุนุงูุฌุฉ ุชุบููุฑ ููุน ุงูุฅุฑุณุงู
    function handleSendTypeChange() {
      updateBatchPreview();
    }

    // ูุนุงููุฉ ุงูุญููุฉ ูุจู ุงูุฅูุดุงุก
    function previewCampaign() {
      const name = document.getElementById('campaign-name').value.trim();
      const templateName = document.getElementById('campaign-template').value;
      const whatsappPhoneNumberID = document.getElementById('whatsapp-phone-number').value;
      const batchSize = parseInt(document.getElementById('batch-size').value);
      const batchInterval = parseInt(document.getElementById('batch-interval').value);
      const sendType = document.getElementById('send-type').value;
      const isSmartSend = document.getElementById('enable-smart-send').checked;
      
      // ุงูุชุญูู ูู ุงูุจูุงูุงุช
      if (!name) {
        showToast('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุญููุฉ ุฃููุงู', 'warning');
        return;
      }
      
      if (!templateName) {
        showToast('ูุฑุฌู ุงุฎุชูุงุฑ ุงููุงูุจ ุฃููุงู', 'warning');
        return;
      }
      
      if (selectedRecipients.length === 0) {
        showToast('ูุฑุฌู ุฅุถุงูุฉ ูุณุชูุจููู ุฃููุงู', 'warning');
        return;
      }
      
      // ุญุณุงุจ ุนุฏุฏ ุงูุฏูุนุงุช ูุงููุฏุฉ (batchInterval ุจุงูุฏูุงุฆู)
      const totalBatches = sendType === 'all' ? 1 : Math.ceil(selectedRecipients.length / batchSize);
      const totalDurationMinutes = sendType === 'all' ? 0 : (totalBatches - 1) * batchInterval;
      const totalDurationLabel = totalDurationMinutes < 60 ? (totalDurationMinutes + ' ุฏูููุฉ') : (totalDurationMinutes / 60) + ' ุณุงุนุฉ';
      
      // ุงูุจุญุซ ุนู ุงุณู ุงููุงูุจ
      const template = availableTemplates.find(t => t.name === templateName);
      const templateDisplay = template ? template.name : templateName;
      
      // ุงูุจุญุซ ุนู ุฑูู ุงููุงุชุณุงุจ
      const phoneSelect = document.getElementById('whatsapp-phone-number');
      const selectedPhone = phoneSelect.options[phoneSelect.selectedIndex]?.text || 'ุบูุฑ ูุญุฏุฏ';
      
      // ุนุฑุถ ุงููุนุงููุฉ
      const previewHTML = `
        <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm" id="campaign-preview-overlay" onclick="if(event.target === this) this.remove()">
          <div class="w-full max-w-lg mx-4 bg-card rounded-xl border shadow-lg">
            <div class="flex items-center justify-between border-b border-border p-4">
              <h3 class="text-heading-md font-bold">ูุนุงููุฉ ุงูุญููุฉ</h3>
              <button onclick="document.getElementById('campaign-preview-overlay').remove()" class="text-muted-foreground hover:text-foreground">
                <i data-lucide="x" class="h-5 w-5"></i>
              </button>
            </div>
            <div class="p-4 space-y-4">
              <div class="grid gap-3">
                <div class="flex justify-between items-center py-2 border-b border-border">
                  <span class="text-muted-foreground">ุงุณู ุงูุญููุฉ</span>
                  <span class="font-semibold">${name}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-border">
                  <span class="text-muted-foreground">ุงููุงูุจ</span>
                  <span class="font-semibold">${templateDisplay}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-border">
                  <span class="text-muted-foreground">ุฑูู ุงููุงุชุณุงุจ</span>
                  <span class="font-semibold text-left" dir="ltr">${selectedPhone}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-border">
                  <span class="text-muted-foreground">ุนุฏุฏ ุงููุณุชูุจููู</span>
                  <span class="font-semibold number">${selectedRecipients.length}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-border">
                  <span class="text-muted-foreground">ููุน ุงูุฅุฑุณุงู</span>
                  <span class="font-semibold">${sendType === 'all' ? 'ุฏูุนุฉ ูุงุญุฏุฉ' : 'ูุฌุฒุฃ'}</span>
                </div>
                ${sendType !== 'all' ? `
                <div class="flex justify-between items-center py-2 border-b border-border">
                  <span class="text-muted-foreground">ุญุฌู ุงูุฏูุนุฉ</span>
                  <span class="font-semibold number">${batchSize} ูุณุชูุจู</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-border">
                  <span class="text-muted-foreground">ุนุฏุฏ ุงูุฏูุนุงุช</span>
                  <span class="font-semibold number">${totalBatches}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-border">
                  <span class="text-muted-foreground">ุงููุฏุฉ ุงูุฅุฌูุงููุฉ</span>
                  <span class="font-semibold number">${totalDurationLabel}</span>
                </div>
                ` : ''}
                <div class="flex justify-between items-center py-2">
                  <span class="text-muted-foreground">ุงูุฅุฑุณุงู ุงูุฐูู</span>
                  <span class="font-semibold ${isSmartSend ? 'text-primary' : 'text-muted-foreground'}">${isSmartSend ? 'ููุนูู โ' : 'ุบูุฑ ููุนูู'}</span>
                </div>
              </div>
            </div>
            <div class="flex justify-end gap-2 border-t border-border p-4">
              <button onclick="document.getElementById('campaign-preview-overlay').remove()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-body-sm font-medium transition hover:bg-accent">
                ุฅุบูุงู
              </button>
              <button onclick="document.getElementById('campaign-preview-overlay').remove(); createCampaign();" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
                <i data-lucide="send" class="h-4 w-4"></i>
                ุฅูุดุงุก ุงูุญููุฉ
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', previewHTML);
      lucide.createIcons();
    }

    // ุฅูุดุงุก ุงูุญููุฉ
    async function createCampaign() {
      const name = document.getElementById('campaign-name').value.trim();
      const description = document.getElementById('campaign-description').value.trim();
      const templateName = document.getElementById('campaign-template').value;
      const batchSize = parseInt(document.getElementById('batch-size').value);
      const batchInterval = parseInt(document.getElementById('batch-interval').value);
      const sendType = document.getElementById('send-type').value;
      const whatsappPhoneNumberID = document.getElementById('whatsapp-phone-number').value;

      // ุงูุชุญูู ูู ุงูุจูุงูุงุช ุจุดูู ุชูุตููู
      if (!name) {
        showToast('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุญููุฉ', 'error');
        document.getElementById('campaign-name').focus();
        return;
      }
      
      if (!templateName) {
        showToast('ูุฑุฌู ุงุฎุชูุงุฑ ุงููุงูุจ', 'error');
        document.getElementById('campaign-template').focus();
        return;
      }
      
      if (!whatsappPhoneNumberID) {
        showToast('ูุฑุฌู ุงุฎุชูุงุฑ ุฑูู ุงููุงุชุณุงุจ ููุฅุฑุณุงู', 'error');
        document.getElementById('whatsapp-phone-number').focus();
        return;
      }
      const headerImageBox = document.getElementById('create-campaign-header-image-box');
      const headerImageUrlEl = document.getElementById('create-campaign-header-image-url');
      if (headerImageBox && !headerImageBox.classList.contains('hidden') && headerImageUrlEl && !headerImageUrlEl.value.trim()) {
        showToast('ูุฑุฌู ุฑูุน ุตูุฑุฉ ุงูุฑุฃุณ ูููุงูุจ ุงููุญุฏุฏ', 'error');
        return;
      }
      
      const recipientsSource = document.getElementById('recipients-source').value;
      const useAllDatabase = (recipientsSource === 'database');
      if (!useAllDatabase && selectedRecipients.length === 0) {
        showToast('ูุฑุฌู ุฅุถุงูุฉ ูุณุชูุจููู ููุญููุฉ', 'error');
        return;
      }

      const createBtn = document.getElementById('create-campaign-btn');
      createBtn.disabled = true;
      createBtn.innerHTML = '<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i><span>ุฌุงุฑู ุงูุฅูุดุงุก...</span>';
      lucide.createIcons();

      try {
        const isSmartSend = document.getElementById('enable-smart-send').checked;
        
        const headerImageUrlEl = document.getElementById('create-campaign-header-image-url');
        const headerImageUrl = (headerImageUrlEl && headerImageUrlEl.value) ? headerImageUrlEl.value.trim() : '';
        const targetDialCodeEl = document.getElementById('target-country-dial-code');
        const targetCountryDialCode = (useAllDatabase && targetDialCodeEl && targetDialCodeEl.value) ? targetDialCodeEl.value.trim() : '';
        const campaignData = {
          name: name,
          description: description,
          template_name: templateName,
          template_language: 'ar',
          whatsapp_phone_number_id: whatsappPhoneNumberID,
          header_image_url: headerImageUrl,
          batch_size: useAllDatabase ? (sendType === 'all' ? databaseCustomersCount : batchSize) : (sendType === 'all' ? selectedRecipients.length : batchSize),
          batch_interval_hours: sendType === 'all' ? 0 : (batchInterval >= 60 ? batchInterval / 60 : 0),
          batch_interval_minutes: sendType === 'all' ? 0 : batchInterval,
          is_smart_send: isSmartSend,
          use_all_database: useAllDatabase,
          target_country_dial_code: targetCountryDialCode,
          recipients: useAllDatabase ? [] : selectedRecipients
        };

        const response = await fetch(`${API_BASE_URL}/campaigns`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          },
          body: JSON.stringify(campaignData)
        });

        const result = await response.json();
        
        if (result.success) {
          let message = result.message || 'ุชู ุฅูุดุงุก ุงูุญููุฉ ุจูุฌุงุญ!';
          
          // ุฅุฐุง ูุงูุช ููุงู ุฃุฑูุงู ูุณุชุจุนุฏุฉุ ุฃุถู ุชูุงุตูู
          if (result.excluded_count && result.excluded_count > 0) {
            message += ` (${result.final_count} ูุณุชูุจูุ ${result.excluded_count} ูุณุชุจุนุฏ)`;
          }
          
          showToast(message, 'success');
          hideCreateCampaignModal();
          refreshCampaigns();
        } else {
          showToast('ูุดู ูู ุฅูุดุงุก ุงูุญููุฉ: ' + (result.message || result.error || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'), 'error');
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุฅูุดุงุก ุงูุญููุฉ:', error);
        showToast('ุชุนุฐุฑ ุฅูุดุงุก ุงูุญููุฉ. ุชุญูู ูู ุงูุงุชุตุงู', 'error');
      } finally {
        createBtn.disabled = false;
        createBtn.innerHTML = '<i data-lucide="send" class="h-4 w-4"></i><span>ุฅูุดุงุก ุงูุญููุฉ</span>';
        lucide.createIcons();
      }
    }

    // ุนุฑุถ ุชูุงุตูู ุงูุญููุฉ
    async function viewCampaignDetails(campaignId) {
      document.getElementById('campaign-details-modal').classList.remove('hidden');
      document.getElementById('campaign-details-modal').classList.add('flex');
      
      const content = document.getElementById('campaign-details-content');
      content.innerHTML = '<div class="text-center text-body-sm text-muted-foreground">ุฌุงุฑู ุชุญููู ุชูุงุตูู ุงูุญููุฉ...</div>';

      try {
        const response = await fetch(`${API_BASE_URL}/campaigns/${campaignId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          renderCampaignDetails(result.campaign, result.recipients || [], result.batches || [], result.actual_sent_count);
          
          // ุชุญููู ุฃููุงุน ุฃุฎุทุงุก ููุชุง ูุฃุณุจุงุจ ุงููุดู ุฅุฐุง ูุงูุช ููุงู ุฑุณุงุฆู ูุงุดูุฉ
          if (result.campaign.failed_count > 0) {
            setTimeout(() => loadMetaErrors(campaignId), 300);
            setTimeout(() => loadFailureReasons(campaignId), 500);
          }
        } else {
          content.innerHTML = '<div class="text-center text-destructive text-body-sm">ุชุนุฐุฑ ุชุญููู ุชูุงุตูู ุงูุญููุฉ</div>';
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุชูุงุตูู ุงูุญููุฉ:', error);
        content.innerHTML = '<div class="text-center text-destructive text-body-sm">ุชุนุฐุฑ ุชุญููู ุชูุงุตูู ุงูุญููุฉ</div>';
      }
    }

    // ุฏุงูุฉ ุชุญููู ุฃุณุจุงุจ ุงููุดู
    async function loadFailureReasons(campaignId) {
      const contentDiv = document.getElementById('failure-reasons-content');
      if (!contentDiv) return;
      
      contentDiv.innerHTML = `
        <div class="text-center text-body-sm text-muted-foreground">
          <i data-lucide="loader-2" class="h-6 w-6 mx-auto mb-2 animate-spin"></i>
          <p>ุฌุงุฑู ุชุญููู ุฃุณุจุงุจ ุงููุดู...</p>
        </div>
      `;
      lucide.createIcons();
      
      try {
        const response = await fetch(`${API_BASE_URL}/campaigns/${campaignId}/failure-reasons`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.reasons && result.reasons.length > 0) {
          // ุชุฑุชูุจ ุงูุฃุณุจุงุจ ุญุณุจ ุงูุนุฏุฏ (ุชูุงุฒููุงู)
          const sortedReasons = result.reasons.sort((a, b) => b.count - a.count);
          
          // ุญุณุงุจ ุงููุณุจ ุงููุฆููุฉ
          const total = result.total_failed;
          
          contentDiv.innerHTML = `
            <div class="space-y-3">
              ${sortedReasons.map((reason, index) => {
                const percentage = ((reason.count / total) * 100).toFixed(1);
                const barColor = getFailureReasonColor(reason.reason);
                const icon = getFailureReasonIcon(reason.reason);
                
                return `
                  <div class="rounded-lg border border-border bg-card p-4">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0">
                        <div class="flex h-10 w-10 items-center justify-center rounded-full ${barColor}/20">
                          <i data-lucide="${icon}" class="h-5 w-5 ${barColor}"></i>
                        </div>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between gap-2 mb-2">
                          <h4 class="text-body-md font-medium text-foreground">${reason.reason}</h4>
                          <div class="flex items-center gap-2 flex-shrink-0">
                            <span class="text-body-sm font-bold ${barColor}">${reason.count}</span>
                            <span class="text-body-xs text-muted-foreground">(${percentage}%)</span>
                          </div>
                        </div>
                        <div class="w-full bg-muted rounded-full h-2">
                          <div class="${barColor} h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            
            <div class="mt-4 rounded-lg border border-border bg-muted/30 p-4">
              <h4 class="text-body-sm font-semibold text-foreground mb-2">๐ก ูุตุงุฆุญ ูุชูููู ูุนุฏู ุงููุดู:</h4>
              <ul class="text-body-xs text-muted-foreground space-y-1">
                ${getFailureRecommendations(sortedReasons).map(tip => `<li class="flex items-start gap-2"><span>โข</span><span>${tip}</span></li>`).join('')}
              </ul>
            </div>
          `;
        } else {
          contentDiv.innerHTML = `
            <div class="text-center text-body-sm text-muted-foreground">
              <i data-lucide="check-circle" class="h-8 w-8 mx-auto mb-2 text-success"></i>
              <p>ูุง ุชูุฌุฏ ุชูุงุตูู ูุชุงุญุฉ ุนู ุฃุณุจุงุจ ุงููุดู</p>
            </div>
          `;
        }
        
        lucide.createIcons();
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุฃุณุจุงุจ ุงููุดู:', error);
        contentDiv.innerHTML = `
          <div class="text-center text-destructive text-body-sm">
            <i data-lucide="alert-triangle" class="h-8 w-8 mx-auto mb-2"></i>
            <p>ุชุนุฐุฑ ุชุญููู ุฃุณุจุงุจ ุงููุดู</p>
          </div>
        `;
        lucide.createIcons();
      }
    }

    // ุชูุฒูู ููู CSV ุจุงูุฃุฑูุงู ุงูุชู ูู ุชุตู ููุง ุงูุญููุฉ ูุณุจุจ ุนุฏู ุงููุตูู
    async function downloadFailedRecipientsCSV(campaignId) {
      const base = (typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : '/api/v1').replace(/\/$/, '');
      const url = `${base}/campaigns/${campaignId}/failed-recipients.csv`;
      const token = localStorage.getItem('access_token');
      try {
        const response = await fetch(url, {
          method: 'GET',
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          showToast(err.error || 'ูุดู ุชูุฒูู ุงูููู', 'error');
          return;
        }
        const blob = await response.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `campaign-${campaignId}-failed-recipients.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
        showToast('ุชู ุชูุฒูู ุงูููู ุจูุฌุงุญ', 'success');
      } catch (e) {
        console.error('ุฎุทุฃ ูู ุชูุฒูู CSV:', e);
        showToast('ูุดู ุชูุฒูู ุงูููู', 'error');
      }
    }

    // ุฏุงูุฉ ูุชุญุฏูุฏ ููู ุญุณุจ ููุน ุงูุฎุทุฃ
    function getFailureReasonColor(reason) {
      if (reason.includes('ุทุฑููุฉ ุงูุฏูุน') || reason.includes('Payment')) {
        return 'text-red-600';
      } else if (reason.includes('ุญูุงูุฉ ุงููุธุงู') || reason.includes('ecosystem')) {
        return 'text-orange-600';
      } else if (reason.includes('ุบูุฑ ูุงุจู ููุชุณููู') || reason.includes('undeliverable')) {
        return 'text-yellow-600';
      } else if (reason.includes('ุชุฌุฑุจุฉ') || reason.includes('experiment')) {
        return 'text-purple-600';
      } else if (reason.includes('ูุญุธูุฑ') || reason.includes('blocked')) {
        return 'text-pink-600';
      } else {
        return 'text-gray-600';
      }
    }

    // ุฏุงูุฉ ูุชุญุฏูุฏ ุฃููููุฉ ุญุณุจ ููุน ุงูุฎุทุฃ
    function getFailureReasonIcon(reason) {
      if (reason.includes('ุทุฑููุฉ ุงูุฏูุน') || reason.includes('Payment')) {
        return 'credit-card';
      } else if (reason.includes('ุญูุงูุฉ ุงููุธุงู') || reason.includes('ecosystem')) {
        return 'shield-alert';
      } else if (reason.includes('ุบูุฑ ูุงุจู ููุชุณููู') || reason.includes('undeliverable')) {
        return 'phone-off';
      } else if (reason.includes('ุชุฌุฑุจุฉ') || reason.includes('experiment')) {
        return 'flask';
      } else if (reason.includes('ูุญุธูุฑ') || reason.includes('blocked')) {
        return 'ban';
      } else {
        return 'alert-circle';
      }
    }

    // ุฏุงูุฉ ููุญุตูู ุนูู ูุตุงุฆุญ ูุฎุตุตุฉ ุญุณุจ ุฃุณุจุงุจ ุงููุดู
    function getFailureRecommendations(reasons) {
      const tips = [];
      const topReason = reasons[0]?.reason || '';
      
      if (topReason.includes('ุทุฑููุฉ ุงูุฏูุน')) {
        tips.push('โ๏ธ ุนุงุฌู: ุชุญูู ูู ุทุฑููุฉ ุงูุฏูุน ูู Meta Business Manager');
        tips.push('ุชุฃูุฏ ูู ุตูุงุญูุฉ ุงูุจุทุงูุฉ ููุฌูุฏ ุฑุตูุฏ ูุงูู');
      }
      
      if (reasons.some(r => r.reason.includes('ุญูุงูุฉ ุงููุธุงู'))) {
        tips.push('ุงุณุชุฎุฏู ููุงูุจ ูุนุชูุฏุฉ ูู Meta ููุท');
        tips.push('ูุง ุชุฑุณู ูููุณ ุงูุนููุงุก ุจุดูู ูุชูุฑุงุฑ');
        tips.push('ุงุณุชุฎุฏู ุงูุฅุฑุณุงู ุงูุฐูู ูุชุฌูุจ ุงูุชูุฑุงุฑ');
      }
      
      if (reasons.some(r => r.reason.includes('ุบูุฑ ูุงุจู ููุชุณููู'))) {
        tips.push('ูุธูู ูุงุฆูุฉ ุงูุฃุฑูุงู ูุงุญุฐู ุงูุฃุฑูุงู ุบูุฑ ุงูุตุญูุญุฉ');
        tips.push('ุชุญูู ูู ุตุญุฉ ุงูุฃุฑูุงู ูุจู ุงูุฅุฑุณุงู');
      }
      
      if (tips.length === 0) {
        tips.push('ูุณูู ุงูุญููุงุช ุฅูู ุฏูุนุงุช ุตุบูุฑุฉ (50-100 ุฑุณุงูุฉ/ุณุงุนุฉ)');
        tips.push('ุฑุงูุจ ูุนุฏู ุงููุดู ููู ุฏูุนุฉ');
      }
      
      return tips;
    }

    function renderCampaignDetails(campaign, recipients, batches, actualSentCount) {
      batches = batches || [];
      actualSentCount = actualSentCount != null ? actualSentCount : campaign.sent_count;
      document.getElementById('details-campaign-name').textContent = campaign.name;
      const content = document.getElementById('campaign-details-content');
      
      const totalR = campaign.total_recipients || 0;
      const progressSent = totalR > 0 ? Math.min(100, Math.round((actualSentCount / totalR) * 100)) : 0;
      const successRate = totalR > 0 
        ? Math.round((campaign.delivered_count / totalR) * 100) 
        : 0;

      function formatBatchStatus(status) {
        const m = { pending: 'ูุนูููุฉ', processing: 'ุฌุงุฑู ุงูุชุดุบูู', completed: 'ุชูุช', failed: 'ูุดูุช' };
        return m[status] || status;
      }
      function formatBatchStatusClass(status) {
        const m = { pending: 'bg-muted text-muted-foreground', processing: 'bg-primary/20 text-primary', completed: 'bg-success/20 text-success', failed: 'bg-destructive/20 text-destructive' };
        return m[status] || 'bg-muted';
      }
      function formatDate(d) {
        if (d == null || d === undefined || d === '') return '-';
        const dt = new Date(d);
        if (isNaN(dt.getTime())) return '-';
        return dt.toLocaleString('ar-SA', { dateStyle: 'short', timeStyle: 'short', numberingSystem: 'latn' });
      }
      function formatNum(n) {
        if (n == null || n === '') return '0';
        return Number(n).toLocaleString('en-US');
      }

      content.innerHTML = `
        <div class="space-y-6">
          <!-- Campaign Info Section -->
          <div class="rounded-lg border bg-card">
            <div class="border-b border-border px-6 py-4">
              <h3 class="text-heading-md font-semibold flex items-center gap-2">
                <i data-lucide="info" class="h-5 w-5 text-primary"></i>
                <span>ูุนูููุงุช ุงูุญููุฉ</span>
              </h3>
            </div>
            <div class="p-6">
              <div class="grid gap-6 md:grid-cols-2">
                <!-- ุงููุณู ุงูุฃููู -->
                <div class="space-y-4">
                  <div>
                    <label class="text-body-sm font-semibold text-muted-foreground block mb-1">ุงุณู ุงูุญููุฉ</label>
                    <div class="flex items-center gap-2">
                      <div class="text-body-md font-medium">${campaign.name}</div>
                      ${campaign.is_smart_send ? `
                        <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-primary text-primary-foreground" title="ุญููุฉ ุฐููุฉ">
                          <i data-lucide="zap" class="h-3 w-3"></i>
                        </span>
                      ` : ''}
                    </div>
                  </div>
                  
                  <div>
                    <label class="text-body-sm font-semibold text-muted-foreground block mb-1">ุงููุตู</label>
                    <div class="text-body-md text-foreground">${campaign.description || 'ุจุฏูู ูุตู'}</div>
                  </div>
                  
                  <div>
                    <label class="text-body-sm font-semibold text-muted-foreground block mb-1">ุงููุงูุจ ุงููุณุชุฎุฏู</label>
                    <div class="inline-flex items-center rounded-full border border-input px-3 py-1 text-body-sm font-semibold bg-accent text-accent-foreground">
                      ${campaign.template_name}
                    </div>
                  </div>
                  
                  <div>
                    <label class="text-body-sm font-semibold text-muted-foreground block mb-1">ุฑูู ุงููุงุชุณุงุจ</label>
                    <div class="text-body-md font-semibold">
                      ${campaign.whatsapp_phone_number_id ? `<span class="number">${campaign.whatsapp_phone_number_id}</span>` : 'ุงูุฑูู ุงูุงูุชุฑุงุถู'}
                    </div>
                  </div>
                </div>
                
                <!-- ุงููุณู ุงูุฃูุณุฑ -->
                <div class="space-y-4">
                  <div>
                    <label class="text-body-sm font-semibold text-muted-foreground block mb-1">ุชุงุฑูุฎ ุงูุฅูุดุงุก</label>
                    <div class="text-body-md"><span class="number">${new Date(campaign.created_at).toLocaleDateString('en-GB', { 
                      year: 'numeric', 
                      month: '2-digit', 
                      day: '2-digit'
                    })}</span> - <span class="number">${new Date(campaign.created_at).toLocaleTimeString('en-GB', {
                      hour: '2-digit',
                      minute: '2-digit'
                    })}</span></div>
                  </div>
                  
                  <div>
                    <label class="text-body-sm font-semibold text-muted-foreground block mb-1">ุงูุญุงูุฉ</label>
                    <span class="inline-flex items-center rounded-full border px-3 py-1 text-body-sm font-semibold ${getStatusBadgeClass(campaign.status)}">
                      ${getStatusText(campaign.status)}
                    </span>
                  </div>
                  
                  <div>
                    <label class="text-body-sm font-semibold text-muted-foreground block mb-1">ุฅุนุฏุงุฏุงุช ุงูุฅุฑุณุงู</label>
                    <div class="space-y-2">
                      <div class="flex items-center gap-2 text-body-sm">
                        <i data-lucide="users" class="h-4 w-4 text-muted-foreground"></i>
                        <span>ุญุฌู ุงูุฏูุนุฉ: <span class="font-semibold number">${campaign.batch_size}</span> ุนููู</span>
                      </div>
                      <div class="flex items-center gap-2 text-body-sm">
                        <i data-lucide="clock" class="h-4 w-4 text-muted-foreground"></i>
                        <span>ุงููุชุฑุฉ: ูู <span class="font-semibold">${formatCampaignIntervalHtml(campaign)}</span></span>
                      </div>
                      ${campaign.is_smart_send ? `
                        <div class="flex items-center gap-2 text-body-sm text-primary">
                          <i data-lucide="zap" class="h-4 w-4"></i>
                          <span class="font-medium">ุฅุฑุณุงู ุฐูู โจ (ุงุณุชุจุนุงุฏ ุงูููุฑุฑ)</span>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ูุดุงุท ุงูุฏูุนุงุช (ูุฌุฏููุ ุจุฏุกุ ุงูุชูู = ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช) -->
          <div class="rounded-lg border bg-card">
            <div class="border-b border-border px-6 py-4">
              <h3 class="text-heading-md font-semibold flex items-center gap-2">
                <i data-lucide="layers" class="h-5 w-5 text-primary"></i>
                <span>ูุดุงุท ุงูุฏูุนุงุช</span>
              </h3>
              <p class="text-body-sm text-muted-foreground mt-1">ุญุงูุฉ ูู ุฏูุนุฉ: ูุนูููุฉุ ุฌุงุฑู ุงูุชุดุบููุ ุชูุช ุฃู ูุดูุช. ุงูุจูุงูุงุช ุฃุณูู (ูุฌุฏููุ ุจุฏุกุ ุงูุชูู) ูู ุณุฌูุงุช ุงูุฏูุนุงุช.</p>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full caption-bottom text-sm">
                <thead class="bg-muted/50">
                  <tr class="border-b text-right text-body-sm font-semibold text-muted-foreground">
                    <th class="px-4 py-3">ุงูุฏูุนุฉ</th>
                    <th class="px-4 py-3 text-center">ุนุฏุฏ ุงููุณุชูุจููู</th>
                    <th class="px-4 py-3 text-center">ุงูุญุงูุฉ</th>
                    <th class="px-4 py-3 text-center">ูุฌุฏูู</th>
                    <th class="px-4 py-3 text-center">ุจุฏุก</th>
                    <th class="px-4 py-3 text-center">ุงูุชูู</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  ${batches.length > 0 ? batches.map(b => `
                    <tr class="hover:bg-muted/40">
                      <td class="px-4 py-3 font-medium number" dir="ltr">${formatNum(b.batch_number)}</td>
                      <td class="px-4 py-3 text-center number" dir="ltr">${formatNum(b.recipient_count)}</td>
                      <td class="px-4 py-3 text-center">
                        <span class="inline-flex items-center rounded-full border px-2 py-1 text-xs font-semibold ${formatBatchStatusClass(b.status)}">
                          ${formatBatchStatus(b.status)}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground number" dir="ltr">${formatDate(b.scheduled_at)}</td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground number" dir="ltr">${formatDate(b.started_at)}</td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground number" dir="ltr">${formatDate(b.completed_at)}</td>
                    </tr>
                  `).join('') : `
                    <tr>
                      <td colspan="6" class="px-4 py-8 text-center text-body-sm text-muted-foreground">ูุง ุชูุฌุฏ ุฏูุนุงุช ูุณุฌููุฉ ููุฐู ุงูุญููุฉ</td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>

          <!-- ุงูุชูุฏู (ูุทุงุจู ูุฃุฑูุงู ุงูุจุทุงูุงุช: ุฃูุฑุณูุช = ุนุฏุฏ ุงููุญุงููุงุช ุงููุนูู) -->
          <div class="rounded-lg border bg-card p-4">
            <h3 class="text-body-md font-semibold text-muted-foreground mb-2">ุงูุชูุฏู</h3>
            <div class="flex items-center gap-4">
              <div class="flex-1">
                <div class="flex justify-between text-body-sm mb-1">
                  <span class="number" dir="ltr">${formatNum(actualSentCount)} / ${formatNum(totalR)}</span>
                  <span class="number" dir="ltr">${progressSent}%</span>
                </div>
                <div class="w-full bg-muted rounded-full h-2">
                  <div class="bg-primary h-2 rounded-full transition-all" style="width: ${progressSent}%"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Stats Cards -->
          <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-7">
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold number" dir="ltr">${formatNum(campaign.total_recipients)}</div>
              <div class="text-body-sm text-muted-foreground">ุฅุฌูุงูู ุงููุณุชูุจููู</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-primary number">${campaign.sent_count}</div>
              <div class="text-body-sm text-muted-foreground">ุฃูุฑุณููุช</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-success number">${campaign.delivered_count}</div>
              <div class="text-body-sm text-muted-foreground">ูุตูุช</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-accent-foreground number">${campaign.read_count}</div>
              <div class="text-body-sm text-muted-foreground">ููุฑูุฆุช</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-warning number">${campaign.replied_count || 0}</div>
              <div class="text-body-sm text-muted-foreground">ุชู ุงูุฑุฏ ุนูููุง</div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-purple-600 number">${campaign.clicked_count || 0}</div>
              <div class="text-body-sm text-muted-foreground">
                ููููุฑ ุนูููุง
                <div class="text-body-xs text-muted-foreground mt-1">
                  (ููุท ููุฃุฒุฑุงุฑ ุงูุชูุงุนููุฉ)
                </div>
              </div>
            </div>
            <div class="rounded-lg border bg-card p-4 text-center">
              <div class="text-heading-lg font-bold text-destructive number">${campaign.failed_count}</div>
              <div class="text-body-sm text-muted-foreground">ูุดูุช</div>
            </div>
          </div>

          <!-- ุฃููุงุน ุฃุฎุทุงุก ููุชุง (ุฌุฏูู: ุงุณู ุงูุฎุทุฃุ ุงููุตูุ ุนุฏุฏ ุงูุฃุญุฏุงุซ) -->
          ${campaign.failed_count > 0 ? `
            <div class="rounded-lg border bg-card" id="meta-errors-section">
              <div class="border-b border-border px-6 py-4">
                <div class="flex items-center justify-between">
                  <div>
                    <h3 class="text-heading-md font-semibold flex items-center gap-2">
                      <i data-lucide="alert-triangle" class="h-5 w-5 text-destructive"></i>
                      <span>ุฃููุงุน ุงูุฃุฎุทุงุก ูู ููุชุง</span>
                    </h3>
                    <p class="text-body-sm text-muted-foreground mt-1">ุฃุณุจุงุจ ุนุฏู ุงูุชุณููู ููุง ูุฑุฏุช ูู ูุงุชุณุงุจ (ููุชุง) ููุฐู ุงูุญููุฉ</p>
                  </div>
                  <button onclick="loadMetaErrors(${campaign.id})" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-3 py-2 text-body-sm font-medium transition hover:bg-accent">
                    <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                    <span>ุชุญุฏูุซ</span>
                  </button>
                </div>
              </div>
              <div id="meta-errors-content" class="p-4">
                <div class="text-center text-body-sm text-muted-foreground">
                  <i data-lucide="loader-2" class="h-6 w-6 mx-auto mb-2 animate-spin"></i>
                  <p>ุฌุงุฑู ุชุญููู ุฃููุงุน ุงูุฃุฎุทุงุก...</p>
                </div>
              </div>
            </div>
          ` : ''}

          <!-- Failure Reasons Section -->
          ${campaign.failed_count > 0 ? `
            <div class="rounded-lg border border-destructive/30 bg-destructive/5" id="failure-reasons-section">
              <div class="border-b border-destructive/20 p-4">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <i data-lucide="alert-circle" class="h-5 w-5 text-destructive"></i>
                    <h3 class="text-heading-md font-semibold text-destructive">ุฃุณุจุงุจ ุงููุดู (${campaign.failed_count})</h3>
                  </div>
                  <div class="flex items-center gap-2">
                    <button onclick="downloadFailedRecipientsCSV(${campaign.id})" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-3 py-2 text-body-sm font-medium transition hover:bg-accent">
                      <i data-lucide="download" class="h-4 w-4"></i>
                      <span>ุชูุฒูู CSV</span>
                    </button>
                    <button onclick="loadFailureReasons(${campaign.id})" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-3 py-2 text-body-sm font-medium transition hover:bg-accent">
                      <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                      <span>ุชุญุฏูุซ</span>
                    </button>
                  </div>
                </div>
              </div>
              <div id="failure-reasons-content" class="p-4">
                <div class="text-center text-body-sm text-muted-foreground">
                  <i data-lucide="loader-2" class="h-6 w-6 mx-auto mb-2 animate-spin"></i>
                  <p>ุฌุงุฑู ุชุญููู ุฃุณุจุงุจ ุงููุดู...</p>
                </div>
              </div>
            </div>
          ` : ''}

          <!-- Recipients Table -->
          <div class="rounded-lg border bg-card">
            <div class="border-b border-border p-4">
              <div class="flex items-center justify-between">
                <h3 class="text-heading-md font-semibold">ุชูุงุตูู ุงููุณุชูุจููู</h3>
                <button onclick="fixCampaignStats(${campaign.id})" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-3 py-2 text-body-sm font-medium transition hover:bg-accent hover:text-accent-foreground">
                  <i data-lucide="calculator" class="h-4 w-4"></i>
                  <span>ุฅุนุงุฏุฉ ุญุณุงุจ ุฏููู</span>
                </button>
              </div>
            </div>
            <div class="overflow-x-auto max-h-96">
              <table class="w-full caption-bottom text-sm">
                <thead class="bg-muted/50 sticky top-0">
                  <tr class="border-b text-right text-body-sm font-semibold text-muted-foreground">
                    <th class="px-4 py-3">ุงูุนููู</th>
                    <th class="px-4 py-3 text-center">ุงูุฏูุนุฉ</th>
                    <th class="px-4 py-3 text-center">ุงูุญุงูุฉ</th>
                    <th class="px-4 py-3 text-center">ุงูุฅุฑุณุงู</th>
                    <th class="px-4 py-3 text-center">ุงูุชุณููู</th>
                    <th class="px-4 py-3 text-center">ุงููุฑุงุกุฉ</th>
                    <th class="px-4 py-3 text-center">ุงูุฑุฏ</th>
                    <th class="px-4 py-3 text-center">ุงูููุฑ</th>
                    <th class="px-4 py-3 text-center">ุชูุงุตูู</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  ${recipients.length > 0 ? recipients.map(recipient => `
                    <tr class="hover:bg-muted/40">
                      <td class="px-4 py-3">
                        <div class="space-y-1">
                          <div class="text-body-md font-medium">${recipient.customer_name || 'ุบูุฑ ูุญุฏุฏ'}</div>
                          <div class="text-body-sm text-muted-foreground number">${recipient.phone_number}</div>
                        </div>
                      </td>
                      <td class="px-4 py-3 text-center">
                        <span class="inline-flex items-center rounded-full border border-input px-2 py-1 text-xs font-medium bg-accent text-accent-foreground">
                          ${recipient.batch_number || 1}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-center">
                        <span class="inline-flex items-center rounded-full border border-input px-2 py-1 text-xs font-semibold ${getStatusBadgeClass(recipient.status)}">
                          ${getStatusText(recipient.status)}
                        </span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.sent_at ? new Date(recipient.sent_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.delivered_at ? new Date(recipient.delivered_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.read_at ? new Date(recipient.read_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.replied_at ? new Date(recipient.replied_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                      <td class="px-4 py-3 text-center text-body-sm text-muted-foreground">
                        <span class="number">${recipient.clicked_at ? new Date(recipient.clicked_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'}) : '-'}</span>
                      </td>
                      <td class="px-4 py-3 text-center">
                        ${recipient.message_id ? `
                          <button onclick="showMessageDetails('${recipient.message_id}')" class="inline-flex items-center gap-1 rounded-md border border-input bg-background px-2 py-1 text-xs font-medium transition hover:bg-accent hover:text-accent-foreground">
                            <i data-lucide="info" class="h-3 w-3"></i>
                            <span>ุชูุงุตูู</span>
                          </button>
                        ` : '-'}
                      </td>
                    </tr>
                  `).join('') : `
                    <tr>
                      <td colspan="9" class="h-32 text-center text-body-sm text-muted-foreground">
                        <div class="space-y-3">
                          <i data-lucide="users-x" class="h-8 w-8 mx-auto"></i>
                          <p>ูุง ุชูุฌุฏ ูุณุชูุจููู ูู ูุฐู ุงูุญููุฉ</p>
                          <p class="text-body-xs">ูุฏ ุชููู ุงูุญููุฉ ุฃููุดุฆุช ุจุฏูู ุฅุถุงูุฉ ูุณุชูุจููู</p>
                          <button onclick="addRecipientsToExistingCampaign(${campaign.id})" class="inline-flex items-center gap-2 rounded-md bg-primary px-3 py-2 text-body-sm font-medium text-primary-foreground transition hover:bg-primary/90">
                            <i data-lucide="user-plus" class="h-4 w-4"></i>
                            <span>ุฅุถุงูุฉ ูุณุชูุจููู</span>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      lucide.createIcons();
    }

    function hideCampaignDetailsModal() {
      document.getElementById('campaign-details-modal').classList.add('hidden');
      document.getElementById('campaign-details-modal').classList.remove('flex');
    }

    // ุจุฏุก ุงูุญููุฉ
    async function startCampaign(campaignId) {
      const ok = await showConfirmModal({
        title: 'ุจุฏุก ุงูุญููุฉ',
        message: 'ูู ุฃูุช ูุชุฃูุฏ ูู ุจุฏุก ูุฐู ุงูุญููุฉุ ุณูุชู ุฅุฑุณุงู ุงูุฑุณุงุฆู ููุฑุงู.',
        confirmText: 'ููุงูู',
        cancelText: 'ุฅูุบุงุก'
      });
      if (!ok) return;

      try {
        const response = await fetch(`${API_BASE_URL}/campaigns/${campaignId}/start`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          }
        });

        const result = await response.json();
        
        if (result.success) {
          showToast('ุชู ุจุฏุก ุงูุญููุฉ ุจูุฌุงุญ!', 'success');
          refreshCampaigns();
        } else {
          showToast('ูุดู ูู ุจุฏุก ุงูุญููุฉ: ' + (result.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'), 'error');
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุจุฏุก ุงูุญููุฉ:', error);
        showToast('ุชุนุฐุฑ ุจุฏุก ุงูุญููุฉ. ุชุญูู ูู ุงูุงุชุตุงู', 'error');
      }
    }

    // ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูุญููุฉ
    async function resendCampaign(campaignId) {
      const ok = await showConfirmModal({
        title: 'ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูุญููุฉ',
        message: 'ูู ุชุฑูุฏ ุฅุนุงุฏุฉ ุฅุฑุณุงู ูุฐู ุงูุญููุฉุ ุณูุชู ุฅุฑุณุงู ุงูุฑุณุงุฆู ูููุณุชูุจููู ูุฑุฉ ุฃุฎุฑู.',
        confirmText: 'ููุงูู',
        cancelText: 'ุฅูุบุงุก'
      });
      if (!ok) return;

      try {
        const response = await fetch(`${API_BASE_URL}/campaigns/${campaignId}/resend`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          }
        });

        const result = await response.json();
        
        if (result.success) {
          showToast('ุชู ุจุฏุก ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู ุจูุฌุงุญ!', 'success');
          refreshCampaigns();
        } else {
          showToast('ูุดู ูู ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู: ' + (result.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'), 'error');
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู:', error);
        showToast('ุชุนุฐุฑ ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู. ุชุญูู ูู ุงูุงุชุตุงู', 'error');
      }
    }

    // ุฅุถุงูุฉ ูุณุชูุจููู ูุญููุฉ ููุฌูุฏุฉ
    async function addRecipientsToExistingCampaign(campaignId) {
      const phoneNumber = await showPromptModal({
        title: 'ุฅุถุงูุฉ ูุณุชูุจู',
        message: 'ุฃุฏุฎู ุฑูู ุงููุงุชู (ูุซุงู: 966550002445):',
        placeholder: '966550002445',
        submitText: 'ุฅุถุงูุฉ',
        cancelText: 'ุฅูุบุงุก'
      });
      if (!phoneNumber || !phoneNumber.trim()) {
        return;
      }

      const cleanPhone = phoneNumber.trim().replace(/[\s\-\+]/g, '');
      
      if (!/^966\d{9}$/.test(cleanPhone)) {
        showToast('ุฑูู ุงููุงุชู ุบูุฑ ุตุญูุญ. ูุฌุจ ุฃู ูุจุฏุฃ ุจู 966 ููุญุชูู ุนูู 12 ุฑููุงู', 'error');
        return;
      }

      try {
        const campaignData = {
          recipients: [{
            customer_id: 0,
            phone_number: cleanPhone,
            customer_name: `ุนููู ${cleanPhone.slice(-4)}`
          }]
        };

        const response = await fetch(`${API_BASE_URL}/campaigns/${campaignId}/recipients`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          },
          body: JSON.stringify(campaignData)
        });

        const result = await response.json();
        
        if (result.success) {
          showToast('ุชู ุฅุถุงูุฉ ุงููุณุชูุจู ุจูุฌุงุญ!', 'success');
          viewCampaignDetails(campaignId); // ุฅุนุงุฏุฉ ุชุญููู ุงูุชูุงุตูู
        } else {
          showToast('ูุดู ูู ุฅุถุงูุฉ ุงููุณุชูุจู: ' + (result.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'), 'error');
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุฅุถุงูุฉ ุงููุณุชูุจู:', error);
        showToast('ุชุนุฐุฑ ุฅุถุงูุฉ ุงููุณุชูุจู. ุชุญูู ูู ุงูุงุชุตุงู', 'error');
      }
    }

    // ุฅุนุงุฏุฉ ุญุณุงุจ ุฅุญุตุงุฆูุงุช ุงูุญููุฉ ุจุฏูุฉ
    async function fixCampaignStats(campaignId) {
      try {
        const response = await fetch(`${API_BASE_URL}/campaigns/${campaignId}/fix-stats`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast('ุชู ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช ุจุฏูุฉ!', 'success');
          // ุฅุนุงุฏุฉ ุชุญููู ุชูุงุตูู ุงูุญููุฉ
          viewCampaignDetails(campaignId);
        } else {
          showToast('ูุดู ูู ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช: ' + (result.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'), 'error');
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช:', error);
        showToast('ุชุนุฐุฑ ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช', 'error');
      }
    }

    // ุญุฐู ุญููุฉ ูุงุญุฏุฉ (ููุณุชุฏุนู ุจุนุฏ ุงูุชุฃููุฏ ูู ุงูููุฏุงู)
    async function deleteCampaign(campaignId, campaignName) {
      try {
        const response = await fetch(`${API_BASE_URL}/campaigns/${campaignId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          }
        });

        const result = await response.json();
        
        if (result.success) {
          showToast('ุชู ุญุฐู ุงูุญููุฉ ุจูุฌุงุญ!', 'success');
          hideConfirmDeleteCampaignModal();
          refreshCampaigns();
        } else {
          showToast('ูุดู ูู ุญุฐู ุงูุญููุฉ: ' + (result.error || result.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'), 'error');
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุญุฐู ุงูุญููุฉ:', error);
        showToast('ุชุนุฐุฑ ุญุฐู ุงูุญููุฉ. ุชุญูู ูู ุงูุงุชุตุงู', 'error');
      }
    }

    let pendingDeleteCampaign = null;

    function showConfirmDeleteCampaignModal(campaignId, campaignName) {
      pendingDeleteCampaign = { id: campaignId, name: campaignName };
      document.getElementById('confirm-delete-campaign-name').textContent = campaignName || '(ุจุฏูู ุงุณู)';
      const modal = document.getElementById('confirm-delete-campaign-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function hideConfirmDeleteCampaignModal() {
      pendingDeleteCampaign = null;
      const modal = document.getElementById('confirm-delete-campaign-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // ุญุฐู ุฌููุน ุงูุญููุงุช
    async function deleteAllCampaigns() {
      // ุชุฃููุฏ ุฃููู
      const ok = await showConfirmModal({
        title: 'ุชุญุฐูุฑ: ุญุฐู ุฌููุน ุงูุญููุงุช',
        message: 'ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูุญููุงุชุ\n\nูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู ูุณูุญุฐู:\n- ุฌููุน ุงูุญููุงุช\n- ุฌููุน ุงููุณุชูุจููู\n- ุฌููุน ุงูุฅุญุตุงุฆูุงุช',
        confirmText: 'ูุชุงุจุนุฉ',
        cancelText: 'ุฅูุบุงุก',
        danger: true
      });
      if (!ok) return;

      // ุชุฃููุฏ ุซุงูู ูุน ูููุฉ ูุฑูุฑ
      const confirmText = await showPromptModal({
        title: 'ุชุฃููุฏ ููุงุฆู',
        message: 'ููุชุฃููุฏ ุงูููุงุฆูุ ุงูุชุจ: DELETE_ALL_CAMPAIGNS',
        placeholder: 'DELETE_ALL_CAMPAIGNS',
        requiredValue: 'DELETE_ALL_CAMPAIGNS',
        submitText: 'ุญุฐู ุงููู',
        cancelText: 'ุฅูุบุงุก'
      });
      if (confirmText !== 'DELETE_ALL_CAMPAIGNS') {
        showToast('ุชู ุฅูุบุงุก ุงูุนูููุฉ', 'info');
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/campaigns/delete-all`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          },
          body: JSON.stringify({
            confirm_password: 'DELETE_ALL_CAMPAIGNS'
          })
        });

        const result = await response.json();
        
        if (result.success) {
          showToast(`ุชู ุญุฐู ${result.deleted_count} ุญููุฉ ุจูุฌุงุญ!`, 'success');
          refreshCampaigns();
        } else {
          showToast('ูุดู ูู ุญุฐู ุงูุญููุงุช: ' + (result.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'), 'error');
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุญุฐู ุงูุญููุงุช:', error);
        showToast('ุชุนุฐุฑ ุญุฐู ุงูุญููุงุช. ุชุญูู ูู ุงูุงุชุตุงู', 'error');
      }
    }

    // ุชุญุฏูุซ ุญุงูุงุช ุฌููุน ุงูุญููุงุช
    async function updateAllCampaignStatuses() {
      try {
        const response = await fetch(`${API_BASE_URL}/campaigns/update-statuses`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          }
        });

        const result = await response.json();
        
        if (result.success) {
          showToast(`ุชู ูุญุต ูุชุญุฏูุซ ${result.updated_count} ุญููุฉ`, 'success');
          refreshCampaigns();
        } else {
          showToast('ูุดู ูู ุชุญุฏูุซ ุงูุญุงูุงุช: ' + (result.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'), 'error');
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุญุงูุงุช:', error);
        showToast('ุชุนุฐุฑ ุชุญุฏูุซ ุงูุญุงูุงุช. ุชุญูู ูู ุงูุงุชุตุงู', 'error');
      }
    }

    async function refreshCampaigns() {
      await loadAndRenderCampaigns();
    }

    // ุฏุงูุฉ ูุนุงูุฌุฉ ุชูุนูู/ุฅูุบุงุก ุงูุฅุฑุณุงู ุงูุฐูู
    function handleSmartSendToggle() {
      const smartSendEnabled = document.getElementById('enable-smart-send').checked;
      const smartSendInfo = document.getElementById('smart-send-info');
      
      if (smartSendEnabled) {
        smartSendInfo.classList.remove('hidden');
      } else {
        smartSendInfo.classList.add('hidden');
        // ุฅุฎูุงุก ูุชุงุฆุฌ ุงููุญุต ุฅุฐุง ูุงูุช ุธุงูุฑุฉ
        const resultsDiv = document.getElementById('smart-send-results');
        if (resultsDiv) {
          resultsDiv.classList.add('hidden');
        }
        // ุฅุนุงุฏุฉ ุชุนููู ุงููุชุบูุฑ
        smartSendFilteredRecipients = null;
      }
    }

    // ูุชุบูุฑ ุนุงู ูุชุฎุฒูู ูุชุงุฆุฌ ุงููุญุต ุงูุฐูู
    let smartSendFilteredRecipients = null;

    // ุฏุงูุฉ ูุญุต ุงูุฅุฑุณุงู ุงูุฐูู
    async function runSmartSendCheck() {
      const checkBtn = document.getElementById('check-recipients-btn');
      const resultsDiv = document.getElementById('smart-send-results');
      
      // ุฌูุน ุฃุฑูุงู ุงูููุงุชู ูู ุงููุณุชูุจููู
      let phoneNumbers = [];
      const source = document.getElementById('recipients-source').value;
      
      if (source === 'manual') {
        const manualText = document.getElementById('manual-recipients').value;
        const lines = manualText.split('\n').filter(line => line.trim());
        phoneNumbers = lines.map(line => {
          const parts = line.split(',');
          return parts[0].trim();
        }).filter(phone => phone);
      } else if (source === 'database') {
        // ุงุณุชุฎุฏุงู ุงููุณุชูุจููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        if (window.parsedRecipients && window.parsedRecipients.length > 0) {
          phoneNumbers = window.parsedRecipients.map(r => r.phone_number);
        }
      }
      
      if (phoneNumbers.length === 0) {
        showToast('ูุง ุชูุฌุฏ ุฃุฑูุงู ูููุญุต. ูุฑุฌู ุฅุถุงูุฉ ูุณุชูุจููู ุฃููุงู', 'warning');
        return;
      }
      
      // ุชุนุทูู ุงูุฒุฑ ูุฅุธูุงุฑ ุฑุณุงูุฉ ุงูุชุญููู
      checkBtn.disabled = true;
      checkBtn.innerHTML = '<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i><span>ุฌุงุฑู ุงููุญุต...</span>';
      lucide.createIcons();
      
      try {
        const response = await fetch(`${API_BASE_URL}/campaigns/smart-send-check`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
          },
          body: JSON.stringify({
            phone_numbers: phoneNumbers
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // ุญูุธ ุงูุฃุฑูุงู ุงููุณููุญุฉ ููุงุณุชุฎุฏุงู ุนูุฏ ุฅูุดุงุก ุงูุญููุฉ
          smartSendFilteredRecipients = result.allowed_numbers;
          
          // ุนุฑุถ ุงููุชุงุฆุฌ
          document.getElementById('smart-total').textContent = result.total;
          document.getElementById('smart-allowed').textContent = result.allowed;
          document.getElementById('smart-excluded').textContent = result.excluded;
          document.getElementById('smart-message').textContent = result.message;
          
          resultsDiv.classList.remove('hidden');
          
          // ุชุญุฏูุซ ุนุฏุฏ ุงููุณุชูุจููู ูู ุงููุงุฌูุฉ ุจุนุฏ ุงููุญุต ุงูุฐูู
          updateManualCountAfterSmartSend();
          updateRecipientsPreview();
          
        } else {
          showToast('ูุดู ูู ูุญุต ุงูุฃุฑูุงู: ' + (result.error || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'), 'error');
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ูุญุต ุงูุฅุฑุณุงู ุงูุฐูู:', error);
        showToast('ุชุนุฐุฑ ูุญุต ุงูุฃุฑูุงู. ุชุญูู ูู ุงูุงุชุตุงู', 'error');
      } finally {
        // ุฅุนุงุฏุฉ ุชูุนูู ุงูุฒุฑ
        checkBtn.disabled = false;
        checkBtn.innerHTML = '<i data-lucide="scan-search" class="h-4 w-4"></i><span>ูุญุต ุงูุฃุฑูุงู ุงูุขู</span>';
        lucide.createIcons();
      }
    }

    // ุชุญุฏูุซ ุนุฏุงุฏ ุงูุฅุฏุฎุงู ุงููุฏูู ููุท ุจุนุฏ ุงููุญุต ุงูุฐูู (ูุง ูุณุชุจุฏู ุฏุงูุฉ ูุนุงููุฉ ุงููุณุชูุจููู)
    function updateManualCountAfterSmartSend() {
      if (!smartSendFilteredRecipients || smartSendFilteredRecipients.length === 0) return;
      
      const source = document.getElementById('recipients-source').value;
      
      if (source === 'manual') {
        document.getElementById('manual-count').textContent = smartSendFilteredRecipients.length;
      }
    }

    // Pagination functions
    function updatePaginationInfo(from, to, total, current, totalPages) {
      document.getElementById('showing-from').textContent = from;
      document.getElementById('showing-to').textContent = to;
      document.getElementById('total-campaigns').textContent = total;
      document.getElementById('current-page-num').textContent = current;
      document.getElementById('total-pages-num').textContent = totalPages;
      
      // ุชุญุฏูุซ ุญุงูุฉ ุงูุฃุฒุฑุงุฑ
      const firstBtn = document.getElementById('first-page-btn');
      const prevBtn = document.getElementById('prev-page-btn');
      const nextBtn = document.getElementById('next-page-btn');
      const lastBtn = document.getElementById('last-page-btn');
      
      firstBtn.disabled = current === 1;
      prevBtn.disabled = current === 1;
      nextBtn.disabled = current === totalPages;
      lastBtn.disabled = current === totalPages;
      
      // ุชุญุฏูุซ ุงูุฃููููุงุช
      lucide.createIcons();
    }
    
    function goToFirstPage() {
      if (currentPage !== 1) {
        currentPage = 1;
        renderCampaigns();
      }
    }
    
    function goToPrevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderCampaigns();
      }
    }
    
    function goToNextPage() {
      const totalPages = Math.ceil(campaigns.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderCampaigns();
      }
    }
    
    function goToLastPage() {
      const totalPages = Math.ceil(campaigns.length / itemsPerPage);
      if (currentPage !== totalPages) {
        currentPage = totalPages;
        renderCampaigns();
      }
    }

    // ุฏูุงู API ููุญููุงุช
    async function loadCampaigns(limit = 50) {
      try {
        const data = await apiRequest(`/campaigns?limit=${limit}`);
        if (data.success) {
          return Array.isArray(data.data) ? data.data : [];
        }
        console.error('ูุดู ูู ุฌูุจ ุงูุญููุงุช:', data);
        return [];
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุงูุญููุงุช:', error);
        return [];
      }
    }

    async function loadMetaTemplates(limit = 50) {
      try {
        const data = await apiRequest(`/meta/templates?limit=${limit}`);
        if (data.success && Array.isArray(data.data)) {
          return data.data;
        }
        console.error('ูุดู ูู ุฌูุจ ุงูููุงูุจ:', data);
        return [];
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุงูููุงูุจ:', error);
        return [];
      }
    }

    // ุชููุฆุฉ ุงูุตูุญุฉ
    document.addEventListener('DOMContentLoaded', () => {
      // ุชููุฆุฉ ูููู ุงูููุฏุฑ
      renderHeader('header-container', { activePage: 'campaigns' });
      
      lucide.createIcons();
      loadAndRenderCampaigns();

      // ุชุฃููุฏ ุงูุญุฐู: ุนุฑุถ ููุฏุงู ุงูุชุฃููุฏ ุจุฏู confirm()
      document.getElementById('campaigns-table-body').addEventListener('click', function(e) {
        const btn = e.target.closest('.btn-delete-campaign');
        if (!btn) return;
        e.preventDefault();
        const id = btn.getAttribute('data-campaign-id');
        const name = btn.getAttribute('data-campaign-name') || '';
        if (id) showConfirmDeleteCampaignModal(parseInt(id, 10), name);
      });

      document.getElementById('confirm-delete-campaign-cancel').addEventListener('click', hideConfirmDeleteCampaignModal);
      document.getElementById('confirm-delete-campaign-submit').addEventListener('click', function() {
        if (pendingDeleteCampaign) {
          const { id, name } = pendingDeleteCampaign;
          this.disabled = true;
          deleteCampaign(id, name).finally(() => { this.disabled = false; });
        }
      });
      document.getElementById('confirm-delete-campaign-modal').addEventListener('click', function(e) {
        if (e.target === this) hideConfirmDeleteCampaignModal();
      });
      
      // ุฅุถุงูุฉ ูุณุชูุนุงุช ููุชุญุฏูุซ ุงูุชููุงุฆู
      document.getElementById('batch-size').addEventListener('change', updateBatchPreview);
      document.getElementById('batch-interval').addEventListener('change', updateBatchPreview);
      
      // ุฅุถุงูุฉ ูุณุชูุน ูุฑูุน ููู CSV
      document.getElementById('csv-file').addEventListener('change', handleCSVUpload);
      
      // ุชูุนูู ุงูุฅุฑุณุงู ุงูุฐูู ุงูุชุฑุงุถูุงู
      handleSmartSendToggle();
    });

    // ุฏุงูุฉ logout ููุฌูุฏุฉ ูู api.js

    // ุฏุงูุฉ ูุณุงุนุฏุฉ ููุญุต ุงูุฑูุฒ ุงููููุฒ
    function isValidToken(token) {
      return token && 
             token !== 'null' && 
             token !== 'undefined' && 
             token.length > 10 &&
             token.includes('.');
    }

    // ุนุฑุถ ุชูุงุตูู ุงูุฑุณุงูุฉ (skipRefresh: ุชุฌูุจ ุฅุนุงุฏุฉ ูุญุงููุฉ ุงูุชุฌุฏูุฏ ุนูุฏ 401 ูุชุฌูุจ ุงูุชูุฑุงุฑ ุงููุงููุงุฆู)
    async function showMessageDetails(messageId, skipRefresh) {
      try {
        console.log('๐ ุฌุงุฑู ุฌูุจ ุชูุงุตูู ุงูุฑุณุงูุฉ:', messageId);
        
        // ูุญุต ูุนุฑู ุงูุฑุณุงูุฉ
        if (!messageId || messageId === 'null' || messageId === 'undefined' || messageId === '') {
          console.error('โ ูุนุฑู ุงูุฑุณุงูุฉ ุบูุฑ ุตุงูุญ:', messageId);
          showToast('ูุนุฑู ุงูุฑุณุงูุฉ ุบูุฑ ุตุงูุญ', 'error');
          return;
        }
        
        // ูุญุต ุงูุฑูุฒ ุงููููุฒ
        const token = localStorage.getItem('access_token') || localStorage.getItem('tchat_token');
        const isLoggedIn = localStorage.getItem('tchat_logged_in');
        
        console.log('๐ ูุญุต ุงูุฑูุฒ ุงููููุฒ:', {
          token: token ? token.substring(0, 20) + '...' : 'null',
          isLoggedIn: isLoggedIn,
          tokenLength: token ? token.length : 0
        });
        
        if (!isLoggedIn || isLoggedIn === 'false') {
          console.error('โ ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู ุฏุฎููู');
          showToast('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู', 'error');
          window.location.href = './login.html';
          return;
        }
        
        if (!isValidToken(token)) {
          console.error('โ ูุง ููุฌุฏ ุฑูุฒ ูููุฒ ุตุงูุญ');
          console.log('๐ ุชูุงุตูู ุงูุชุฎุฒูู:', {
            access_token: localStorage.getItem('access_token'),
            tchat_token: localStorage.getItem('tchat_token'),
            isLoggedIn: localStorage.getItem('tchat_logged_in'),
            allKeys: Object.keys(localStorage)
          });
          
          // ูุญุงููุฉ ุฅุนุงุฏุฉ ุชุณุฌูู ุงูุฏุฎูู ุชููุงุฆูุงู
          console.log('๐ ูุญุงููุฉ ุฅุนุงุฏุฉ ุชุณุฌูู ุงูุฏุฎูู...');
          const refreshToken = localStorage.getItem('tchat_refresh_token');
          if (refreshToken && refreshToken !== 'null') {
            try {
              const refreshResponse = await fetch(`${API_BASE_URL}/auth/refresh`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${refreshToken}`
                }
              });
              
              if (refreshResponse.ok) {
                const refreshData = await refreshResponse.json();
                if (refreshData.success && refreshData.token) {
                  localStorage.setItem('tchat_token', refreshData.token);
                  console.log('โ ุชู ุชุฌุฏูุฏ ุงูุฑูุฒ ุงููููุฒ ุจูุฌุงุญ');
                  // ุฅุนุงุฏุฉ ุงููุญุงููุฉ
                  return showMessageDetails(messageId);
                }
              }
            } catch (error) {
              console.error('โ ูุดู ูู ุชุฌุฏูุฏ ุงูุฑูุฒ ุงููููุฒ:', error);
            }
          }
          
          showToast('ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉ', 'error');
          localStorage.removeItem('tchat_token');
          localStorage.removeItem('tchat_logged_in');
          localStorage.removeItem('tchat_refresh_token');
          window.location.href = './login.html';
          return;
        }
        
        const response = await fetch(`${API_BASE_URL}/messages/${messageId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('ุฎุทุฃ ูู ุงูุงุณุชุฌุงุจุฉ:', errorText);
          
          // ูุนุงูุฌุฉ ุฎุทุฃ 401: ูุญุงููุฉ ุชุฌุฏูุฏ ุงูุฑูุฒ ุซู ุฅุนุงุฏุฉ ุงูุทูุจ ูุฑุฉ ูุงุญุฏุฉ ูุจู ุงุนุชุจุงุฑ ุงูุฌูุณุฉ ููุชููุฉ
          if (response.status === 401) {
            if (!skipRefresh) {
              const refreshToken = localStorage.getItem('tchat_refresh_token');
              if (refreshToken && refreshToken !== 'null') {
                try {
                  const refreshResponse = await fetch(`${API_BASE_URL}/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${refreshToken}` }
                  });
                  if (refreshResponse.ok) {
                    const refreshData = await refreshResponse.json();
                    if (refreshData.success && refreshData.token) {
                      localStorage.setItem('tchat_token', refreshData.token);
                      console.log('โ ุชู ุชุฌุฏูุฏ ุงูุฑูุฒ ุจุนุฏ 401ุ ุฅุนุงุฏุฉ ุทูุจ ุชูุงุตูู ุงูุฑุณุงูุฉ');
                      return showMessageDetails(messageId, true);
                    }
                  }
                } catch (e) {
                  console.error('โ ูุดู ุชุฌุฏูุฏ ุงูุฑูุฒ ุจุนุฏ 401:', e);
                }
              }
            }
            console.error('โ ุงูุชูุช ุตูุงุญูุฉ ุงูุฑูุฒ ุงููููุฒ');
            showToast('ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉ', 'error');
            localStorage.removeItem('tchat_token');
            localStorage.removeItem('tchat_logged_in');
            localStorage.removeItem('tchat_refresh_token');
            window.location.href = './login.html';
            return;
          }
          
          throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 100)}`);
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const responseText = await response.text();
          console.error('ุงุณุชุฌุงุจุฉ ุบูุฑ ุตุญูุญุฉ:', responseText);
          throw new Error('ุงูุงุณุชุฌุงุจุฉ ููุณุช JSON ุตุงูุญ');
        }

        const result = await response.json();
        
        if (result.success && result.data) {
          displayMessageDetails(result.data);
        } else {
          console.error('โ ูุดู ูู ุฌูุจ ุชูุงุตูู ุงูุฑุณุงูุฉ:', result);
          if (result.error === 'ุงูุฑุณุงูุฉ ุบูุฑ ููุฌูุฏุฉ') {
            showToast('ุงูุฑุณุงูุฉ ุบูุฑ ููุฌูุฏุฉ ุฃู ูุญุฐููุฉ', 'error');
          } else {
            throw new Error(result.message || 'ูุดู ูู ุฌูุจ ุชูุงุตูู ุงูุฑุณุงูุฉ');
          }
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุฌูุจ ุชูุงุตูู ุงูุฑุณุงูุฉ:', error);
        showToast('ุชุนุฐุฑ ุฌูุจ ุชูุงุตูู ุงูุฑุณุงูุฉ', 'error');
      }
    }

    // ุนุฑุถ ุชูุงุตูู ุงูุฑุณุงูุฉ ูู ุงููุงูุฐุฉ
    function displayMessageDetails(message) {
      const modal = document.getElementById('message-details-modal');
      const content = document.getElementById('message-details-content');
      
      // ุชุญููู ุงูุชูุงุฑูุฎ (ุฃุฑูุงู ุบุฑุจูุฉ 1234567890)
      const createdAt = new Date(message.created_at).toLocaleString('ar-SA', { numberingSystem: 'latn' });
      const timestampReceived = message.timestamp_received ? 
        new Date(message.timestamp_received * 1000).toLocaleString('ar-SA', { numberingSystem: 'latn' }) : 'ุบูุฑ ูุญุฏุฏ';
      
      // ุชุญุฏูุฏ ููุน ุงููุตุฏุฑ
      let sourceTypeText = '';
      let sourceIcon = '';
      switch(message.source_type) {
        case 'campaign':
          sourceTypeText = 'ุญููุฉ ุชุณููููุฉ';
          sourceIcon = '๐ข';
          break;
        case 'abandoned_cart':
          sourceTypeText = 'ุณูุฉ ูุชุฑููุฉ';
          sourceIcon = '๐';
          break;
        case 'manual':
          sourceTypeText = 'ุฑุณุงูุฉ ูุฏููุฉ';
          sourceIcon = '๐ฌ';
          break;
        default:
          sourceTypeText = 'ุบูุฑ ูุญุฏุฏ';
          sourceIcon = '๐จ';
      }

      // ุชุญุฏูุฏ ุญุงูุฉ ุงูุฑุณุงูุฉ
      let statusText = '';
      let statusColor = '';
      switch(message.status) {
        case 'sent':
          statusText = 'ูุฑุณูุฉ';
          statusColor = 'text-blue-600';
          break;
        case 'delivered':
          statusText = 'ูุณููุฉ';
          statusColor = 'text-green-600';
          break;
        case 'read':
          statusText = 'ููุฑูุกุฉ';
          statusColor = 'text-green-700';
          break;
        case 'failed':
          statusText = 'ูุดู ุงูุฅุฑุณุงู';
          statusColor = 'text-red-600';
          break;
        default:
          statusText = message.status || 'ุบูุฑ ูุญุฏุฏ';
          statusColor = 'text-gray-600';
      }

      content.innerHTML = `
        <div class="space-y-6">
          <!-- ูุนูููุงุช ุฃุณุงุณูุฉ -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-body-sm text-muted-foreground">ูุนุฑู ุงูุฑุณุงูุฉ</label>
              <p class="text-body-md font-mono break-all">${message.message_id || 'ุบูุฑ ูุญุฏุฏ'}</p>
            </div>
            <div>
              <label class="text-body-sm text-muted-foreground">ูุนุฑู ุงููุญุงุฏุซุฉ</label>
              <p class="text-body-md">${message.conversation_id || 'ุบูุฑ ูุญุฏุฏ'}</p>
            </div>
            <div>
              <label class="text-body-sm text-muted-foreground">ูู</label>
              <p class="text-body-md">${message.from_phone || 'ุบูุฑ ูุญุฏุฏ'}</p>
            </div>
            <div>
              <label class="text-body-sm text-muted-foreground">ุฅูู</label>
              <p class="text-body-md">${message.to_phone || 'ุบูุฑ ูุญุฏุฏ'}</p>
            </div>
          </div>

          <!-- ููุน ุงูุฑุณุงูุฉ ูุงููุตุฏุฑ -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-body-sm text-muted-foreground">ููุน ุงูุฑุณุงูุฉ</label>
              <p class="text-body-md">${message.message_type || 'ุบูุฑ ูุญุฏุฏ'}</p>
            </div>
            <div>
              <label class="text-body-sm text-muted-foreground">ุงููุตุฏุฑ</label>
              <p class="text-body-md">${sourceIcon} ${sourceTypeText}</p>
            </div>
            <div>
              <label class="text-body-sm text-muted-foreground">ุงูุงุชุฌุงู</label>
              <p class="text-body-md">${message.direction === 'incoming' ? 'ูุงุฑุฏ' : 'ุตุงุฏุฑ'}</p>
            </div>
            <div>
              <label class="text-body-sm text-muted-foreground">ุงูุญุงูุฉ</label>
              <p class="text-body-md ${statusColor} font-medium">${statusText}</p>
            </div>
          </div>

          <!-- ุงููุญุชูู -->
          <div>
            <label class="text-body-sm text-muted-foreground">ูุญุชูู ุงูุฑุณุงูุฉ</label>
            <div class="mt-2 p-4 bg-muted rounded-lg">
              <p class="text-body-md">${message.content || 'ูุง ููุฌุฏ ูุญุชูู'}</p>
            </div>
          </div>

          <!-- ุงููุณุงุฆุท -->
          ${message.media_id || message.media_url ? `
          <div>
            <label class="text-body-sm text-muted-foreground">ุงููุณุงุฆุท</label>
            <div class="mt-2 space-y-2">
              ${message.media_id ? `<p class="text-body-sm">ูุนุฑู ุงููุณุงุฆุท: <code class="bg-muted px-2 py-1 rounded">${message.media_id}</code></p>` : ''}
              ${message.media_url ? `<p class="text-body-sm">ุฑุงุจุท ุงููุณุงุฆุท: <a href="${message.media_url}" target="_blank" class="text-primary hover:underline">ุนุฑุถ</a></p>` : ''}
            </div>
          </div>
          ` : ''}

          <!-- ุงูุชูุงุฑูุฎ -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-body-sm text-muted-foreground">ุชุงุฑูุฎ ุงูุฅูุดุงุก</label>
              <p class="text-body-md">${createdAt}</p>
            </div>
            <div>
              <label class="text-body-sm text-muted-foreground">ุทุงุจุน ุฒููู ุงูููุจ ููู</label>
              <p class="text-body-md">${timestampReceived}</p>
            </div>
          </div>

          <!-- ูุนุฑู ุงููุตุฏุฑ -->
          ${message.source_id ? `
          <div>
            <label class="text-body-sm text-muted-foreground">ูุนุฑู ุงููุตุฏุฑ</label>
            <p class="text-body-md">${message.source_id}</p>
          </div>
          ` : ''}

          <!-- ุณุจุจ ูุดู ุงูุฑุณุงูุฉ -->
          ${message.status === 'failed' && message.error_message ? `
          <div class="border border-destructive/30 bg-destructive/10 rounded-lg p-4">
            <label class="text-body-sm text-destructive font-semibold flex items-center gap-2">
              <i data-lucide="alert-circle" class="w-4 h-4"></i>
              ุณุจุจ ุงููุดู
            </label>
            <p class="text-body-md text-destructive mt-2">${message.error_message}</p>
          </div>
          ` : ''}

          <!-- ุจูุงูุงุช ุงูููุจ ููู -->
          ${message.webhook_data && Object.keys(message.webhook_data).length > 0 ? `
          <div>
            <label class="text-body-sm text-muted-foreground">ุจูุงูุงุช ุงูููุจ ููู</label>
            <div class="mt-2 p-4 bg-muted rounded-lg overflow-auto max-h-40">
              <pre class="text-body-xs font-mono">${JSON.stringify(message.webhook_data, null, 2)}</pre>
            </div>
          </div>
          ` : ''}
        </div>
      `;

      modal.classList.remove('hidden');
      
      // ุถูุงู ุธููุฑ ุงููุงูุฐุฉ ูู ุงูููุฏูุฉ
      modal.style.zIndex = '9999';
      modal.style.position = 'fixed';
      
      // ุฅุนุงุฏุฉ ุชูุนูู ุงูุฃููููุงุช
      setTimeout(() => {
        lucide.createIcons();
      }, 50);
    }

    // ุฅุบูุงู ูุงูุฐุฉ ุชูุงุตูู ุงูุฑุณุงูุฉ
    function closeMessageDetails() {
      document.getElementById('message-details-modal').classList.add('hidden');
    }

    // ุฅุบูุงู ุงููุงูุฐุฉ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
    document.getElementById('message-details-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeMessageDetails();
      }
    });

    // ุฅุบูุงู ุงููุงูุฐุฉ ุนูุฏ ุงูุถุบุท ุนูู Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('message-details-modal');
        if (modal && !modal.classList.contains('hidden')) {
          closeMessageDetails();
        }
        const testModal = document.getElementById('test-send-modal');
        if (testModal && !testModal.classList.contains('hidden')) {
          hideTestSendModal();
        }
      }
    });

    // ==================== ุฏูุงู ุงูุฅุฑุณุงู ุงูุชุฌุฑูุจู ====================

    let testSendTemplates = [];
    let testMessageID = null;
    let statusCheckInterval = null;

    // ุนุฑุถ ูุงูุฐุฉ ุงูุฅุฑุณุงู ุงูุชุฌุฑูุจู
    async function showTestSendModal() {
      const modal = document.getElementById('test-send-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      // ุฅุฎูุงุก ูุชุงุฆุฌ ุณุงุจูุฉ
      document.getElementById('test-send-result').classList.add('hidden');
      document.getElementById('test-phone-number').value = '';
      testMessageID = null;
      
      // ุชุญููู ุงูููุงูุจ
      await loadTestTemplates();
      lucide.createIcons();
    }

    // ุฅุฎูุงุก ูุงูุฐุฉ ุงูุฅุฑุณุงู ุงูุชุฌุฑูุจู
    function hideTestSendModal() {
      const modal = document.getElementById('test-send-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      
      // ุฅููุงู ูุญุต ุงูุญุงูุฉ
      if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
        statusCheckInterval = null;
      }
    }

    // ุชุญููู ุงูููุงูุจ ููุฅุฑุณุงู ุงูุชุฌุฑูุจู
    async function loadTestTemplates() {
      const templateSelect = document.getElementById('test-template');
      templateSelect.innerHTML = '<option value="">ุฌุงุฑู ุชุญููู ุงูููุงูุจ...</option>';
      
      try {
        testSendTemplates = await loadMetaTemplates(100);
        
        const approvedTemplates = testSendTemplates.filter(t => t.status === 'APPROVED');
        
        // ูุฑุฒ ุงูููุงูุจ: ุงูููุงูุจ ุงูุจุณูุทุฉ (ุจุฏูู ูุชุบูุฑุงุช) ุฃููุงู
        const sortedTemplates = approvedTemplates.sort((a, b) => {
          const aHasVars = hasTemplateVariables(a);
          const bHasVars = hasTemplateVariables(b);
          if (aHasVars && !bHasVars) return 1;
          if (!aHasVars && bHasVars) return -1;
          return 0;
        });
        
        if (sortedTemplates.length > 0) {
          templateSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุงูุจ</option>' +
            '<option value="hello_world" data-lang="en_US">๐งช hello_world (ุงุฎุชุจุงุฑู - ุฅูุฌููุฒู)</option>' +
            sortedTemplates.map(template => {
              const langText = template.language === 'ar' ? 'ุนุฑุจู' : template.language === 'en' ? 'ุฅูุฌููุฒู' : template.language;
              const hasVars = hasTemplateVariables(template);
              const varIcon = hasVars ? 'โ๏ธ ' : 'โ ';
              return `<option value="${template.name}" data-lang="${template.language}">${varIcon}${template.name} (${langText})</option>`;
            }).join('');
        } else {
          templateSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุงูุจ</option>' +
            '<option value="hello_world" data-lang="en_US">๐งช hello_world (ุงุฎุชุจุงุฑู - ุฅูุฌููุฒู)</option>';
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุงูููุงูุจ:', error);
        templateSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุงูุจ</option>' +
          '<option value="hello_world" data-lang="en_US">๐งช hello_world (ุงุฎุชุจุงุฑู - ุฅูุฌููุฒู)</option>';
      }
    }
    
    // ูุญุต ุฅุฐุง ูุงู ุงููุงูุจ ูุญุชุงุฌ ูุชุบูุฑุงุช (ูุณุชุฎุฏู ุงููุธุงู ุงูุฐูู)
    function hasTemplateVariables(template) {
      if (!template || !template.components) return false;
      
      // ุงุณุชุฎุฏุงู ุงูุชุญููู ุงูุฐูู
      const analysis = analyzeTemplate(template);
      return analysis.needsVariables;
    }
    
    // ==================== ูุธุงู ุฐูู ูุงูุชุดุงู ูุชุบูุฑุงุช ุงููุงูุจ ====================
    
    // ุงุณุชุฎุฑุงุฌ ุนุฏุฏ ุงููุชุบูุฑุงุช ูู ูุต ุงููุงูุจ
    function extractVariablesCount(text) {
      if (!text) return 0;
      const matches = text.match(/\{\{(\d+)\}\}/g);
      if (!matches) return 0;
      
      // ุงุณุชุฎุฑุงุฌ ุฃูุจุฑ ุฑูู ูุชุบูุฑ
      let maxVar = 0;
      for (const match of matches) {
        const num = parseInt(match.replace(/[{}]/g, ''));
        if (num > maxVar) maxVar = num;
      }
      return maxVar;
    }
    
    // ุชุญููู ุฐูู ูููููุงุช ุงููุงูุจ
    function analyzeTemplate(template) {
      const analysis = {
        needsVariables: false,
        header: { needed: false, type: null, count: 0 },
        body: { needed: false, count: 0, examples: [] },
        buttons: [],
        confidence: 'high', // high, medium, low
        reason: ''
      };
      
      if (!template || !template.components) {
        analysis.reason = 'ุงููุงูุจ ุจุณูุท ุจุฏูู ููููุงุช';
        return analysis;
      }
      
      for (const component of template.components) {
        // ุชุญููู ุงูู HEADER
        if (component.type === 'HEADER') {
          if (component.format === 'TEXT') {
            const varsCount = extractVariablesCount(component.text);
            if (varsCount > 0) {
              analysis.header.needed = true;
              analysis.header.type = 'text';
              analysis.header.count = varsCount;
              analysis.needsVariables = true;
            }
          } else if (['IMAGE', 'VIDEO', 'DOCUMENT'].includes(component.format)) {
            // ุงูุชุญูู ููุง ุฅุฐุง ูุงูุช ุงููุณุงุฆุท ูุชุบูุฑุฉ ุฃู ุซุงุจุชุฉ
            // ุฅุฐุง ูุงู ููุงู example.header_handle ุฃู header_urlุ ููู ูุชุบูุฑุฉ
            if (component.example) {
              const hasHandle = component.example.header_handle && component.example.header_handle.length > 0;
              const hasUrl = component.example.header_url && component.example.header_url.length > 0;
              if (hasHandle || hasUrl) {
                analysis.header.needed = true;
                analysis.header.type = component.format.toLowerCase();
                analysis.header.count = 1;
                analysis.needsVariables = true;
              }
            }
            // ุฅุฐุง ูุง ููุฌุฏ exampleุ ูุงููุณุงุฆุท ุซุงุจุชุฉ (ูุฑููุนุฉ ูุณุจูุงู)
          }
        }
        
        // ุชุญููู ุงูู BODY
        if (component.type === 'BODY') {
          // ุทุฑููุฉ 1: ุงูุจุญุซ ุนู {{1}}, {{2}}, ... ูู ุงููุต
          const varsCount = extractVariablesCount(component.text);
          if (varsCount > 0) {
            analysis.body.needed = true;
            analysis.body.count = varsCount;
            analysis.needsVariables = true;
          }
          
          // ุทุฑููุฉ 2: ุงูุชุญูู ูู ูุฌูุฏ example.body_text
          if (component.example && component.example.body_text) {
            const exampleTexts = component.example.body_text;
            if (Array.isArray(exampleTexts) && exampleTexts.length > 0) {
              // ุนุฏุฏ ุงููุชุบูุฑุงุช = ุนุฏุฏ ุงูุฃูุซูุฉ ูู ุงููุตูููุฉ ุงูุฃููู
              const firstExample = exampleTexts[0];
              if (Array.isArray(firstExample)) {
                analysis.body.needed = true;
                analysis.body.count = Math.max(analysis.body.count, firstExample.length);
                analysis.body.examples = firstExample;
                analysis.needsVariables = true;
              }
            }
          }
        }
        
        // ุชุญููู ุงูู BUTTONS
        if (component.type === 'BUTTONS' && component.buttons) {
          for (let i = 0; i < component.buttons.length; i++) {
            const btn = component.buttons[i];
            
            if (btn.type === 'URL') {
              // ุงูุชุญูู ูู ูุฌูุฏ ูุชุบูุฑ ูู ุงูู URL
              const hasVariable = btn.url && btn.url.match(/\{\{\d+\}\}/);
              
              // ุงูุชุญูู ูู ูุฌูุฏ example
              const hasExample = btn.example && btn.example.length > 0;
              
              if (hasVariable || hasExample) {
                analysis.buttons.push({
                  index: i,
                  type: 'url',
                  hasVariable: !!hasVariable,
                  example: hasExample ? btn.example[0] : null
                });
                analysis.needsVariables = true;
              }
            }
          }
        }
      }
      
      // ุชุญุฏูุฏ ูุณุชูู ุงูุซูุฉ
      if (analysis.needsVariables) {
        if (analysis.body.examples.length > 0 || analysis.header.count > 0) {
          analysis.confidence = 'high';
          analysis.reason = 'ุชู ุงูุชุดุงู ูุชุบูุฑุงุช ูุงุถุญุฉ ูู ุงููุงูุจ';
        } else if (analysis.buttons.length > 0) {
          analysis.confidence = 'medium';
          analysis.reason = 'ุงููุงูุจ ูุญุชูู ุนูู ุฃุฒุฑุงุฑ ุฏููุงููููุฉ';
        }
      } else {
        analysis.confidence = 'high';
        analysis.reason = 'ุงููุงูุจ ุจุณูุท ุจุฏูู ูุชุบูุฑุงุช';
      }
      
      return analysis;
    }
    
    // ุงุณุชุฎุฑุงุฌ ุฑุงุจุท ูุณุงุฆุท ุงูุฑุฃุณ (ุตูุฑุฉ/ููุฏูู/ูุณุชูุฏ) ูู ุงููุงูุจ ุงููุญุฏุฏ
    function getHeaderMediaUrlFromTemplate(template, mediaType) {
      if (!template || !template.components) return '';
      const formatMap = { image: 'IMAGE', video: 'VIDEO', document: 'DOCUMENT' };
      const expectedFormat = formatMap[mediaType];
      const headerComp = template.components.find(c => c.type === 'HEADER' && c.format === expectedFormat);
      if (!headerComp || !headerComp.example) return '';
      const ex = headerComp.example;
      const url = (ex.header_url && ex.header_url[0])
        || (ex.header_handle && ex.header_handle[0])
        || (ex.headerUrl && ex.headerUrl[0])
        || (ex.headerHandle && ex.headerHandle[0]);
      return url ? String(url).trim() : '';
    }
    
    // ุจูุงุก ููููุงุช ุงููุงูุจ ุจูุงุกู ุนูู ุงูุชุญููู ุงูุฐูู
    function buildSmartComponents(template, variableValues = {}) {
      const analysis = analyzeTemplate(template);
      const components = [];
      
      console.log('๐ง ุชุญููู ุฐูู ูููุงูุจ:', template?.name);
      console.log('๐ง ูุชูุฌุฉ ุงูุชุญููู:', JSON.stringify(analysis, null, 2));
      console.log('๐ง ููู ุงููุชุบูุฑุงุช:', JSON.stringify(variableValues, null, 2));
      
      // ุฅุฐุง ูู ูุญุชุงุฌ ุงููุงูุจ ูุชุบูุฑุงุชุ ูุฑุฌุน ูุตูููุฉ ูุงุฑุบุฉ
      if (!analysis.needsVariables) {
        console.log('โ ุงููุงูุจ ูุง ูุญุชุงุฌ ูุชุบูุฑุงุช - ุฅุฑุณุงู ุจุฏูู components');
        return { components: [], analysis };
      }
      
      // ุชุญููู ููู ุงููุชุบูุฑุงุช ุฅูู ูุตูููุฉ
      const varArray = [];
      for (let i = 1; i <= 10; i++) {
        varArray.push(variableValues[i.toString()] || `ูููุฉ ${i}`);
      }
      
      // ุฅุถุงูุฉ ูููู ุงูู HEADER ุฅุฐุง ูุงู ูุทููุจุงู
      if (analysis.header.needed) {
        const headerComponent = { type: 'header', parameters: [] };
        
        if (analysis.header.type === 'text') {
          for (let i = 0; i < analysis.header.count; i++) {
            headerComponent.parameters.push({
              type: 'text',
              text: varArray[i] || `ูููุฉ ${i + 1}`
            });
          }
        } else if (analysis.header.type === 'image') {
          // ุงุณุชุฎุฏุงู ุตูุฑุฉ ุงูุฑุฃุณ ูู ุงููุงูุจ (ุงููุฑููุนุฉ ุนูุฏ ุฅูุดุงุก ุงููุงูุจ) ุฃู ูู ููู ุงููุชุบูุฑุงุช
          const headerImageUrl = variableValues['header_image']
            || getHeaderMediaUrlFromTemplate(template, 'image');
          headerComponent.parameters.push({
            type: 'image',
            image: { link: headerImageUrl || 'https://placehold.co/800x400/png?text=Test+Image' }
          });
        } else if (analysis.header.type === 'video') {
          const headerVideoUrl = variableValues['header_video']
            || getHeaderMediaUrlFromTemplate(template, 'video');
          headerComponent.parameters.push({
            type: 'video',
            video: { link: headerVideoUrl || 'https://sample-videos.com/video321/mp4/720/big_buck_bunny_720p_1mb.mp4' }
          });
        } else if (analysis.header.type === 'document') {
          const headerDocUrl = variableValues['header_document']
            || getHeaderMediaUrlFromTemplate(template, 'document');
          headerComponent.parameters.push({
            type: 'document',
            document: { link: headerDocUrl || 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf', filename: 'test.pdf' }
          });
        }
        
        if (headerComponent.parameters.length > 0) {
          components.push(headerComponent);
        }
      }
      
      // ุฅุถุงูุฉ ูููู ุงูู BODY ุฅุฐุง ูุงู ูุทููุจุงู
      if (analysis.body.needed && analysis.body.count > 0) {
        const bodyComponent = { type: 'body', parameters: [] };
        
        for (let i = 0; i < analysis.body.count; i++) {
          bodyComponent.parameters.push({
            type: 'text',
            text: varArray[i] || `ูููุฉ ${i + 1}`
          });
        }
        
        components.push(bodyComponent);
      }
      
      // ุฅุถุงูุฉ ููููุงุช ุงูุฃุฒุฑุงุฑ ุฅุฐุง ูุงูุช ูุทููุจุฉ
      for (const btn of analysis.buttons) {
        components.push({
          type: 'button',
          sub_type: 'url',
          index: btn.index,
          parameters: [{
            type: 'text',
            text: btn.example || 'test'
          }]
        });
      }
      
      console.log('๐ค ุงูููููุงุช ุงููุจููุฉ:', JSON.stringify(components, null, 2));
      
      return { components, analysis };
    }
    
    // ุงุณุชุฎุฑุงุฌ ูุญุชูู ุงููุงูุจ ููุนุฑุถ
    function getTemplateDisplayContent(template) {
      if (!template || !template.components) return '';
      
      let content = '';
      
      for (const component of template.components) {
        if (component.type === 'HEADER' && component.format === 'TEXT' && component.text) {
          content += '*' + component.text + '*\n\n';
        }
        if (component.type === 'BODY' && component.text) {
          content += component.text;
        }
        if (component.type === 'FOOTER' && component.text) {
          content += '\n\n_' + component.text + '_';
        }
      }
      
      return content || (template ? template.name : '');
    }

    // ุฅุฑุณุงู ุฑุณุงูุฉ ุชุฌุฑูุจูุฉ
    async function sendTestMessage() {
      const phoneNumber = document.getElementById('test-phone-number').value.trim();
      const templateName = document.getElementById('test-template').value;
      const templateLang = document.getElementById('test-template-language').value;
      
      // ุฌูุน ููู ุงููุชุบูุฑุงุช ูู ุงูุญููู ุงูุฏููุงููููุฉ
      const varValues = getVariableValues();
      const customerName = varValues['1'] || ''; // ุงููุชุบูุฑ ุงูุฃูู ูู ุงุณู ุงูุนููู
      
      // ุงูุชุญูู ูู ุงูุจูุงูุงุช
      if (!phoneNumber) {
        showToast('ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงููุงุชู', 'error');
        return;
      }
      
      // ุชูุธูู ุงูุฑูู
      const cleanPhone = phoneNumber.replace(/[\s\-\+]/g, '');
      if (!/^\d{10,15}$/.test(cleanPhone)) {
        showToast('ุฑูู ุงููุงุชู ุบูุฑ ุตุญูุญ. ูุฌุจ ุฃู ูุญุชูู ุนูู 10-15 ุฑููุงู', 'error');
        return;
      }
      
      if (!templateName) {
        showToast('ูุฑุฌู ุงุฎุชูุงุฑ ุงููุงูุจ', 'error');
        return;
      }
      
      const sendBtn = document.getElementById('test-send-btn');
      const resultDiv = document.getElementById('test-send-result');
      const resultContent = document.getElementById('test-send-result-content');
      
      // ุชุนุทูู ุงูุฒุฑ ูุนุฑุถ ุญุงูุฉ ุงูุฅุฑุณุงู
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i><span>ุฌุงุฑู ุงูุฅุฑุณุงู...</span>';
      lucide.createIcons();
      
      // ุนุฑุถ ุญุงูุฉ ุงูุงูุชุธุงุฑ
      resultDiv.classList.remove('hidden');
      resultContent.className = 'rounded-lg border border-muted bg-muted/30 p-4';
      resultContent.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-full bg-muted animate-pulse">
            <i data-lucide="loader-2" class="h-5 w-5 text-muted-foreground animate-spin"></i>
          </div>
          <div>
            <div class="text-body-md font-semibold">ุฌุงุฑู ุฅุฑุณุงู ุงูุฑุณุงูุฉ...</div>
            <div class="text-body-sm text-muted-foreground">ูุฑุฌู ุงูุงูุชุธุงุฑ</div>
          </div>
        </div>
      `;
      lucide.createIcons();
      
      try {
        // ุชุญุฏูุฏ ุงููุบุฉ ุงูุตุญูุญุฉ ูููุงูุจ
        let finalLang = templateLang;
        
        // ูุงูุจ hello_world ูุญุชุงุฌ en_US ุจุงูุถุจุท
        if (templateName === 'hello_world') {
          finalLang = 'en_US';
        }
        
        // ุงูุจุญุซ ุนู ูุบุฉ ุงููุงูุจ ูู ุงูุจูุงูุงุช ุงููุญููุฉ
        const selectedTemplate = testSendTemplates.find(t => t.name === templateName);
        if (selectedTemplate && selectedTemplate.language) {
          finalLang = selectedTemplate.language;
        }
        
        // ุงุณุชุฎุฑุงุฌ ูุญุชูู ุงููุงูุจ ููุนุฑุถ
        const templateContent = getTemplateDisplayContent(selectedTemplate);
        
        // ุงุณุชุฎุฏุงู ุงููุธุงู ุงูุฐูู ูุชุญููู ุงููุงูุจ ูุน ููู ุงููุชุบูุฑุงุช ุงููุฏุฎูุฉ
        const { components: smartComponents, analysis } = buildSmartComponents(selectedTemplate, varValues);
        
        // ุงูุชุญูู ูู ุฎูุงุฑ ุงูุชุฌุงูุฒ ุงููุฏูู
        const forceNoVariables = document.getElementById('test-no-variables').checked;
        
        console.log('๐ง ุฅุฑุณุงู ูุงูุจ:', templateName, 'ุจูุบุฉ:', finalLang);
        console.log('๐ง ุชุญููู ุงููุงูุจ:', analysis.reason);
        console.log('๐ง ูุญุชุงุฌ ูุชุบูุฑุงุช:', analysis.needsVariables);
        console.log('๐ง ุชุฌุงูุฒ ูุฏูู (ุจุฏูู ูุชุบูุฑุงุช):', forceNoVariables);
        
        // ุจูุงุก ุงูุจูุงูุงุช ููุฅุฑุณุงู
        const requestBody = {
          to: cleanPhone,
          type: 'template',
          template_name: templateName,
          template_language: finalLang,
          template_content: templateContent
        };
        
        // ุฅุถุงูุฉ ุงูููููุงุช ุจูุงุกู ุนูู ุงูุชุญููู ุงูุฐูู (ุฅูุง ุฅุฐุง ุชู ุงูุชุฌุงูุฒ ูุฏููุงู)
        if (!forceNoVariables && smartComponents && smartComponents.length > 0) {
          requestBody.template_components = smartComponents;
          console.log('๐ค ุฅุฑุณุงู ูุน ูุชุบูุฑุงุช:', smartComponents.length, 'ูููู');
        } else {
          console.log('๐ค ุฅุฑุณุงู ุจุฏูู ูุชุบูุฑุงุช');
        }
        
        console.log('๐ค ุจูุงูุงุช ุงูุทูุจ ุงูููุงุฆูุฉ:', JSON.stringify(requestBody, null, 2));
        
        const result = await apiRequest('/whatsapp/send', {
          method: 'POST',
          body: JSON.stringify(requestBody)
        });
        
        if (result.success) {
          testMessageID = result.message_id;
          
          // ุนุฑุถ ูุฌุงุญ ุงูุฅุฑุณุงู
          resultContent.className = 'rounded-lg border border-primary bg-primary/5 p-4';
          resultContent.innerHTML = `
            <div class="space-y-4">
              <div class="flex items-center gap-3">
                <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary/20">
                  <i data-lucide="check" class="h-5 w-5 text-primary"></i>
                </div>
                <div>
                  <div class="text-body-md font-semibold text-primary">ุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุจูุฌุงุญ!</div>
                  <div class="text-body-sm text-muted-foreground">ุงููุงูุจ: ${templateName}</div>
                </div>
              </div>
              
              <div class="border-t border-border pt-4">
                <div class="text-body-sm font-semibold mb-3">ูุชุงุจุนุฉ ุญุงูุฉ ุงูุฑุณุงูุฉ:</div>
                <div id="message-status-tracker" class="space-y-2">
                  <div class="flex items-center gap-3 p-2 rounded-lg bg-primary/10">
                    <i data-lucide="send" class="h-4 w-4 text-primary"></i>
                    <span class="text-body-sm">ุชู ุงูุฅุฑุณุงู</span>
                    <i data-lucide="check" class="h-4 w-4 text-primary mr-auto"></i>
                  </div>
                  <div id="status-delivered" class="flex items-center gap-3 p-2 rounded-lg bg-muted/50">
                    <i data-lucide="check-check" class="h-4 w-4 text-muted-foreground"></i>
                    <span class="text-body-sm text-muted-foreground">ุชู ุงูุชุณููู</span>
                    <i data-lucide="loader-2" class="h-4 w-4 text-muted-foreground animate-spin mr-auto"></i>
                  </div>
                  <div id="status-read" class="flex items-center gap-3 p-2 rounded-lg bg-muted/50">
                    <i data-lucide="eye" class="h-4 w-4 text-muted-foreground"></i>
                    <span class="text-body-sm text-muted-foreground">ุชูุช ุงููุฑุงุกุฉ</span>
                    <span class="text-body-xs text-muted-foreground mr-auto">ูู ุงูุงูุชุธุงุฑ</span>
                  </div>
                </div>
              </div>
              
              <div class="text-body-xs text-muted-foreground">
                <i data-lucide="info" class="h-3 w-3 inline"></i>
                <span>ูุนุฑู ุงูุฑุณุงูุฉ: <code class="bg-muted px-1 rounded text-[10px]">${testMessageID}</code></span>
              </div>
            </div>
          `;
          lucide.createIcons();
          
          // ุจุฏุก ูุชุงุจุนุฉ ุงูุญุงูุฉ
          startStatusTracking();
          
        } else {
          // ูุดู ุงูุฅุฑุณุงู
          let errorMsg = result.message || result.error || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู';
          let suggestion = '';
          
          // ุชุญููู ููุน ุงูุฎุทุฃ ูุชูุฏูู ุงูุชุฑุงุญุงุช
          if (errorMsg.includes('ุฑุงุจุท ุตูุฑุฉ ุงูุฑุฃุณ') || errorMsg.includes('ุตูุฑุฉ ุงูุฑุฃุณ') || (errorMsg.includes('403') && errorMsg.includes('ุงูุฑุฃุณ'))) {
            suggestion = 'ุงุฑูุน ุตูุฑุฉ ุฑุฃุณ ูู ุญูู ยซุตูุฑุฉ ุงูุฑุฃุณยป ุฃุนูุงูุ ุฃู ุงุณุชุฎุฏู ุฑุงุจุทุงู ุนุงูุงู (HTTPS) โ ุฑูุงุจุท ูุงุชุณุงุจ ูุง ุชุนูู ุนูุฏ ุงูุฅุฑุณุงู.';
          } else if (errorMsg.includes('parameter') || errorMsg.includes('Parameter') || errorMsg.includes('132000')) {
            suggestion = 'ุงููุงูุจ ูุญุชุงุฌ ูุชุบูุฑุงุช ุจุตูุบุฉ ุฎุงุตุฉ. ุฌุฑุจ ูุงูุจ hello_world ุฃู ุชุฃูุฏ ูู ุฅุนุฏุงุฏ ุงููุงูุจ ูู Meta ุจุดูู ุตุญูุญ.';
          } else if (errorMsg.includes('format')) {
            suggestion = 'ุชุฃูุฏ ูู ุงุฎุชูุงุฑ ุงููุงูุจ ุงูุตุญูุญ ูุงููุบุฉ ุงููุทุงุจูุฉ';
          } else if (errorMsg.includes('not found') || errorMsg.includes('ุบูุฑ ููุฌูุฏ')) {
            suggestion = 'ุชุฃูุฏ ูู ุฃู ุงููุงูุจ ูุนุชูุฏ ูู Meta Business ูุฃู ุงููุบุฉ ุตุญูุญุฉ';
          } else if (errorMsg.includes('limit') || errorMsg.includes('ุญุฏ')) {
            suggestion = 'ุชู ุงููุตูู ููุญุฏ ุงูุฃูุตู ูู ุงูุฑุณุงุฆู. ุญุงูู ูุงุญูุงู';
          }
          
          resultContent.className = 'rounded-lg border border-destructive bg-destructive/5 p-4';
          resultContent.innerHTML = `
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <div class="flex h-10 w-10 items-center justify-center rounded-full bg-destructive/20">
                  <i data-lucide="x" class="h-5 w-5 text-destructive"></i>
                </div>
                <div>
                  <div class="text-body-md font-semibold text-destructive">ูุดู ุฅุฑุณุงู ุงูุฑุณุงูุฉ</div>
                  <div class="text-body-sm text-muted-foreground">${errorMsg}</div>
                </div>
              </div>
              ${suggestion ? `
                <div class="flex items-start gap-2 p-3 rounded-lg bg-warning/10 border border-warning/30">
                  <i data-lucide="lightbulb" class="h-4 w-4 text-warning mt-0.5"></i>
                  <div class="text-body-sm text-warning-foreground">${suggestion}</div>
                </div>
              ` : ''}
            </div>
          `;
          lucide.createIcons();
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุงูุชุฌุฑูุจูุฉ:', error);
        resultContent.className = 'rounded-lg border border-destructive bg-destructive/5 p-4';
        resultContent.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-full bg-destructive/20">
              <i data-lucide="alert-triangle" class="h-5 w-5 text-destructive"></i>
            </div>
            <div>
              <div class="text-body-md font-semibold text-destructive">ุฎุทุฃ ูู ุงูุงุชุตุงู</div>
              <div class="text-body-sm text-muted-foreground">ุชุนุฐุฑ ุฅุฑุณุงู ุงูุฑุณุงูุฉ. ุชุญูู ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช.</div>
            </div>
          </div>
        `;
        lucide.createIcons();
      } finally {
        // ุฅุนุงุฏุฉ ุชูุนูู ุงูุฒุฑ
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i data-lucide="send" class="h-4 w-4"></i><span>ุฅุฑุณุงู ุงูุขู</span>';
        lucide.createIcons();
      }
    }

    // ูุชุงุจุนุฉ ุญุงูุฉ ุงูุฑุณุงูุฉ
    function startStatusTracking() {
      if (!testMessageID) return;
      
      let checkCount = 0;
      const maxChecks = 30; // 30 ูุญุงููุฉ (30 ุซุงููุฉ)
      
      statusCheckInterval = setInterval(async () => {
        checkCount++;
        
        if (checkCount > maxChecks) {
          clearInterval(statusCheckInterval);
          statusCheckInterval = null;
          
          // ุชุญุฏูุซ ุญุงูุฉ ุงูุชุชุจุน - ุงูุชูุช ุงููุฏุฉ
          const deliveredDiv = document.getElementById('status-delivered');
          const readDiv = document.getElementById('status-read');
          
          if (deliveredDiv && !deliveredDiv.classList.contains('delivered-done')) {
            deliveredDiv.innerHTML = `
              <i data-lucide="check-check" class="h-4 w-4 text-muted-foreground"></i>
              <span class="text-body-sm text-muted-foreground">ุชู ุงูุชุณููู</span>
              <span class="text-body-xs text-muted-foreground mr-auto">ุงูุชูุช ุงููุฏุฉ</span>
            `;
            lucide.createIcons();
          }
          
          if (readDiv && !readDiv.classList.contains('read-done')) {
            readDiv.innerHTML = `
              <i data-lucide="eye" class="h-4 w-4 text-muted-foreground"></i>
              <span class="text-body-sm text-muted-foreground">ุชูุช ุงููุฑุงุกุฉ</span>
              <span class="text-body-xs text-muted-foreground mr-auto">ุงูุชูุช ุงููุฏุฉ</span>
            `;
            lucide.createIcons();
          }
          
          return;
        }
        
        try {
          const result = await apiRequest(`/messages/${testMessageID}`);
          
          if (result.success && result.data) {
            updateStatusUI(result.data.status);
          }
        } catch (error) {
          console.error('ุฎุทุฃ ูู ูุญุต ุญุงูุฉ ุงูุฑุณุงูุฉ:', error);
        }
      }, 1000); // ูุญุต ูู ุซุงููุฉ
    }

    // ุชุญุฏูุซ ูุงุฌูุฉ ุญุงูุฉ ุงูุฑุณุงูุฉ
    function updateStatusUI(status) {
      const deliveredDiv = document.getElementById('status-delivered');
      const readDiv = document.getElementById('status-read');
      
      if (!deliveredDiv || !readDiv) return;
      
      // ุชุญุฏูุซ ุญุงูุฉ ุงูุชุณููู
      if (status === 'delivered' || status === 'read') {
        deliveredDiv.className = 'flex items-center gap-3 p-2 rounded-lg bg-success/10 delivered-done';
        deliveredDiv.innerHTML = `
          <i data-lucide="check-check" class="h-4 w-4 text-success"></i>
          <span class="text-body-sm text-success font-medium">ุชู ุงูุชุณููู</span>
          <i data-lucide="check" class="h-4 w-4 text-success mr-auto"></i>
        `;
        lucide.createIcons();
      }
      
      // ุชุญุฏูุซ ุญุงูุฉ ุงููุฑุงุกุฉ
      if (status === 'read') {
        readDiv.className = 'flex items-center gap-3 p-2 rounded-lg bg-blue-500/10 read-done';
        readDiv.innerHTML = `
          <i data-lucide="eye" class="h-4 w-4 text-blue-500"></i>
          <span class="text-body-sm text-blue-500 font-medium">ุชูุช ุงููุฑุงุกุฉ</span>
          <i data-lucide="check" class="h-4 w-4 text-blue-500 mr-auto"></i>
        `;
        lucide.createIcons();
        
        // ุฅููุงู ุงูุชุชุจุน ุจุนุฏ ุงููุฑุงุกุฉ
        if (statusCheckInterval) {
          clearInterval(statusCheckInterval);
          statusCheckInterval = null;
        }
      } else if (status === 'delivered') {
        // ุชุญุฏูุซ ุญุงูุฉ ุงููุฑุงุกุฉ - ูู ุงูุงูุชุธุงุฑ
        readDiv.innerHTML = `
          <i data-lucide="eye" class="h-4 w-4 text-muted-foreground"></i>
          <span class="text-body-sm text-muted-foreground">ุชูุช ุงููุฑุงุกุฉ</span>
          <i data-lucide="loader-2" class="h-4 w-4 text-muted-foreground animate-spin mr-auto"></i>
        `;
        lucide.createIcons();
      }
      
      // ุญุงูุฉ ุงููุดู
      if (status === 'failed') {
        deliveredDiv.className = 'flex items-center gap-3 p-2 rounded-lg bg-destructive/10';
        deliveredDiv.innerHTML = `
          <i data-lucide="x" class="h-4 w-4 text-destructive"></i>
          <span class="text-body-sm text-destructive font-medium">ูุดู ุงูุชุณููู</span>
        `;
        
        readDiv.className = 'flex items-center gap-3 p-2 rounded-lg bg-muted/30';
        readDiv.innerHTML = `
          <i data-lucide="eye-off" class="h-4 w-4 text-muted-foreground"></i>
          <span class="text-body-sm text-muted-foreground">-</span>
        `;
        lucide.createIcons();
        
        // ุฅููุงู ุงูุชุชุจุน
        if (statusCheckInterval) {
          clearInterval(statusCheckInterval);
          statusCheckInterval = null;
        }
      }
    }

    // ุชุญุฏูุซ ูุบุฉ ุงููุงูุจ ูุนุฑุถ ุงูุชุญููู ุงูุฐูู ุนูุฏ ุงุฎุชูุงุฑ ุงููุงูุจ
    function setupTestTemplateListener() {
      const templateSelect = document.getElementById('test-template');
      if (templateSelect) {
        templateSelect.addEventListener('change', function() {
          const selectedOption = this.options[this.selectedIndex];
          const lang = selectedOption?.getAttribute('data-lang');
          const templateName = this.value;
          
          // ุชุญุฏูุซ ุงููุบุฉ
          if (lang) {
            const langSelect = document.getElementById('test-template-language');
            if (lang === 'ar') {
              langSelect.value = 'ar';
            } else if (lang === 'en_US') {
              langSelect.value = 'en_US';
            } else if (lang === 'en') {
              langSelect.value = 'en';
            }
          }
          
          // ุนุฑุถ ูุชูุฌุฉ ุงูุชุญููู ุงูุฐูู
          updateTemplateAnalysis(templateName);
        });
      }
    }
    
    // ุงุณุชุฎุฑุงุฌ ูุญุชูู ุงููุงูุจ ููุนุฑุถ ุงูููุตู
    function getTemplatePreview(template) {
      if (!template || !template.components) return null;
      
      const preview = {
        header: null,
        headerType: null,
        headerMediaUrl: null,
        body: null,
        footer: null,
        buttons: []
      };
      
      for (const component of template.components) {
        if (component.type === 'HEADER') {
          preview.headerType = component.format;
          if (component.format === 'TEXT') {
            preview.header = component.text;
          } else if (component.format === 'IMAGE') {
            preview.header = '๐ผ๏ธ ุตูุฑุฉ';
            const ex = component.example || {};
            preview.headerMediaUrl = (ex.header_url && ex.header_url[0]) || (ex.header_handle && ex.header_handle[0]) || (ex.headerUrl && ex.headerUrl[0]) || (ex.headerHandle && ex.headerHandle[0]) || null;
          } else if (component.format === 'VIDEO') {
            preview.header = '๐ฌ ููุฏูู';
            const ex = component.example || {};
            preview.headerMediaUrl = (ex.header_url && ex.header_url[0]) || (ex.header_handle && ex.header_handle[0]) || (ex.headerUrl && ex.headerUrl[0]) || (ex.headerHandle && ex.headerHandle[0]) || null;
          } else if (component.format === 'DOCUMENT') {
            preview.header = '๐ ููู';
            const ex = component.example || {};
            preview.headerMediaUrl = (ex.header_url && ex.header_url[0]) || (ex.header_handle && ex.header_handle[0]) || (ex.headerUrl && ex.headerUrl[0]) || (ex.headerHandle && ex.headerHandle[0]) || null;
          }
        }
        
        if (component.type === 'BODY') {
          preview.body = component.text;
        }
        
        if (component.type === 'FOOTER') {
          preview.footer = component.text;
        }
        
        if (component.type === 'BUTTONS' && component.buttons) {
          for (const btn of component.buttons) {
            if (btn.type === 'URL') {
              preview.buttons.push({ type: 'ุฑุงุจุท', text: btn.text, url: btn.url });
            } else if (btn.type === 'QUICK_REPLY') {
              preview.buttons.push({ type: 'ุฑุฏ ุณุฑูุน', text: btn.text });
            } else if (btn.type === 'PHONE_NUMBER') {
              preview.buttons.push({ type: 'ุงุชุตุงู', text: btn.text });
            }
          }
        }
      }
      
      return preview;
    }
    
    // ูุชุบูุฑ ูุชุฎุฒูู ุงููุงูุจ ุงูุญุงูู ูุงูุชุญููู
    let currentTemplateAnalysis = null;
    let currentTemplatePreview = null;
    
    // ุนุฑุถ ูุชูุฌุฉ ุงูุชุญููู ุงูุฐูู ููุญุชูู ุงููุงูุจ
    function updateTemplateAnalysis(templateName) {
      const analysisDiv = document.getElementById('template-analysis-result');
      const variablesContainer = document.getElementById('template-variables-container');
      
      if (!templateName) {
        analysisDiv.classList.add('hidden');
        variablesContainer.innerHTML = '';
        return;
      }
      
      if (templateName === 'hello_world') {
        // hello_world ูุงูุจ ุจุณูุท
        currentTemplateAnalysis = { needsVariables: false };
        currentTemplatePreview = { body: 'Hello World! ๐' };
        variablesContainer.innerHTML = '';
        renderTemplatePreview();
        return;
      }
      
      // ุงูุจุญุซ ุนู ุงููุงูุจ ูู ุงููุงุฆูุฉ
      const template = testSendTemplates.find(t => t.name === templateName);
      if (!template) {
        analysisDiv.classList.add('hidden');
        variablesContainer.innerHTML = '';
        return;
      }
      
      // ุชุญููู ุงููุงูุจ
      currentTemplateAnalysis = analyzeTemplate(template);
      currentTemplatePreview = getTemplatePreview(template);
      
      // ุฅูุดุงุก ุญููู ุงููุชุบูุฑุงุช
      renderVariableInputs();
      
      // ุนุฑุถ ุงููุนุงููุฉ
      renderTemplatePreview();
    }
    
    // ุฅูุดุงุก ุญููู ุฅุฏุฎุงู ุงููุชุบูุฑุงุช
    function renderVariableInputs() {
      const container = document.getElementById('template-variables-container');
      
      if (!currentTemplateAnalysis) {
        container.innerHTML = '';
        return;
      }
      
      const analysis = currentTemplateAnalysis;
      const totalVars = analysis.body.count || 0;
      const needsVariables = analysis.needsVariables;
      
      if (!needsVariables) {
        container.innerHTML = '';
        return;
      }
      
      // ุฃุณูุงุก ุงูุชุฑุงุถูุฉ ูููุชุบูุฑุงุช
      const varLabels = [
        'ุงุณู ุงูุนููู',
        'ุงููุชุบูุฑ ุงูุซุงูู',
        'ุงููุชุบูุฑ ุงูุซุงูุซ',
        'ุงููุชุบูุฑ ุงูุฑุงุจุน',
        'ุงููุชุบูุฑ ุงูุฎุงูุณ',
        'ุงููุชุบูุฑ ุงูุณุงุฏุณ'
      ];
      
      const varPlaceholders = [
        'ูุซุงู: ุฃุญูุฏ',
        'ูุซุงู: ูููุฉ 2',
        'ูุซุงู: ูููุฉ 3',
        'ูุซุงู: ูููุฉ 4',
        'ูุซุงู: ูููุฉ 5',
        'ูุซุงู: ูููุฉ 6'
      ];
      
      let html = '';
      
      // ุตูุฑุฉ ุงูุฑุฃุณ: ุญูู ุฑูุน ุตูุฑุฉ (ููููุงูุจ ุงูุชู ุชุญุชูู ุตูุฑุฉ ุฑุฃุณ)
      if (analysis.header.needed && analysis.header.type === 'image') {
        html += `
          <div class="space-y-2 p-3 rounded-lg border border-amber-500/30 bg-amber-500/5" id="header-image-upload-box">
            <label class="text-body-sm font-medium flex items-center gap-2">
              <i data-lucide="image" class="h-4 w-4 text-amber-600"></i>
              <span>ุตูุฑุฉ ุงูุฑุฃุณ (ุงุฎุชูุงุฑู)</span>
            </label>
            <p class="text-body-xs text-muted-foreground">ุงุฑูุน ุตูุฑุฉ ูุฑุฃุณ ุงูุฑุณุงูุฉ. ุฅู ูู ุชุฑูุนุ ุณููุณุชุฎุฏู ุงูุฑุงุจุท ูู ุงููุงูุจ (ูุฏ ููุดู ุงูุชุณููู ูุฑูุงุจุท ูุงุชุณุงุจ).</p>
            <input 
              type="file" 
              accept="image/jpeg,image/png,image/jpg"
              id="header-image-file-input"
              class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm file:mr-2 file:rounded file:border-0 file:bg-primary file:px-3 file:py-1 file:text-body-sm file:text-primary-foreground"
            />
            <input type="hidden" id="template-var-header_image" data-var-num="header_image" class="template-var-input" />
            <div id="header-image-preview" class="hidden mt-2 rounded-lg overflow-hidden border border-border bg-muted/20 max-w-xs">
              <img id="header-image-preview-img" src="" alt="ูุนุงููุฉ" class="w-full max-h-32 object-cover" />
            </div>
          </div>
        `;
      }
      // ููุฏูู/ูุณุชูุฏ ุงูุฑุฃุณ: ูุจูู ุญูู ุงูุฑุงุจุท
      if (analysis.header.needed && ['video', 'document'].includes(analysis.header.type)) {
        const headerLabel = analysis.header.type === 'video' ? 'ุฑุงุจุท ุจุฏูู ูููุฏูู ุงูุฑุฃุณ' : 'ุฑุงุจุท ุจุฏูู ููุณุชูุฏ ุงูุฑุฃุณ';
        const headerKey = analysis.header.type === 'video' ? 'header_video' : 'header_document';
        html += `
          <div class="space-y-1 p-3 rounded-lg border border-amber-500/30 bg-amber-500/5">
            <label class="text-body-sm font-medium flex items-center gap-2">
              <i data-lucide="file" class="h-4 w-4 text-amber-600"></i>
              <span>${headerLabel} (ุงุฎุชูุงุฑู)</span>
            </label>
            <input 
              type="url" 
              id="template-var-${headerKey}" 
              data-var-num="${headerKey}"
              placeholder="https://example.com/file" 
              class="template-var-input flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" 
              oninput="updatePreviewRealtime()"
            />
          </div>
        `;
      }
      
      for (let i = 0; i < totalVars; i++) {
        const varNum = i + 1;
        html += `
          <div class="space-y-1">
            <label class="text-body-sm font-medium flex items-center gap-2">
              <span class="inline-flex items-center justify-center h-5 w-5 rounded bg-warning/20 text-warning text-xs font-mono">{{${varNum}}}</span>
              <span>${varLabels[i] || `ุงููุชุบูุฑ ${varNum}`}</span>
            </label>
            <input 
              type="text" 
              id="template-var-${varNum}" 
              data-var-num="${varNum}"
              placeholder="${varPlaceholders[i] || `ูููุฉ ุงููุชุบูุฑ ${varNum}`}" 
              class="template-var-input flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring" 
              oninput="updatePreviewRealtime()"
            />
          </div>
        `;
      }
      
      container.innerHTML = html;
      lucide.createIcons();

      // ุฑูุน ุตูุฑุฉ ุงูุฑุฃุณ: ุนูุฏ ุงุฎุชูุงุฑ ููู ูุฑูุนู ุซู ูููุฃ ุงูุฑุงุจุท ูู ุงูุญูู ุงููุฎูู
      const fileInput = document.getElementById('header-image-file-input');
      if (fileInput) {
        fileInput.addEventListener('change', async function() {
          const file = this.files && this.files[0];
          const hiddenInput = document.getElementById('template-var-header_image');
          const previewDiv = document.getElementById('header-image-preview');
          const previewImg = document.getElementById('header-image-preview-img');
          if (!file) {
            if (hiddenInput) { hiddenInput.value = ''; }
            if (previewDiv) { previewDiv.classList.add('hidden'); }
            updatePreviewRealtime();
            return;
          }
          if (!file.type.match(/^image\/(jpeg|png|jpg)$/)) {
            showToast('ุงูููู ูุฌุจ ุฃู ูููู ุตูุฑุฉ (JPEG ุฃู PNG)', 'error');
            return;
          }
          if (file.size > 5 * 1024 * 1024) {
            showToast('ุญุฌู ุงูุตูุฑุฉ ูุฌุจ ุฃูุง ูุชุฌุงูุฒ 5 ููุฌุงุจุงูุช', 'error');
            return;
          }
          const token = localStorage.getItem('access_token') || localStorage.getItem('tchat_token');
          if (!token) {
            showToast('ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู', 'error');
            return;
          }
          const baseUrl = (typeof API_BASE_URL !== 'undefined' ? API_BASE_URL : '/api/v1').replace(/\/$/, '');
          const formData = new FormData();
          formData.append('file', file);
          try {
            const res = await fetch(baseUrl + '/campaigns/upload-header-image', {
              method: 'POST',
              headers: { 'Authorization': 'Bearer ' + token },
              body: formData
            });
            const data = await res.json();
            if (data.success && data.url) {
              if (hiddenInput) { hiddenInput.value = data.url; }
              if (previewImg) { previewImg.src = data.url; }
              if (previewDiv) { previewDiv.classList.remove('hidden'); }
              showToast('ุชู ุฑูุน ุงูุตูุฑุฉ ุจูุฌุงุญ', 'success');
              updatePreviewRealtime();
            } else {
              showToast(data.message || data.error || 'ูุดู ุฑูุน ุงูุตูุฑุฉ', 'error');
            }
          } catch (err) {
            console.error('ุฑูุน ุตูุฑุฉ ุงูุฑุฃุณ:', err);
            showToast('ูุดู ุฑูุน ุงูุตูุฑุฉ', 'error');
          }
        });
      }
    }
    
    // ุชุญุฏูุซ ุงููุนุงููุฉ ูู ุงูููุช ุงููุนูู
    function updatePreviewRealtime() {
      renderTemplatePreview();
    }
    
    // ุงูุญุตูู ุนูู ููู ุงููุชุบูุฑุงุช ุงููุฏุฎูุฉ
    function getVariableValues() {
      const values = {};
      const inputs = document.querySelectorAll('.template-var-input');
      inputs.forEach(input => {
        const varNum = input.getAttribute('data-var-num');
        if (varNum) values[varNum] = input.value || '';
      });
      return values;
    }
    
    // ุนุฑุถ ูุนุงููุฉ ุงููุงูุจ ูุน ุงูููู ุงูุญุงููุฉ
    function renderTemplatePreview() {
      const analysisDiv = document.getElementById('template-analysis-result');
      
      if (!currentTemplatePreview) {
        analysisDiv.classList.add('hidden');
        return;
      }
      
      analysisDiv.classList.remove('hidden');
      analysisDiv.className = 'p-3 rounded-lg border border-border bg-muted/30 space-y-3';
      
      const analysis = currentTemplateAnalysis;
      const preview = currentTemplatePreview;
      const varValues = getVariableValues();
      
      // ุญุงูุฉ ุงููุงูุจ
      let statusHTML = '';
      if (!analysis || !analysis.needsVariables) {
        statusHTML = `
          <div class="flex items-center gap-2">
            <i data-lucide="check-circle" class="h-4 w-4 text-primary"></i>
            <span class="text-body-sm font-medium text-primary">ูุงูุจ ุจุณูุท - ุฌุงูุฒ ููุฅุฑุณุงู</span>
          </div>
        `;
      } else {
        let details = [];
        if (analysis.body.needed) {
          details.push(`${analysis.body.count} ูุชุบูุฑ ูู ุงููุต`);
        }
        if (analysis.header.needed) {
          details.push(`${analysis.header.type === 'text' ? 'ูุชุบูุฑ ูู ุงูุนููุงู' : analysis.header.type + ' ูุชุบูุฑ'}`);
        }
        if (analysis.buttons.length > 0) {
          details.push(`${analysis.buttons.length} ุฒุฑ ุฏููุงูููู`);
        }
        
        statusHTML = `
          <div class="flex items-center gap-2 mb-2">
            <i data-lucide="eye" class="h-4 w-4 text-muted-foreground"></i>
            <span class="text-body-sm font-medium">ูุนุงููุฉ ุงูุฑุณุงูุฉ</span>
          </div>
        `;
      }
      
      // ูุนุงููุฉ ุงููุญุชูู
      let contentHTML = '<div class="bg-background rounded-lg p-3 border border-border space-y-2">';
      
      // Header โ ุนุฑุถ ุงูุดูู ุงูููุงุฆู (ุตูุฑุฉ ุงูุฑุฃุณ ูู ุงููุงูุจ)
      if (preview.header) {
        const headerMediaUrlForPreview = preview.headerMediaUrl;
        if (preview.headerType === 'TEXT') {
          let headerText = escapeHtml(preview.header);
          headerText = replaceVariablesWithValues(headerText, varValues);
          contentHTML += `<p class="text-body-sm font-bold">${headerText}</p>`;
        } else if (preview.headerType === 'IMAGE' && headerMediaUrlForPreview) {
          contentHTML += `<div class="rounded-lg overflow-hidden border border-border bg-muted/20 my-1">
            <img src="${escapeHtml(headerMediaUrlForPreview)}" alt="ุฑุฃุณ ุงููุงูุจ" class="w-full max-h-48 object-cover" loading="lazy"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
            />
            <div class="hidden items-center justify-center gap-2 py-6 text-muted-foreground text-body-sm" style="display:none;">
              <i data-lucide="image" class="h-8 w-8"></i>
              <span>ุตูุฑุฉ ุงูุฑุฃุณ</span>
            </div>
          </div>`;
        } else if (preview.headerType === 'VIDEO' && headerMediaUrlForPreview) {
          contentHTML += `<div class="rounded-lg overflow-hidden border border-border bg-black/10 my-1">
            <video src="${escapeHtml(headerMediaUrlForPreview)}" class="w-full max-h-40 object-contain" controls preload="metadata"></video>
          </div>`;
        } else if (preview.headerType === 'DOCUMENT' && headerMediaUrlForPreview) {
          contentHTML += `<a href="${escapeHtml(headerMediaUrlForPreview)}" target="_blank" rel="noopener" class="flex items-center gap-2 rounded-lg border border-border bg-muted/20 p-3 my-1 text-body-sm text-primary hover:bg-muted/40">
            <i data-lucide="file-text" class="h-5 w-5 shrink-0"></i>
            <span>ููู ูุฑูู</span>
          </a>`;
        } else {
          contentHTML += `<p class="text-body-xs text-muted-foreground">${preview.header}</p>`;
        }
      }
      
      // Body
      if (preview.body) {
        let bodyText = escapeHtml(preview.body);
        bodyText = replaceVariablesWithValues(bodyText, varValues);
        contentHTML += `<p class="text-body-sm whitespace-pre-wrap">${bodyText}</p>`;
      }
      
      // Footer
      if (preview.footer) {
        contentHTML += `<p class="text-body-xs text-muted-foreground border-t border-border pt-2 mt-2">${escapeHtml(preview.footer)}</p>`;
      }
      
      // Buttons
      if (preview.buttons && preview.buttons.length > 0) {
        contentHTML += '<div class="flex flex-wrap gap-2 border-t border-border pt-2 mt-2">';
        for (const btn of preview.buttons) {
          contentHTML += `<span class="inline-flex items-center gap-1 px-2 py-1 bg-primary/10 text-primary text-body-xs rounded-full">
            <i data-lucide="${btn.type === 'ุฑุงุจุท' ? 'external-link' : btn.type === 'ุงุชุตุงู' ? 'phone' : 'reply'}" class="h-3 w-3"></i>
            ${escapeHtml(btn.text)}
          </span>`;
        }
        contentHTML += '</div>';
      }
      
      contentHTML += '</div>';
      
      analysisDiv.innerHTML = statusHTML + contentHTML;
      lucide.createIcons();
    }
    
    // ุงุณุชุจุฏุงู ุงููุชุบูุฑุงุช ุจุงูููู ุงููุฏุฎูุฉ
    function replaceVariablesWithValues(text, values) {
      return text.replace(/\{\{(\d+)\}\}/g, (match, num) => {
        const value = values[num];
        if (value && value.trim()) {
          return `<span class="bg-primary/20 text-primary px-1 rounded">${escapeHtml(value)}</span>`;
        } else {
          return `<span class="bg-warning/20 text-warning px-1 rounded font-mono text-xs">{{${num}}}</span>`;
        }
      });
    }
    
    // ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชูุฑูุจ HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // ุชููุฆุฉ listener ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    document.addEventListener('DOMContentLoaded', setupTestTemplateListener);
  </script>
</body>
</html>
