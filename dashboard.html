<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TCHAT - لوحة التحكم</title>
    <link rel="stylesheet" href="./style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="./api.js"></script>
  </head>
  <body class="rtl min-h-screen" style="background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 50%, #ffffff 100%); font-family: 'LamaSans', sans-serif;">
    
    <div class="min-h-screen flex">
      
      <!-- Sidebar -->
      <div class="w-64 min-h-screen border-l border-gray-200" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);">
        <div class="p-6">
          <!-- User Profile -->
          <div class="flex items-center space-x-3 space-x-reverse mb-8">
            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background: linear-gradient(135deg, #4f46e5, #7c3aed);">
              ا
            </div>
            <div class="text-right">
              <p class="text-body-sm font-medium text-gray-900">المدير العام</p>
              <p class="text-body-sm text-gray-500">admin@munasabati.com</p>
            </div>
          </div>

          <!-- Navigation Menu -->
          <nav class="space-y-2">
            <a href="#" class="flex items-center px-3 py-2 text-body-sm font-medium rounded-lg text-white" style="background: linear-gradient(135deg, #4f46e5, #7c3aed);">
              <i data-lucide="home" class="w-4 h-4 ml-2"></i>
              الرئيسية
            </a>
            
            <a href="#" class="flex items-center px-3 py-2 text-body-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
              <i data-lucide="users" class="w-4 h-4 ml-2"></i>
              المناسبات
            </a>
            
            <a href="#" class="flex items-center px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
              <i data-lucide="calendar" class="w-4 h-4 ml-2"></i>
              العمليات
            </a>
            
            <a href="#" class="flex items-center px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
              <i data-lucide="activity" class="w-4 h-4 ml-2"></i>
              الدردشات
            </a>
            
            <a href="#" class="flex items-center px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
              <i data-lucide="phone" class="w-4 h-4 ml-2"></i>
              أرقام الواتساب
            </a>
            
            <a href="#" class="flex items-center px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
              <i data-lucide="file-text" class="w-4 h-4 ml-2"></i>
              سجلات المرفوعات
            </a>
            
            <a href="#" class="flex items-center px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
              <i data-lucide="credit-card" class="w-4 h-4 ml-2"></i>
              إدارة القوالب
            </a>
            
            <a href="#" class="flex items-center px-3 py-2 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
              <i data-lucide="settings" class="w-4 h-4 ml-2"></i>
              الإعدادات
            </a>
          </nav>
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex-1">
        <!-- Header -->
        <header class="border-b border-gray-200 p-6" style="background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px);">
          <div class="flex items-center justify-between">
            <div class="text-right">
              <h1 class="text-heading-md font-bold text-gray-900">لوحة التحكم</h1>
            </div>
            <div>
              <button onclick="logout()" class="flex items-center px-4 py-2 text-body-sm rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 transition-colors">
                <i data-lucide="log-out" class="w-4 h-4 ml-2"></i>
                <span>تسجيل الخروج</span>
              </button>
            </div>
          </div>
        </header>

        <!-- Main Content -->
        <main class="p-6">

          <!-- Revenue Table -->
          <div class="bg-white rounded-xl border border-gray-200 shadow-sm mb-8">
            <div class="p-4 rounded-t-xl" style="background: linear-gradient(135deg, #a855f7, #3b82f6);">
              <h2 class="text-heading-sm font-bold text-white text-right">إجمالي الإيرادات (SAR)</h2>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-4 text-right text-body-sm font-medium text-gray-700"></th>
                    <th class="px-6 py-4 text-right text-body-sm font-medium text-gray-700">الحالة</th>
                    <th class="px-6 py-4 text-right text-body-sm font-medium text-gray-700">إجمالي الإيرادات<br><span class="font-normal text-gray-500">(منذ البدء)</span></th>
                    <th class="px-6 py-4 text-right text-body-sm font-medium text-gray-700">إجمالي الإيرادات<br><span class="font-normal text-gray-500">(30 يوماً سابقة)</span></th>
                    <th class="px-6 py-4 text-right text-body-sm font-medium text-gray-700">إجمالي الإيرادات<br><span class="font-normal text-gray-500">(آخر 30 يوماً)</span></th>
                    <th class="px-6 py-4 text-right text-body-sm font-medium text-gray-700">الطلبات المنسوبة<br><span class="font-normal text-gray-500">(آخر 30 يوماً)</span></th>
                  </tr>
                </thead>
                <tbody id="revenue-table-tbody" class="divide-y divide-gray-200">
                  <!-- البيانات ستُحمل من Backend -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- WhatsApp Numbers Table -->
          <div class="bg-white rounded-xl border border-gray-200 shadow-sm mb-8">
            <div class="p-4 rounded-t-xl" style="background: linear-gradient(135deg, #a855f7, #3b82f6);">
              <h2 class="text-heading-sm font-bold text-white text-right">أرقام الواتساب</h2>
              <p class="text-body-sm text-white/80 text-right">إدارة أرقام الواتساب والدفع ومراقبة الذكاء</p>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">الرقم</th>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">الحالة</th>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">تقييم الجودة</th>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">الحد اليومي للرسائل</th>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">الإسم</th>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">مزود الخدمة</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="border-t border-gray-200 hover:bg-gray-50">
                    <td class="px-6 py-4 text-center">
                      <span class="font-mono text-body-md text-gray-900">966533934546</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        متصل
                      </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        مرتفع
                      </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <div class="flex items-center justify-center space-x-2 space-x-reverse">
                        <span class="font-mono text-body-md text-gray-900">1,000</span>
                        <i data-lucide="trending-up" class="w-4 h-4 text-blue-500"></i>
                      </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <span class="text-gray-900">مناسبتي</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <span class="text-gray-900">Whatsapp</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Payment Status -->
          <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
            <div class="p-4 rounded-t-xl" style="background: linear-gradient(135deg, #3b82f6, #a855f7);">
              <div class="flex items-center justify-between">
                <h2 class="text-heading-sm font-bold text-white">حالة الدفع</h2>
                <i data-lucide="dollar-sign" class="w-6 h-6 text-white"></i>
              </div>
            </div>
            
            <div class="p-6">
              <div class="flex items-center justify-between">
                <div class="text-right">
                  <p class="text-body-lg font-bold text-gray-900">حالة الدفع عبر واتساب الأعمال</p>
                </div>
                <div class="text-left">
                  <div class="flex items-center space-x-3 space-x-reverse">
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    <span class="text-gray-900">لا يوجد مشكلة</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script>
      // تحقق من تسجيل الدخول
      if (!localStorage.getItem('tchat_logged_in')) {
        window.location.href = './login.html';
      }

      // تحميل البيانات من Backend
      async function loadDashboardData() {
        try {
          console.log('بدء تحميل بيانات لوحة التحكم...');
          
          // تحميل بيانات الإيرادات
          const revenueData = await loadRevenueData();
          console.log('Revenue Data:', revenueData);
          renderRevenueTable(revenueData);
          
          // تحميل أرقام WhatsApp من Meta
          const metaPhoneNumbers = await loadMetaPhoneNumbers();
          console.log('Meta Phone Numbers:', metaPhoneNumbers);
          renderWhatsAppTable(metaPhoneNumbers);
          
        } catch (error) {
          console.error('خطأ في تحميل بيانات لوحة التحكم:', error);
        }
      }

      // عرض جدول الإيرادات
      function renderRevenueTable(data) {
        const tbody = document.getElementById('revenue-table-tbody');
        if (!data || data.length === 0) return;
        
        tbody.innerHTML = data.map(item => {
          const statusClass = item.status === 'فعالة' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800';
          const isTotal = item.campaign_name === 'الحملات التسويقية';
          const borderClass = isTotal ? 'border-t-2 border-gray-300' : '';
          
          return `
            <tr class="hover:bg-gray-50 ${borderClass}">
              <td class="px-6 py-4 text-right">
                <span class="text-body-md text-gray-900 ${isTotal ? 'font-bold' : 'font-medium'}">${item.campaign_name}</span>
              </td>
              <td class="px-6 py-4 text-right">
                ${item.status.includes('ذات إيرادات') ? 
                  `<span class="text-body-sm text-gray-600">${item.status}</span>` :
                  `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">${item.status}</span>`
                }
              </td>
              <td class="px-6 py-4 text-right">
                <span class="font-mono text-body-lg font-bold text-gray-900 number">${item.total_revenue.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
              </td>
              <td class="px-6 py-4 text-right">
                <span class="font-mono text-body-md text-gray-900 number">${item.last_30_days.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
              </td>
              <td class="px-6 py-4 text-right">
                <span class="font-mono text-body-md text-gray-900 number">${item.previous_30_days.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
              </td>
              <td class="px-6 py-4 text-right">
                <span class="text-body-lg font-bold text-gray-900 number">${item.attributed_orders}</span>
              </td>
            </tr>
          `;
        }).join('');
      }

      // عرض جدول أرقام WhatsApp
      function renderWhatsAppTable(phoneNumbers) {
        const tbody = document.getElementById('whatsapp-numbers-tbody');
        if (!phoneNumbers || phoneNumbers.length === 0) {
          console.error('لا توجد أرقام WhatsApp');
          return;
        }
        
        console.log('عرض أرقام WhatsApp:', phoneNumbers);
        
        tbody.innerHTML = phoneNumbers.map(phone => {
          // تنسيق تقييم الجودة
          let qualityText = phone.quality_rating;
          if (qualityText === 'GREEN') qualityText = 'مرتفع';
          else if (qualityText === 'YELLOW') qualityText = 'متوسط';
          else if (qualityText === 'RED') qualityText = 'منخفض';
          
          // تنظيف رقم الهاتف (إزالة المسافات والرموز)
          const cleanPhoneNumber = phone.display_phone_number.replace(/[\s\+\-]/g, '');
          
          // تحديد الحد اليومي بناء على throughput level أو استخدام 1000 كافتراضي
          const dailyLimit = phone.throughput_level === 'HIGH' ? 10000 : 
                           phone.throughput_level === 'VERY_HIGH' ? 100000 : 1000;
          
          // تحديد الحالة
          const status = phone.code_verification_status === 'VERIFIED' ? 'متصل' : 'غير متحقق';
          
          return `
            <tr class="border-t border-gray-200 hover:bg-gray-50">
              <td class="px-6 py-4 text-center">
                <span class="font-mono text-gray-900 number">${cleanPhoneNumber}</span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  ${status}
                </span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  ${qualityText}
                </span>
              </td>
              <td class="px-6 py-4 text-center">
                <div class="flex items-center justify-center space-x-2 space-x-reverse">
                  <span class="font-mono text-gray-900 number">${dailyLimit.toLocaleString('en-US')}</span>
                  <i data-lucide="trending-up" class="w-4 h-4 text-blue-500"></i>
                </div>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="text-gray-900">${phone.verified_name}</span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="text-gray-900">Whatsapp</span>
              </td>
            </tr>
          `;
        }).join('');
        
        // إعادة تهيئة الأيقونات
        lucide.createIcons();
      }

      // تهيئة أيقونات Lucide
      document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        loadDashboardData();
      });

      // تسجيل الخروج
      function logout() {
        localStorage.removeItem('tchat_logged_in');
        localStorage.removeItem('tchat_user');
        localStorage.removeItem('tchat_token');
        window.location.href = './login.html';
      }
    </script>
  </body>
</html>
