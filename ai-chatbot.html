<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TCHAT - Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="./api.js"></script>
  <script src="./components/header.js"></script>
</head>
<body class="rtl min-h-screen bg-background" style="font-family: 'LamaSans', sans-serif;">
  
  <div class="min-h-screen">
    
    <!-- Header Container -->
    <div id="header-container"></div>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    
    <!-- Page Header -->
    <section class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-heading-lg font-bold text-foreground">Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p class="text-body-sm text-muted-foreground">Ø§Ù„Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
      </div>
      <div class="flex items-center gap-3">
        <!-- Ø²Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„/Ø§Ù„ØªØ¹Ø·ÙŠÙ„ -->
        <div class="flex items-center gap-2">
          <span class="text-body-sm text-muted-foreground" id="status-text">Ù…Ø¹Ø·Ù„</span>
          <button 
            id="toggle-btn"
            onclick="toggleChatbot()"
            class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 bg-muted"
          >
            <span id="toggle-dot" class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"></span>
          </button>
        </div>
      </div>
    </section>

    <!-- Status Card -->
    <section class="mb-8">
      <div id="status-card" class="rounded-xl border bg-card p-6 shadow-sm">
        <div class="flex items-center gap-4">
          <div id="status-icon" class="flex h-14 w-14 items-center justify-center rounded-full bg-muted">
            <i data-lucide="bot" class="h-7 w-7 text-muted-foreground"></i>
          </div>
          <div>
            <h2 id="status-title" class="text-heading-md font-semibold">Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ù…Ø¹Ø·Ù„</h2>
            <p id="status-desc" class="text-body-sm text-muted-foreground">Ù‚Ù… Ø¨ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ù„Ù„Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      
      <!-- Settings Card -->
      <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
        <div class="border-b border-border p-6">
          <div class="flex items-center gap-3">
            <i data-lucide="settings" class="h-5 w-5 text-muted-foreground"></i>
            <h2 class="text-heading-md font-semibold">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
          </div>
        </div>
        <div class="p-6 space-y-6">
          
          <!-- AI Provider -->
          <div>
            <label class="block text-body-sm font-medium mb-2">Ù…Ø²ÙˆØ¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</label>
            <select id="ai-provider" onchange="updateModel()" class="w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus:outline-none focus:ring-2 focus:ring-primary">
              <option value="anthropic">Anthropic (Claude)</option>
              <option value="openai">OpenAI (GPT)</option>
            </select>
          </div>

          <!-- AI Model -->
          <div>
            <label class="block text-body-sm font-medium mb-2">Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</label>
            <select id="ai-model" class="w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus:outline-none focus:ring-2 focus:ring-primary">
              <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
              <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
              <option value="gpt-4">GPT-4</option>
              <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
            </select>
          </div>

          <!-- Reply Mode -->
          <div>
            <label class="block text-body-sm font-medium mb-2">ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø¯</label>
            <div class="space-y-2">
              <label class="flex items-center gap-3 cursor-pointer">
                <input type="radio" name="reply-mode" value="false" id="reply-outside" class="h-4 w-4 text-primary focus:ring-primary" checked>
                <span class="text-body-sm">Ø§Ù„Ø±Ø¯ ÙÙ‚Ø· Ø®Ø§Ø±Ø¬ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„</span>
              </label>
              <label class="flex items-center gap-3 cursor-pointer">
                <input type="radio" name="reply-mode" value="true" id="reply-all" class="h-4 w-4 text-primary focus:ring-primary">
                <span class="text-body-sm">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
              </label>
            </div>
          </div>

          <!-- Working Hours -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-body-sm font-medium mb-2">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„</label>
              <input type="time" id="working-start" value="09:00" class="w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div>
              <label class="block text-body-sm font-medium mb-2">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„</label>
              <input type="time" id="working-end" value="23:00" class="w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
          </div>

          <!-- Max Tokens -->
          <div>
            <label class="block text-body-sm font-medium mb-2">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø±Ø¯ (tokens)</label>
            <input type="number" id="max-tokens" value="500" min="100" max="2000" class="w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus:outline-none focus:ring-2 focus:ring-primary">
          </div>

          <!-- Temperature -->
          <div>
            <label class="block text-body-sm font-medium mb-2">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹: <span id="temp-value">0.7</span></label>
            <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" onchange="document.getElementById('temp-value').textContent = this.value" class="w-full h-2 bg-muted rounded-lg appearance-none cursor-pointer">
            <div class="flex justify-between text-caption text-muted-foreground mt-1">
              <span>Ø¯Ù‚ÙŠÙ‚</span>
              <span>Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ</span>
            </div>
          </div>

          <!-- Excluded Keywords -->
          <div>
            <label class="block text-body-sm font-medium mb-2">ÙƒÙ„Ù…Ø§Øª Ù…Ø³ØªØ«Ù†Ø§Ø© (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)</label>
            <input type="text" id="excluded-keywords" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠØ±, Ø´ÙƒÙˆÙ‰, Ù…Ø´ÙƒÙ„Ø©" class="w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus:outline-none focus:ring-2 focus:ring-primary">
            <p class="text-caption text-muted-foreground mt-1">Ù„Ù† ÙŠØ±Ø¯ Ø§Ù„Ø¨ÙˆØª Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</p>
          </div>

          <!-- Save Button -->
          <button onclick="saveSettings()" class="w-full inline-flex items-center justify-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
            <i data-lucide="save" class="h-4 w-4"></i>
            <span>Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
          </button>
        </div>
      </div>

      <!-- Store Context Card -->
      <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
        <div class="border-b border-border p-6">
          <div class="flex items-center gap-3">
            <i data-lucide="file-text" class="h-5 w-5 text-muted-foreground"></i>
            <h2 class="text-heading-md font-semibold">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± (Ø§Ù„Ø³ÙŠØ§Ù‚)</h2>
          </div>
        </div>
        <div class="p-6">
          <p class="text-body-sm text-muted-foreground mb-4">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¹Ø±ÙÙ‡Ø§ Ø§Ù„Ø¨ÙˆØª Ø¹Ù† Ù…ØªØ¬Ø±Ùƒ Ù„Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</p>
          <textarea 
            id="store-context" 
            rows="12"
            placeholder="Ù…Ø«Ø§Ù„:
Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù„Ù…ØªØ¬Ø± [Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±].
Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±:
- Ø§Ù„ØªÙˆØµÙŠÙ„: 2-3 Ø£ÙŠØ§Ù… Ù„Ù„Ø±ÙŠØ§Ø¶ØŒ 4-5 Ø£ÙŠØ§Ù… Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
- Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª ÙÙˆÙ‚ 200 Ø±ÙŠØ§Ù„
- Ø§Ù„Ø¯ÙØ¹: Ù†Ù‚Ø¯ÙŠØŒ Ø¨Ø·Ø§Ù‚Ø©ØŒ ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ
- Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„: 9 ØµØ¨Ø§Ø­Ø§Ù‹ - 11 Ù…Ø³Ø§Ø¡Ù‹
- Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: 966500000000

Ø±Ø¯ Ø¨Ø´ÙƒÙ„ Ù…Ø®ØªØµØ± ÙˆÙˆØ¯ÙˆØ¯ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©."
            class="w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus:outline-none focus:ring-2 focus:ring-primary resize-none"
          ></textarea>
        </div>
      </div>
    </div>

    <!-- Test Section -->
    <section class="mt-6">
      <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
        <div class="border-b border-border p-6">
          <div class="flex items-center gap-3">
            <i data-lucide="flask-conical" class="h-5 w-5 text-muted-foreground"></i>
            <h2 class="text-heading-md font-semibold">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª</h2>
          </div>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Test Input -->
            <div>
              <label class="block text-body-sm font-medium mb-2">Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
              <textarea 
                id="test-message" 
                rows="3"
                placeholder="Ù…Ø«Ø§Ù„: ÙƒÙ… Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù„Ø±ÙŠØ§Ø¶ØŸ"
                class="w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus:outline-none focus:ring-2 focus:ring-primary resize-none"
              ></textarea>
              <button onclick="testBot()" id="test-btn" class="mt-3 inline-flex items-center gap-2 rounded-md bg-secondary px-4 py-2 text-button-md font-semibold text-secondary-foreground shadow-sm transition hover:bg-secondary/80">
                <i data-lucide="send" class="h-4 w-4"></i>
                <span>Ø§Ø®ØªØ¨Ø§Ø±</span>
              </button>
            </div>
            <!-- Test Result -->
            <div>
              <label class="block text-body-sm font-medium mb-2">Ø±Ø¯ Ø§Ù„Ø¨ÙˆØª</label>
              <div id="test-result" class="min-h-[100px] rounded-md border border-input bg-muted/50 px-3 py-2 text-body-sm">
                <span class="text-muted-foreground">Ø³ÙŠØ¸Ù‡Ø± Ø±Ø¯ Ø§Ù„Ø¨ÙˆØª Ù‡Ù†Ø§...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Logs Section -->
    <section class="mt-6">
      <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
        <div class="border-b border-border p-6">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <i data-lucide="history" class="h-5 w-5 text-muted-foreground"></i>
              <h2 class="text-heading-md font-semibold">Ø³Ø¬Ù„ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h2>
            </div>
            <button onclick="loadLogs()" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
              <i data-lucide="refresh-cw" class="h-4 w-4"></i>
            </button>
          </div>
        </div>
        <div class="p-6">
          <div id="logs-container" class="space-y-3">
            <p class="text-body-sm text-muted-foreground text-center py-8">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
          </div>
        </div>
      </div>
    </section>

  </main>
  </div>

  <script>
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (!localStorage.getItem('tchat_logged_in')) {
      window.location.href = './login.html';
    }

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
    let isEnabled = false;
    let currentSettings = null;

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', async function() {
      renderHeader('header-container', { activePage: 'ai-chatbot' });
      lucide.createIcons();
      
      try {
        await loadSettings();
        await loadLogs();
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        // Ù„Ø§ Ù†Ø±Ø¬Ø¹ Ù„Ù„Ù€ login Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ - ÙÙ‚Ø· Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
        showToast('ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ù€ Migration ÙÙŠ Ø§Ù„Ù€ Backend', 'warning');
      }
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    async function loadSettings() {
      try {
        const settings = await loadAIChatbotSettings();
        if (settings) {
          currentSettings = settings;
          isEnabled = settings.is_enabled;
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
          document.getElementById('ai-provider').value = settings.ai_provider || 'anthropic';
          updateModel();
          document.getElementById('ai-model').value = settings.ai_model || 'claude-sonnet-4-20250514';
          document.getElementById('store-context').value = settings.store_context || '';
          document.getElementById('max-tokens').value = settings.max_tokens || 500;
          document.getElementById('temperature').value = settings.temperature || 0.7;
          document.getElementById('temp-value').textContent = settings.temperature || 0.7;
          document.getElementById('working-start').value = settings.working_hours_start || '09:00';
          document.getElementById('working-end').value = settings.working_hours_end || '23:00';
          document.getElementById('excluded-keywords').value = settings.excluded_keywords || '';
          
          // ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø¯
          if (settings.reply_to_all) {
            document.getElementById('reply-all').checked = true;
          } else {
            document.getElementById('reply-outside').checked = true;
          }
          
          updateStatusUI();
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
    function updateModel() {
      const provider = document.getElementById('ai-provider').value;
      const modelSelect = document.getElementById('ai-model');
      
      if (provider === 'anthropic') {
        modelSelect.innerHTML = `
          <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
          <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
          <option value="claude-3-haiku-20240307">Claude 3 Haiku (Ø£Ø³Ø±Ø¹)</option>
        `;
      } else {
        modelSelect.innerHTML = `
          <option value="gpt-4">GPT-4</option>
          <option value="gpt-4-turbo">GPT-4 Turbo</option>
          <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Ø£Ø±Ø®Øµ)</option>
        `;
      }
    }

    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø­Ø§Ù„Ø©
    function updateStatusUI() {
      const toggleBtn = document.getElementById('toggle-btn');
      const toggleDot = document.getElementById('toggle-dot');
      const statusText = document.getElementById('status-text');
      const statusCard = document.getElementById('status-card');
      const statusIcon = document.getElementById('status-icon');
      const statusTitle = document.getElementById('status-title');
      const statusDesc = document.getElementById('status-desc');
      
      if (isEnabled) {
        toggleBtn.classList.remove('bg-muted');
        toggleBtn.classList.add('bg-primary');
        toggleDot.classList.remove('translate-x-1');
        toggleDot.classList.add('translate-x-6');
        statusText.textContent = 'Ù…ÙØ¹Ù„';
        statusText.classList.add('text-primary');
        statusText.classList.remove('text-muted-foreground');
        
        statusCard.classList.add('border-primary/50', 'bg-primary/5');
        statusIcon.classList.remove('bg-muted');
        statusIcon.classList.add('bg-primary/10');
        statusIcon.querySelector('i').classList.remove('text-muted-foreground');
        statusIcon.querySelector('i').classList.add('text-primary');
        statusTitle.textContent = 'ğŸŸ¢ Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ù…ÙØ¹Ù„';
        statusDesc.textContent = 'Ø³ÙŠØ±Ø¯ Ø§Ù„Ø¨ÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡';
      } else {
        toggleBtn.classList.add('bg-muted');
        toggleBtn.classList.remove('bg-primary');
        toggleDot.classList.add('translate-x-1');
        toggleDot.classList.remove('translate-x-6');
        statusText.textContent = 'Ù…Ø¹Ø·Ù„';
        statusText.classList.remove('text-primary');
        statusText.classList.add('text-muted-foreground');
        
        statusCard.classList.remove('border-primary/50', 'bg-primary/5');
        statusIcon.classList.add('bg-muted');
        statusIcon.classList.remove('bg-primary/10');
        statusIcon.querySelector('i').classList.add('text-muted-foreground');
        statusIcon.querySelector('i').classList.remove('text-primary');
        statusTitle.textContent = 'ğŸ”´ Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ù…Ø¹Ø·Ù„';
        statusDesc.textContent = 'Ù‚Ù… Ø¨ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ù„Ù„Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡';
      }
    }

    // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª
    async function toggleChatbot() {
      try {
        const newState = !isEnabled;
        const result = await toggleAIChatbot(newState);
        
        if (result.success) {
          isEnabled = newState;
          updateStatusUI();
          showToast(result.message, 'success');
        } else {
          showToast(result.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©', 'error');
      }
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    async function saveSettings() {
      try {
        const settings = {
          is_enabled: isEnabled,
          ai_provider: document.getElementById('ai-provider').value,
          ai_model: document.getElementById('ai-model').value,
          store_context: document.getElementById('store-context').value,
          max_tokens: parseInt(document.getElementById('max-tokens').value) || 500,
          temperature: parseFloat(document.getElementById('temperature').value) || 0.7,
          reply_to_all: document.getElementById('reply-all').checked,
          working_hours_start: document.getElementById('working-start').value,
          working_hours_end: document.getElementById('working-end').value,
          excluded_keywords: document.getElementById('excluded-keywords').value
        };
        
        const result = await updateAIChatbotSettings(settings);
        
        if (result.success) {
          showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } else {
          showToast(result.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'error');
      }
    }

    // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙˆØª
    async function testBot() {
      const message = document.getElementById('test-message').value.trim();
      if (!message) {
        showToast('Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'warning');
        return;
      }
      
      const resultDiv = document.getElementById('test-result');
      const testBtn = document.getElementById('test-btn');
      
      resultDiv.innerHTML = '<span class="text-muted-foreground">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</span>';
      testBtn.disabled = true;
      
      try {
        const result = await testAIChatbot(message);
        
        if (result.success) {
          resultDiv.innerHTML = `<p class="text-foreground">${result.answer}</p>`;
        } else {
          resultDiv.innerHTML = `<span class="text-destructive">${result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£'}</span>`;
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
        resultDiv.innerHTML = '<span class="text-destructive">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ§Ø­ API.</span>';
      } finally {
        testBtn.disabled = false;
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    async function loadLogs() {
      const container = document.getElementById('logs-container');
      
      try {
        const logs = await loadAIChatbotLogs(20);
        
        if (!logs || logs.length === 0) {
          container.innerHTML = '<p class="text-body-sm text-muted-foreground text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯</p>';
          return;
        }
        
        container.innerHTML = logs.map(log => `
          <div class="border rounded-lg p-4 space-y-2">
            <div class="flex items-center justify-between">
              <span class="text-body-sm font-medium">${log.phone}</span>
              <span class="text-caption text-muted-foreground">${formatDate(log.created_at)}</span>
            </div>
            <div class="bg-muted/50 rounded p-2">
              <p class="text-body-sm"><strong>Ø§Ù„Ø³Ø¤Ø§Ù„:</strong> ${log.question}</p>
            </div>
            <div class="bg-primary/5 rounded p-2">
              <p class="text-body-sm"><strong>Ø§Ù„Ø±Ø¯:</strong> ${log.answer}</p>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', error);
        container.innerHTML = '<p class="text-body-sm text-destructive text-center py-8">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</p>';
      }
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('ar-SA', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
    function showToast(message, type = 'info') {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
      const toast = document.createElement('div');
      toast.className = `fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-96 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-y-full opacity-0`;
      
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
      const colors = {
        success: 'bg-green-500 text-white',
        error: 'bg-red-500 text-white',
        warning: 'bg-yellow-500 text-black',
        info: 'bg-blue-500 text-white'
      };
      
      toast.classList.add(...(colors[type] || colors.info).split(' '));
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
      setTimeout(() => {
        toast.classList.remove('translate-y-full', 'opacity-0');
      }, 100);
      
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
      setTimeout(() => {
        toast.classList.add('translate-y-full', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>

</body>
</html>
