<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TCHAT - القوالب</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="./api.js"></script>
  <script src="./components/header.js"></script>
</head>
<body class="rtl min-h-screen bg-background" style="font-family: 'LamaSans', sans-serif;">
  <!-- Header Container -->
  <div id="header-container"></div>

  <!-- Template Preview Modal -->
  <div id="template-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="closeTemplateModal()"></div>
    <div class="fixed inset-4 md:inset-auto md:left-1/2 md:top-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[420px] md:max-h-[85vh] bg-card rounded-2xl shadow-2xl overflow-hidden flex flex-col">
      <!-- Modal Header -->
      <div class="flex items-center justify-between px-4 py-3 border-b border-border bg-muted/30">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full bg-[#25D366] flex items-center justify-center">
            <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
          </div>
          <div>
            <div id="modal-template-name" class="text-sm font-semibold text-foreground"></div>
            <div id="modal-template-lang" class="text-[10px] text-muted-foreground"></div>
          </div>
        </div>
        <button onclick="closeTemplateModal()" class="w-8 h-8 rounded-full hover:bg-muted flex items-center justify-center transition-colors">
          <i data-lucide="x" class="w-4 h-4 text-muted-foreground"></i>
        </button>
      </div>
      
      <!-- WhatsApp Chat Background -->
      <div class="flex-1 overflow-y-auto p-4" style="background-color: #e5ddd5; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwgAADsIBFShKgAAAABl0RVh0U29mdHdhcmUAcGFpbnQubmV0IDQuMC4xMkMEa+wAAABZSURBVGhD7c4xDQAwDMCw8v/n8hSfEFBT+pNktu/P7D6j/RntN9pvtN9ov9F+o/1G+432G+032m+032i/0X6j/Ub7jfYb7Tfab7TfaL/RfqP9RvuN9pt2km8JwJ4zGtJUHAAAAABJRU5ErkJggg==');">
        <div id="modal-message-preview" class="max-w-[85%] mr-auto"></div>
      </div>
      
      <!-- Modal Footer -->
      <div class="px-4 py-3 border-t border-border bg-muted/30">
        <div class="flex items-center justify-between text-[10px] text-muted-foreground">
          <span id="modal-template-category"></span>
          <span id="modal-template-status"></span>
        </div>
      </div>
    </div>
  </div>

  <main class="container mx-auto px-4 py-8">
    <section class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-heading-lg font-bold text-foreground">القوالب المعتمدة</h1>
        <p class="text-body-sm text-muted-foreground">عرض أحدث قوالب واتساب المعتمدة في حساب Meta</p>
      </div>
      <div class="flex items-center gap-2 text-body-sm text-muted-foreground">
        <span>إجمالي القوالب:</span>
        <span id="templates-total" class="text-heading-md font-semibold number">0</span>
      </div>
    </section>

    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
      <div class="border-b border-border p-6">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="layout-dashboard" class="h-5 w-5 text-muted-foreground"></i>
            <h2 class="text-heading-md font-semibold">قوالب واتساب</h2>
          </div>
          <div class="flex flex-wrap items-center gap-3 text-body-sm text-muted-foreground">
            <div class="flex items-center gap-2 whitespace-nowrap">
              <span>تصفية حسب اللغة</span>
              <select id="language-filter" class="rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                <option value="all">جميع اللغات</option>
                <option value="ar">العربية</option>
                <option value="en">الإنجليزية</option>
              </select>
            </div>
            <div class="flex items-center gap-2 whitespace-nowrap">
              <span>فئة القالب</span>
              <select id="category-filter" class="rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                <option value="all">جميع الفئات</option>
                <option value="MARKETING">تسويق</option>
                <option value="UTILITY">تنبيهات</option>
                <option value="AUTHENTICATION">تحقق</option>
              </select>
            </div>
            <div class="flex items-center gap-2 whitespace-nowrap">
              <span>عدد السجلات</span>
              <select id="limit-select" class="rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>
        </div>
        <div class="mt-4 flex items-center gap-3 text-body-sm text-muted-foreground">
          <input type="search" id="search-input" placeholder="ابحث باسم القالب..." class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2" />
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full caption-bottom text-sm">
          <thead class="bg-muted/50">
            <tr class="border-b text-right text-[11px] font-semibold text-muted-foreground">
              <th class="px-3 py-2 w-[50%]">القالب</th>
              <th class="px-3 py-2 w-[16%] text-center">اللغة</th>
              <th class="px-3 py-2 w-[17%] text-center">الفئة</th>
              <th class="px-3 py-2 w-[17%] text-center">الحالة</th>
            </tr>
          </thead>
          <tbody id="templates-table-body" class="divide-y divide-border">
            <tr>
              <td colspan="4" class="h-20 text-center text-[12px] text-muted-foreground">جاري تحميل القوالب...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="flex items-center justify-between gap-4 border-t border-border px-4 py-3">
        <div class="text-[11px] text-muted-foreground whitespace-nowrap">صفحة <span id="current-page">1</span> من <span id="total-pages">1</span></div>
        <div class="flex items-center gap-1.5">
          <button id="prev-page" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-2.5 py-1.5 text-[11px] font-medium text-muted-foreground transition-colors disabled:opacity-40 hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2" disabled>
            <i data-lucide="chevron-right" class="h-3.5 w-3.5"></i>
            <span>السابق</span>
          </button>
          <button id="next-page" class="inline-flex items-center justify-center rounded-md border border-input bg-background px-2.5 py-1.5 text-[11px] font-medium text-muted-foreground transition-colors disabled:opacity-40 hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
            <span>التالي</span>
            <i data-lucide="chevron-left" class="h-3.5 w-3.5"></i>
          </button>
        </div>
      </div>
    </div>
  </main>

  <script>
    if (!localStorage.getItem('tchat_logged_in')) {
      window.location.href = './login.html';
    }

    const badgeClass = 'inline-flex items-center justify-center h-5 min-w-[60px] rounded-full border border-input px-2 text-[10px] font-medium';

    let allTemplates = [];
    let filteredTemplates = [];
    let currentPage = 1;
    let pageSize = 50;


    function renderTemplatesPage() {
      const tbody = document.getElementById('templates-table-body');
      if (!filteredTemplates.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="h-20 text-center text-[12px] text-muted-foreground">لا توجد قوالب مطابقة للمعايير الحالية</td></tr>';
        updatePagination();
        return;
      }

      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, filteredTemplates.length);
      const pageItems = filteredTemplates.slice(startIndex, endIndex);

      tbody.innerHTML = pageItems.map(template => {
        const components = Array.isArray(template.components) ? template.components : [];

        const statusClass = `${badgeClass} ${template.status === 'APPROVED' ? 'bg-success/10 text-success' : template.status === 'REJECTED' ? 'bg-destructive/10 text-destructive' : 'bg-warning/10 text-warning'}`;
        const statusText = template.status === 'APPROVED' ? 'معتمد' : template.status === 'REJECTED' ? 'مرفوض' : 'قيد المراجعة';

        const categoryClass = `${badgeClass} ${template.category === 'MARKETING' ? 'bg-primary/10 text-primary' : template.category === 'UTILITY' ? 'bg-muted text-muted-foreground' : template.category === 'AUTHENTICATION' ? 'bg-accent text-accent-foreground' : 'bg-muted text-muted-foreground'}`;
        const categoryText = template.category === 'MARKETING' ? 'تسويق' : template.category === 'UTILITY' ? 'خدمات' : template.category === 'AUTHENTICATION' ? 'تحقق' : template.category || 'غير محدد';
        const languageText = template.language === 'ar' ? 'العربية' : template.language === 'en' ? 'الإنجليزية' : template.language;

        const componentTags = components.length
          ? `<div class="flex flex-wrap items-center gap-0.5">${components.map(component => `<span class="inline-flex items-center rounded px-1 py-px text-[9px] font-medium bg-muted/40 text-muted-foreground/80">${component.type}</span>`).join('')}</div>`
          : '';

        return `
          <tr class="align-middle hover:bg-muted/40 transition-colors cursor-pointer" onclick="openTemplateModal('${template.id}')">
            <td class="px-3 py-2.5">
              <div class="space-y-1">
                <div class="text-[13px] font-semibold text-foreground leading-tight">${template.name}</div>
                <div class="flex flex-wrap items-center gap-x-2 gap-y-1">
                  <span class="text-[10px] text-muted-foreground/60 number font-mono">${template.id}</span>
                  ${componentTags}
                </div>
              </div>
            </td>
            <td class="px-3 py-2.5 text-center align-middle">
              <span class="text-[11px] text-muted-foreground">${languageText}</span>
            </td>
            <td class="px-3 py-2.5 text-center align-middle">
              <span class="${categoryClass}">${categoryText}</span>
            </td>
            <td class="px-3 py-2.5 text-center align-middle">
              <span class="${statusClass}">${statusText}</span>
            </td>
          </tr>
        `;
      }).join('');

      updatePagination();
      lucide.createIcons();
    }

    function updatePagination() {
      const total = filteredTemplates.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      currentPage = Math.min(currentPage, totalPages);

      document.getElementById('current-page').textContent = totalPages ? currentPage : 0;
      document.getElementById('total-pages').textContent = totalPages;
      document.getElementById('templates-total').textContent = total;

      document.getElementById('prev-page').disabled = currentPage <= 1;
      document.getElementById('next-page').disabled = currentPage >= totalPages;
    }

    function applyFilters() {
      const lang = document.getElementById('language-filter').value;
      const category = document.getElementById('category-filter').value;
      const search = document.getElementById('search-input').value.trim().toLowerCase();

      filteredTemplates = allTemplates.filter(template => {
        const matchesLang = lang === 'all' || template.language === lang;
        const matchesCategory = category === 'all' || template.category === category;
        const matchesSearch = !search || template.name.toLowerCase().includes(search);
        return matchesLang && matchesCategory && matchesSearch;
      });

      currentPage = 1;
      renderTemplatesPage();
    }

    async function loadTemplates(limit = 50) {
      const tbody = document.getElementById('templates-table-body');
      tbody.innerHTML = '<tr><td colspan="4" class="h-20 text-center text-[12px] text-muted-foreground">جاري تحميل القوالب...</td></tr>';

      try {
        const templates = await loadMetaTemplates(limit);
        allTemplates = templates || [];
        filteredTemplates = [...allTemplates];
        renderTemplatesPage();
      } catch (error) {
        console.error('خطأ في تحميل القوالب:', error);
        tbody.innerHTML = '<tr><td colspan="4" class="h-20 text-center text-[12px] text-destructive">تعذر تحميل القوالب من Meta</td></tr>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // تهيئة مكون الهيدر
      renderHeader('header-container', { activePage: 'templates' });
      
      lucide.createIcons();

      document.getElementById('language-filter').addEventListener('change', applyFilters);
      document.getElementById('category-filter').addEventListener('change', applyFilters);
      document.getElementById('search-input').addEventListener('input', applyFilters);
      document.getElementById('limit-select').addEventListener('change', (e) => {
        pageSize = Number(e.target.value);
        currentPage = 1;
        renderTemplatesPage();
      });

      document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderTemplatesPage();
        }
      });

      document.getElementById('next-page').addEventListener('click', () => {
        const totalPages = Math.ceil(filteredTemplates.length / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          renderTemplatesPage();
        }
      });

      loadTemplates();
    });

    async function loadMetaTemplates(limit = 50) {
      try {
        const data = await apiRequest(`/meta/templates?limit=${limit}`);
        console.log('استجابة القوالب:', data);
        
        if (data.success && Array.isArray(data.data)) {
          return data.data;
        }
        
        // عرض رسالة الخطأ للمستخدم
        const errorMsg = data.message || data.error || 'خطأ غير معروف';
        console.error('فشل في جلب قوالب Meta:', errorMsg);
        
        const tbody = document.getElementById('templates-table-body');
        tbody.innerHTML = `<tr><td colspan="4" class="h-20 text-center text-[12px] text-destructive">
          <div class="space-y-1">
            <div>فشل في جلب القوالب من Meta</div>
            <div class="text-[11px] text-muted-foreground">${errorMsg}</div>
          </div>
        </td></tr>`;
        
        return [];
      } catch (error) {
        console.error('خطأ في تحميل قوالب Meta:', error);
        return [];
      }
    }

    // دوال Modal لعرض القالب
    function openTemplateModal(templateId) {
      const template = allTemplates.find(t => t.id === templateId);
      if (!template) return;

      const modal = document.getElementById('template-modal');
      const langText = template.language === 'ar' ? 'العربية' : template.language === 'en' ? 'الإنجليزية' : template.language;
      const categoryText = template.category === 'MARKETING' ? 'تسويق' : template.category === 'UTILITY' ? 'خدمات' : template.category === 'AUTHENTICATION' ? 'تحقق' : template.category;
      const statusText = template.status === 'APPROVED' ? 'معتمد ✓' : template.status === 'REJECTED' ? 'مرفوض ✗' : 'قيد المراجعة';

      document.getElementById('modal-template-name').textContent = template.name;
      document.getElementById('modal-template-lang').textContent = langText;
      document.getElementById('modal-template-category').textContent = categoryText;
      document.getElementById('modal-template-status').textContent = statusText;

      // بناء معاينة الرسالة بتصميم واتساب
      const preview = document.getElementById('modal-message-preview');
      preview.innerHTML = renderWhatsAppMessage(template);

      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      lucide.createIcons();
    }

    function closeTemplateModal() {
      const modal = document.getElementById('template-modal');
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // إغلاق المودال بزر Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeTemplateModal();
    });

    function renderWhatsAppMessage(template) {
      const components = Array.isArray(template.components) ? template.components : [];
      
      const header = components.find(c => c.type === 'HEADER');
      const body = components.find(c => c.type === 'BODY');
      const footer = components.find(c => c.type === 'FOOTER');
      const buttons = components.find(c => c.type === 'BUTTONS');

      let html = `<div class="rounded-lg overflow-hidden shadow-sm" style="background-color: #dcf8c6;">`;
      
      // Header
      if (header) {
        if (header.format === 'IMAGE') {
          const imgUrl = header.example?.header_handle?.[0] || '';
          html += `<div class="w-full aspect-video bg-muted/20 flex items-center justify-center overflow-hidden">
            ${imgUrl ? `<img src="${imgUrl}" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<div class=\\'flex flex-col items-center justify-center h-full text-muted-foreground/50\\' dir=\\'ltr\\'><svg class=\\'w-10 h-10\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><rect x=\\'3\\' y=\\'3\\' width=\\'18\\' height=\\'18\\' rx=\\'2\\'/><circle cx=\\'8.5\\' cy=\\'8.5\\' r=\\'1.5\\'/><path d=\\'m21 15-5-5L5 21\\'/></svg><span class=\\'text-xs mt-1\\'>صورة</span></div>'" />` : `<div class="flex flex-col items-center justify-center h-full text-muted-foreground/50"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg><span class="text-xs mt-1">صورة</span></div>`}
          </div>`;
        } else if (header.format === 'VIDEO') {
          html += `<div class="w-full aspect-video bg-black/10 flex items-center justify-center">
            <div class="flex flex-col items-center text-muted-foreground/50">
              <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              <span class="text-xs mt-1">فيديو</span>
            </div>
          </div>`;
        } else if (header.format === 'DOCUMENT') {
          html += `<div class="px-3 py-2 bg-black/5 flex items-center gap-2 border-b border-black/5">
            <svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8" fill="none" stroke="white" stroke-width="1.5"/></svg>
            <span class="text-xs text-foreground/70">مستند</span>
          </div>`;
        } else if (header.text) {
          html += `<div class="px-3 pt-2 text-sm font-bold text-foreground/90">${formatWhatsAppText(header.text)}</div>`;
        }
      }

      // Body
      if (body?.text) {
        html += `<div class="px-3 py-2 text-[13px] text-foreground/90 leading-relaxed whitespace-pre-wrap">${formatWhatsAppText(body.text)}</div>`;
      }

      // Footer
      if (footer?.text) {
        html += `<div class="px-3 pb-2 text-[11px] text-foreground/50">${footer.text}</div>`;
      }

      // Timestamp
      html += `<div class="px-3 pb-1.5 flex justify-end">
        <span class="text-[10px] text-foreground/40">${new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit', hour12: true })}</span>
      </div>`;

      html += `</div>`;

      // Buttons
      if (buttons?.buttons?.length) {
        html += `<div class="mt-1 space-y-1">`;
        buttons.buttons.forEach(btn => {
          const icon = btn.type === 'URL' ? `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14 21 3"/></svg>` :
                   btn.type === 'PHONE_NUMBER' ? `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.362 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.338 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>` :
                   btn.type === 'QUICK_REPLY' ? `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>` : '';
          html += `<div class="rounded-lg bg-white shadow-sm px-3 py-2 flex items-center justify-center gap-2 text-[#00a884] text-[13px] font-medium">
            ${icon}
            <span>${btn.text}</span>
          </div>`;
        });
        html += `</div>`;
      }

      return html;
    }

    function formatWhatsAppText(text) {
      if (!text) return '';
      // تحويل تنسيق واتساب
      return text
        .replace(/\*(.*?)\*/g, '<strong>$1</strong>') // Bold
        .replace(/_(.*?)_/g, '<em>$1</em>') // Italic
        .replace(/~(.*?)~/g, '<del>$1</del>') // Strikethrough
        .replace(/```(.*?)```/g, '<code class="bg-black/10 px-1 rounded">$1</code>') // Code
        .replace(/\{\{(\d+)\}\}/g, '<span class="bg-[#00a884]/20 text-[#00a884] px-1 rounded text-[11px]">{{$1}}</span>'); // Variables
    }

    // دالة logout موجودة في api.js
  </script>
</body>
</html>
