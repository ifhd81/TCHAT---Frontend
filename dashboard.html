<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TCHAT - لوحة التحكم</title>
    <link rel="stylesheet" href="./style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="./api.js"></script>
    <script src="./components/header.js"></script>
  </head>
  <body class="rtl min-h-screen bg-background" style="font-family: 'LamaSans', sans-serif;">
    
    <div class="min-h-screen">
      
      <!-- Header Container -->
      <div id="header-container"></div>

      <!-- Main Content -->
      <main class="container mx-auto px-4 py-6">
        
        <!-- Stats Cards -->
        <div class="grid gap-4 md:grid-cols-4 mb-6">
          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
              <h3 class="tracking-tight text-body-md font-medium">إجمالي العملاء</h3>
              <i data-lucide="users" class="h-4 w-4 text-muted-foreground"></i>
            </div>
            <div class="p-6 pt-0">
              <div class="text-heading-xl font-bold number" id="total-customers-header">0</div>
              <p class="text-body-sm text-muted-foreground">عميل نشط</p>
            </div>
          </div>

          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
              <h3 class="tracking-tight text-body-md font-medium">إجمالي الإيرادات</h3>
              <i data-lucide="saudi-riyal" class="h-4 w-4 text-muted-foreground"></i>
            </div>
            <div class="p-6 pt-0">
              <div class="text-heading-xl font-bold number" id="total-revenue">0</div>
              <p class="text-body-sm text-muted-foreground" id="revenue-subtitle">من السلات المتروكة المحولة</p>
            </div>
          </div>

          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
              <h3 class="tracking-tight text-body-md font-medium">السلات المتروكة</h3>
              <i data-lucide="shopping-cart" class="h-4 w-4 text-muted-foreground"></i>
            </div>
            <div class="p-6 pt-0">
              <div class="text-heading-xl font-bold number" id="total-carts-header">0</div>
              <p class="text-body-sm text-muted-foreground">مجموع السلات المتروكة</p>
            </div>
          </div>

          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
              <h3 class="tracking-tight text-body-md font-medium">الرسائل المرسلة</h3>
              <i data-lucide="send" class="h-4 w-4 text-muted-foreground"></i>
            </div>
            <div class="p-6 pt-0">
              <div class="text-heading-xl font-bold number" id="total-messages-header">0</div>
              <p class="text-body-sm text-muted-foreground">رسالة واتساب</p>
            </div>
          </div>
        </div>

        <!-- Tables Grid -->
        <div class="grid gap-4 md:grid-cols-2">
          
          <!-- Revenue Table -->
          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="flex flex-col space-y-1.5 p-6 border-b">
              <h3 class="text-heading-md font-semibold leading-none tracking-tight">الحملات والإيرادات</h3>
              <p class="text-body-sm text-muted-foreground">نتائج الحملات التسويقية</p>
            </div>
            <div class="p-6">
              <div class="relative w-full overflow-auto">
                <table class="w-full caption-bottom text-sm">
                  <thead class="[&_tr]:border-b">
                    <tr class="border-b transition-colors hover:bg-muted/50">
                      <th class="h-12 px-4 text-right align-middle font-medium text-muted-foreground text-body-sm">الحملة</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">الحالة</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">الإيرادات</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">الطلبات</th>
                    </tr>
                  </thead>
                  <tbody id="revenue-table-tbody" class="[&_tr:last-child]:border-0">
                    <!-- Data loaded from backend -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Abandoned Carts Table -->
          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="flex flex-col space-y-1.5 p-6 border-b">
              <h3 class="text-heading-md font-semibold leading-none tracking-tight">السلات المتروكة</h3>
              <p class="text-body-sm text-muted-foreground">العملاء وحالة الإرسال</p>
            </div>
            <div class="p-6">
              <div class="relative w-full overflow-auto">
                <table class="w-full caption-bottom text-sm">
                  <thead class="[&_tr]:border-b">
                    <tr class="border-b transition-colors hover:bg-muted/50">
                      <th class="h-12 px-4 text-right align-middle font-medium text-muted-foreground text-body-sm">العميل</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">الجوال</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">المبلغ</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">الحالة</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">التوقيت</th>
                    </tr>
                  </thead>
                  <tbody id="abandoned-carts-tbody" class="[&_tr:last-child]:border-0">
                    <!-- Data loaded from backend -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Pagination -->
            <div class="flex items-center justify-between px-6 py-4 border-t">
              <div class="text-body-sm text-muted-foreground">
                <span id="current-range">1-10</span> من <span id="total-items">0</span>
              </div>
              <div class="flex items-center space-x-2 space-x-reverse">
                <button 
                  id="prev-btn" 
                  onclick="previousPage()" 
                  class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8 w-8"
                  disabled
                >
                  <i data-lucide="chevron-right" class="h-4 w-4"></i>
                </button>
                <div class="text-body-sm">
                  <span id="current-page">1</span> / <span id="total-pages">1</span>
                </div>
                <button 
                  id="next-btn" 
                  onclick="nextPage()" 
                  class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8 w-8"
                >
                  <i data-lucide="chevron-left" class="h-4 w-4"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- WhatsApp Numbers Table -->
          <div class="rounded-lg border bg-card text-card-foreground shadow-sm md:col-span-2">
            <div class="flex flex-col space-y-1.5 p-6 border-b">
              <h3 class="text-heading-md font-semibold leading-none tracking-tight">أرقام واتساب المرتبطة بميتا</h3>
              <p class="text-body-sm text-muted-foreground">تفاصيل الأرقام والجودة وحالة التحقق</p>
            </div>
            <div class="p-6">
              <div class="relative w-full overflow-auto">
                <table class="w-full caption-bottom text-sm">
                  <thead class="[&_tr]:border-b">
                    <tr class="border-b transition-colors hover:bg-muted/50">
                      <th class="h-12 px-4 text-right align-middle font-medium text-muted-foreground text-body-sm">المعرف</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">رقم الواتساب</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">الاسم الموثق</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">حالة التحقق</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">تقييم الجودة</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">مستوى الإرسال</th>
                    </tr>
                  </thead>
                  <tbody id="meta-phone-numbers-tbody" class="[&_tr:last-child]:border-0">
                    <!-- Data loaded from backend -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
        </div>
    </main>
    </div>

    <script>
      const TABLE_STATES = {
        loading: (colspan, message = 'جاري التحميل...') => `
          <tr>
            <td colspan="${colspan}" class="h-24 text-center text-body-md text-muted-foreground">
              <div class="inline-flex items-center space-x-2 space-x-reverse">
                <svg class="h-4 w-4 animate-spin text-muted-foreground" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
                <span>${message}</span>
              </div>
            </td>
          </tr>
        `,
        empty: (colspan, message = 'لا توجد بيانات متاحة') => `
          <tr>
            <td colspan="${colspan}" class="h-24 text-center text-body-md text-muted-foreground">${message}</td>
          </tr>
        `,
        error: (colspan, message = 'تعذّر تحميل البيانات') => `
          <tr>
            <td colspan="${colspan}" class="h-24 text-center text-body-md text-destructive">
              <div class="inline-flex items-center space-x-2 space-x-reverse">
                <i data-lucide="alert-triangle" class="h-4 w-4"></i>
                <span>${message}</span>
              </div>
            </td>
          </tr>
        `,
      };

      function setTableState(tbodyId, state, colspan, message) {
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        tbody.innerHTML = TABLE_STATES[state](colspan, message);
      }

      function formatThroughputLevel(level) {
        if (!level) {
          return {
            label: 'غير محدد',
            badge: '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-muted text-muted-foreground">غير محدد</span>'
          };
        }

        const normalized = String(level).toUpperCase();
        const throughputMap = {
          'LOW': { label: 'منخفض', badge: 'bg-warning/10 text-warning' },
          'MEDIUM': { label: 'متوسط', badge: 'bg-primary/10 text-primary' },
          'HIGH': { label: 'عالٍ', badge: 'bg-success/10 text-success' },
          'VERY_HIGH': { label: 'عالٍ جداً', badge: 'bg-success/10 text-success' },
          'STANDARD': { label: 'قياسي', badge: 'bg-accent text-accent-foreground' },
          'LIMITED': { label: 'محدود', badge: 'bg-destructive/10 text-destructive' },
          'TIER_1': { label: 'المستوى 1', badge: 'bg-success/10 text-success' },
          'TIER_2': { label: 'المستوى 2', badge: 'bg-primary/10 text-primary' },
          'TIER_3': { label: 'المستوى 3', badge: 'bg-warning/10 text-warning' },
          'TIER_4': { label: 'المستوى 4', badge: 'bg-destructive/10 text-destructive' },
        };

        const config = throughputMap[normalized] || { label: level, badge: 'bg-accent text-accent-foreground' };
        return {
          label: config.label,
          badge: `<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold ${config.badge}">${config.label}</span>`
        };
      }

      // تحقق من تسجيل الدخول
      if (!localStorage.getItem('tchat_logged_in')) {
        window.location.href = './login.html';
      }

      // متغيرات pagination
      let currentPage = 1;
      let itemsPerPage = 3;
      let totalItems = 0;
      let allAbandonedCarts = [];

      // تحميل البيانات من Backend
      async function loadDashboardData() {
        try {
          setTableState('revenue-table-tbody', 'loading', 4);
          setTableState('abandoned-carts-tbody', 'loading', 5);
          setTableState('meta-phone-numbers-tbody', 'loading', 6);
          
          // تحميل بيانات الإيرادات
          const revenueData = await loadRevenueData();
          console.log('Revenue Data:', revenueData);
          renderRevenueTable(revenueData);
          
          // تحديث الإحصائيات في header
          const systemStats = await loadSystemStats();
          if (systemStats) {
            document.getElementById('total-customers-header').textContent = systemStats.total_customers || 0;
            document.getElementById('total-carts-header').textContent = systemStats.total_abandoned_carts || 0;
            document.getElementById('total-messages-header').textContent = systemStats.total_whatsapp_sent || 0;
            
            // عرض الإيرادات من السلات المتروكة المحولة
            const totalRevenue = systemStats.total_revenue || 0;
            const purchasedCarts = systemStats.purchased_carts || 0;
            document.getElementById('total-revenue').textContent = totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            // تحديث النص التوضيحي
            const revenueSubtitle = document.getElementById('revenue-subtitle');
            if (revenueSubtitle) {
              revenueSubtitle.textContent = `من ${purchasedCarts} سلة متروكة محولة`;
            }
          }
          
          // تحميل أرقام واتساب من ميتا
          try {
            const metaPhoneNumbers = await loadMetaPhoneNumbers();
            renderMetaPhoneNumbersTable(metaPhoneNumbers);
          } catch (error) {
            console.error('تعذّر تحميل أرقام واتساب:', error);
            setTableState('meta-phone-numbers-tbody', 'error', 6, 'تعذّر تحميل أرقام واتساب');
          }

          // تحميل بيانات السلات المتروكة
          const abandonedCarts = await loadAbandonedCarts(50); // جلب 50 عنصر
          console.log('Abandoned Carts:', abandonedCarts);
          allAbandonedCarts = abandonedCarts;
          totalItems = abandonedCarts.length;
          updatePagination();
          renderAbandonedCartsPage();

          // فحص المحادثات غير المقروءة
          checkUnreadConversations();
          
        } catch (error) {
          console.error('خطأ في تحميل بيانات لوحة التحكم:', error);
          setTableState('revenue-table-tbody', 'error', 4, 'تعذّر تحميل بيانات الإيرادات');
          setTableState('abandoned-carts-tbody', 'error', 5, 'تعذّر تحميل بيانات السلات المتروكة');
          setTableState('meta-phone-numbers-tbody', 'error', 6, 'تعذّر تحميل أرقام واتساب');
        }
      }

      // عرض جدول الإيرادات
      function renderRevenueTable(data) {
        const tbody = document.getElementById('revenue-table-tbody');
        if (!tbody) return;
        if (!data || data.length === 0) {
          tbody.innerHTML = TABLE_STATES.empty(4, 'لا توجد بيانات إيرادات متاحة');
          return;
        }
        
        const revenue = (item) => Number(item.total_revenue) || 0;
        const orders = (item) => Number(item.attributed_orders) || 0;
        tbody.innerHTML = data.map(item => {
          const isActive = item.status === 'فعالة';
          const statusBadge = isActive 
            ? '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-success/10 text-success">فعالة</span>'
            : '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-warning/10 text-warning">متوقفة</span>';
          
          return `
            <tr class="border-b transition-colors hover:bg-muted/50">
              <td class="p-4 align-middle text-right">
                <div class="font-medium text-body-md">${item.campaign_name || ''}</div>
              </td>
              <td class="p-4 align-middle text-center">
                ${statusBadge}
              </td>
              <td class="p-4 align-middle text-center">
                <div class="font-mono font-medium number">${revenue(item).toLocaleString('en-US', {minimumFractionDigits: 0})}</div>
              </td>
              <td class="p-4 align-middle text-center">
                <div class="font-medium text-primary number">${orders(item)}</div>
              </td>
            </tr>
          `;
        }).join('');
      }

      // عرض جدول أرقام WhatsApp من Meta
      function renderMetaPhoneNumbersTable(phoneNumbers) {
        const tbody = document.getElementById('meta-phone-numbers-tbody');
        if (!tbody) return;
        if (!phoneNumbers || phoneNumbers.length === 0) {
          tbody.innerHTML = TABLE_STATES.empty(6, 'لا توجد أرقام واتساب مرتبطة');
          return;
        }
        
        tbody.innerHTML = phoneNumbers.map(phone => {
          const throughputConfig = formatThroughputLevel(phone.throughput_level);
          
          // تقييم الجودة
          let qualityBadge = '';
          switch (phone.quality_rating) {
            case 'GREEN':
              qualityBadge = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-success/10 text-success">مرتفع</span>';
              break;
            case 'YELLOW':
              qualityBadge = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-warning/10 text-warning">متوسط</span>';
              break;
            case 'RED':
              qualityBadge = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-destructive/10 text-destructive">منخفض</span>';
              break;
            case 'UNKNOWN':
              qualityBadge = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-blue-100 text-blue-700">غير محدد</span>';
              break;
            default:
              qualityBadge = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-muted text-muted-foreground">غير متاح</span>';
          }
          
          const cleanPhoneNumber = phone.display_phone_number ? phone.display_phone_number.replace(/[\s\+\-]/g, '') : 'غير محدد';
          
          // حالة التحقق
          let verificationStatus = '';
          switch (phone.code_verification_status) {
            case 'VERIFIED':
              verificationStatus = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-success/10 text-success"><i data-lucide="shield-check" class="h-3 w-3 ml-1"></i>متحقق</span>';
              break;
            case 'EXPIRED':
              verificationStatus = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-warning/10 text-warning"><i data-lucide="clock" class="h-3 w-3 ml-1"></i>منتهي</span>';
              break;
            case 'NOT_VERIFIED':
              verificationStatus = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-muted text-muted-foreground"><i data-lucide="shield-alert" class="h-3 w-3 ml-1"></i>غير متحقق</span>';
              break;
            default:
              verificationStatus = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-muted text-muted-foreground"><i data-lucide="shield-question" class="h-3 w-3 ml-1"></i>غير معروف</span>';
          }
          return `
            <tr class="border-b transition-colors hover:bg-muted/50">
              <td class="p-4 align-middle text-right">
                <span class="font-mono text-body-sm text-muted-foreground number">${phone.id}</span>
              </td>
              <td class="p-4 align-middle text-center">
                <div class="font-mono font-medium number">${cleanPhoneNumber}</div>
              </td>
              <td class="p-4 align-middle text-center">
                <div class="text-body-md font-medium">${phone.verified_name || 'غير محدد'}</div>
              </td>
              <td class="p-4 align-middle text-center">
                ${verificationStatus}
              </td>
              <td class="p-4 align-middle text-center">
                ${qualityBadge}
              </td>
              <td class="p-4 align-middle text-center">
                ${throughputConfig.badge}
              </td>
            </tr>
          `;
        }).join('');
        
        lucide.createIcons();
      }

      // عرض جدول السلات المتروكة
      function renderAbandonedCartsTable(carts) {
        const tbody = document.getElementById('abandoned-carts-tbody');
        if (!tbody) return;
        if (!carts || carts.length === 0) {
          tbody.innerHTML = TABLE_STATES.empty(5, 'لا توجد سلات متروكة حالياً');
          updatePaginationInfo();
          return;
        }
        
        tbody.innerHTML = carts.map(cart => {
          // تنسيق التاريخ
          const createdDate = new Date(cart.created_at);
          const timeAgo = getTimeAgo(createdDate);
          
          // تحديد حالة الإرسال بشكل مفصل
          const messageStatus = cart.message_status || 'pending';
          const statusConfig = {
            'sent': {
              label: 'تم الإرسال',
              icon: 'send',
              class: 'bg-blue-100 text-blue-800 border-blue-200'
            },
            'delivered': {
              label: 'وصلت',
              icon: 'check',
              class: 'bg-green-100 text-green-800 border-green-200'
            },
            'read': {
              label: 'قرأها',
              icon: 'eye',
              class: 'bg-green-200 text-green-900 border-green-300'
            },
            'replied': {
              label: 'رد عليها',
              icon: 'message-circle',
              class: 'bg-purple-100 text-purple-800 border-purple-200'
            },
            'failed': {
              label: 'فشلت',
              icon: 'x-circle',
              class: 'bg-red-100 text-red-800 border-red-200'
            },
            'ecosystem_limited': {
              label: 'محدودة',
              icon: 'alert-triangle',
              class: 'bg-orange-100 text-orange-800 border-orange-200'
            },
            'user_opted_out': {
              label: 'أوقف الاستقبال',
              icon: 'user-x',
              class: 'bg-gray-100 text-gray-600 border-gray-200'
            },
            'pending': {
              label: 'قيد الإرسال',
              icon: 'clock',
              class: 'bg-yellow-100 text-yellow-800 border-yellow-200'
            }
          };
          
          const config = statusConfig[messageStatus] || statusConfig['pending'];
          const statusBadge = `<span class="inline-flex items-center gap-1 rounded-full border px-2.5 py-0.5 text-xs font-semibold ${config.class}"><i data-lucide="${config.icon}" class="w-3 h-3"></i>${config.label}</span>`;
          
          // تنظيف رقم الجوال
          const cleanMobile = cart.customer_mobile ? cart.customer_mobile.replace(/[\s\+\-]/g, '') : 'غير محدد';
          
          return `
            <tr class="border-b transition-colors hover:bg-muted/50">
              <td class="p-4 align-middle text-right">
                <div class="flex items-center space-x-3 space-x-reverse">
                  <div class="relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full bg-muted">
                    <span class="flex h-full w-full items-center justify-center bg-primary text-primary-foreground">
                      ${userIconSvg('h-5 w-5')}
                    </span>
                  </div>
                  <div class="font-medium text-body-md">${cart.customer_name || 'غير محدد'}</div>
                </div>
              </td>
              <td class="p-4 align-middle text-center">
                <div class="font-mono text-body-sm text-muted-foreground number">${cleanMobile}</div>
              </td>
              <td class="p-4 align-middle text-center">
                <div class="font-mono font-medium number">${cart.total_amount ? cart.total_amount.toLocaleString('en-US', {minimumFractionDigits: 0}) : '0'}</div>
              </td>
              <td class="p-4 align-middle text-center">
                ${statusBadge}
              </td>
              <td class="p-4 align-middle text-center">
                <div class="text-body-sm text-muted-foreground">${timeAgo}</div>
              </td>
            </tr>
          `;
        }).join('');
        
        // إعادة تهيئة الأيقونات
        lucide.createIcons();
      }

      // حساب الوقت المنقضي
      function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMins < 1) return 'الآن';
        if (diffMins < 60) return `منذ ${diffMins} دقيقة`;
        if (diffHours < 24) return `منذ ${diffHours} ساعة`;
        return `منذ ${diffDays} يوم`;
      }

      // عرض صفحة من السلات المتروكة
      function renderAbandonedCartsPage() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = allAbandonedCarts.slice(startIndex, endIndex);
        
        renderAbandonedCartsTable(pageData);
        updatePaginationInfo();
      }

      // تحديث معلومات pagination
      function updatePaginationInfo() {
        const startIndex = (currentPage - 1) * itemsPerPage + 1;
        const endIndex = Math.min(currentPage * itemsPerPage, totalItems);
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        
        document.getElementById('current-range').textContent = `${startIndex}-${endIndex}`;
        document.getElementById('total-items').textContent = totalItems;
        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;
        
        // تحديث حالة الأزرار
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;
      }

      // تحديث pagination
      function updatePagination() {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        updatePaginationInfo();
      }

      // الصفحة السابقة
      function previousPage() {
        if (currentPage > 1) {
          currentPage--;
          renderAbandonedCartsPage();
        }
      }

      // الصفحة التالية  
      function nextPage() {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderAbandonedCartsPage();
        }
      }

      // تهيئة أيقونات Lucide والهيدر
      document.addEventListener('DOMContentLoaded', function() {
        // تهيئة مكون الهيدر
        renderHeader('header-container', { activePage: 'dashboard' });
        
        lucide.createIcons();
        loadDashboardData();
        
        // فحص المحادثات غير المقروءة كل دقيقة
        setInterval(checkUnreadConversations, 60000);
      });

      // تسجيل الخروج
      // دالة logout موجودة في api.js
    </script>
  </body>
</html>
