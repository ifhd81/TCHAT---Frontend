<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TCHAT - لوحة التحكم</title>
    <link rel="stylesheet" href="./style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="./api.js"></script>
  </head>
  <body class="rtl min-h-screen" style="background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 50%, #ffffff 100%); font-family: 'LamaSans', sans-serif;">
    
    <div class="min-h-screen">
      
      <!-- Header with Navigation -->
      <header class="border-b border-gray-200 p-4" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);">
        <div class="flex items-center justify-between">
          <!-- Logo and Title -->
          <div class="flex items-center space-x-3 space-x-reverse">
            <div class="w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold" style="background: linear-gradient(135deg, #4f46e5, #7c3aed);">
              T
            </div>
            <h1 class="text-heading-md font-bold text-gray-900">TCHAT</h1>
          </div>
          
          <!-- Navigation Menu -->
          <nav class="flex items-center space-x-6 space-x-reverse">
            <a href="#" class="flex items-center px-3 py-2 text-body-sm font-medium rounded-lg text-white" style="background: linear-gradient(135deg, #4f46e5, #7c3aed);">
              <i data-lucide="home" class="w-4 h-4 ml-2"></i>
              الرئيسية
            </a>
            
            <a href="#" class="flex items-center px-3 py-2 text-body-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
              <i data-lucide="shopping-cart" class="w-4 h-4 ml-2"></i>
              السلات المتروكة
            </a>
            
            <a href="#" class="flex items-center px-3 py-2 text-body-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
              <i data-lucide="message-circle" class="w-4 h-4 ml-2"></i>
              رسائل WhatsApp
            </a>
            
            <a href="#" class="flex items-center px-3 py-2 text-body-sm font-medium text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
              <i data-lucide="settings" class="w-4 h-4 ml-2"></i>
              الإعدادات
            </a>
          </nav>
          
          <!-- User Menu and Logout -->
          <div class="flex items-center space-x-4 space-x-reverse">
            <div class="flex items-center space-x-2 space-x-reverse">
              <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold" style="background: linear-gradient(135deg, #4f46e5, #7c3aed);">
                ا
              </div>
              <span class="text-body-sm text-gray-700">المدير العام</span>
            </div>
            
            <button onclick="logout()" class="flex items-center px-3 py-2 text-body-sm rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 transition-colors">
              <i data-lucide="log-out" class="w-4 h-4 ml-2"></i>
              <span>خروج</span>
            </button>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <div class="flex-1">

        <!-- Main Content -->
        <main class="p-6">

          <!-- Revenue Table -->
          <div class="bg-white rounded-xl border border-gray-200 shadow-sm mb-8">
            <div class="p-4 rounded-t-xl" style="background: linear-gradient(135deg, #a855f7, #3b82f6);">
              <h2 class="text-heading-sm font-bold text-white text-right">إجمالي الإيرادات (SAR)</h2>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-4 text-right text-body-sm font-medium text-gray-700"></th>
                    <th class="px-6 py-4 text-right text-body-sm font-medium text-gray-700">الحالة</th>
                    <th class="px-6 py-4 text-right text-body-sm font-medium text-gray-700">إجمالي الإيرادات<br><span class="font-normal text-gray-500">(منذ البدء)</span></th>
                    <th class="px-6 py-4 text-right text-body-sm font-medium text-gray-700">إجمالي الإيرادات<br><span class="font-normal text-gray-500">(30 يوماً سابقة)</span></th>
                    <th class="px-6 py-4 text-right text-body-sm font-medium text-gray-700">إجمالي الإيرادات<br><span class="font-normal text-gray-500">(آخر 30 يوماً)</span></th>
                    <th class="px-6 py-4 text-right text-body-sm font-medium text-gray-700">الطلبات المنسوبة<br><span class="font-normal text-gray-500">(آخر 30 يوماً)</span></th>
                  </tr>
                </thead>
                <tbody id="revenue-table-tbody" class="divide-y divide-gray-200">
                  <!-- البيانات ستُحمل من Backend -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Meta WhatsApp Numbers Table -->
          <div class="bg-white rounded-xl border border-gray-200 shadow-sm mb-8">
            <div class="p-4 rounded-t-xl" style="background: linear-gradient(135deg, #a855f7, #3b82f6);">
              <h2 class="text-heading-sm font-bold text-white text-right">أرقام الواتساب من Meta</h2>
              <p class="text-body-sm text-white/80 text-right">البيانات الحقيقية من Meta Business API</p>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">ID</th>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">رقم الهاتف</th>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">الاسم المتحقق</th>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">حالة التحقق</th>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">تقييم الجودة</th>
                  </tr>
                </thead>
                <tbody id="meta-phone-numbers-tbody">
                  <!-- البيانات ستُحمل من Meta API -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Abandoned Carts and Customers Table -->
          <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
            <div class="p-4 rounded-t-xl" style="background: linear-gradient(135deg, #3b82f6, #a855f7);">
              <h2 class="text-heading-sm font-bold text-white text-right">العملاء والسلات المتروكة</h2>
              <p class="text-body-sm text-white/80 text-right">العملاء المسجلين مع سلاتهم المتروكة وحالة الإرسال</p>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">اسم العميل</th>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">رقم الجوال</th>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">قيمة السلة</th>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">عدد المنتجات</th>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">حالة الإرسال</th>
                    <th class="px-6 py-3 text-center text-body-sm font-medium text-gray-700">منذ</th>
                  </tr>
                </thead>
                <tbody id="abandoned-carts-tbody">
                  <!-- البيانات ستُحمل من Backend -->
                </tbody>
              </table>
            </div>
          </div>
        </main>
    </div>

    <script>
      // تحقق من تسجيل الدخول
      if (!localStorage.getItem('tchat_logged_in')) {
        window.location.href = './login.html';
      }

      // تحميل البيانات من Backend
      async function loadDashboardData() {
        try {
          console.log('بدء تحميل بيانات لوحة التحكم...');
          
          // تحميل بيانات الإيرادات
          const revenueData = await loadRevenueData();
          console.log('Revenue Data:', revenueData);
          renderRevenueTable(revenueData);
          
          // تحميل أرقام WhatsApp من Meta
          const metaPhoneNumbers = await loadMetaPhoneNumbers();
          console.log('Meta Phone Numbers:', metaPhoneNumbers);
          renderMetaPhoneNumbersTable(metaPhoneNumbers);
          
          // تحميل بيانات السلات المتروكة
          const abandonedCarts = await loadAbandonedCarts();
          console.log('Abandoned Carts:', abandonedCarts);
          renderAbandonedCartsTable(abandonedCarts);
          
        } catch (error) {
          console.error('خطأ في تحميل بيانات لوحة التحكم:', error);
        }
      }

      // عرض جدول الإيرادات
      function renderRevenueTable(data) {
        const tbody = document.getElementById('revenue-table-tbody');
        if (!data || data.length === 0) return;
        
        tbody.innerHTML = data.map(item => {
          const statusClass = item.status === 'فعالة' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800';
          const isTotal = item.campaign_name === 'الحملات التسويقية';
          const borderClass = isTotal ? 'border-t-2 border-gray-300' : '';
          
          return `
            <tr class="hover:bg-gray-50 ${borderClass}">
              <td class="px-6 py-4 text-right">
                <span class="text-body-md text-gray-900 ${isTotal ? 'font-bold' : 'font-medium'}">${item.campaign_name}</span>
              </td>
              <td class="px-6 py-4 text-right">
                ${item.status.includes('ذات إيرادات') ? 
                  `<span class="text-body-sm text-gray-600">${item.status}</span>` :
                  `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">${item.status}</span>`
                }
              </td>
              <td class="px-6 py-4 text-right">
                <span class="font-mono text-body-lg font-bold text-gray-900 number">${item.total_revenue.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
              </td>
              <td class="px-6 py-4 text-right">
                <span class="font-mono text-body-md text-gray-900 number">${item.last_30_days.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
              </td>
              <td class="px-6 py-4 text-right">
                <span class="font-mono text-body-md text-gray-900 number">${item.previous_30_days.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
              </td>
              <td class="px-6 py-4 text-right">
                <span class="text-body-lg font-bold text-gray-900 number">${item.attributed_orders}</span>
              </td>
            </tr>
          `;
        }).join('');
      }

      // عرض جدول أرقام WhatsApp من Meta
      function renderMetaPhoneNumbersTable(phoneNumbers) {
        const tbody = document.getElementById('meta-phone-numbers-tbody');
        if (!phoneNumbers || phoneNumbers.length === 0) {
          console.error('لا توجد أرقام WhatsApp من Meta');
          tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">لا توجد أرقام WhatsApp</td></tr>';
          return;
        }
        
        console.log('عرض أرقام Meta WhatsApp:', phoneNumbers);
        console.log('عدد الأرقام:', phoneNumbers.length);
        
        tbody.innerHTML = phoneNumbers.map(phone => {
          // تنسيق تقييم الجودة
          let qualityText = phone.quality_rating;
          let qualityClass = 'bg-gray-100 text-gray-800';
          
          if (qualityText === 'GREEN') {
            qualityText = 'مرتفع';
            qualityClass = 'bg-green-100 text-green-800';
          } else if (qualityText === 'YELLOW') {
            qualityText = 'متوسط';
            qualityClass = 'bg-yellow-100 text-yellow-800';
          } else if (qualityText === 'RED') {
            qualityText = 'منخفض';
            qualityClass = 'bg-red-100 text-red-800';
          }
          
          // تنظيف رقم الهاتف (إزالة المسافات والرموز)
          const cleanPhoneNumber = phone.display_phone_number.replace(/[\s\+\-]/g, '');
          
          // تحديد حالة التحقق
          const verificationStatus = phone.code_verification_status === 'VERIFIED' ? 'متحقق' : 'غير متحقق';
          const statusClass = phone.code_verification_status === 'VERIFIED' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
          
          return `
            <tr class="border-t border-gray-200 hover:bg-gray-50">
              <td class="px-6 py-4 text-center">
                <span class="font-mono text-body-sm text-gray-900 number">${phone.id}</span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="font-mono text-body-md text-gray-900 number">${cleanPhoneNumber}</span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="text-body-md text-gray-900 font-medium">${phone.verified_name}</span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                  ${verificationStatus}
                </span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${qualityClass}">
                  ${qualityText}
                </span>
              </td>
            </tr>
          `;
        }).join('');
        
        console.log('تم عرض الجدول بنجاح');
      }

      // عرض جدول السلات المتروكة والعملاء
      function renderAbandonedCartsTable(carts) {
        const tbody = document.getElementById('abandoned-carts-tbody');
        if (!carts || carts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">لا توجد سلات متروكة</td></tr>';
          return;
        }
        
        tbody.innerHTML = carts.map(cart => {
          // تنسيق التاريخ
          const createdDate = new Date(cart.created_at);
          const timeAgo = getTimeAgo(createdDate);
          
          // تحديد حالة الإرسال
          const messageSent = cart.reminder_sent;
          const sendingStatus = messageSent ? 'تم الإرسال' : 'لم يتم الإرسال';
          const statusClass = messageSent ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
          
          return `
            <tr class="border-t border-gray-200 hover:bg-gray-50">
              <td class="px-6 py-4 text-center">
                <span class="text-body-md text-gray-900 font-medium">${cart.customer_name || 'غير محدد'}</span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="font-mono text-body-md text-gray-900 number">${cart.customer_mobile || 'غير محدد'}</span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="font-mono text-body-md text-gray-900 number">${cart.total_amount ? cart.total_amount.toLocaleString('en-US', {minimumFractionDigits: 2}) : '0.00'} ${cart.currency || 'SAR'}</span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="text-body-md text-gray-900 number">${cart.items_count || 0}</span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                  ${sendingStatus}
                </span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="text-body-sm text-gray-600">${timeAgo}</span>
              </td>
            </tr>
          `;
        }).join('');
      }

      // حساب الوقت المنقضي
      function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMins < 1) return 'الآن';
        if (diffMins < 60) return `منذ ${diffMins} دقيقة`;
        if (diffHours < 24) return `منذ ${diffHours} ساعة`;
        return `منذ ${diffDays} يوم`;
      }

      // تهيئة أيقونات Lucide
      document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        loadDashboardData();
      });

      // تسجيل الخروج
      function logout() {
        localStorage.removeItem('tchat_logged_in');
        localStorage.removeItem('tchat_user');
        localStorage.removeItem('tchat_token');
        window.location.href = './login.html';
      }
    </script>
  </body>
</html>
