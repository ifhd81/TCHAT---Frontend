<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TCHAT - Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¤ØªÙ…ØªØ©</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="./api.js"></script>
  <script src="./components/header.js"></script>
</head>
<body class="rtl min-h-screen bg-background" style="font-family: 'LamaSans', sans-serif;">
  
  <div class="min-h-screen">
    
    <!-- Header Container -->
    <div id="header-container"></div>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    
    <!-- Page Header -->
    <section class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-heading-lg font-bold text-foreground">Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¤ØªÙ…ØªØ©</h1>
        <p class="text-body-sm text-muted-foreground">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø§Ø« Ù…Ø¹ÙŠÙ†Ø©</p>
      </div>
      <button onclick="showCreateAutomationModal()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
        <i data-lucide="plus" class="h-4 w-4"></i>
        <span>Ø£ØªÙ…ØªØ© Ø¬Ø¯ÙŠØ¯Ø©</span>
      </button>
    </section>

    <!-- Stats Cards -->
    <section class="mb-8 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <div class="rounded-xl border bg-card p-6 shadow-sm">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-primary/10">
            <i data-lucide="zap" class="h-5 w-5 text-primary"></i>
          </div>
          <div>
            <p class="text-body-sm text-muted-foreground">Ø§Ù„Ø£ØªÙ…ØªØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</p>
            <p class="text-heading-lg font-bold number" id="active-automations-count">0</p>
          </div>
        </div>
      </div>
      <div class="rounded-xl border bg-card p-6 shadow-sm">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-success/10">
            <i data-lucide="send" class="h-5 w-5 text-success"></i>
          </div>
          <div>
            <p class="text-body-sm text-muted-foreground">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</p>
            <p class="text-heading-lg font-bold number" id="total-sent-count">0</p>
          </div>
        </div>
      </div>
      <div class="rounded-xl border bg-card p-6 shadow-sm">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-warning/10">
            <i data-lucide="shopping-cart" class="h-5 w-5 text-warning"></i>
          </div>
          <div>
            <p class="text-body-sm text-muted-foreground">Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</p>
            <p class="text-heading-lg font-bold number" id="total-carts-count">0</p>
          </div>
        </div>
      </div>
      <div class="rounded-xl border bg-card p-6 shadow-sm">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-accent">
            <i data-lucide="percent" class="h-5 w-5 text-accent-foreground"></i>
          </div>
          <div>
            <p class="text-body-sm text-muted-foreground">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„</p>
            <p class="text-heading-lg font-bold number" id="conversion-rate">0%</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Automations List with Visual Workflow -->
    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
      <div class="border-b border-border p-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="workflow" class="h-5 w-5 text-muted-foreground"></i>
            <h2 class="text-heading-md font-semibold">Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¤ØªÙ…ØªØ© Ù…Ø¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
          </div>
          <button onclick="refreshAutomations()" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="refresh-cw" class="h-4 w-4"></i>
          </button>
        </div>
      </div>

      <div class="p-6">
        <div id="automations-list" class="space-y-6">
          <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØªÙ…ØªØ§Øª Ù‡Ù†Ø§ -->
        </div>
      </div>
    </div>

  </main>

  </div>

  <!-- Modal: Edit Abandoned Cart Settings -->
  <div id="edit-abandoned-cart-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div class="flex items-center gap-4">
            <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-warning/10">
              <i data-lucide="shopping-cart" class="h-6 w-6 text-warning"></i>
            </div>
            <div>
              <div class="flex items-center gap-3">
                <h2 class="text-heading-lg font-bold">Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©</h2>
                <span id="modal-status-badge" class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-success/10 text-success">Ù…ÙØ¹Ù‘Ù„</span>
              </div>
              <p class="text-body-sm text-muted-foreground mt-1">Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¯Ø£ÙˆØ§ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©: <span id="modal-total-customers" class="font-semibold number">0</span></p>
            </div>
          </div>
          <button onclick="hideEditAbandonedCartModal()" class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="x" class="h-5 w-5"></i>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-6">

          <!-- Analytics Section -->
          <div class="space-y-4">
            <!-- Send Template Step -->
            <div class="rounded-xl border-2 border-warning bg-warning/5 overflow-hidden">
              <div class="bg-warning px-4 py-3 flex items-center gap-2">
                <i data-lucide="send" class="h-5 w-5 text-white"></i>
                <span class="text-white font-semibold">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù‚Ø§Ù„Ø¨</span>
              </div>
              <div class="p-4 space-y-4">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="inline-flex items-center gap-1 rounded-md border border-border bg-background px-2 py-1 text-body-sm">
                      <i data-lucide="file-text" class="h-3 w-3"></i>
                      <span id="modal-template-name">cart_1</span>
                    </span>
                    <span class="text-body-sm text-muted-foreground">ØªÙ… Ø£Ø±Ø³Ù„</span>
                  </div>
                  <div class="flex items-center gap-4 text-body-sm text-muted-foreground">
                    <span class="flex items-center gap-1">
                      <i data-lucide="clock" class="h-4 w-4"></i>
                      Ø§Ù†ØªØ¸Ø± <span id="modal-delay-text">ÙÙˆØ±ÙŠ</span>
                    </span>
                    <span>Ø¨Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± <span id="modal-pending-count" class="font-semibold number">0</span></span>
                    <span>ØªØ®Ø·ÙˆØ§ Ø§Ù„Ù…Ø±Ø­Ù„Ø© <span id="modal-skipped-count" class="font-semibold number">0</span></span>
                  </div>
                </div>
                
                <div class="border-t border-border pt-4">
                  <p class="text-body-sm text-muted-foreground mb-3">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø®Ø·ÙˆØ© Ù…Ù†Ø° Ø§Ù„Ø¨Ø¯Ø¡</p>
                  <div class="grid grid-cols-6 gap-3">
                    <div class="flex flex-col items-center">
                      <div class="flex items-center justify-center h-16 w-16 rounded-full bg-red-100 text-red-500 text-heading-md font-bold"><span id="stat-sent">0</span></div>
                      <p class="text-body-xs text-muted-foreground mt-2">Ø£ÙØ±Ø³Ù„Øª</p>
                    </div>
                    <div class="flex flex-col items-center">
                      <div class="flex items-center justify-center h-16 w-16 rounded-full bg-pink-100 text-pink-500 text-heading-md font-bold"><span id="stat-delivered">0</span></div>
                      <p class="text-body-xs text-muted-foreground mt-2">ÙˆØµÙ„Øª</p>
                    </div>
                    <div class="flex flex-col items-center">
                      <div class="flex items-center justify-center h-16 w-16 rounded-full bg-cyan-100 text-cyan-500 text-heading-md font-bold"><span id="stat-read">0</span></div>
                      <p class="text-body-xs text-muted-foreground mt-2">Ù‚ÙØ±Ø¦Øª</p>
                    </div>
                    <div class="flex flex-col items-center">
                      <div class="flex items-center justify-center h-16 w-16 rounded-full bg-violet-100 text-violet-500 text-heading-md font-bold"><span id="stat-replied">0</span></div>
                      <p class="text-body-xs text-muted-foreground mt-2">Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§</p>
                    </div>
                    <div class="flex flex-col items-center">
                      <div class="flex items-center justify-center h-16 w-16 rounded-full bg-green-100 text-green-500 text-heading-md font-bold"><span id="stat-clicked">0</span></div>
                      <p class="text-body-xs text-muted-foreground mt-2">Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡</p>
                    </div>
                    <div class="flex flex-col items-center">
                      <div class="flex items-center justify-center h-16 w-16 rounded-full bg-indigo-100 text-indigo-500 text-heading-md font-bold"><span id="stat-failed">0</span></div>
                      <p class="text-body-xs text-muted-foreground mt-2">Ø§Ø±ØªØ¯Øª</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Completion Step -->
            <div class="rounded-xl border-2 border-success bg-success/5 overflow-hidden">
              <div class="bg-success px-4 py-3 flex items-center gap-2">
                <i data-lucide="check" class="h-5 w-5 text-white"></i>
                <span class="text-white font-semibold">Ø£ÙƒÙ…Ù„</span>
              </div>
              <div class="p-6 flex flex-col items-center">
                <div class="flex items-center justify-center h-16 w-16 rounded-full bg-success/10 text-success text-heading-lg font-bold"><span id="stat-converted">0</span></div>
                <p class="text-body-sm text-muted-foreground mt-2">Ø¹Ù…Ù„Ø§Ø¡ Ù‚Ø¯ Ø£ÙƒÙ…Ù„ÙˆØ§ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù…Ù„Ø©</p>
              </div>
            </div>
          </div>

          <!-- Divider -->
          <div class="border-t border-border"></div>

          <!-- Settings Section -->
          <div class="space-y-4">
            <h3 class="text-heading-sm font-semibold flex items-center gap-2">
              <i data-lucide="settings" class="h-5 w-5 text-muted-foreground"></i>
              Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£ØªÙ…ØªØ©
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Template Selection -->
              <div class="space-y-2">
                <label class="text-body-sm font-medium text-foreground">Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <select id="template-select" class="w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨...</option>
                </select>
              </div>

              <!-- Timing Selection -->
              <div class="space-y-2">
                <label class="text-body-sm font-medium text-foreground">ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>
                <select id="timing-select" class="w-full rounded-md border border-input bg-background px-3 py-2 text-body-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
                  <option value="0">ÙÙˆØ±ÙŠ (Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±)</option>
                  <option value="5">Ø¨Ø¹Ø¯ 5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
                  <option value="15">Ø¨Ø¹Ø¯ 15 Ø¯Ù‚ÙŠÙ‚Ø©</option>
                  <option value="30">Ø¨Ø¹Ø¯ 30 Ø¯Ù‚ÙŠÙ‚Ø©</option>
                  <option value="60">Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø©</option>
                  <option value="120">Ø¨Ø¹Ø¯ Ø³Ø§Ø¹ØªÙŠÙ†</option>
                  <option value="180">Ø¨Ø¹Ø¯ 3 Ø³Ø§Ø¹Ø§Øª</option>
                  <option value="360">Ø¨Ø¹Ø¯ 6 Ø³Ø§Ø¹Ø§Øª</option>
                  <option value="720">Ø¨Ø¹Ø¯ 12 Ø³Ø§Ø¹Ø©</option>
                  <option value="1440">Ø¨Ø¹Ø¯ 24 Ø³Ø§Ø¹Ø©</option>
                </select>
              </div>
            </div>

            <!-- Template Preview -->
            <div id="template-preview" class="hidden rounded-lg border border-border bg-muted/30 p-4">
              <div class="flex items-center gap-2 mb-2">
                <i data-lucide="eye" class="h-4 w-4 text-muted-foreground"></i>
                <span class="text-body-sm font-medium text-muted-foreground">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚Ø§Ù„Ø¨</span>
              </div>
              <div id="template-preview-content" class="text-body-sm text-foreground whitespace-pre-wrap"></div>
            </div>

            <!-- Additional Options -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <label class="flex items-center gap-3 cursor-pointer rounded-lg border border-border p-3 hover:bg-muted/30 transition">
                <input type="checkbox" id="prevent-duplicate" checked class="h-4 w-4 rounded border-input text-primary focus:ring-primary">
                <div>
                  <span class="text-body-sm font-medium text-foreground">Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙƒØ±Ø±</span>
                  <p class="text-body-xs text-muted-foreground">Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©</p>
                </div>
              </label>

              <label class="flex items-center gap-3 cursor-pointer rounded-lg border border-border p-3 hover:bg-muted/30 transition">
                <input type="checkbox" id="skip-purchased" checked class="h-4 w-4 rounded border-input text-primary focus:ring-primary">
                <div>
                  <span class="text-body-sm font-medium text-foreground">ØªØ®Ø·ÙŠ Ø§Ù„Ø³Ù„Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©</span>
                  <p class="text-body-xs text-muted-foreground">Ø¥Ø°Ø§ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡</p>
                </div>
              </label>
            </div>
          </div>

        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-between border-t border-border p-6">
          <button onclick="toggleAbandonedCartStatusFromModal()" id="modal-toggle-btn" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-button-md font-medium text-foreground shadow-sm transition hover:bg-accent">
            <i data-lucide="pause" class="h-4 w-4"></i>
            <span>Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</span>
          </button>
          <div class="flex items-center gap-3">
            <button onclick="hideEditAbandonedCartModal()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-button-md font-medium text-foreground shadow-sm transition hover:bg-accent">
              Ø¥Ù„ØºØ§Ø¡
            </button>
            <button onclick="saveAbandonedCartSettings()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
              <i data-lucide="save" class="h-4 w-4"></i>
              <span>Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal: Create New Automation -->
  <div id="create-automation-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div>
            <h2 class="text-heading-lg font-bold">Ø¥Ù†Ø´Ø§Ø¡ Ø£ØªÙ…ØªØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <p class="text-body-sm text-muted-foreground mt-1">Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø¯Ø« Ù…Ø¹ÙŠÙ†</p>
          </div>
          <button onclick="hideCreateAutomationModal()" class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="x" class="h-5 w-5"></i>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-6">
          
          <!-- Automation Name -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">Ø§Ø³Ù… Ø§Ù„Ø£ØªÙ…ØªØ©</label>
            <input type="text" id="automation-name" placeholder="Ù…Ø«Ø§Ù„: ØªØ°ÙƒÙŠØ± Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
          </div>

          <!-- Trigger Selection -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù…ÙØ´ØºÙ‘Ù„</label>
            <p class="text-body-sm text-muted-foreground">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø°ÙŠ Ø³ÙŠÙØ´ØºÙ‘Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø£ØªÙ…ØªØ©</p>
            <select id="trigger-select" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø¯Ø«...</option>
              <option value="abandoned_cart">Ø³Ù„Ø© Ù…ØªØ±ÙˆÙƒØ©</option>
              <option value="new_order">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</option>
              <option value="order_shipped">Ø´Ø­Ù† Ø§Ù„Ø·Ù„Ø¨</option>
              <option value="order_delivered">ØªÙˆØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</option>
              <option value="new_customer">Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</option>
            </select>
          </div>

          <!-- Template Selection -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <select id="new-automation-template" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨...</option>
            </select>
          </div>

          <!-- Timing Selection -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label>
            <select id="new-automation-timing" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="0">ÙÙˆØ±ÙŠ</option>
              <option value="5">Ø¨Ø¹Ø¯ 5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
              <option value="15">Ø¨Ø¹Ø¯ 15 Ø¯Ù‚ÙŠÙ‚Ø©</option>
              <option value="30">Ø¨Ø¹Ø¯ 30 Ø¯Ù‚ÙŠÙ‚Ø©</option>
              <option value="60">Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø©</option>
              <option value="120">Ø¨Ø¹Ø¯ Ø³Ø§Ø¹ØªÙŠÙ†</option>
              <option value="1440">Ø¨Ø¹Ø¯ 24 Ø³Ø§Ø¹Ø©</option>
            </select>
          </div>

        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 border-t border-border p-6">
          <button onclick="hideCreateAutomationModal()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-button-md font-medium text-foreground shadow-sm transition hover:bg-accent">
            Ø¥Ù„ØºØ§Ø¡
          </button>
          <button onclick="createAutomation()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
            <i data-lucide="plus" class="h-4 w-4"></i>
            <span>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ØªÙ…ØªØ©</span>
          </button>
        </div>

      </div>
    </div>
  </div>

  <script>
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (!localStorage.getItem('tchat_logged_in')) {
      window.location.href = './login.html';
    }

    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    let allTemplates = [];
    let automations = [];
    let abandonedCartSettings = {
      id: 0,
      templateName: 'cart_1',
      templateLanguage: 'ar',
      delayMinutes: 0,
      isActive: true,
      preventDuplicate: true,
      skipPurchased: true
    };

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', async () => {
      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù‡ÙŠØ¯Ø±
      renderHeader('header-container', { activePage: 'automations' });
      lucide.createIcons();
      await Promise.all([
        loadTemplates(),
        loadAutomations(),
        loadAbandonedCartSettings(),
        loadStats()
      ]);
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ù…Ù† API
    async function loadTemplates() {
      try {
        const response = await apiRequest('/meta/templates?limit=100');
        if (response && response.data) {
          allTemplates = response.data.filter(t => t.status === 'APPROVED');
          populateTemplateSelects();
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨:', error);
        showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨', 'error');
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† API
    async function loadStats() {
      try {
        const response = await apiRequest('/automations/stats');
        if (response && response.success && response.data) {
          const stats = response.data;
          document.getElementById('active-automations-count').textContent = stats.active_automations || 0;
          document.getElementById('total-sent-count').textContent = stats.total_sent || 0;
          document.getElementById('total-carts-count').textContent = stats.total_carts || 0;
          const conversionRate = stats.conversion_rate || 0;
          document.getElementById('conversion-rate').textContent = conversionRate.toFixed(1) + '%';
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
      }
    }

    // Ù…Ù„Ø¡ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨
    function populateTemplateSelects() {
      const selects = ['template-select', 'new-automation-template'];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨...</option>';
        
        allTemplates.forEach(template => {
          const langText = template.language === 'ar' ? 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©';
          const option = document.createElement('option');
          option.value = template.name;
          option.textContent = `${template.name} (${langText})`;
          option.dataset.template = JSON.stringify(template);
          select.appendChild(option);
        });
      });

      // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚Ø§Ù„Ø¨
      const templateSelect = document.getElementById('template-select');
      if (templateSelect) {
        templateSelect.addEventListener('change', showTemplatePreview);
      }
    }

    // Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚Ø§Ù„Ø¨
    function showTemplatePreview() {
      const select = document.getElementById('template-select');
      const preview = document.getElementById('template-preview');
      const previewContent = document.getElementById('template-preview-content');
      
      if (!select || !preview || !previewContent) return;
      
      const selectedOption = select.options[select.selectedIndex];
      if (!selectedOption || !selectedOption.value || !selectedOption.dataset.template) {
        preview.classList.add('hidden');
        return;
      }

      const template = JSON.parse(selectedOption.dataset.template);
      const components = template.components || [];
      
      let previewText = '';
      components.forEach(comp => {
        if (comp.type === 'HEADER' && comp.text) {
          previewText += `ğŸ“Œ ${comp.text}\n\n`;
        }
        if (comp.type === 'BODY' && comp.text) {
          previewText += comp.text + '\n\n';
        }
        if (comp.type === 'FOOTER' && comp.text) {
          previewText += `â€”\n${comp.text}`;
        }
      });

      previewContent.textContent = previewText || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…ØªØ§Ø­Ø©';
      preview.classList.remove('hidden');
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØªÙ…ØªØ§Øª Ù…Ù† API
    async function loadAutomations() {
      try {
        const response = await apiRequest('/automations');
        if (response && response.success && response.data) {
          automations = response.data;
        }
        renderAutomations();
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØªÙ…ØªØ§Øª:', error);
        renderAutomations();
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ© Ù…Ù† API
    async function loadAbandonedCartSettings() {
      try {
        const response = await apiRequest('/automations/trigger/abandoned_cart');
        if (response && response.success && response.data) {
          const data = response.data;
          abandonedCartSettings = {
            id: data.id,
            templateName: data.template_name,
            templateLanguage: data.template_language || 'ar',
            delayMinutes: data.delay_minutes || 0,
            isActive: data.is_active !== false,
            preventDuplicate: data.prevent_duplicate !== false,
            skipPurchased: data.skip_purchased !== false,
            totalSent: data.total_sent || 0,
            totalConverted: data.total_converted || 0
          };
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©:', error);
      }
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Øµ Ø§Ù„ÙˆÙ‚Øª
    function getTimingText(minutes) {
      if (minutes === 0) return 'ÙÙˆØ±ÙŠ';
      if (minutes < 60) return `Ø¨Ø¹Ø¯ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
      if (minutes === 60) return 'Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø©';
      if (minutes < 1440) return `Ø¨Ø¹Ø¯ ${minutes / 60} Ø³Ø§Ø¹Ø§Øª`;
      return `Ø¨Ø¹Ø¯ ${minutes / 1440} ÙŠÙˆÙ…`;
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø£ØªÙ…ØªØ§Øª
    function renderAutomations() {
      const container = document.getElementById('automations-list');
      
      // Ø£ØªÙ…ØªØ© Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©
      const abandonedCartAutomation = `
        <div class="rounded-xl border border-border bg-background p-4 md:p-6 transition hover:shadow-md cursor-pointer" onclick="showEditAbandonedCartModal()">
          <div class="flex items-start justify-between gap-3">
            <div class="flex items-start gap-3 md:gap-4 flex-1 min-w-0">
              <div class="flex h-12 w-12 md:h-14 md:w-14 shrink-0 items-center justify-center rounded-xl bg-warning/10">
                <i data-lucide="shopping-cart" class="h-6 w-6 md:h-7 md:w-7 text-warning"></i>
              </div>
              <div class="min-w-0 flex-1">
                <div class="flex flex-wrap items-center gap-2">
                  <h3 class="text-body-md md:text-heading-md font-semibold text-foreground">ØªØ°ÙƒÙŠØ± Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©</h3>
                  <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${abandonedCartSettings.isActive ? 'bg-success/10 text-success' : 'bg-destructive/10 text-destructive'}">
                    ${abandonedCartSettings.isActive ? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…ØªÙˆÙ‚Ù'}
                  </span>
                </div>
                <p class="mt-1 text-body-xs md:text-body-sm text-muted-foreground hidden sm:block">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¹Ù†Ø¯ ØªØ±Ùƒ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</p>
                
                <!-- Stats Summary -->
                <div class="mt-3 md:mt-4 grid grid-cols-2 sm:flex sm:flex-wrap items-center gap-3 md:gap-4">
                  <div class="flex items-center gap-2">
                    <div class="flex h-7 w-7 md:h-8 md:w-8 items-center justify-center rounded-full bg-primary/10">
                      <span class="text-body-xs md:text-body-sm font-bold text-primary number">${abandonedCartSettings.totalSent || 0}</span>
                    </div>
                    <span class="text-body-xs text-muted-foreground">Ø£ÙØ±Ø³Ù„Øª</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <div class="flex h-7 w-7 md:h-8 md:w-8 items-center justify-center rounded-full bg-success/10">
                      <span class="text-body-xs md:text-body-sm font-bold text-success number">${abandonedCartSettings.totalConverted || 0}</span>
                    </div>
                    <span class="text-body-xs text-muted-foreground">Ø£ÙƒÙ…Ù„ÙˆØ§</span>
                  </div>
                  <div class="flex items-center gap-1 text-body-xs text-muted-foreground">
                    <i data-lucide="file-text" class="h-3 w-3 shrink-0"></i>
                    <span class="truncate">${abandonedCartSettings.templateName}</span>
                  </div>
                  <div class="flex items-center gap-1 text-body-xs text-muted-foreground">
                    <i data-lucide="clock" class="h-3 w-3 shrink-0"></i>
                    <span>${getTimingText(abandonedCartSettings.delayMinutes)}</span>
                  </div>
                </div>
              </div>
            </div>
            <button class="hidden sm:inline-flex h-9 w-9 md:h-10 md:w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground hover:bg-accent shrink-0">
              <i data-lucide="settings" class="h-4 w-4 md:h-5 md:w-5"></i>
            </button>
          </div>
        </div>
      `;

      container.innerHTML = abandonedCartAutomation;
      lucide.createIcons();
    }

    // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ© Ù…Ø¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    function showEditAbandonedCartModal() {
      const modal = document.getElementById('edit-abandoned-cart-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©
      updateModalData();
      
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      const templateSelect = document.getElementById('template-select');
      const timingSelect = document.getElementById('timing-select');
      
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø§Ù„Ø¨ - Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ÙŠÙ…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø£Ø¶ÙÙ‡Ø§ Ù…Ø¤Ù‚ØªØ§Ù‹
      if (templateSelect) {
        templateSelect.value = abandonedCartSettings.templateName;
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø§Ù„Ù‚Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
        if (templateSelect.value !== abandonedCartSettings.templateName && abandonedCartSettings.templateName) {
          const option = document.createElement('option');
          option.value = abandonedCartSettings.templateName;
          option.textContent = abandonedCartSettings.templateName;
          option.selected = true;
          templateSelect.insertBefore(option, templateSelect.firstChild.nextSibling);
        }
      }
      
      if (timingSelect) {
        timingSelect.value = abandonedCartSettings.delayMinutes || 0;
      }
      
      const preventDuplicate = document.getElementById('prevent-duplicate');
      const skipPurchased = document.getElementById('skip-purchased');
      if (preventDuplicate) preventDuplicate.checked = abandonedCartSettings.preventDuplicate !== false;
      if (skipPurchased) skipPurchased.checked = abandonedCartSettings.skipPurchased !== false;
      
      showTemplatePreview();
      lucide.createIcons();
    }

    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§ÙØ°Ø©
    function updateModalData() {
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Ø© ÙˆØ§Ù„Ø­Ø§Ù„Ø©
      const statusBadge = document.getElementById('modal-status-badge');
      const toggleBtn = document.getElementById('modal-toggle-btn');
      
      if (abandonedCartSettings.isActive) {
        statusBadge.className = 'inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-success/10 text-success';
        statusBadge.textContent = 'Ù…ÙØ¹Ù‘Ù„';
        toggleBtn.innerHTML = '<i data-lucide="pause" class="h-4 w-4"></i><span>Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</span>';
      } else {
        statusBadge.className = 'inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-destructive/10 text-destructive';
        statusBadge.textContent = 'Ù…ØªÙˆÙ‚Ù';
        toggleBtn.innerHTML = '<i data-lucide="play" class="h-4 w-4"></i><span>ØªÙØ¹ÙŠÙ„</span>';
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙˆÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
      document.getElementById('modal-template-name').textContent = abandonedCartSettings.templateName;
      document.getElementById('modal-delay-text').textContent = getTimingText(abandonedCartSettings.delayMinutes);
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      document.getElementById('modal-total-customers').textContent = abandonedCartSettings.totalSent || 0;
      document.getElementById('stat-sent').textContent = abandonedCartSettings.totalSent || 0;
      document.getElementById('stat-converted').textContent = abandonedCartSettings.totalConverted || 0;
      
      // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ (Ø³ØªÙƒÙˆÙ† Ù…Ù† API Ù„Ø§Ø­Ù‚Ø§Ù‹)
      document.getElementById('stat-delivered').textContent = 0;
      document.getElementById('stat-read').textContent = 0;
      document.getElementById('stat-replied').textContent = 0;
      document.getElementById('stat-clicked').textContent = 0;
      document.getElementById('stat-failed').textContent = 0;
      document.getElementById('modal-pending-count').textContent = 0;
      document.getElementById('modal-skipped-count').textContent = 0;
      
      lucide.createIcons();
    }

    // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©
    function hideEditAbandonedCartModal() {
      const modal = document.getElementById('edit-abandoned-cart-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØªÙ…ØªØ© Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø©
    async function toggleAbandonedCartStatusFromModal() {
      await toggleAbandonedCartStatus();
      updateModalData();
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ÙØ´ØºÙ‘Ù„
    function getTriggerIcon(triggerType) {
      const icons = {
        'abandoned_cart': 'shopping-cart',
        'new_order': 'package',
        'order_shipped': 'truck',
        'order_delivered': 'check-circle',
        'new_customer': 'user-plus',
        'browse_abandonment': 'eye',
        'review_request': 'star'
      };
      return icons[triggerType] || 'zap';
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù„ÙˆÙ† Ø§Ù„Ù…ÙØ´ØºÙ‘Ù„
    function getTriggerColor(triggerType) {
      const colors = {
        'abandoned_cart': 'warning',
        'new_order': 'primary',
        'order_shipped': 'accent',
        'order_delivered': 'success',
        'new_customer': 'primary',
        'browse_abandonment': 'warning',
        'review_request': 'accent'
      };
      return colors[triggerType] || 'primary';
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…ÙØ´ØºÙ‘Ù„ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
    function getTriggerName(triggerType) {
      const names = {
        'abandoned_cart': 'Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©',
        'new_order': 'Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯',
        'order_shipped': 'Ø´Ø­Ù† Ø§Ù„Ø·Ù„Ø¨',
        'order_delivered': 'ØªÙˆØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨',
        'new_customer': 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯',
        'browse_abandonment': 'ØªØ±Ùƒ ØªØµÙØ­ Ø§Ù„Ù…ØªØ¬Ø±',
        'review_request': 'Ø·Ù„Ø¨ ØªÙ‚ÙŠÙŠÙ…'
      };
      return names[triggerType] || triggerType;
    }

    // Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©
    async function saveAbandonedCartSettings() {
      const templateName = document.getElementById('template-select').value;
      const delayMinutes = parseInt(document.getElementById('timing-select').value) || 0;
      const preventDuplicate = document.getElementById('prevent-duplicate').checked;
      const skipPurchased = document.getElementById('skip-purchased').checked;

      if (!templateName) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø§Ù„Ø¨', 'error');
        return;
      }

      // ØªØ­Ø¯ÙŠØ¯ Ù„ØºØ© Ø§Ù„Ù‚Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±
      const templateSelect = document.getElementById('template-select');
      const selectedOption = templateSelect.options[templateSelect.selectedIndex];
      let templateLanguage = 'ar';
      if (selectedOption && selectedOption.dataset.template) {
        const template = JSON.parse(selectedOption.dataset.template);
        templateLanguage = template.language || 'ar';
      }

      try {
        let response;
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ID ØµØ­ÙŠØ­ØŒ Ù†Ù†Ø´Ø¦ Ø£ØªÙ…ØªØ© Ø¬Ø¯ÙŠØ¯Ø©
        if (!abandonedCartSettings.id || abandonedCartSettings.id === 0) {
          const createPayload = {
            name: 'ØªØ°ÙƒÙŠØ± Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©',
            trigger_type: 'abandoned_cart',
            template_name: templateName,
            template_language: templateLanguage,
            delay_minutes: delayMinutes,
            is_active: true,
            prevent_duplicate: preventDuplicate,
            skip_purchased: skipPurchased
          };
          
          response = await apiRequest('/automations', 'POST', createPayload);
          
          if (response && response.success && response.data) {
            abandonedCartSettings.id = response.data.id;
          }
        } else {
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØªÙ…ØªØ© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
          const updatePayload = {
            template_name: templateName,
            template_language: templateLanguage,
            delay_minutes: delayMinutes,
            is_active: abandonedCartSettings.isActive,
            prevent_duplicate: preventDuplicate,
            skip_purchased: skipPurchased
          };
          
          response = await apiRequest(`/automations/${abandonedCartSettings.id}`, 'PUT', updatePayload);
        }
        
        if (response && response.success) {
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø­ÙØ¸
          abandonedCartSettings = {
            ...abandonedCartSettings,
            templateName,
            templateLanguage,
            delayMinutes,
            preventDuplicate,
            skipPurchased
          };
          
          hideEditAbandonedCartModal();
          renderAutomations();
          showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } else {
          showToast(response?.message || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'error');
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
        showToast('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª - ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯', 'error');
      }
    }

    // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©
    async function toggleAbandonedCartStatus() {
      try {
        const response = await apiRequest(`/automations/${abandonedCartSettings.id}/toggle`, 'POST');
        
        if (response && response.success) {
          abandonedCartSettings.isActive = response.is_active;
          renderAutomations();
          loadStats();
          
          const message = abandonedCartSettings.isActive ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ØªÙ…ØªØ©' : 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø£ØªÙ…ØªØ©';
          showToast(message, 'success');
        } else {
          showToast(response?.message || 'ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©', 'error');
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©:', error);
        showToast('ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©', 'error');
      }
    }

    // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø£ØªÙ…ØªØ© Ø¬Ø¯ÙŠØ¯Ø©
    function showCreateAutomationModal() {
      const modal = document.getElementById('create-automation-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
      document.getElementById('automation-name').value = '';
      document.getElementById('trigger-select').value = '';
      document.getElementById('new-automation-template').value = '';
      document.getElementById('new-automation-timing').value = '0';
      lucide.createIcons();
    }

    // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø£ØªÙ…ØªØ© Ø¬Ø¯ÙŠØ¯Ø©
    function hideCreateAutomationModal() {
      const modal = document.getElementById('create-automation-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø£ØªÙ…ØªØ© Ø¬Ø¯ÙŠØ¯Ø©
    async function createAutomation() {
      const name = document.getElementById('automation-name').value.trim();
      const trigger = document.getElementById('trigger-select').value;
      const template = document.getElementById('new-automation-template').value;
      const timing = parseInt(document.getElementById('new-automation-timing').value) || 0;

      if (!name || !trigger || !template) {
        showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
      }

      // ØªØ­Ø¯ÙŠØ¯ Ù„ØºØ© Ø§Ù„Ù‚Ø§Ù„Ø¨
      const templateSelect = document.getElementById('new-automation-template');
      const selectedOption = templateSelect.options[templateSelect.selectedIndex];
      let templateLanguage = 'ar';
      if (selectedOption.dataset.template) {
        const templateData = JSON.parse(selectedOption.dataset.template);
        templateLanguage = templateData.language || 'ar';
      }

      const payload = {
        name: name,
        trigger_type: trigger,
        template_name: template,
        template_language: templateLanguage,
        delay_minutes: timing,
        is_active: true,
        prevent_duplicate: true,
        skip_purchased: true
      };

      try {
        const response = await apiRequest('/automations', 'POST', payload);
        
        if (response && response.success) {
          hideCreateAutomationModal();
          await loadAutomations();
          await loadStats();
          showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ØªÙ…ØªØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } else {
          showToast(response?.message || 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ØªÙ…ØªØ©', 'error');
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ØªÙ…ØªØ©:', error);
        showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ØªÙ…ØªØ©', 'error');
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØªÙ…ØªØ§Øª
    async function refreshAutomations() {
      await Promise.all([loadAutomations(), loadAbandonedCartSettings(), loadStats()]);
      showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'success');
    }

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Toast
    function showToast(message, type = 'info') {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Toast
      const toast = document.createElement('div');
      toast.className = `fixed bottom-4 left-4 z-50 rounded-lg px-4 py-3 shadow-lg transition-all duration-300 transform translate-y-full opacity-0`;
      
      if (type === 'success') {
        toast.classList.add('bg-success', 'text-white');
      } else if (type === 'error') {
        toast.classList.add('bg-destructive', 'text-white');
      } else {
        toast.classList.add('bg-primary', 'text-white');
      }
      
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // Ø¥Ø¸Ù‡Ø§Ø±
      setTimeout(() => {
        toast.classList.remove('translate-y-full', 'opacity-0');
      }, 10);
      
      // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
      setTimeout(() => {
        toast.classList.add('translate-y-full', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>
