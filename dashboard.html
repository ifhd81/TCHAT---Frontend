<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TCHAT - لوحة التحكم</title>
    <link rel="stylesheet" href="./style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="./config.js"></script>
    <script src="./api.js"></script>
    <script src="./components/header.js"></script>
    <script src="./components/confirm-modal.js"></script>
</head>
  <body class="rtl min-h-screen bg-background" style="font-family: 'LamaSans', sans-serif;">
    
    <div class="min-h-screen">
      
      <!-- Header Container -->
      <div id="header-container"></div>

      <!-- Main Content -->
      <main class="container mx-auto px-4 py-6">
        
        <!-- Stats Cards -->
        <div class="grid gap-4 md:grid-cols-4 mb-6">
          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
              <h3 class="tracking-tight text-body-md font-medium">إجمالي العملاء</h3>
              <i data-lucide="users" class="h-4 w-4 text-muted-foreground"></i>
            </div>
            <div class="p-6 pt-0">
              <div class="text-heading-xl font-bold number" id="total-customers-header">0</div>
              <p class="text-body-sm text-muted-foreground">عميل نشط</p>
            </div>
          </div>

          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
              <h3 class="tracking-tight text-body-md font-medium">إجمالي الإيرادات</h3>
              <i data-lucide="saudi-riyal" class="h-4 w-4 text-muted-foreground"></i>
            </div>
            <div class="p-6 pt-0">
              <div class="text-heading-xl font-bold number" id="total-revenue">0</div>
              <p class="text-body-sm text-muted-foreground" id="revenue-subtitle">من السلات المتروكة المحولة</p>
            </div>
          </div>

          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
              <h3 class="tracking-tight text-body-md font-medium">السلات المتروكة</h3>
              <i data-lucide="shopping-cart" class="h-4 w-4 text-muted-foreground"></i>
            </div>
            <div class="p-6 pt-0">
              <div class="text-heading-xl font-bold number" id="total-carts-header">0</div>
              <p class="text-body-sm text-muted-foreground">مجموع السلات المتروكة</p>
            </div>
          </div>

          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
              <h3 class="tracking-tight text-body-md font-medium">الرسائل المرسلة</h3>
              <i data-lucide="send" class="h-4 w-4 text-muted-foreground"></i>
            </div>
            <div class="p-6 pt-0">
              <div class="text-heading-xl font-bold number" id="total-messages-header">0</div>
              <p class="text-body-sm text-muted-foreground">رسالة واتساب</p>
            </div>
          </div>
        </div>

        <!-- Tables Grid -->
        <div class="grid gap-4 md:grid-cols-2">
          
          <!-- Revenue Table -->
          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="flex flex-col space-y-1.5 p-6 border-b">
              <h3 class="text-heading-md font-semibold leading-none tracking-tight">الحملات والإيرادات</h3>
              <p class="text-body-sm text-muted-foreground">نتائج الحملات التسويقية</p>
            </div>
            <div class="p-6">
              <div class="relative w-full overflow-auto">
                <table class="w-full caption-bottom text-sm">
                  <thead class="[&_tr]:border-b">
                    <tr class="border-b transition-colors hover:bg-muted/50">
                      <th class="h-12 px-4 text-right align-middle font-medium text-muted-foreground text-body-sm">الحملة</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">الحالة</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">الإيرادات</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">الطلبات</th>
                    </tr>
                  </thead>
                  <tbody id="revenue-table-tbody" class="[&_tr:last-child]:border-0">
                    <!-- Data loaded from backend -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Abandoned Carts Table -->
          <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="flex flex-col space-y-1.5 p-6 border-b">
              <h3 class="text-heading-md font-semibold leading-none tracking-tight">السلات المتروكة</h3>
              <p class="text-body-sm text-muted-foreground">العملاء وحالة الإرسال</p>
            </div>
            <div class="p-6">
              <div class="relative w-full overflow-auto">
                <table class="w-full caption-bottom text-sm">
                  <thead class="[&_tr]:border-b">
                    <tr class="border-b transition-colors hover:bg-muted/50">
                      <th class="h-12 px-4 text-right align-middle font-medium text-muted-foreground text-body-sm">العميل</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">الجوال</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">المبلغ</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">الحالة</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">التوقيت</th>
                    </tr>
                  </thead>
                  <tbody id="abandoned-carts-tbody" class="[&_tr:last-child]:border-0">
                    <!-- Data loaded from backend -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Pagination -->
            <div class="flex items-center justify-between px-6 py-4 border-t">
              <div class="text-body-sm text-muted-foreground">
                <span id="current-range">1-10</span> من <span id="total-items">0</span>
              </div>
              <div class="flex items-center space-x-2 space-x-reverse">
                <button 
                  id="prev-btn" 
                  onclick="previousPage()" 
                  class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8 w-8"
                  disabled
                >
                  <i data-lucide="chevron-right" class="h-4 w-4"></i>
                </button>
                <div class="text-body-sm">
                  <span id="current-page">1</span> / <span id="total-pages">1</span>
                </div>
                <button 
                  id="next-btn" 
                  onclick="nextPage()" 
                  class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8 w-8"
                >
                  <i data-lucide="chevron-left" class="h-4 w-4"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- WhatsApp Numbers Table -->
          <div class="rounded-lg border bg-card text-card-foreground shadow-sm md:col-span-2">
            <div class="flex flex-col space-y-1.5 p-6 border-b">
              <h3 class="text-heading-md font-semibold leading-none tracking-tight">أرقام واتساب المرتبطة بميتا</h3>
              <p class="text-body-sm text-muted-foreground">تفاصيل الأرقام والجودة وحالة التحقق</p>
            </div>
            <div class="p-6">
              <div class="relative w-full overflow-auto">
                <table class="w-full caption-bottom text-sm">
                  <thead class="[&_tr]:border-b">
                    <tr class="border-b transition-colors hover:bg-muted/50">
                      <th class="h-12 px-4 text-right align-middle font-medium text-muted-foreground text-body-sm">المعرف</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">رقم الواتساب</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">الاسم الموثق</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">حالة التحقق</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">تقييم الجودة</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">حد السرعة (Throughput)</th>
                      <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground text-body-sm">مستوى الإرسال</th>
                    </tr>
                  </thead>
                  <tbody id="meta-phone-numbers-tbody" class="[&_tr:last-child]:border-0">
                    <!-- Data loaded from backend -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
        </div>
    </main>
    </div>

    <!-- Cart Details Modal -->
    <div id="cart-details-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
      <div class="relative w-full max-w-lg mx-4 bg-card rounded-lg shadow-xl border animate-in fade-in-0 zoom-in-95">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b">
          <h3 class="text-heading-md font-semibold">تفاصيل السلة المتروكة</h3>
          <button onclick="closeCartModal()" class="rounded-md p-2 hover:bg-muted transition-colors">
            <i data-lucide="x" class="h-4 w-4 text-muted-foreground"></i>
          </button>
        </div>
        
        <!-- Content -->
        <div class="p-6 space-y-4">
          <!-- Customer Info -->
          <div class="flex items-center gap-4 p-4 bg-muted/50 rounded-lg">
            <div class="relative flex h-12 w-12 shrink-0 overflow-hidden rounded-full bg-primary">
              <span id="modal-customer-avatar" class="flex h-full w-full items-center justify-center text-primary-foreground"></span>
            </div>
            <div>
              <div class="font-semibold text-body-md" id="modal-customer-name">-</div>
              <div class="font-mono text-body-sm text-muted-foreground number" id="modal-customer-mobile">-</div>
            </div>
          </div>

          <!-- Cart Details Grid -->
          <div class="grid grid-cols-2 gap-4">
            <div class="p-4 bg-muted/30 rounded-lg">
              <div class="text-body-sm text-muted-foreground mb-1">المبلغ</div>
              <div class="flex items-baseline gap-1">
                <span class="font-mono font-bold text-heading-sm number" id="modal-cart-amount">-</span>
                <span class="text-body-sm text-muted-foreground">ر.س</span>
              </div>
            </div>
            <div class="p-4 bg-muted/30 rounded-lg">
              <div class="text-body-sm text-muted-foreground mb-1">التوقيت</div>
              <div class="font-medium text-body-md" id="modal-cart-time">-</div>
            </div>
          </div>

          <!-- Status Section -->
          <div class="p-4 border rounded-lg">
            <div class="flex items-center justify-between mb-3">
              <span class="text-body-sm text-muted-foreground">حالة الإرسال</span>
              <span id="modal-status-badge"></span>
            </div>
            
            <!-- Error Details (shown only for failed status) -->
            <div id="modal-error-section" class="hidden mt-3 pt-3 border-t border-destructive/20">
              <div class="p-4 bg-destructive/10 rounded-lg">
                <!-- Error Header -->
                <div class="flex items-center gap-2 mb-4">
                  <i data-lucide="alert-circle" class="h-5 w-5 text-destructive shrink-0"></i>
                  <span class="font-semibold text-destructive text-body-md">تفاصيل الفشل</span>
                </div>
                
                <!-- Error Table -->
                <div class="overflow-hidden rounded-lg border border-destructive/20 bg-background">
                  <table class="w-full text-sm">
                    <thead>
                      <tr class="border-b border-destructive/20 bg-destructive/5">
                        <th class="px-4 py-2.5 text-right font-semibold text-destructive w-28">التفاصيل</th>
                        <th class="px-4 py-2.5 text-right font-semibold text-destructive">القيمة</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr class="border-b border-destructive/10">
                        <td class="px-4 py-3 text-muted-foreground">كود الخطأ</td>
                        <td class="px-4 py-3 font-mono font-medium text-foreground" id="modal-error-code">-</td>
                      </tr>
                      <tr class="border-b border-destructive/10">
                        <td class="px-4 py-3 text-muted-foreground">الرسالة</td>
                        <td class="px-4 py-3 text-foreground text-body-sm leading-relaxed" dir="ltr" id="modal-error-message">-</td>
                      </tr>
                      <tr>
                        <td class="px-4 py-3 text-muted-foreground">الترجمة</td>
                        <td class="px-4 py-3 text-foreground text-body-sm leading-relaxed" id="modal-error-translation">-</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- WhatsApp ID (if available) -->
            <div id="modal-whatsapp-section" class="hidden mt-3 pt-3 border-t">
              <div class="flex items-center justify-between">
                <span class="text-body-sm text-muted-foreground">معرف الرسالة</span>
                <span class="font-mono text-body-xs text-muted-foreground" id="modal-whatsapp-id">-</span>
              </div>
            </div>
          </div>

          <!-- Cart ID -->
          <div class="flex items-center justify-between text-body-sm">
            <span class="text-muted-foreground">معرف السلة</span>
            <span class="font-mono text-muted-foreground" id="modal-cart-id">-</span>
          </div>
        </div>

        <!-- Footer -->
        <div class="flex justify-end gap-2 p-6 border-t">
          <button onclick="closeCartModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4">
            إغلاق
          </button>
        </div>
      </div>
    </div>

    <script>
      const TABLE_STATES = {
        loading: (colspan, message = 'جاري التحميل...') => `
          <tr>
            <td colspan="${colspan}" class="h-24 text-center text-body-md text-muted-foreground">
              <div class="inline-flex items-center space-x-2 space-x-reverse">
                <svg class="h-4 w-4 animate-spin text-muted-foreground" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
                <span>${message}</span>
              </div>
            </td>
          </tr>
        `,
        empty: (colspan, message = 'لا توجد بيانات متاحة') => `
          <tr>
            <td colspan="${colspan}" class="h-24 text-center text-body-md text-muted-foreground">${message}</td>
          </tr>
        `,
        error: (colspan, message = 'تعذّر تحميل البيانات') => `
          <tr>
            <td colspan="${colspan}" class="h-24 text-center text-body-md text-destructive">
              <div class="inline-flex items-center space-x-2 space-x-reverse">
                <i data-lucide="alert-triangle" class="h-4 w-4"></i>
                <span>${message}</span>
              </div>
            </td>
          </tr>
        `,
      };

      function setTableState(tbodyId, state, colspan, message) {
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        tbody.innerHTML = TABLE_STATES[state](colspan, message);
      }

      function formatThroughputLevel(level) {
        if (!level) {
          return {
            label: 'غير محدد',
            badge: '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-muted text-muted-foreground">غير محدد</span>'
          };
        }

        const normalized = String(level).toUpperCase();
        const throughputMap = {
          'LOW': { label: 'منخفض', badge: 'bg-warning/10 text-warning' },
          'MEDIUM': { label: 'متوسط', badge: 'bg-primary/10 text-primary' },
          'HIGH': { label: 'عالٍ', badge: 'bg-success/10 text-success' },
          'VERY_HIGH': { label: 'عالٍ جداً', badge: 'bg-success/10 text-success' },
          'STANDARD': { label: 'قياسي', badge: 'bg-accent text-accent-foreground' },
          'LIMITED': { label: 'محدود', badge: 'bg-destructive/10 text-destructive' },
          'TIER_1': { label: 'المستوى 1', badge: 'bg-success/10 text-success' },
          'TIER_2': { label: 'المستوى 2', badge: 'bg-primary/10 text-primary' },
          'TIER_3': { label: 'المستوى 3', badge: 'bg-warning/10 text-warning' },
          'TIER_4': { label: 'المستوى 4', badge: 'bg-destructive/10 text-destructive' },
        };

        const config = throughputMap[normalized] || { label: level, badge: 'bg-accent text-accent-foreground' };
        return {
          label: config.label,
          badge: `<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold ${config.badge}">${config.label}</span>`
        };
      }

      // تنسيق حد الرسائل messaging_limit_tier
      function formatMessagingLimit(tier) {
        if (!tier) {
          return '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-muted text-muted-foreground">غير محدد</span>';
        }
        
        const tierMap = {
          'TIER_50': { label: '50', color: 'bg-muted text-muted-foreground' },
          'TIER_250': { label: '250', color: 'bg-muted text-muted-foreground' },
          'TIER_1K': { label: '1K', color: 'bg-warning/10 text-warning' },
          'TIER_10K': { label: '10K', color: 'bg-primary/10 text-primary' },
          'TIER_100K': { label: '100K', color: 'bg-success/10 text-success' },
          'TIER_UNLIMITED': { label: 'غير محدود', color: 'bg-success/10 text-success' },
        };
        
        const config = tierMap[tier] || { label: tier, color: 'bg-muted text-muted-foreground' };
        return `<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold ${config.color}">${config.label}</span>`;
      }

      // تنسيق مستوى السرعة (Throughput): STANDARD ≈80/ثا، HIGH ≈1000/ثا، VERY_HIGH
      function formatThroughputLevel(level) {
        const l = (level || '').toUpperCase();
        if (!l) {
          return '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-muted text-muted-foreground">غير محدد</span>';
        }
        const map = {
          'STANDARD':   { label: 'STANDARD', desc: '~80 رسالة/ثا', color: 'bg-primary/10 text-primary' },
          'HIGH':       { label: 'HIGH', desc: '~1000 رسالة/ثا', color: 'bg-success/10 text-success' },
          'VERY_HIGH':  { label: 'VERY_HIGH', desc: 'أعلى', color: 'bg-success/20 text-success' },
        };
        const config = map[l] || { label: l, desc: '', color: 'bg-muted text-muted-foreground' };
        return `<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold ${config.color}" title="${config.desc || ''}">${config.label}</span>`;
      }

      // تحقق من تسجيل الدخول
      if (!localStorage.getItem('tchat_logged_in')) {
        window.location.href = './login.html';
      }

      // متغيرات pagination
      let currentPage = 1;
      let itemsPerPage = 3;
      let totalItems = 0;
      let allAbandonedCarts = [];

      // تحميل البيانات من Backend
      async function loadDashboardData() {
        try {
          setTableState('revenue-table-tbody', 'loading', 4);
          setTableState('abandoned-carts-tbody', 'loading', 5);
          setTableState('meta-phone-numbers-tbody', 'loading', 7);
          
          // تحميل بيانات الإيرادات
          const revenueData = await loadRevenueData();
          console.log('Revenue Data:', revenueData);
          renderRevenueTable(revenueData);
          
          // تحديث الإحصائيات في header
          const systemStats = await loadSystemStats();
          if (systemStats) {
            document.getElementById('total-customers-header').textContent = systemStats.total_customers || 0;
            document.getElementById('total-carts-header').textContent = systemStats.total_abandoned_carts || 0;
            document.getElementById('total-messages-header').textContent = systemStats.total_whatsapp_sent || 0;
            
            // عرض الإيرادات من السلات المتروكة المحولة
            const totalRevenue = systemStats.total_revenue || 0;
            const purchasedCarts = systemStats.purchased_carts || 0;
            document.getElementById('total-revenue').textContent = totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            // تحديث النص التوضيحي
            const revenueSubtitle = document.getElementById('revenue-subtitle');
            if (revenueSubtitle) {
              revenueSubtitle.textContent = `من ${purchasedCarts} سلة متروكة محولة`;
            }
          }
          
          // تحميل أرقام واتساب من ميتا
          try {
            const metaPhoneNumbers = await loadMetaPhoneNumbers();
            renderMetaPhoneNumbersTable(metaPhoneNumbers);
          } catch (error) {
            console.error('تعذّر تحميل أرقام واتساب:', error);
            setTableState('meta-phone-numbers-tbody', 'error', 7, 'تعذّر تحميل أرقام واتساب');
          }

          // تحميل بيانات السلات المتروكة
          const abandonedCarts = await loadAbandonedCarts(50); // جلب 50 عنصر
          console.log('Abandoned Carts:', abandonedCarts);
          allAbandonedCarts = abandonedCarts;
          totalItems = abandonedCarts.length;
          updatePagination();
          renderAbandonedCartsPage();

          // فحص المحادثات غير المقروءة
          checkUnreadConversations();
          
        } catch (error) {
          console.error('خطأ في تحميل بيانات لوحة التحكم:', error);
          setTableState('revenue-table-tbody', 'error', 4, 'تعذّر تحميل بيانات الإيرادات');
          setTableState('abandoned-carts-tbody', 'error', 5, 'تعذّر تحميل بيانات السلات المتروكة');
          setTableState('meta-phone-numbers-tbody', 'error', 7, 'تعذّر تحميل أرقام واتساب');
        }
      }

      // عرض جدول الإيرادات
      function renderRevenueTable(data) {
        const tbody = document.getElementById('revenue-table-tbody');
        if (!tbody) return;
        if (!data || data.length === 0) {
          tbody.innerHTML = TABLE_STATES.empty(4, 'لا توجد بيانات إيرادات متاحة');
          return;
        }
        
        const revenue = (item) => Number(item.total_revenue) || 0;
        const orders = (item) => Number(item.attributed_orders) || 0;
        tbody.innerHTML = data.map(item => {
          const isActive = item.status === 'فعالة';
          const statusBadge = isActive 
            ? '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-success/10 text-success">فعالة</span>'
            : '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-warning/10 text-warning">متوقفة</span>';
          
          return `
            <tr class="border-b transition-colors hover:bg-muted/50">
              <td class="p-4 align-middle text-right">
                <div class="font-medium text-body-md">${item.campaign_name || ''}</div>
              </td>
              <td class="p-4 align-middle text-center">
                ${statusBadge}
              </td>
              <td class="p-4 align-middle text-center">
                <div class="font-mono font-medium number">${revenue(item).toLocaleString('en-US', {minimumFractionDigits: 0})}</div>
              </td>
              <td class="p-4 align-middle text-center">
                <div class="font-medium text-primary number">${orders(item)}</div>
              </td>
            </tr>
          `;
        }).join('');
      }

      // عرض جدول أرقام WhatsApp من Meta
      function renderMetaPhoneNumbersTable(phoneNumbers) {
        const tbody = document.getElementById('meta-phone-numbers-tbody');
        if (!tbody) return;
        if (!phoneNumbers || phoneNumbers.length === 0) {
          tbody.innerHTML = TABLE_STATES.empty(7, 'لا توجد أرقام واتساب مرتبطة');
          return;
        }

        tbody.innerHTML = phoneNumbers.map(phone => {
          // حد السرعة (Throughput): STANDARD | HIGH | VERY_HIGH
          const throughputLevel = phone.throughput_level || (phone.throughput && phone.throughput.level) || '';
          const throughputBadge = formatThroughputLevel(throughputLevel);
          // مستوى الإرسال (messaging_limit_tier)
          const messagingLimitBadge = formatMessagingLimit(phone.messaging_limit_tier);
          
          // تقييم الجودة
          let qualityBadge = '';
          switch (phone.quality_rating) {
            case 'GREEN':
              qualityBadge = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-success/10 text-success">مرتفع</span>';
              break;
            case 'YELLOW':
              qualityBadge = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-warning/10 text-warning">متوسط</span>';
              break;
            case 'RED':
              qualityBadge = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-destructive/10 text-destructive">منخفض</span>';
              break;
            case 'UNKNOWN':
              qualityBadge = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-blue-100 text-blue-700">غير محدد</span>';
              break;
            default:
              qualityBadge = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-muted text-muted-foreground">غير متاح</span>';
          }
          
          const cleanPhoneNumber = phone.display_phone_number ? phone.display_phone_number.replace(/[\s\+\-]/g, '') : 'غير محدد';
          
          // حالة التحقق (name_status)
          let verificationStatus = '';
          switch (phone.name_status) {
            case 'APPROVED':
              verificationStatus = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-success/10 text-success"><i data-lucide="shield-check" class="h-3 w-3 ml-1"></i>معتمد</span>';
              break;
            case 'PENDING':
              verificationStatus = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-warning/10 text-warning"><i data-lucide="clock" class="h-3 w-3 ml-1"></i>قيد المراجعة</span>';
              break;
            case 'DECLINED':
              verificationStatus = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-destructive/10 text-destructive"><i data-lucide="shield-x" class="h-3 w-3 ml-1"></i>مرفوض</span>';
              break;
            default:
              verificationStatus = '<span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold bg-muted text-muted-foreground"><i data-lucide="shield-question" class="h-3 w-3 ml-1"></i>غير معروف</span>';
          }
          return `
            <tr class="border-b transition-colors hover:bg-muted/50">
              <td class="p-4 align-middle text-right">
                <span class="font-mono text-body-sm text-muted-foreground number">${phone.id}</span>
              </td>
              <td class="p-4 align-middle text-center">
                <div class="font-mono font-medium number">${cleanPhoneNumber}</div>
              </td>
              <td class="p-4 align-middle text-center">
                <div class="text-body-md font-medium">${phone.verified_name || 'غير محدد'}</div>
              </td>
              <td class="p-4 align-middle text-center">
                ${verificationStatus}
              </td>
              <td class="p-4 align-middle text-center">
                ${qualityBadge}
              </td>
              <td class="p-4 align-middle text-center">
                ${throughputBadge}
              </td>
              <td class="p-4 align-middle text-center">
                ${messagingLimitBadge}
              </td>
            </tr>
          `;
        }).join('');
        
        lucide.createIcons();
      }

      // عرض جدول السلات المتروكة
      function renderAbandonedCartsTable(carts) {
        const tbody = document.getElementById('abandoned-carts-tbody');
        if (!tbody) return;
        if (!carts || carts.length === 0) {
          tbody.innerHTML = TABLE_STATES.empty(5, 'لا توجد سلات متروكة حالياً');
          updatePaginationInfo();
          return;
        }
        
        tbody.innerHTML = carts.map((cart, index) => {
          // تنسيق التاريخ
          const createdDate = new Date(cart.created_at);
          const timeAgo = getTimeAgo(createdDate);
          
          // تحديد حالة الإرسال بشكل مفصل
          const messageStatus = cart.message_status || 'pending';
          const statusConfig = {
            'sent': {
              label: 'تم الإرسال',
              icon: 'send',
              class: 'bg-blue-100 text-blue-800 border-blue-200'
            },
            'delivered': {
              label: 'وصلت',
              icon: 'check',
              class: 'bg-green-100 text-green-800 border-green-200'
            },
            'read': {
              label: 'قرأها',
              icon: 'eye',
              class: 'bg-green-200 text-green-900 border-green-300'
            },
            'replied': {
              label: 'رد عليها',
              icon: 'message-circle',
              class: 'bg-purple-100 text-purple-800 border-purple-200'
            },
            'failed': {
              label: 'فشلت',
              icon: 'x-circle',
              class: 'bg-red-100 text-red-800 border-red-200'
            },
            'ecosystem_limited': {
              label: 'محدودة',
              icon: 'alert-triangle',
              class: 'bg-orange-100 text-orange-800 border-orange-200'
            },
            'user_opted_out': {
              label: 'أوقف الاستقبال',
              icon: 'user-x',
              class: 'bg-gray-100 text-gray-600 border-gray-200'
            },
            'pending': {
              label: 'قيد الإرسال',
              icon: 'clock',
              class: 'bg-yellow-100 text-yellow-800 border-yellow-200'
            }
          };
          
          const config = statusConfig[messageStatus] || statusConfig['pending'];
          const statusBadge = `<span class="inline-flex items-center gap-1 rounded-full border px-2.5 py-0.5 text-xs font-semibold ${config.class}"><i data-lucide="${config.icon}" class="w-3 h-3"></i>${config.label}</span>`;
          
          // تنظيف رقم الجوال
          const cleanMobile = cart.customer_mobile ? cart.customer_mobile.replace(/[\s\+\-]/g, '') : 'غير محدد';
          
          // حساب الـ index الفعلي في المصفوفة الكاملة
          const actualIndex = (currentPage - 1) * itemsPerPage + index;
          
          return `
            <tr class="border-b transition-colors hover:bg-muted/50 cursor-pointer" onclick="openCartModal(${actualIndex})">
              <td class="p-4 align-middle text-right">
                <div class="flex items-center space-x-3 space-x-reverse">
                  <div class="relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full bg-muted">
                    <span class="flex h-full w-full items-center justify-center bg-primary text-primary-foreground">
                      ${userIconSvg('h-5 w-5')}
                    </span>
                  </div>
                  <div class="font-medium text-body-md">${cart.customer_name || 'غير محدد'}</div>
                </div>
              </td>
              <td class="p-4 align-middle text-center">
                <div class="font-mono text-body-sm text-muted-foreground number">${cleanMobile}</div>
              </td>
              <td class="p-4 align-middle text-center">
                <div class="font-mono font-medium number">${cart.total_amount ? cart.total_amount.toLocaleString('en-US', {minimumFractionDigits: 0}) : '0'}</div>
              </td>
              <td class="p-4 align-middle text-center">
                ${statusBadge}
              </td>
              <td class="p-4 align-middle text-center">
                <div class="text-body-sm text-muted-foreground">${timeAgo}</div>
              </td>
            </tr>
          `;
        }).join('');
        
        // إعادة تهيئة الأيقونات
        lucide.createIcons();
      }

      // فتح modal تفاصيل السلة
      function openCartModal(cartIndex) {
        const cart = allAbandonedCarts[cartIndex];
        if (!cart) return;

        const modal = document.getElementById('cart-details-modal');
        
        // تعبئة بيانات العميل
        document.getElementById('modal-customer-avatar').innerHTML = userIconSvg('h-6 w-6');
        document.getElementById('modal-customer-name').textContent = cart.customer_name || 'غير محدد';
        document.getElementById('modal-customer-mobile').textContent = cart.customer_mobile ? cart.customer_mobile.replace(/[\s\+\-]/g, '') : 'غير محدد';
        
        // تعبئة بيانات السلة
        document.getElementById('modal-cart-amount').textContent = cart.total_amount ? cart.total_amount.toLocaleString('en-US', {minimumFractionDigits: 2}) : '0';
        document.getElementById('modal-cart-time').textContent = getTimeAgo(new Date(cart.created_at));
        document.getElementById('modal-cart-id').textContent = cart.id || '-';

        // تحديد حالة الإرسال
        const messageStatus = cart.message_status || 'pending';
        const statusConfig = {
          'sent': { label: 'تم الإرسال', icon: 'send', class: 'bg-blue-100 text-blue-800 border-blue-200' },
          'delivered': { label: 'وصلت', icon: 'check', class: 'bg-green-100 text-green-800 border-green-200' },
          'read': { label: 'قرأها', icon: 'eye', class: 'bg-green-200 text-green-900 border-green-300' },
          'replied': { label: 'رد عليها', icon: 'message-circle', class: 'bg-purple-100 text-purple-800 border-purple-200' },
          'failed': { label: 'فشلت', icon: 'x-circle', class: 'bg-red-100 text-red-800 border-red-200' },
          'ecosystem_limited': { label: 'محدودة', icon: 'alert-triangle', class: 'bg-orange-100 text-orange-800 border-orange-200' },
          'user_opted_out': { label: 'أوقف الاستقبال', icon: 'user-x', class: 'bg-gray-100 text-gray-600 border-gray-200' },
          'pending': { label: 'قيد الإرسال', icon: 'clock', class: 'bg-yellow-100 text-yellow-800 border-yellow-200' }
        };
        
        const config = statusConfig[messageStatus] || statusConfig['pending'];
        document.getElementById('modal-status-badge').innerHTML = `<span class="inline-flex items-center gap-1 rounded-full border px-2.5 py-0.5 text-xs font-semibold ${config.class}"><i data-lucide="${config.icon}" class="w-3 h-3"></i>${config.label}</span>`;

        // عرض تفاصيل الخطأ إذا كانت الحالة فاشلة
        const errorSection = document.getElementById('modal-error-section');
        if (messageStatus === 'failed' || messageStatus === 'ecosystem_limited' || messageStatus === 'user_opted_out') {
          errorSection.classList.remove('hidden');
          
          // استخراج بيانات الخطأ من السلة
          const errorCode = cart.error_code || cart.failure_code || '-';
          
          // الرسالة الإنجليزية من ميتا
          const errorMessage = cart.error_message || cart.meta_error_message || getDefaultErrorMessage(errorCode, messageStatus);
          
          // الترجمة العربية
          const errorTranslation = cart.error_translation || getFailureReasonText(errorCode, messageStatus);
          
          // تعبئة الحقول
          document.getElementById('modal-error-code').textContent = errorCode;
          document.getElementById('modal-error-message').textContent = errorMessage;
          document.getElementById('modal-error-translation').textContent = errorTranslation;
        } else {
          errorSection.classList.add('hidden');
        }

        // عرض معرف رسالة WhatsApp إذا كان متاحاً
        const whatsappSection = document.getElementById('modal-whatsapp-section');
        if (cart.whatsapp_message_id) {
          whatsappSection.classList.remove('hidden');
          document.getElementById('modal-whatsapp-id').textContent = cart.whatsapp_message_id;
        } else {
          whatsappSection.classList.add('hidden');
        }

        // عرض الـ modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        lucide.createIcons();
      }

      // إغلاق modal تفاصيل السلة
      function closeCartModal() {
        const modal = document.getElementById('cart-details-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }

      // دالة للحصول على الرسالة الإنجليزية الافتراضية
      function getDefaultErrorMessage(errorCode, messageStatus) {
        if (messageStatus === 'ecosystem_limited') {
          return 'This message was not delivered to maintain healthy ecosystem engagement';
        }
        if (messageStatus === 'user_opted_out') {
          return 'User has opted out of receiving marketing messages from this business';
        }
        
        const errorMessages = {
          '131026': 'Message undeliverable - recipient is not available on WhatsApp',
          '131047': 'Re-engagement message rejected - recipient has not replied within 24 hours',
          '131049': 'This message was not delivered to maintain healthy ecosystem engagement',
          '131051': 'Unsupported message type for this recipient',
          '131052': 'Too many messages sent to this phone number',
          '131053': 'Media upload failed',
          '130472': 'Conversation session expired (24 hours)',
          '131031': 'Business account is temporarily locked',
          '131042': 'Template is not approved or has been paused',
          '131045': 'Template has been paused or deleted',
          '132000': 'Template parameter count mismatch',
          '132001': 'Template does not exist',
          '132005': 'Template parameter values are invalid',
          '132007': 'Template violates WhatsApp Business policy',
          '132012': 'Template is paused',
          '132015': 'Template is permanently disabled due to policy violation',
          '132016': 'Template is temporarily paused for review',
          '132068': 'Template flow is blocked',
          '132069': 'Template flow is throttled',
          '133004': 'Server is busy, please try again later',
          '133010': 'Phone number is not registered on WhatsApp',
          '135000': 'Generic WhatsApp API error'
        };
        
        return errorMessages[errorCode] || 'Message delivery failed';
      }

      // دالة للحصول على الترجمة العربية للخطأ
      function getFailureReasonText(errorCode, messageStatus) {
        if (messageStatus === 'ecosystem_limited') {
          return 'لم يتم تسليم هذه الرسالة للحفاظ على بيئة تفاعل صحية';
        }
        if (messageStatus === 'user_opted_out') {
          return 'العميل قام بإيقاف استقبال الرسائل التسويقية من هذا الحساب';
        }
        
        const errorTranslations = {
          '131026': 'الرسالة غير قابلة للتسليم - المستلم غير متاح على واتساب',
          '131047': 'رفض رسالة إعادة التفاعل - المستلم لم يرد خلال 24 ساعة',
          '131049': 'لم يتم تسليم هذه الرسالة للحفاظ على بيئة تفاعل صحية',
          '131051': 'نوع الرسالة غير مدعوم لهذا المستلم',
          '131052': 'تم إرسال عدد كبير جداً من الرسائل لهذا الرقم',
          '131053': 'فشل في رفع الوسائط',
          '130472': 'انتهت صلاحية جلسة المحادثة (24 ساعة)',
          '131031': 'حساب الأعمال مقفل مؤقتاً',
          '131042': 'القالب غير معتمد أو تم إيقافه',
          '131045': 'القالب متوقف أو محذوف',
          '132000': 'عدد معاملات القالب غير متطابق',
          '132001': 'القالب غير موجود',
          '132005': 'قيم معاملات القالب غير صالحة',
          '132007': 'القالب ينتهك سياسة واتساب للأعمال',
          '132012': 'القالب متوقف',
          '132015': 'القالب معطل نهائياً بسبب انتهاك السياسة',
          '132016': 'القالب معلق مؤقتاً للمراجعة',
          '132068': 'تدفق القالب محظور',
          '132069': 'تدفق القالب مقيد',
          '133004': 'الخادم مشغول، يرجى المحاولة لاحقاً',
          '133010': 'رقم الهاتف غير مسجل في واتساب',
          '135000': 'خطأ عام في واجهة واتساب'
        };
        
        return errorTranslations[errorCode] || 'فشل في تسليم الرسالة';
      }

      // إغلاق الـ modal عند النقر خارجه
      document.addEventListener('click', function(event) {
        const modal = document.getElementById('cart-details-modal');
        if (event.target === modal) {
          closeCartModal();
        }
      });

      // إغلاق الـ modal بمفتاح Escape
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          closeCartModal();
        }
      });

      // حساب الوقت المنقضي
      function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMins < 1) return 'الآن';
        if (diffMins < 60) return `منذ ${diffMins} دقيقة`;
        if (diffHours < 24) return `منذ ${diffHours} ساعة`;
        return `منذ ${diffDays} يوم`;
      }

      // عرض صفحة من السلات المتروكة
      function renderAbandonedCartsPage() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = allAbandonedCarts.slice(startIndex, endIndex);
        
        renderAbandonedCartsTable(pageData);
        updatePaginationInfo();
      }

      // تحديث معلومات pagination
      function updatePaginationInfo() {
        const startIndex = (currentPage - 1) * itemsPerPage + 1;
        const endIndex = Math.min(currentPage * itemsPerPage, totalItems);
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        
        document.getElementById('current-range').textContent = `${startIndex}-${endIndex}`;
        document.getElementById('total-items').textContent = totalItems;
        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;
        
        // تحديث حالة الأزرار
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;
      }

      // تحديث pagination
      function updatePagination() {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        updatePaginationInfo();
      }

      // الصفحة السابقة
      function previousPage() {
        if (currentPage > 1) {
          currentPage--;
          renderAbandonedCartsPage();
        }
      }

      // الصفحة التالية  
      function nextPage() {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderAbandonedCartsPage();
        }
      }

      // تهيئة أيقونات Lucide والهيدر
      document.addEventListener('DOMContentLoaded', function() {
        // تهيئة مكون الهيدر
        renderHeader('header-container', { activePage: 'dashboard' });
        
        lucide.createIcons();
        loadDashboardData();
        
        // فحص المحادثات غير المقروءة كل دقيقة
        setInterval(checkUnreadConversations, 60000);
      });

      // تسجيل الخروج
      // دالة logout موجودة في api.js
    </script>
  </body>
</html>
