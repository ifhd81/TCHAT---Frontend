<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TCHAT - ุงูุญููุงุช ุงููุคุชูุชุฉ</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="./api.js"></script>
  <script src="./components/header.js"></script>
</head>
<body class="rtl min-h-screen bg-background" style="font-family: 'LamaSans', sans-serif;">
  
  <div class="min-h-screen">
    
    <!-- Header Container -->
    <div id="header-container"></div>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    
    <!-- Page Header -->
    <section class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-heading-lg font-bold text-foreground">ุงูุญููุงุช ุงููุคุชูุชุฉ</h1>
        <p class="text-body-sm text-muted-foreground">ุฅุนุฏุงุฏ ุงูุฑุณุงุฆู ุงูุชููุงุฆูุฉ ุจูุงุกู ุนูู ุฃุญุฏุงุซ ูุนููุฉ</p>
      </div>
      <button onclick="showCreateAutomationModal()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
        <i data-lucide="plus" class="h-4 w-4"></i>
        <span>ุฃุชูุชุฉ ุฌุฏูุฏุฉ</span>
      </button>
    </section>

    <!-- Stats Cards -->
    <section class="mb-8 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <div class="rounded-xl border bg-card p-6 shadow-sm">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-primary/10">
            <i data-lucide="zap" class="h-5 w-5 text-primary"></i>
          </div>
          <div>
            <p class="text-body-sm text-muted-foreground">ุงูุฃุชูุชุงุช ุงููุดุทุฉ</p>
            <p class="text-heading-lg font-bold number" id="active-automations-count">0</p>
          </div>
        </div>
      </div>
      <div class="rounded-xl border bg-card p-6 shadow-sm">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-success/10">
            <i data-lucide="send" class="h-5 w-5 text-success"></i>
          </div>
          <div>
            <p class="text-body-sm text-muted-foreground">ุงูุฑุณุงุฆู ุงููุฑุณูุฉ</p>
            <p class="text-heading-lg font-bold number" id="total-sent-count">0</p>
          </div>
        </div>
      </div>
      <div class="rounded-xl border bg-card p-6 shadow-sm">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-warning/10">
            <i data-lucide="shopping-cart" class="h-5 w-5 text-warning"></i>
          </div>
          <div>
            <p class="text-body-sm text-muted-foreground">ุงูุณูุงุช ุงููุณุชูุฏูุฉ</p>
            <p class="text-heading-lg font-bold number" id="total-carts-count">0</p>
          </div>
        </div>
      </div>
      <div class="rounded-xl border bg-card p-6 shadow-sm">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-accent">
            <i data-lucide="percent" class="h-5 w-5 text-accent-foreground"></i>
          </div>
          <div>
            <p class="text-body-sm text-muted-foreground">ูุณุจุฉ ุงูุชุญููู</p>
            <p class="text-heading-lg font-bold number" id="conversion-rate">0%</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Automations List -->
    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
      <div class="border-b border-border p-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <i data-lucide="workflow" class="h-5 w-5 text-muted-foreground"></i>
            <h2 class="text-heading-md font-semibold">ูุงุฆูุฉ ุงูุฃุชูุชุงุช</h2>
          </div>
          <button onclick="refreshAutomations()" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="refresh-cw" class="h-4 w-4"></i>
          </button>
        </div>
      </div>

      <div class="p-6">
        <div id="automations-list" class="space-y-4">
          <!-- ุณูุชู ุชุญููู ุงูุฃุชูุชุงุช ููุง -->
        </div>
      </div>
    </div>

    <!-- Current Configuration Section -->
    <div class="mt-8 rounded-xl border bg-card text-card-foreground shadow-sm">
      <div class="border-b border-border p-6">
        <div class="flex items-center gap-3">
          <i data-lucide="settings" class="h-5 w-5 text-muted-foreground"></i>
          <h2 class="text-heading-md font-semibold">ุงูุฅุนุฏุงุฏ ุงูุญุงูู ููุณูุฉ ุงููุชุฑููุฉ</h2>
        </div>
      </div>
      <div class="p-6">
        <div class="rounded-lg border border-border bg-muted/30 p-6">
          <div class="flex items-start gap-4">
            <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-warning/10">
              <i data-lucide="shopping-cart" class="h-6 w-6 text-warning"></i>
            </div>
            <div class="flex-1">
              <h3 class="text-heading-sm font-semibold text-foreground">ุชุฐููุฑ ุงูุณูุฉ ุงููุชุฑููุฉ</h3>
              <p class="mt-1 text-body-sm text-muted-foreground">ูุชู ุฅุฑุณุงู ุฑุณุงูุฉ ุชููุงุฆูุฉ ุนูุฏ ุชุฑู ุงูุนููู ูุณูุฉ ุงูุชุณูู</p>
              
              <div class="mt-4 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
                <div class="rounded-md border border-border bg-background p-4">
                  <div class="flex items-center gap-2 text-body-sm text-muted-foreground">
                    <i data-lucide="file-text" class="h-4 w-4"></i>
                    <span>ุงููุงูุจ ุงููุณุชุฎุฏู</span>
                  </div>
                  <p class="mt-1 text-body-md font-semibold text-foreground" id="current-template-name">cart_1</p>
                </div>
                <div class="rounded-md border border-border bg-background p-4">
                  <div class="flex items-center gap-2 text-body-sm text-muted-foreground">
                    <i data-lucide="clock" class="h-4 w-4"></i>
                    <span>ููุช ุงูุฅุฑุณุงู</span>
                  </div>
                  <p class="mt-1 text-body-md font-semibold text-foreground" id="current-send-time">ููุฑู</p>
                </div>
                <div class="rounded-md border border-border bg-background p-4">
                  <div class="flex items-center gap-2 text-body-sm text-muted-foreground">
                    <i data-lucide="toggle-right" class="h-4 w-4"></i>
                    <span>ุงูุญุงูุฉ</span>
                  </div>
                  <p class="mt-1 text-body-md font-semibold text-success" id="current-status">ููุนูู</p>
                </div>
              </div>

              <div class="mt-4 flex items-center gap-3">
                <button onclick="showEditAbandonedCartModal()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-medium text-primary-foreground shadow-sm transition hover:bg-primary/90">
                  <i data-lucide="edit" class="h-4 w-4"></i>
                  <span>ุชุนุฏูู ุงูุฅุนุฏุงุฏุงุช</span>
                </button>
                <button onclick="toggleAbandonedCartStatus()" id="toggle-status-btn" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-button-md font-medium text-foreground shadow-sm transition hover:bg-accent">
                  <i data-lucide="pause" class="h-4 w-4"></i>
                  <span>ุฅููุงู ูุคูุช</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>

  </div>

  <!-- Modal: Edit Abandoned Cart Settings -->
  <div id="edit-abandoned-cart-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div>
            <h2 class="text-heading-lg font-bold">ุฅุนุฏุงุฏุงุช ุงูุณูุฉ ุงููุชุฑููุฉ</h2>
            <p class="text-body-sm text-muted-foreground mt-1">ุชุฎุตูุต ุงููุงูุจ ูููุช ุงูุฅุฑุณุงู</p>
          </div>
          <button onclick="hideEditAbandonedCartModal()" class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="x" class="h-5 w-5"></i>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-6">
          
          <!-- Template Selection -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">ุงููุงูุจ ุงููุณุชุฎุฏู</label>
            <p class="text-body-sm text-muted-foreground">ุงุฎุชุฑ ูุงูุจ ูุงุชุณุงุจ ูุฅุฑุณุงูู ุนูุฏ ุชุฑู ุงูุณูุฉ</p>
            <select id="template-select" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="">ุฌุงุฑู ุชุญููู ุงูููุงูุจ...</option>
            </select>
            
            <!-- Template Preview -->
            <div id="template-preview" class="hidden mt-4 rounded-lg border border-border bg-muted/30 p-4">
              <div class="flex items-center gap-2 mb-3">
                <i data-lucide="eye" class="h-4 w-4 text-muted-foreground"></i>
                <span class="text-body-sm font-medium text-muted-foreground">ูุนุงููุฉ ุงููุงูุจ</span>
              </div>
              <div id="template-preview-content" class="text-body-md text-foreground whitespace-pre-wrap"></div>
            </div>
          </div>

          <!-- Timing Selection -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">ููุช ุงูุฅุฑุณุงู</label>
            <p class="text-body-sm text-muted-foreground">ูุชู ูุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุจุนุฏ ุชุฑู ุงูุณูุฉุ</p>
            <select id="timing-select" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="0">ููุฑู (ุนูุฏ ุงุณุชูุงู ุงูุฅุดุนุงุฑ)</option>
              <option value="5">ุจุนุฏ 5 ุฏูุงุฆู</option>
              <option value="15">ุจุนุฏ 15 ุฏูููุฉ</option>
              <option value="30">ุจุนุฏ 30 ุฏูููุฉ</option>
              <option value="60">ุจุนุฏ ุณุงุนุฉ</option>
              <option value="120">ุจุนุฏ ุณุงุนุชูู</option>
              <option value="180">ุจุนุฏ 3 ุณุงุนุงุช</option>
              <option value="360">ุจุนุฏ 6 ุณุงุนุงุช</option>
              <option value="720">ุจุนุฏ 12 ุณุงุนุฉ</option>
              <option value="1440">ุจุนุฏ 24 ุณุงุนุฉ</option>
            </select>
          </div>

          <!-- Additional Options -->
          <div class="space-y-4 rounded-lg border border-border p-4">
            <h3 class="text-body-md font-semibold text-foreground">ุฎูุงุฑุงุช ุฅุถุงููุฉ</h3>
            
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="prevent-duplicate" checked class="h-5 w-5 rounded border-input text-primary focus:ring-primary">
              <div>
                <span class="text-body-md text-foreground">ููุน ุงูุฅุฑุณุงู ุงูููุฑุฑ</span>
                <p class="text-body-sm text-muted-foreground">ุนุฏู ุฅุฑุณุงู ุฃูุซุฑ ูู ุฑุณุงูุฉ ููุนููู ุฎูุงู 24 ุณุงุนุฉ</p>
              </div>
            </label>

            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="skip-purchased" checked class="h-5 w-5 rounded border-input text-primary focus:ring-primary">
              <div>
                <span class="text-body-md text-foreground">ุชุฎุทู ุงูุณูุงุช ุงููุดุชุฑุงุฉ</span>
                <p class="text-body-sm text-muted-foreground">ุนุฏู ุฅุฑุณุงู ุฑุณุงูุฉ ุฅุฐุง ุฃููู ุงูุนููู ุงูุดุฑุงุก</p>
              </div>
            </label>
          </div>

        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 border-t border-border p-6">
          <button onclick="hideEditAbandonedCartModal()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-button-md font-medium text-foreground shadow-sm transition hover:bg-accent">
            ุฅูุบุงุก
          </button>
          <button onclick="saveAbandonedCartSettings()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
            <i data-lucide="save" class="h-4 w-4"></i>
            <span>ุญูุธ ุงูุฅุนุฏุงุฏุงุช</span>
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal: Create New Automation -->
  <div id="create-automation-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="rounded-xl border bg-card shadow-lg">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between border-b border-border p-6">
          <div>
            <h2 class="text-heading-lg font-bold">ุฅูุดุงุก ุฃุชูุชุฉ ุฌุฏูุฏุฉ</h2>
            <p class="text-body-sm text-muted-foreground mt-1">ุฅุนุฏุงุฏ ุฑุณุงูุฉ ุชููุงุฆูุฉ ุจูุงุกู ุนูู ุญุฏุซ ูุนูู</p>
          </div>
          <button onclick="hideCreateAutomationModal()" class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
            <i data-lucide="x" class="h-5 w-5"></i>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6 space-y-6">
          
          <!-- Automation Name -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">ุงุณู ุงูุฃุชูุชุฉ</label>
            <input type="text" id="automation-name" placeholder="ูุซุงู: ุชุฐููุฑ ุงูุณูุฉ ุงููุชุฑููุฉ" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
          </div>

          <!-- Trigger Selection -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">ุงูุญุฏุซ ุงูููุดุบูู</label>
            <p class="text-body-sm text-muted-foreground">ุงุฎุชุฑ ุงูุญุฏุซ ุงูุฐู ุณููุดุบูู ูุฐู ุงูุฃุชูุชุฉ</p>
            <select id="trigger-select" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="">ุงุฎุชุฑ ุงูุญุฏุซ...</option>
              <option value="abandoned_cart">ุณูุฉ ูุชุฑููุฉ</option>
              <option value="new_order">ุทูุจ ุฌุฏูุฏ</option>
              <option value="order_shipped">ุดุญู ุงูุทูุจ</option>
              <option value="order_delivered">ุชูุตูู ุงูุทูุจ</option>
              <option value="new_customer">ุนููู ุฌุฏูุฏ</option>
            </select>
          </div>

          <!-- Template Selection -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">ุงููุงูุจ ุงููุณุชุฎุฏู</label>
            <select id="new-automation-template" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="">ุฌุงุฑู ุชุญููู ุงูููุงูุจ...</option>
            </select>
          </div>

          <!-- Timing Selection -->
          <div class="space-y-3">
            <label class="text-body-md font-semibold text-foreground">ููุช ุงูุฅุฑุณุงู</label>
            <select id="new-automation-timing" class="w-full rounded-md border border-input bg-background px-4 py-3 text-body-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
              <option value="0">ููุฑู</option>
              <option value="5">ุจุนุฏ 5 ุฏูุงุฆู</option>
              <option value="15">ุจุนุฏ 15 ุฏูููุฉ</option>
              <option value="30">ุจุนุฏ 30 ุฏูููุฉ</option>
              <option value="60">ุจุนุฏ ุณุงุนุฉ</option>
              <option value="120">ุจุนุฏ ุณุงุนุชูู</option>
              <option value="1440">ุจุนุฏ 24 ุณุงุนุฉ</option>
            </select>
          </div>

        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 border-t border-border p-6">
          <button onclick="hideCreateAutomationModal()" class="inline-flex items-center gap-2 rounded-md border border-input bg-background px-4 py-2 text-button-md font-medium text-foreground shadow-sm transition hover:bg-accent">
            ุฅูุบุงุก
          </button>
          <button onclick="createAutomation()" class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-button-md font-semibold text-primary-foreground shadow-sm transition hover:bg-primary/90">
            <i data-lucide="plus" class="h-4 w-4"></i>
            <span>ุฅูุดุงุก ุงูุฃุชูุชุฉ</span>
          </button>
        </div>

      </div>
    </div>
  </div>

  <script>
    // ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
    if (!localStorage.getItem('tchat_logged_in')) {
      window.location.href = './login.html';
    }

    // ุงููุชุบูุฑุงุช ุงูุนุงูุฉ
    let allTemplates = [];
    let automations = [];
    let abandonedCartSettings = {
      templateName: 'cart_1',
      delayMinutes: 0,
      isActive: true,
      preventDuplicate: true,
      skipPurchased: true
    };

    // ุชููุฆุฉ ุงูุตูุญุฉ
    document.addEventListener('DOMContentLoaded', async () => {
      // ุชููุฆุฉ ุงูููุฏุฑ
      renderHeader('header-container', { activePage: 'automations' });
      lucide.createIcons();
      await loadTemplates();
      await loadAutomations();
      await loadAbandonedCartSettings();
      updateStats();
    });

    // ุชุญููู ุงูููุงูุจ ูู API
    async function loadTemplates() {
      try {
        const response = await apiRequest('/meta/templates?limit=100');
        if (response && response.data) {
          allTemplates = response.data.filter(t => t.status === 'APPROVED');
          populateTemplateSelects();
        }
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุงูููุงูุจ:', error);
        showToast('ูุดู ุชุญููู ุงูููุงูุจ', 'error');
      }
    }

    // ููุก ููุงุฆู ุงูููุงูุจ
    function populateTemplateSelects() {
      const selects = ['template-select', 'new-automation-template'];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        select.innerHTML = '<option value="">ุงุฎุชุฑ ูุงูุจ...</option>';
        
        allTemplates.forEach(template => {
          const langText = template.language === 'ar' ? 'ุงูุนุฑุจูุฉ' : 'ุงูุฅูุฌููุฒูุฉ';
          const option = document.createElement('option');
          option.value = template.name;
          option.textContent = `${template.name} (${langText})`;
          option.dataset.template = JSON.stringify(template);
          select.appendChild(option);
        });
      });

      // ุฅุถุงูุฉ ุญุฏุซ ูุนุฑุถ ูุนุงููุฉ ุงููุงูุจ
      const templateSelect = document.getElementById('template-select');
      if (templateSelect) {
        templateSelect.addEventListener('change', showTemplatePreview);
      }
    }

    // ุนุฑุถ ูุนุงููุฉ ุงููุงูุจ
    function showTemplatePreview() {
      const select = document.getElementById('template-select');
      const preview = document.getElementById('template-preview');
      const previewContent = document.getElementById('template-preview-content');
      
      const selectedOption = select.options[select.selectedIndex];
      if (!selectedOption.value || !selectedOption.dataset.template) {
        preview.classList.add('hidden');
        return;
      }

      const template = JSON.parse(selectedOption.dataset.template);
      const components = template.components || [];
      
      let previewText = '';
      components.forEach(comp => {
        if (comp.type === 'HEADER' && comp.text) {
          previewText += `๐ ${comp.text}\n\n`;
        }
        if (comp.type === 'BODY' && comp.text) {
          previewText += comp.text + '\n\n';
        }
        if (comp.type === 'FOOTER' && comp.text) {
          previewText += `โ\n${comp.text}`;
        }
      });

      previewContent.textContent = previewText || 'ูุง ุชูุฌุฏ ูุนุงููุฉ ูุชุงุญุฉ';
      preview.classList.remove('hidden');
    }

    // ุชุญููู ุงูุฃุชูุชุงุช
    async function loadAutomations() {
      try {
        // ุญุงููุงู ูุนุฑุถ ุงูุฃุชูุชุฉ ุงูุงูุชุฑุงุถูุฉ ููุณูุฉ ุงููุชุฑููุฉ
        renderAutomations();
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุงูุฃุชูุชุงุช:', error);
      }
    }

    // ุชุญููู ุฅุนุฏุงุฏุงุช ุงูุณูุฉ ุงููุชุฑููุฉ
    async function loadAbandonedCartSettings() {
      try {
        // ุชุญููู ุงูุฅุนุฏุงุฏุงุช ูู localStorage ุฃู API
        const saved = localStorage.getItem('abandoned_cart_settings');
        if (saved) {
          abandonedCartSettings = JSON.parse(saved);
        }
        updateCurrentSettingsDisplay();
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุงูุฅุนุฏุงุฏุงุช:', error);
      }
    }

    // ุชุญุฏูุซ ุนุฑุถ ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ
    function updateCurrentSettingsDisplay() {
      document.getElementById('current-template-name').textContent = abandonedCartSettings.templateName;
      
      const timingText = getTimingText(abandonedCartSettings.delayMinutes);
      document.getElementById('current-send-time').textContent = timingText;
      
      const statusEl = document.getElementById('current-status');
      const toggleBtn = document.getElementById('toggle-status-btn');
      
      if (abandonedCartSettings.isActive) {
        statusEl.textContent = 'ููุนูู';
        statusEl.className = 'mt-1 text-body-md font-semibold text-success';
        toggleBtn.innerHTML = '<i data-lucide="pause" class="h-4 w-4"></i><span>ุฅููุงู ูุคูุช</span>';
      } else {
        statusEl.textContent = 'ูุชููู';
        statusEl.className = 'mt-1 text-body-md font-semibold text-destructive';
        toggleBtn.innerHTML = '<i data-lucide="play" class="h-4 w-4"></i><span>ุชูุนูู</span>';
      }
      
      lucide.createIcons();
    }

    // ุงูุญุตูู ุนูู ูุต ุงูููุช
    function getTimingText(minutes) {
      if (minutes === 0) return 'ููุฑู';
      if (minutes < 60) return `ุจุนุฏ ${minutes} ุฏูููุฉ`;
      if (minutes === 60) return 'ุจุนุฏ ุณุงุนุฉ';
      if (minutes < 1440) return `ุจุนุฏ ${minutes / 60} ุณุงุนุงุช`;
      return `ุจุนุฏ ${minutes / 1440} ููู`;
    }

    // ุนุฑุถ ุงูุฃุชูุชุงุช
    function renderAutomations() {
      const container = document.getElementById('automations-list');
      
      // ุฃุชูุชุฉ ุงูุณูุฉ ุงููุชุฑููุฉ ุงูุงูุชุฑุงุถูุฉ
      const abandonedCartAutomation = `
        <div class="rounded-lg border border-border bg-background p-4 transition hover:shadow-md">
          <div class="flex items-start justify-between">
            <div class="flex items-start gap-4">
              <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-warning/10">
                <i data-lucide="shopping-cart" class="h-6 w-6 text-warning"></i>
              </div>
              <div>
                <div class="flex items-center gap-2">
                  <h3 class="text-heading-sm font-semibold text-foreground">ุชุฐููุฑ ุงูุณูุฉ ุงููุชุฑููุฉ</h3>
                  <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${abandonedCartSettings.isActive ? 'bg-success/10 text-success' : 'bg-destructive/10 text-destructive'}">
                    ${abandonedCartSettings.isActive ? 'ููุนูู' : 'ูุชููู'}
                  </span>
                </div>
                <p class="mt-1 text-body-sm text-muted-foreground">ุฅุฑุณุงู ุฑุณุงูุฉ ุชููุงุฆูุฉ ุนูุฏ ุชุฑู ุงูุนููู ูุณูุฉ ุงูุชุณูู</p>
                <div class="mt-2 flex items-center gap-4 text-body-xs text-muted-foreground">
                  <span class="flex items-center gap-1">
                    <i data-lucide="file-text" class="h-3 w-3"></i>
                    ${abandonedCartSettings.templateName}
                  </span>
                  <span class="flex items-center gap-1">
                    <i data-lucide="clock" class="h-3 w-3"></i>
                    ${getTimingText(abandonedCartSettings.delayMinutes)}
                  </span>
                </div>
              </div>
            </div>
            <button onclick="showEditAbandonedCartModal()" class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-input bg-background text-muted-foreground transition hover:text-foreground">
              <i data-lucide="settings" class="h-4 w-4"></i>
            </button>
          </div>
        </div>
      `;

      container.innerHTML = abandonedCartAutomation;
      lucide.createIcons();
    }

    // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
    function updateStats() {
      document.getElementById('active-automations-count').textContent = abandonedCartSettings.isActive ? '1' : '0';
      // ูููู ุชุญุฏูุซ ุจุงูู ุงูุฅุญุตุงุฆูุงุช ูู API ูุงุญูุงู
    }

    // ุนุฑุถ ูุงูุฐุฉ ุชุนุฏูู ุงูุณูุฉ ุงููุชุฑููุฉ
    function showEditAbandonedCartModal() {
      const modal = document.getElementById('edit-abandoned-cart-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      // ุชุญุฏูุฏ ุงูููู ุงูุญุงููุฉ
      document.getElementById('template-select').value = abandonedCartSettings.templateName;
      document.getElementById('timing-select').value = abandonedCartSettings.delayMinutes;
      document.getElementById('prevent-duplicate').checked = abandonedCartSettings.preventDuplicate;
      document.getElementById('skip-purchased').checked = abandonedCartSettings.skipPurchased;
      
      showTemplatePreview();
      lucide.createIcons();
    }

    // ุฅุฎูุงุก ูุงูุฐุฉ ุชุนุฏูู ุงูุณูุฉ ุงููุชุฑููุฉ
    function hideEditAbandonedCartModal() {
      const modal = document.getElementById('edit-abandoned-cart-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุณูุฉ ุงููุชุฑููุฉ
    async function saveAbandonedCartSettings() {
      const templateName = document.getElementById('template-select').value;
      const delayMinutes = parseInt(document.getElementById('timing-select').value);
      const preventDuplicate = document.getElementById('prevent-duplicate').checked;
      const skipPurchased = document.getElementById('skip-purchased').checked;

      if (!templateName) {
        showToast('ูุฑุฌู ุงุฎุชูุงุฑ ูุงูุจ', 'error');
        return;
      }

      abandonedCartSettings = {
        ...abandonedCartSettings,
        templateName,
        delayMinutes,
        preventDuplicate,
        skipPurchased
      };

      // ุญูุธ ูู localStorage
      localStorage.setItem('abandoned_cart_settings', JSON.stringify(abandonedCartSettings));

      // TODO: ุญูุธ ูู API
      // await apiRequest('/automations/abandoned-cart', 'PUT', abandonedCartSettings);

      hideEditAbandonedCartModal();
      updateCurrentSettingsDisplay();
      renderAutomations();
      showToast('ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ', 'success');
    }

    // ุชุจุฏูู ุญุงูุฉ ุงูุณูุฉ ุงููุชุฑููุฉ
    function toggleAbandonedCartStatus() {
      abandonedCartSettings.isActive = !abandonedCartSettings.isActive;
      localStorage.setItem('abandoned_cart_settings', JSON.stringify(abandonedCartSettings));
      updateCurrentSettingsDisplay();
      renderAutomations();
      updateStats();
      
      const message = abandonedCartSettings.isActive ? 'ุชู ุชูุนูู ุงูุฃุชูุชุฉ' : 'ุชู ุฅููุงู ุงูุฃุชูุชุฉ';
      showToast(message, 'success');
    }

    // ุนุฑุถ ูุงูุฐุฉ ุฅูุดุงุก ุฃุชูุชุฉ ุฌุฏูุฏุฉ
    function showCreateAutomationModal() {
      const modal = document.getElementById('create-automation-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      lucide.createIcons();
    }

    // ุฅุฎูุงุก ูุงูุฐุฉ ุฅูุดุงุก ุฃุชูุชุฉ ุฌุฏูุฏุฉ
    function hideCreateAutomationModal() {
      const modal = document.getElementById('create-automation-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // ุฅูุดุงุก ุฃุชูุชุฉ ุฌุฏูุฏุฉ
    async function createAutomation() {
      const name = document.getElementById('automation-name').value;
      const trigger = document.getElementById('trigger-select').value;
      const template = document.getElementById('new-automation-template').value;
      const timing = document.getElementById('new-automation-timing').value;

      if (!name || !trigger || !template) {
        showToast('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ', 'error');
        return;
      }

      // TODO: ุญูุธ ุงูุฃุชูุชุฉ ูู API
      showToast('ูุฑูุจุงู - ุฅูุดุงุก ุงูุฃุชูุชุงุช ุงููุฎุตุตุฉ', 'info');
      hideCreateAutomationModal();
    }

    // ุชุญุฏูุซ ุงูุฃุชูุชุงุช
    function refreshAutomations() {
      loadAutomations();
      showToast('ุชู ุชุญุฏูุซ ุงููุงุฆูุฉ', 'success');
    }

    // ุนุฑุถ ุฑุณุงูุฉ Toast
    function showToast(message, type = 'info') {
      // ุฅูุดุงุก ุนูุตุฑ Toast
      const toast = document.createElement('div');
      toast.className = `fixed bottom-4 left-4 z-50 rounded-lg px-4 py-3 shadow-lg transition-all duration-300 transform translate-y-full opacity-0`;
      
      if (type === 'success') {
        toast.classList.add('bg-success', 'text-white');
      } else if (type === 'error') {
        toast.classList.add('bg-destructive', 'text-white');
      } else {
        toast.classList.add('bg-primary', 'text-white');
      }
      
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // ุฅุธูุงุฑ
      setTimeout(() => {
        toast.classList.remove('translate-y-full', 'opacity-0');
      }, 10);
      
      // ุฅุฎูุงุก ุจุนุฏ 3 ุซูุงูู
      setTimeout(() => {
        toast.classList.add('translate-y-full', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>
